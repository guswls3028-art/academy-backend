FROM python:3.11-slim

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONPATH=/app

# β… μ΄μ κΈ°μ¤€: Worker β†’ API λ” λ¬΄μ΅°κ±΄ VPC λ‚΄λ¶€ ν†µμ‹ 
# (Cloudflare / HTTPS / μ™Έλ¶€ LB μ λ€ ν†µκ³Ό μ• ν•¨)
ENV API_BASE_URL=http://172.31.32.253:8000

RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    ffmpeg \
    libgl1 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# pip μ•μ •ν™”
RUN pip install --upgrade pip

# π”¥ μΊμ‹ μµμ ν™” ν¬μΈνΈ
COPY requirements/common.txt ./requirements/common.txt
COPY requirements/worker-ai.txt ./requirements/worker-ai.txt
RUN pip install --no-cache-dir -r requirements/worker-ai.txt

# μ½”λ“
COPY apps ./apps
COPY libs ./libs

# Google Vision Key
COPY docker/ai-worker/keys/google-vision.json /keys/google-vision.json
ENV GOOGLE_APPLICATION_CREDENTIALS=/keys/google-vision.json

CMD ["python", "-m", "apps.worker.ai_worker.run"]
