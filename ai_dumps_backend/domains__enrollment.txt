====================================================================================================
# BACKEND APP: domains__enrollment
# ROOT PATH: C:\academy\apps\domains\enrollment
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
from django.contrib import admin
from .models import Enrollment, SessionEnrollment


@admin.register(Enrollment)
class EnrollmentAdmin(admin.ModelAdmin):
    list_display = ("id", "student", "lecture", "status", "enrolled_at")
    list_display_links = ("id", "student")
    list_filter = ("status", "lecture")
    search_fields = ("student__name", "lecture__title")
    ordering = ("-id",)


@admin.register(SessionEnrollment)
class SessionEnrollmentAdmin(admin.ModelAdmin):
    list_display = ("id", "session", "enrollment", "created_at")
    list_display_links = ("id", "session")
    list_filter = ("session__lecture", "session")
    search_fields = ("enrollment__student__name",)
    ordering = ("-id",)


==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class EnrollmentConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.enrollment"


==========================================================================================
# FILE: filters.py
==========================================================================================
# apps/domains/enrollment/filters.py

import django_filters

from .models import Enrollment


class EnrollmentFilter(django_filters.FilterSet):
    """
    Enrollment list filtering.
    Front uses: /lectures/enrollments/?lecture={lectureId}
    """

    class Meta:
        model = Enrollment
        fields = {
            "lecture": ["exact"],
            "student": ["exact"],
            "status": ["exact"],
        }


==========================================================================================
# FILE: models.py
==========================================================================================
# PATH: apps/domains/enrollment/models.py

from django.db import models

from apps.api.common.models import TimestampModel
from apps.domains.students.models import Student
from apps.domains.lectures.models import Lecture, Session
from apps.core.models import Tenant


# ========================================================
# Enrollment (강의 단위 수강 등록)
# ========================================================

class Enrollment(TimestampModel):
    """
    학생이 특정 강의를 수강하는 행위.
    강의 정의(Lecture)와 분리된 '수강 행위' 도메인이다.

    ✅ 운영 기준:
    - Enrollment는 반드시 tenant 단위로 격리됨
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="enrollments",
        null=False,  # ✅ NOT NULL로 변경 (프로덕션 준비)
        blank=False,
        db_index=True,  # ✅ tenant_id 인덱스 추가
    )

    student = models.ForeignKey(
        Student,
        on_delete=models.CASCADE,
        related_name="enrollments",
    )
    lecture = models.ForeignKey(
        Lecture,
        on_delete=models.CASCADE,
        related_name="enrollments",
    )

    status = models.CharField(
        max_length=20,
        choices=[
            ("ACTIVE", "활성"),
            ("INACTIVE", "비활성"),
            ("PENDING", "대기"),
        ],
        default="ACTIVE",
    )

    enrolled_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        indexes = [
            models.Index(fields=["tenant", "created_at"]),  # ✅ 복합 인덱스 추가
        ]
        constraints = [
            models.UniqueConstraint(
                fields=["tenant", "student", "lecture"],
                name="unique_enrollment_per_tenant_lecture",
            )
        ]

    def __str__(self):
        return f"{self.student.name} -> {self.lecture.title}"


# ========================================================
# SessionEnrollment (차시 단위 수강 권한)
# ========================================================

class SessionEnrollment(models.Model):
    """
    특정 Enrollment가 어떤 Session(차시)에 접근 가능한지 정의.
    출결/영상/자료 접근의 기준이 되는 중간 테이블.
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="session_enrollments",
        null=False,  # ✅ NOT NULL로 변경 (프로덕션 준비)
        blank=False,
        db_index=True,  # ✅ tenant_id 인덱스 추가
    )

    session = models.ForeignKey(
        Session,
        on_delete=models.CASCADE,
        related_name="session_enrollments",
    )
    enrollment = models.ForeignKey(
        Enrollment,
        on_delete=models.CASCADE,
        related_name="session_enrollments",
    )

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ("tenant", "session", "enrollment")

    def __str__(self):
        return f"{self.session} - {self.enrollment.student.name}"


==========================================================================================
# FILE: permissions.py
==========================================================================================
# PATH: apps/domains/enrollment/permissions.py

from rest_framework.permissions import BasePermission
from apps.domains.enrollment.models import Enrollment


class HasEnrollmentAccess(BasePermission):
    """
    학생이 해당 Enrollment(수강 정보)에 접근 가능한지 검증
    (tenant 기준 강제)
    """
    message = "You do not have access to this enrollment."

    def has_permission(self, request, view):
        user = request.user

        if not user or not user.is_authenticated:
            return False

        student = getattr(user, "student_profile", None)
        if not student:
            return False

        enrollment_id = (
            request.data.get("enrollment_id")
            or request.query_params.get("enrollment_id")
        )
        if not enrollment_id:
            return False

        tenant = getattr(request, "tenant", None)

        return Enrollment.objects.filter(
            id=enrollment_id,
            student=student,
            tenant=tenant,          # ✅ tenant 안전장치
            status="ACTIVE",
        ).exists()


==========================================================================================
# FILE: serializers.py
==========================================================================================
from rest_framework import serializers

from .models import Enrollment, SessionEnrollment
from apps.domains.students.models import Student


class StudentShortSerializer(serializers.ModelSerializer):
    class Meta:
        model = Student
        fields = [
            "id",
            "name",
            "grade",
            "high_school",
            "high_school_class",
            "major",
            "phone",
            "parent_phone",
        ]


class EnrollmentSerializer(serializers.ModelSerializer):
    student = StudentShortSerializer(read_only=True)

    class Meta:
        model = Enrollment
        fields = "__all__"


class SessionEnrollmentSerializer(serializers.ModelSerializer):
    student_name = serializers.CharField(
        source="enrollment.student.name", read_only=True
    )

    class Meta:
        model = SessionEnrollment
        fields = "__all__"


==========================================================================================
# FILE: urls.py
==========================================================================================
from rest_framework.routers import DefaultRouter
from .views import EnrollmentViewSet, SessionEnrollmentViewSet

router = DefaultRouter()

# ==================================================
# SessionEnrollment (⚠️ 반드시 먼저!)
# ==================================================
router.register(
    r"session-enrollments",
    SessionEnrollmentViewSet,
    basename="session-enrollment",
)

# ==================================================
# Enrollment (⚠️ r"" 는 항상 맨 마지막)
# ==================================================
router.register(
    r"",
    EnrollmentViewSet,
    basename="enrollment",
)

urlpatterns = router.urls


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/domains/enrollment/views.py

from django.db import transaction
from rest_framework.viewsets import ModelViewSet
from rest_framework.decorators import action
from rest_framework.filters import SearchFilter
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.response import Response
from rest_framework import status
from rest_framework.exceptions import ValidationError

from .models import Enrollment, SessionEnrollment
from .serializers import EnrollmentSerializer, SessionEnrollmentSerializer
from .filters import EnrollmentFilter
from apps.domains.lectures.models import Session, Lecture
from apps.domains.students.models import Student


class EnrollmentViewSet(ModelViewSet):
    serializer_class = EnrollmentSerializer

    filter_backends = [DjangoFilterBackend, SearchFilter]
    filterset_class = EnrollmentFilter
    search_fields = ["student__name"]

    def get_queryset(self):
        tenant = getattr(self.request, "tenant", None)
        return (
            Enrollment.objects
            .filter(tenant=tenant)
            .select_related("student", "lecture")
        )

    @transaction.atomic
    @action(detail=False, methods=["post"])
    def bulk_create(self, request):
        tenant = getattr(request, "tenant", None)

        lecture_id = request.data.get("lecture")
        student_ids = request.data.get("students", [])

        if not lecture_id or not isinstance(student_ids, list):
            return Response(
                {"detail": "lecture, students(list)는 필수입니다"},
                status=status.HTTP_400_BAD_REQUEST,
            )

        # ✅ lecture tenant 검증
        lecture = Lecture.objects.filter(
            id=lecture_id,
            tenant=tenant,
        ).first()
        if not lecture:
            raise ValidationError({"detail": "해당 학원의 강의가 아닙니다."})

        created = []
        for sid in student_ids:
            # ✅ student tenant 검증
            if not Student.objects.filter(id=sid, tenant=tenant).exists():
                raise ValidationError(
                    {"detail": f"학생(id={sid})은 현재 학원 소속이 아닙니다."}
                )

            obj, _ = Enrollment.objects.get_or_create(
                tenant=tenant,
                lecture=lecture,
                student_id=sid,
                defaults={"status": "ACTIVE"},
            )
            created.append(obj)

        return Response(
            EnrollmentSerializer(created, many=True).data,
            status=status.HTTP_201_CREATED,
        )

    @transaction.atomic
    def destroy(self, request, *args, **kwargs):
        enrollment = self.get_object()

        SessionEnrollment.objects.filter(
            tenant=enrollment.tenant,
            enrollment=enrollment,
        ).delete()

        enrollment.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)


class SessionEnrollmentViewSet(ModelViewSet):
    serializer_class = SessionEnrollmentSerializer

    filter_backends = [DjangoFilterBackend, SearchFilter]
    filterset_fields = ["session", "enrollment"]
    search_fields = ["enrollment__student__name"]

    def get_queryset(self):
        tenant = getattr(self.request, "tenant", None)
        return (
            SessionEnrollment.objects
            .filter(tenant=tenant)
            .select_related(
                "session",
                "enrollment",
                "enrollment__student",
            )
        )

    @transaction.atomic
    @action(detail=False, methods=["post"])
    def bulk_create(self, request):
        tenant = getattr(request, "tenant", None)

        session_id = request.data.get("session")
        enrollment_ids = request.data.get("enrollments", [])

        if not session_id or not isinstance(enrollment_ids, list):
            return Response(
                {"detail": "session, enrollments(list)는 필수입니다"},
                status=status.HTTP_400_BAD_REQUEST,
            )

        session = Session.objects.select_related("lecture").get(id=session_id)

        # ✅ session 소속 lecture tenant 검증
        if session.lecture.tenant_id != tenant.id:
            raise ValidationError({"detail": "다른 학원의 세션입니다."})

        created = []
        for eid in enrollment_ids:
            enrollment = Enrollment.objects.select_related("lecture").get(
                id=eid,
                tenant=tenant,
            )

            if enrollment.lecture_id != session.lecture_id:
                raise ValidationError(
                    {"detail": "다른 강의 수강자는 이 세션에 추가할 수 없습니다."}
                )

            obj, _ = SessionEnrollment.objects.get_or_create(
                tenant=tenant,
                session=session,
                enrollment=enrollment,
            )
            created.append(obj)

        return Response(
            SessionEnrollmentSerializer(created, many=True).data,
            status=status.HTTP_201_CREATED,
        )


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("lectures", "0001_initial"),
        ("students", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="Enrollment",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("ACTIVE", "활성"),
                            ("INACTIVE", "비활성"),
                            ("PENDING", "대기"),
                        ],
                        default="ACTIVE",
                        max_length=20,
                    ),
                ),
                ("enrolled_at", models.DateTimeField(auto_now_add=True)),
                (
                    "lecture",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="enrollments",
                        to="lectures.lecture",
                    ),
                ),
                (
                    "student",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="enrollments",
                        to="students.student",
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="SessionEnrollment",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "enrollment",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="session_enrollments",
                        to="enrollment.enrollment",
                    ),
                ),
                (
                    "session",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="session_enrollments",
                        to="lectures.session",
                    ),
                ),
            ],
        ),
        migrations.AddConstraint(
            model_name="enrollment",
            constraint=models.UniqueConstraint(
                fields=("student", "lecture"), name="unique_enrollment_per_lecture"
            ),
        ),
        migrations.AlterUniqueTogether(
            name="sessionenrollment",
            unique_together={("session", "enrollment")},
        ),
    ]


==========================================================================================
# FILE: migrations/0002_add_tenant.py
==========================================================================================
# PATH: apps/domains/enrollment/migrations/0002_add_tenant.py

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0001_initial"),
        ("enrollment", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="enrollment",
            name="tenant",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="enrollments",
                to="core.tenant",
            ),
        ),
        migrations.AddField(
            model_name="sessionenrollment",
            name="tenant",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="session_enrollments",
                to="core.tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0003_remove_enrollment_unique_enrollment_per_lecture_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 07:17

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0003_attendance_expense_add_tenant"),
        ("enrollment", "0002_add_tenant"),
        ("lectures", "0002_remove_session_exam"),
        ("students", "0002_add_tenant"),
    ]

    operations = [
        migrations.RemoveConstraint(
            model_name="enrollment",
            name="unique_enrollment_per_lecture",
        ),
        migrations.AlterUniqueTogether(
            name="sessionenrollment",
            unique_together={("tenant", "session", "enrollment")},
        ),
        migrations.AddConstraint(
            model_name="enrollment",
            constraint=models.UniqueConstraint(
                fields=("tenant", "student", "lecture"),
                name="unique_enrollment_per_tenant_lecture",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0004_alter_enrollment_tenant_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-12 12:00

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0014_alter_user_phone_and_more"),
        ("enrollment", "0003_remove_enrollment_unique_enrollment_per_lecture_and_more"),
        ("lectures", "0006_alter_lecture_lecture_time_and_more"),
        ("students", "0009_alter_student_parent_phone_alter_student_phone_and_more"),
    ]

    operations = [
        migrations.AlterField(
            model_name="enrollment",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="enrollments",
                to="core.tenant",
            ),
        ),
        migrations.AlterField(
            model_name="sessionenrollment",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="session_enrollments",
                to="core.tenant",
            ),
        ),
        migrations.AddIndex(
            model_name="enrollment",
            index=models.Index(
                fields=["tenant", "created_at"], name="enrollment__tenant__5d24f1_idx"
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================

