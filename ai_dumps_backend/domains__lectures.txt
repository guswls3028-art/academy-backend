====================================================================================================
# BACKEND APP: domains__lectures
# ROOT PATH: C:\academy\apps\domains\lectures
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
from django.contrib import admin
from .models import Lecture, Session


# --------------------------------------------------
# Lecture
# --------------------------------------------------

@admin.register(Lecture)
class LectureAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "title",
        "name",
        "subject",
        "start_date",
        "end_date",
        "is_active",
    )
    list_display_links = ("id", "title")
    list_filter = ("is_active", "subject")
    search_fields = ("title", "name", "subject")
    ordering = ("-id",)


# --------------------------------------------------
# Session
# --------------------------------------------------

@admin.register(Session)
class SessionAdmin(admin.ModelAdmin):
    """
    Session Admin (ì°¨ì‹œ ê´€ë¦¬)

    âš ï¸ ì¤‘ìš”:
    - Session.exam FKëŠ” ì œê±°ë¨
    - ì‹œí—˜ì€ Exam.sessions (ManyToMany)ë¡œë§Œ ì—°ê²°ë¨
    - adminì—ì„œëŠ” 'ì‹œí—˜ ê°œìˆ˜ / ìš”ì•½'ë§Œ ë…¸ì¶œ
    """

    list_display = (
        "id",
        "lecture",
        "order",
        "title",
        "date",
        "exam_count",     # âœ… ëŒ€ì²´ ì»¬ëŸ¼
    )
    list_display_links = ("id", "title")
    list_filter = ("lecture",)
    search_fields = ("title",)
    ordering = ("lecture", "order")

    # --------------------------------------------
    # âœ… ì—°ê²°ëœ ì‹œí—˜ ê°œìˆ˜ í‘œì‹œ
    # --------------------------------------------
    def exam_count(self, obj: Session) -> int:
        """
        ì´ ì°¨ì‹œì— ì—°ê²°ëœ ì‹œí—˜ ê°œìˆ˜
        (Exam.sessions M2M ê¸°ì¤€)
        """
        return obj.exams.count()

    exam_count.short_description = "ì‹œí—˜ ìˆ˜"


==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class LecturesConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"

    # ğŸ”¥ Django ë‚´ë¶€ ê²½ë¡œ
    name = "apps.domains.lectures"

    # ğŸ”¥ migration / FK / ì°¸ì¡°ìš© ì•± ë¼ë²¨ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
    label = "lectures"


==========================================================================================
# FILE: filters.py
==========================================================================================
# -*- coding: utf-8 -*-

import django_filters
from .models import Enrollment, Attendance


# --------------------------------------------------
# Utils
# --------------------------------------------------

def split_multi(value: str):
    """
    ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ (null-safe)
    """
    if not value:
        return []
    return [v.strip() for v in value.split(",") if v.strip()]


# ==================================================
# Enrollment Filter
# ==================================================

class EnrollmentFilter(django_filters.FilterSet):
    # ----- í…ìŠ¤íŠ¸ ê²€ìƒ‰ -----
    student_name = django_filters.CharFilter(method="filter_student_name")
    student_phone = django_filters.CharFilter(method="filter_student_phone")
    parent_phone = django_filters.CharFilter(method="filter_parent_phone")
    attendance_memo = django_filters.CharFilter(method="filter_attendance_memo")

    # ----- ë‹¤ì¤‘ ì„ íƒ -----
    tags = django_filters.CharFilter(method="filter_tags")  # AND ì¡°ê±´
    status = django_filters.CharFilter(method="filter_status")

    # ----- ìˆ«ì -----
    lecture = django_filters.NumberFilter(field_name="lecture_id")
    student = django_filters.NumberFilter(field_name="student_id")

    def filter_student_name(self, qs, name, value):
        return qs.filter(student__name__icontains=value)

    def filter_student_phone(self, qs, name, value):
        return qs.filter(student__phone__icontains=value)

    def filter_parent_phone(self, qs, name, value):
        return qs.filter(student__parent_phone__icontains=value)

    def filter_attendance_memo(self, qs, name, value):
        return qs.filter(attendances__memo__icontains=value)

    def filter_tags(self, qs, name, value):
        """
        tags=tag1,tag2 â†’ AND ì¡°ê±´
        í•™ìƒì€ ëª¨ë“  íƒœê·¸ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•¨
        """
        for tag in split_multi(value):
            qs = qs.filter(student__tags__name=tag)
        return qs.distinct()

    def filter_status(self, qs, name, value):
        return qs.filter(status__in=split_multi(value))

    class Meta:
        model = Enrollment
        fields = []


# ==================================================
# Attendance Filter
# ==================================================

class AttendanceFilter(django_filters.FilterSet):
    student_name = django_filters.CharFilter(method="filter_student_name")
    memo = django_filters.CharFilter(field_name="memo", lookup_expr="icontains")
    status = django_filters.CharFilter(method="filter_status")

    session = django_filters.NumberFilter(field_name="session_id")
    enrollment = django_filters.NumberFilter(field_name="enrollment_id")

    def filter_student_name(self, qs, name, value):
        return qs.filter(enrollment__student__name__icontains=value)

    def filter_status(self, qs, name, value):
        return qs.filter(status__in=split_multi(value))

    class Meta:
        model = Attendance
        fields = []


==========================================================================================
# FILE: models.py
==========================================================================================
# PATH: apps/domains/lectures/models.py

from django.db import models
from apps.api.common.models import TimestampModel


# ========================================================
# Lecture
# ========================================================

class Lecture(TimestampModel):
    """
    ê°•ì˜ (Course / Lecture)

    - ì—¬ëŸ¬ Session(ì°¨ì‹œ)ì„ ê°€ì§„ë‹¤
    - ì‹œí—˜ê³¼ ì§ì ‘ ì—°ê²°ë˜ì§€ ì•ŠëŠ”ë‹¤
      (ì‹œí—˜ì€ Session ë‹¨ìœ„ë¡œ ìš´ì˜ë¨)
    """

    title = models.CharField(max_length=255)
    name = models.CharField(max_length=255)
    subject = models.CharField(max_length=50)
    description = models.TextField(blank=True)

    start_date = models.DateField(null=True, blank=True)
    end_date = models.DateField(null=True, blank=True)

    is_active = models.BooleanField(default=True)

    def __str__(self):
        return self.title


# ========================================================
# Session
# ========================================================

class Session(TimestampModel):
    """
    ì°¨ì‹œ (Session)

    ğŸ”¥ í•µì‹¬ ì„¤ê³„ ê²°ì • (ì¤‘ìš”):

    âŒ Session.exam (ForeignKey) ì œê±°
    âœ… Exam.sessions (ManyToManyField) ë¥¼ ë‹¨ì¼ ì§„ì‹¤ë¡œ ì‚¬ìš©

    ì´ìœ :
    - Session : Exam = 1:N / N:M êµ¬ì¡° ê³µì‹ ì§€ì›
    - "ì°¨ì‹œì— ì‹œí—˜ì´ 1ê°œ"ë¼ëŠ” ì•”ë¬µì  ê°€ì • ì œê±°
    - ì„±ì /Progress/í†µê³„ ë¡œì§ì˜ ì•ˆì •ì„± í™•ë³´
    - Django reverse accessor ì¶©ëŒ(E302/E303) í•´ê²°

    ì—°ê²° ë°©ì‹:
    - Session â†’ Exam:
        session.exams.all()        (reverse M2M)
    - Exam â†’ Session:
        exam.sessions.all()        (ì •ë°©í–¥ M2M)

    âš ï¸ ì£¼ì˜:
    - "ì´ ì°¨ì‹œì— ì‹œí—˜ì´ ìˆì—ˆëŠ”ê°€?"
        â†’ SessionProgress.exam_attempted ë¡œ íŒë‹¨
    - "ì‹œí—˜ ê²°ê³¼ / í•©ë¶ˆ / ì ìˆ˜"
        â†’ Result + Progress ì§‘ê³„ ì±…ì„
    """

    lecture = models.ForeignKey(
        Lecture,
        on_delete=models.CASCADE,
        related_name="sessions",
    )

    # ì°¨ì‹œ ìˆœì„œ (1ì°¨ì‹œ, 2ì°¨ì‹œ ...)
    order = models.PositiveIntegerField()

    # ì°¨ì‹œ ì œëª©
    title = models.CharField(max_length=255)

    # ì°¨ì‹œ ë‚ ì§œ (ì„ íƒ)
    date = models.DateField(null=True, blank=True)

    class Meta:
        ordering = ["order"]

    def __str__(self):
        return f"{self.lecture.title} - {self.order}ì°¨ì‹œ"


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/domains/lectures/serializers.py

from rest_framework import serializers
from .models import Lecture, Session


# ========================================================
# Lecture
# ========================================================

class LectureSerializer(serializers.ModelSerializer):
    class Meta:
        model = Lecture
        fields = "__all__"
        ref_name = "Lecture"


# ========================================================
# Session
# ========================================================

class SessionSerializer(serializers.ModelSerializer):
    """
    âœ… í”„ë¡ íŠ¸ í‘œì¤€ ê³„ì•½:
    - exam: ì—°ê²°ëœ ì‹œí—˜ ID (nullable)
    - Session ìƒì„¸ì—ì„œ examIdëŠ” ì—¬ê¸°ì„œ ê°€ì ¸ì˜¨ë‹¤
    """
    class Meta:
        model = Session
        fields = "__all__"
        ref_name = "LectureSession"


==========================================================================================
# FILE: urls.py
==========================================================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter

from .views import (
    LectureViewSet,
    SessionViewSet,
)

router = DefaultRouter()

# =========================
# Core Lecture Domain
# =========================
router.register(r"lectures", LectureViewSet, basename="lectures")
router.register(r"sessions", SessionViewSet, basename="sessions")

urlpatterns = [
    path("", include(router.urls)),
]


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/domains/lectures/views.py

from rest_framework.viewsets import ModelViewSet
from rest_framework.filters import SearchFilter
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.response import Response

from .models import Lecture, Session
from .serializers import LectureSerializer, SessionSerializer


# ========================================================
# Lecture
# ========================================================

class LectureViewSet(ModelViewSet):
    queryset = Lecture.objects.all()
    serializer_class = LectureSerializer

    filter_backends = [DjangoFilterBackend, SearchFilter]
    filterset_fields = ["is_active", "subject"]
    search_fields = ["title", "name", "subject"]


# ========================================================
# Session
# ========================================================

class SessionViewSet(ModelViewSet):
    serializer_class = SessionSerializer

    filter_backends = [DjangoFilterBackend, SearchFilter]
    filterset_fields = ["lecture", "date"]
    search_fields = ["title"]

    def get_queryset(self):
        qs = Session.objects.all()

        lecture = self.request.query_params.get("lecture")
        if lecture:
            qs = qs.filter(lecture_id=lecture)

        date = self.request.query_params.get("date")
        if date:
            qs = qs.filter(date=date)

        # âœ… ì„ íƒ: exam_idë¡œë„ í•„í„° ê°€ëŠ¥
        exam = self.request.query_params.get("exam")
        if exam:
            qs = qs.filter(exam_id=exam)

        return qs.order_by("order", "id")

    def create(self, request, *args, **kwargs):
        lecture_id = request.data.get("lecture")
        title = request.data.get("title")
        date = request.data.get("date")

        # âœ… NEW: examì€ optional
        exam_id = request.data.get("exam")

        if not lecture_id:
            return Response({"detail": "lecture í•„ë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"}, status=400)
        if not title:
            return Response({"detail": "title í•„ë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤"}, status=400)

        last_session = (
            Session.objects.filter(lecture_id=lecture_id)
            .order_by("-order")
            .first()
        )
        next_order = last_session.order + 1 if last_session else 1

        data = {
            "lecture": lecture_id,
            "title": title,
            "date": date,
            "order": next_order,
            # âœ… ì‹œí—˜ ì—°ê²° (ì—†ìœ¼ë©´ None)
            "exam": exam_id if exam_id else None,
        }

        serializer = self.get_serializer(data=data)
        serializer.is_valid(raise_exception=True)
        self.perform_create(serializer)

        return Response(serializer.data, status=201)


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("exams", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="Lecture",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("title", models.CharField(max_length=255)),
                ("name", models.CharField(max_length=255)),
                ("subject", models.CharField(max_length=50)),
                ("description", models.TextField(blank=True)),
                ("start_date", models.DateField(blank=True, null=True)),
                ("end_date", models.DateField(blank=True, null=True)),
                ("is_active", models.BooleanField(default=True)),
            ],
            options={
                "abstract": False,
            },
        ),
        migrations.CreateModel(
            name="Session",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("order", models.PositiveIntegerField()),
                ("title", models.CharField(max_length=255)),
                ("date", models.DateField(blank=True, null=True)),
                (
                    "exam",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="sessions",
                        to="exams.exam",
                    ),
                ),
                (
                    "lecture",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="sessions",
                        to="lectures.lecture",
                    ),
                ),
            ],
            options={
                "ordering": ["order"],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_remove_session_exam.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-13 03:11

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("lectures", "0001_initial"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="session",
            name="exam",
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================

