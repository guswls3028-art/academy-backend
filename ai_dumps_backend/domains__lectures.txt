====================================================================================================
# BACKEND APP: domains__lectures
# ROOT PATH: C:\academy\apps\domains\lectures
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
# PATH: apps/domains/lectures/admin.py

from django.contrib import admin
from .models import Lecture, Session


@admin.register(Lecture)
class LectureAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "tenant",
        "title",
        "name",
        "subject",
        "start_date",
        "end_date",
        "is_active",
    )
    list_display_links = ("id", "title")
    list_filter = ("tenant", "is_active", "subject")
    search_fields = ("title", "name", "subject")
    ordering = ("-id",)


@admin.register(Session)
class SessionAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "lecture",
        "order",
        "title",
        "date",
        "exam_count",
    )
    list_display_links = ("id", "title")
    list_filter = ("lecture",)
    search_fields = ("title",)
    ordering = ("lecture", "order")

    def exam_count(self, obj):
        return obj.exams.count()

    exam_count.short_description = "ì‹œí—˜ ìˆ˜"


==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class LecturesConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"

    # ğŸ”¥ Django ë‚´ë¶€ ê²½ë¡œ
    name = "apps.domains.lectures"

    # ğŸ”¥ migration / FK / ì°¸ì¡°ìš© ì•± ë¼ë²¨ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)
    label = "lectures"


==========================================================================================
# FILE: filters.py
==========================================================================================
# -*- coding: utf-8 -*-

import django_filters
from .models import Enrollment, Attendance


# --------------------------------------------------
# Utils
# --------------------------------------------------

def split_multi(value: str):
    """
    ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜ (null-safe)
    """
    if not value:
        return []
    return [v.strip() for v in value.split(",") if v.strip()]


# ==================================================
# Enrollment Filter
# ==================================================

class EnrollmentFilter(django_filters.FilterSet):
    # ----- í…ìŠ¤íŠ¸ ê²€ìƒ‰ -----
    student_name = django_filters.CharFilter(method="filter_student_name")
    student_phone = django_filters.CharFilter(method="filter_student_phone")
    parent_phone = django_filters.CharFilter(method="filter_parent_phone")
    attendance_memo = django_filters.CharFilter(method="filter_attendance_memo")

    # ----- ë‹¤ì¤‘ ì„ íƒ -----
    tags = django_filters.CharFilter(method="filter_tags")  # AND ì¡°ê±´
    status = django_filters.CharFilter(method="filter_status")

    # ----- ìˆ«ì -----
    lecture = django_filters.NumberFilter(field_name="lecture_id")
    student = django_filters.NumberFilter(field_name="student_id")

    def filter_student_name(self, qs, name, value):
        return qs.filter(student__name__icontains=value)

    def filter_student_phone(self, qs, name, value):
        return qs.filter(student__phone__icontains=value)

    def filter_parent_phone(self, qs, name, value):
        return qs.filter(student__parent_phone__icontains=value)

    def filter_attendance_memo(self, qs, name, value):
        return qs.filter(attendances__memo__icontains=value)

    def filter_tags(self, qs, name, value):
        """
        tags=tag1,tag2 â†’ AND ì¡°ê±´
        í•™ìƒì€ ëª¨ë“  íƒœê·¸ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•¨
        """
        for tag in split_multi(value):
            qs = qs.filter(student__tags__name=tag)
        return qs.distinct()

    def filter_status(self, qs, name, value):
        return qs.filter(status__in=split_multi(value))

    class Meta:
        model = Enrollment
        fields = []


# ==================================================
# Attendance Filter
# ==================================================

class AttendanceFilter(django_filters.FilterSet):
    student_name = django_filters.CharFilter(method="filter_student_name")
    memo = django_filters.CharFilter(field_name="memo", lookup_expr="icontains")
    status = django_filters.CharFilter(method="filter_status")

    session = django_filters.NumberFilter(field_name="session_id")
    enrollment = django_filters.NumberFilter(field_name="enrollment_id")

    def filter_student_name(self, qs, name, value):
        return qs.filter(enrollment__student__name__icontains=value)

    def filter_status(self, qs, name, value):
        return qs.filter(status__in=split_multi(value))

    class Meta:
        model = Attendance
        fields = []


==========================================================================================
# FILE: models.py
==========================================================================================
# PATH: apps/domains/lectures/models.py

from django.db import models
from apps.api.common.models import TimestampModel
from apps.core.models import Tenant
from apps.core.db import TenantQuerySet  # âœ… ì¶”ê°€


class Lecture(TimestampModel):
    """
    ê°•ì˜ (Course / Lecture)

    - í•™ì›(Tenant) ë‹¨ìœ„ë¡œ ì™„ì „ ë¶„ë¦¬
    - ì—¬ëŸ¬ Session(ì°¨ì‹œ)ì„ ê°€ì§„ë‹¤
    """

    # ğŸ” tenant-safe manager
    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="lectures",
        db_index=True,  # âœ… tenant_id ì¸ë±ìŠ¤ ì¶”ê°€
    )

    title = models.CharField(max_length=255)
    name = models.CharField(max_length=255)
    subject = models.CharField(max_length=50)
    description = models.TextField(blank=True)

    start_date = models.DateField(null=True, blank=True)
    end_date = models.DateField(null=True, blank=True)

    lecture_time = models.CharField(max_length=100, blank=True, help_text="ê°•ì˜ ì‹œê°„ (ì˜ˆ: í†  12:00 ~ 13:00)")

    color = models.CharField(max_length=20, default="#3b82f6", help_text="ì•„ì´ì½˜/ë¼ë²¨ ìƒ‰ìƒ")

    is_active = models.BooleanField(default=True)

    class Meta:
        indexes = [
            models.Index(fields=["tenant", "created_at"]),  # âœ… ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€
        ]
        constraints = [
            models.UniqueConstraint(
                fields=["tenant", "title"],
                name="uniq_lecture_title_per_tenant",
            )
        ]

    def __str__(self):
        return self.title


class Session(TimestampModel):
    lecture = models.ForeignKey(
        Lecture,
        on_delete=models.CASCADE,
        related_name="sessions",
    )

    order = models.PositiveIntegerField()
    title = models.CharField(max_length=255)
    date = models.DateField(null=True, blank=True)

    class Meta:
        ordering = ["order"]

    def __str__(self):
        return f"{self.lecture.title} - {self.order}ì°¨ì‹œ"


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/domains/lectures/serializers.py

from rest_framework import serializers
from .models import Lecture, Session


class LectureSerializer(serializers.ModelSerializer):
    class Meta:
        model = Lecture
        fields = "__all__"
        read_only_fields = ["tenant"]
        ref_name = "Lecture"


class SessionSerializer(serializers.ModelSerializer):
    order = serializers.IntegerField(required=False, allow_null=True)

    class Meta:
        model = Session
        fields = "__all__"
        ref_name = "LectureSession"


==========================================================================================
# FILE: urls.py
==========================================================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter

from .views import (
    LectureViewSet,
    SessionViewSet,
)

router = DefaultRouter()

# =========================
# Core Lecture Domain
# =========================
router.register(r"lectures", LectureViewSet, basename="lectures")
router.register(r"sessions", SessionViewSet, basename="sessions")

urlpatterns = [
    path("", include(router.urls)),
]


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/domains/lectures/views.py

from django.db.models import Max, Count, Avg, Q
from django.db.models.functions import Coalesce

from rest_framework.viewsets import ModelViewSet
from rest_framework.filters import SearchFilter
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.exceptions import PermissionDenied, NotFound

from .models import Lecture, Session
from .serializers import LectureSerializer, SessionSerializer

from apps.domains.enrollment.models import Enrollment
from apps.domains.attendance.models import Attendance
from apps.support.video.models import Video


class LectureViewSet(ModelViewSet):
    serializer_class = LectureSerializer

    filter_backends = [DjangoFilterBackend, SearchFilter]
    filterset_fields = ["is_active", "subject"]
    search_fields = ["title", "name", "subject"]

    def get_queryset(self):
        """
        ğŸ” tenant ë‹¨ì¼ ì§„ì‹¤
        """
        return Lecture.objects.filter(tenant=self.request.tenant)

    def perform_create(self, serializer):
        """
        ğŸ” Lecture ìƒì„± ì‹œ tenant ê°•ì œ ì£¼ì…
        """
        serializer.save(tenant=self.request.tenant)

    @action(detail=True, methods=["get"], url_path="report")
    def report(self, request, pk=None):
        """
        ê°•ì˜ ë¦¬í¬íŠ¸ ì¡°íšŒ
        GET /api/v1/lectures/lectures/{id}/report/
        """
        lecture = self.get_object()
        tenant = request.tenant

        # ìˆ˜ê°•ìƒ ìˆ˜
        enrollments = Enrollment.objects.filter(
            tenant=tenant,
            lecture=lecture,
            status="ACTIVE"
        ).select_related("student")

        # ì„¸ì…˜ ìˆ˜
        sessions = Session.objects.filter(lecture=lecture)

        # ë¹„ë””ì˜¤ ìˆ˜
        videos = Video.objects.filter(
            session__lecture=lecture
        ).distinct()

        # ì¶œê²° í†µê³„
        attendances = Attendance.objects.filter(
            tenant=tenant,
            session__lecture=lecture,
            enrollment__in=enrollments
        ).select_related("session", "enrollment")

        attendance_by_status = {}
        # Attendance ëª¨ë¸ì˜ choices ì‚¬ìš©
        status_choices = [
            ("PRESENT", "ì¶œì„"),
            ("LATE", "ì§€ê°"),
            ("ONLINE", "ì˜¨ë¼ì¸"),
            ("SUPPLEMENT", "ë³´ê°•"),
            ("EARLY_LEAVE", "ì¡°í‡´"),
            ("ABSENT", "ê²°ì„"),
            ("RUNAWAY", "ì¶œíŠ€"),
            ("MATERIAL", "ìë£Œ"),
            ("INACTIVE", "ë¶€ì¬"),
            ("SECESSION", "íƒˆí‡´"),
        ]
        for status_code, _ in status_choices:
            count = attendances.filter(status=status_code).count()
            if count > 0:
                attendance_by_status[status_code] = count

        # í•™ìƒë³„ ë¦¬í¬íŠ¸ ë°ì´í„°
        students_data = []
        for enrollment in enrollments:
            student = enrollment.student

            # ë¹„ë””ì˜¤ ì§„í–‰ë¥  ê³„ì‚°
            student_videos = Video.objects.filter(
                session__lecture=lecture
            ).distinct()

            # TODO: ì‹¤ì œ ë¹„ë””ì˜¤ ì§„í–‰ë¥  ê³„ì‚° ë¡œì§ í•„ìš”
            # í˜„ì¬ëŠ” ê¸°ë³¸ê°’ ë°˜í™˜
            completed_videos = 0
            total_videos = student_videos.count()
            avg_progress = 0.0

            # ë§ˆì§€ë§‰ ì¶œê²° ìƒíƒœ
            last_attendance = attendances.filter(
                enrollment=enrollment
            ).order_by("-session__date", "-session__order").first()

            students_data.append({
                "enrollment": enrollment.id,
                "student_id": student.id,
                "student_name": student.name,
                "avg_progress": avg_progress,
                "completed_videos": completed_videos,
                "total_videos": total_videos,
                "last_attendance_status": last_attendance.status if last_attendance else None,
            })

        # ìš”ì•½ í†µê³„
        summary = {
            "total_students": enrollments.count(),
            "total_sessions": sessions.count(),
            "total_videos": videos.count(),
            "avg_video_progress": 0.0,  # TODO: ì‹¤ì œ í‰ê·  ì§„í–‰ë¥  ê³„ì‚°
            "completed_students": 0,  # TODO: ì™„ë£Œ í•™ìƒ ìˆ˜ ê³„ì‚°
        }

        return Response({
            "lecture": {
                "id": lecture.id,
                "title": lecture.title,
                "name": lecture.name,
                "subject": lecture.subject,
            },
            "summary": summary,
            "attendance_by_status": attendance_by_status,
            "students": students_data,
        })


class SessionViewSet(ModelViewSet):
    serializer_class = SessionSerializer

    filter_backends = [DjangoFilterBackend, SearchFilter]
    filterset_fields = ["lecture", "date"]
    search_fields = ["title"]

    def get_queryset(self):
        """
        Sessionì€ lectureë¥¼ í†µí•´ tenantê°€ ê²°ì •ë¨
        """
        qs = Session.objects.select_related("lecture")
        qs = qs.filter(lecture__tenant=self.request.tenant)

        lecture = self.request.query_params.get("lecture")
        if lecture:
            qs = qs.filter(lecture_id=lecture)

        date = self.request.query_params.get("date")
        if date:
            qs = qs.filter(date=date)

        return qs.order_by("order", "id")

    def perform_create(self, serializer):
        """
        ğŸ” Session ìƒì„± ì‹œ lecture.tenant ê²€ì¦
        order ë¯¸ì œê³µ ì‹œ í•´ë‹¹ ê°•ì˜ì˜ max(order)+1 ìë™ ì„¤ì •
        """
        lecture = serializer.validated_data["lecture"]
        if lecture.tenant_id != self.request.tenant.id:
            raise PermissionDenied("ë‹¤ë¥¸ í•™ì›ì˜ ê°•ì˜ì—ëŠ” ì„¸ì…˜ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

        order = serializer.validated_data.get("order")
        if order is None:
            agg = Session.objects.filter(lecture=lecture).aggregate(Max("order"))
            order = (agg["order__max"] or 0) + 1
        serializer.save(order=order)


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("exams", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="Lecture",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("title", models.CharField(max_length=255)),
                ("name", models.CharField(max_length=255)),
                ("subject", models.CharField(max_length=50)),
                ("description", models.TextField(blank=True)),
                ("start_date", models.DateField(blank=True, null=True)),
                ("end_date", models.DateField(blank=True, null=True)),
                ("is_active", models.BooleanField(default=True)),
            ],
            options={
                "abstract": False,
            },
        ),
        migrations.CreateModel(
            name="Session",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("order", models.PositiveIntegerField()),
                ("title", models.CharField(max_length=255)),
                ("date", models.DateField(blank=True, null=True)),
                (
                    "exam",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="sessions",
                        to="exams.exam",
                    ),
                ),
                (
                    "lecture",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="sessions",
                        to="lectures.lecture",
                    ),
                ),
            ],
            options={
                "ordering": ["order"],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_remove_session_exam.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-13 03:11

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("lectures", "0001_initial"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="session",
            name="exam",
        ),
    ]


==========================================================================================
# FILE: migrations/0003_add_tenant_to_lecture.py
==========================================================================================
# PATH: apps/domains/lectures/migrations/0003_add_tenant_to_lecture.py

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("lectures", "0002_remove_session_exam"),
        ("core", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="lecture",
            name="tenant",
            field=models.ForeignKey(
                to="core.tenant",
                on_delete=django.db.models.deletion.CASCADE,
                related_name="lectures",
                null=True,
            ),
        ),
        migrations.RunSQL(
            sql="UPDATE lectures_lecture SET tenant_id = 1 WHERE tenant_id IS NULL;",
            reverse_sql=migrations.RunSQL.noop,
        ),
        migrations.AlterField(
            model_name="lecture",
            name="tenant",
            field=models.ForeignKey(
                to="core.tenant",
                on_delete=django.db.models.deletion.CASCADE,
                related_name="lectures",
            ),
        ),
        migrations.AddConstraint(
            model_name="lecture",
            constraint=models.UniqueConstraint(
                fields=("tenant", "title"),
                name="uniq_lecture_title_per_tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0004_add_lecture_time.py
==========================================================================================
# Generated manually

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("lectures", "0003_add_tenant_to_lecture"),
    ]

    operations = [
        migrations.AddField(
            model_name="lecture",
            name="lecture_time",
            field=models.CharField(blank=True, help_text="ê°•ì˜ ì‹œê°„ (ì˜ˆ: ì›”ìˆ˜ê¸ˆ 14:00~16:00)", max_length=100),
        ),
    ]


==========================================================================================
# FILE: migrations/0005_add_lecture_color.py
==========================================================================================
# Generated manually

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("lectures", "0004_add_lecture_time"),
    ]

    operations = [
        migrations.AddField(
            model_name="lecture",
            name="color",
            field=models.CharField(default="#3b82f6", help_text="ì•„ì´ì½˜/ë¼ë²¨ ìƒ‰ìƒ", max_length=20),
        ),
    ]


==========================================================================================
# FILE: migrations/0006_alter_lecture_lecture_time_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-12 12:00

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0014_alter_user_phone_and_more"),
        ("lectures", "0005_add_lecture_color"),
    ]

    operations = [
        migrations.AlterField(
            model_name="lecture",
            name="lecture_time",
            field=models.CharField(
                blank=True, help_text="ê°•ì˜ ì‹œê°„ (ì˜ˆ: í†  12:00 ~ 13:00)", max_length=100
            ),
        ),
        migrations.AddIndex(
            model_name="lecture",
            index=models.Index(
                fields=["tenant", "created_at"], name="lectures_le_tenant__ca19dc_idx"
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================

