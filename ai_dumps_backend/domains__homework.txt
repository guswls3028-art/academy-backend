====================================================================================================
# BACKEND APP: domains__homework
# ROOT PATH: C:\academy\apps\domains\homework
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================
# PATH: apps/domains/homework/__init__.py
# homework domain package


==========================================================================================
# FILE: apps.py
==========================================================================================
# PATH: apps/domains/homework/apps.py
from django.apps import AppConfig


class HomeworkConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.homework"
    label = "homework"


==========================================================================================
# FILE: filters.py
==========================================================================================
import django_filters

# DESIGN:
# - /homework/scores/* ì—”ë“œí¬ì¸íŠ¸ëŠ” ìœ ì§€í•˜ë˜
# - Score ìŠ¤ëƒ…ìƒ·ì˜ ë‹¨ì¼ ì§„ì‹¤ì€ homework_results.HomeworkScore ì´ë‹¤.
from apps.domains.homework_results.models import HomeworkScore


class HomeworkScoreFilter(django_filters.FilterSet):
    enrollment_id = django_filters.NumberFilter(field_name="enrollment_id")
    session = django_filters.NumberFilter(field_name="session_id")
    lecture = django_filters.NumberFilter(field_name="session__lecture_id")
    is_locked = django_filters.BooleanFilter(field_name="is_locked")

    class Meta:
        model = HomeworkScore
        fields = ["enrollment_id", "session", "lecture", "is_locked"]


==========================================================================================
# FILE: models.py
==========================================================================================
"""
Homework Domain Models

âœ… ì„¤ê³„ ê³ ì •(ì¤‘ìš”)
- homework ë„ë©”ì¸ì€ "ì •ì˜/ì •ì±…" ë ˆì´ì–´ë‹¤.
- ëŸ°íƒ€ì„ ê²°ê³¼(ì ìˆ˜/ë½/ìŠ¤ëƒ…ìƒ·)ëŠ” homework_results ë„ë©”ì¸ ì†Œìœ .

âœ… homework ë„ë©”ì¸ì˜ ì±…ì„
- Session ë‹¨ìœ„ ê³¼ì œ íŒì • ì •ì±…(HomeworkPolicy)
  - ì»¤íŠ¸ë¼ì¸ (%)
  - ë°˜ì˜¬ë¦¼ ë‹¨ìœ„ (%)
  - í´ë¦¬ë‹‰ ì—°ë™ ì—¬ë¶€

âœ… MVP í™•ì • ìš”êµ¬ì‚¬í•­ (2026-01-21)
1) ì»¤íŠ¸ë¼ì¸ì€ % ê¸°ë°˜
2) ì ìˆ˜ ì…ë ¥ ë°©ì‹ì€ í•™ì›ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ:
   - percent ì§ì ‘ ì…ë ¥ (0~100)
   - raw ì ìˆ˜ ì…ë ¥ (ì˜ˆ: 18/20)
   â†’ percent ê³„ì‚°ì€ homework.utilsì—ì„œ ìˆ˜í–‰ ê°€ëŠ¥(ì •ì±… ê¸°ë°˜)

âš ï¸ ì¤‘ìš”:
- ìš´ì˜ ì ìˆ˜ ìŠ¤ëƒ…ìƒ·(HomeworkScore)ì€ homework_resultsë¡œ ì´ì „ë¨.
"""

from __future__ import annotations

from django.db import models

from apps.api.common.models import TimestampModel
from apps.domains.lectures.models import Session


class HomeworkPolicy(TimestampModel):
    """
    Session ë‹¨ìœ„ ê³¼ì œ íŒì • ì •ì±…

    âœ… ìš”êµ¬ì‚¬í•­
    - ì»¤íŠ¸ë¼ì¸ì€ % ê¸°ë°˜ (cutline_percent)
    - ì ìˆ˜ëŠ” score/max_score ê¸°ë°˜ìœ¼ë¡œ percent ê³„ì‚° í›„ cutline ë¹„êµ
    """

    session = models.OneToOneField(
        Session,
        on_delete=models.CASCADE,
        related_name="homework_policy",
    )

    # í†µê³¼ ì»¤íŠ¸ë¼ì¸ (%)
    cutline_percent = models.PositiveSmallIntegerField(default=80)

    # ë°˜ì˜¬ë¦¼ ë‹¨ìœ„(%) - ì˜ˆ: 5ë©´ 83% â†’ 85%ë¡œ ë°˜ì˜¬ë¦¼
    round_unit_percent = models.PositiveSmallIntegerField(default=5)

    # í´ë¦¬ë‹‰ ì—°ë™ ì—¬ë¶€
    clinic_enabled = models.BooleanField(default=True)

    # ê³¼ì œ ë¶ˆí•©ê²© ì‹œ í´ë¦¬ë‹‰ ëŒ€ìƒ ì—¬ë¶€
    clinic_on_fail = models.BooleanField(default=True)

    class Meta:
        ordering = ["-updated_at"]

    def __str__(self):
        return (
            f"HomeworkPolicy(session={self.session_id}, "
            f"cutline={self.cutline_percent}%, unit={self.round_unit_percent}%)"
        )


==========================================================================================
# FILE: serializers.py
==========================================================================================
"""
Homework Domain Serializers

âœ… ë©”ëª¨ (MVP)
- HomeworkPolicyëŠ” session ë‹¹ 1ê°œ ë³´ì¥
- cutline_percent(%) ëŠ” í”„ë¡ íŠ¸ Setupì—ì„œ ìˆ˜ì • ê°€ëŠ¥ (PATCH í—ˆìš©)
- ì ìˆ˜ ë°©ì‹ì€ í•™ì›ë§ˆë‹¤ ë‹¤ë¥´ë¯€ë¡œ score/max_score í˜•íƒœë¡œ ì €ì¥í•˜ê³ ,
  backendì—ì„œ percentë¡œ íŒì •í•´ì„œ passed/clinic_requiredë¥¼ ë‚´ë ¤ì¤€ë‹¤.

âš ï¸ Score ìŠ¤ëƒ…ìƒ·ì˜ ë‹¨ì¼ ì§„ì‹¤ì€ homework_results ë„ë©”ì¸ì´ë‹¤.
- ë‹¤ë§Œ /homework/scores/* ë¼ìš°íŒ…ì€ í˜¸í™˜ì„ ìœ„í•´ ì—¬ê¸°ì„œ ìœ ì§€í•œë‹¤.
"""

from rest_framework import serializers

from .models import HomeworkPolicy

# âœ… ë‹¨ì¼ ì§„ì‹¤: homework score snapshot
from apps.domains.homework_results.models import HomeworkScore


class HomeworkPolicySerializer(serializers.ModelSerializer):
    class Meta:
        model = HomeworkPolicy
        fields = [
            "id",
            "session",
            "cutline_percent",
            "round_unit_percent",
            "clinic_enabled",
            "clinic_on_fail",
            "updated_at",
            "created_at",
        ]
        read_only_fields = ["id", "session", "updated_at", "created_at"]


class HomeworkPolicyPatchSerializer(serializers.ModelSerializer):
    """
    âœ… PATCH ì „ìš©
    - ì»¤íŠ¸ë¼ì¸/ë°˜ì˜¬ë¦¼ë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ
    """

    class Meta:
        model = HomeworkPolicy
        fields = ["cutline_percent", "round_unit_percent"]


class HomeworkScoreSerializer(serializers.ModelSerializer):
    class Meta:
        model = HomeworkScore
        fields = [
            "id",
            "session",
            "enrollment_id",
            "score",
            "max_score",
            "passed",
            "clinic_required",
            "teacher_approved",
            "is_locked",
            "lock_reason",
            "updated_at",
            "created_at",
        ]
        read_only_fields = [
            "id",
            "session",
            "enrollment_id",
            "passed",
            "clinic_required",
            "is_locked",
            "lock_reason",
            "updated_at",
            "created_at",
        ]


class HomeworkQuickPatchSerializer(serializers.Serializer):
    """
    âœ… ì¡°êµ ì ìˆ˜ ì…ë ¥ Quick Patch

    ì§€ì› ì…ë ¥:
    - percent ì…ë ¥: score=85, max_score=100(ë˜ëŠ” ìƒëµ)
    - raw ì…ë ¥: score=18, max_score=20

    backend ë‹¨ì¼ ì§„ì‹¤:
    - passed = (percent >= cutline_percent)
    - clinic_required = clinic_enabled && clinic_on_fail && (not passed)
    """

    session_id = serializers.IntegerField()
    enrollment_id = serializers.IntegerField()

    score = serializers.FloatField()
    max_score = serializers.FloatField(required=False, allow_null=True)

    # UI í¸ì˜: scoreë§Œ ë³´ë‚´ë„ percentë¡œ ê°„ì£¼í•˜ê³  ì‹¶ìœ¼ë©´ max_score=100 ê¸°ë³¸
    # (í”„ë¡ íŠ¸ QuickScoreInputì´ % ì…ë ¥ì¼ í™•ë¥ ì´ ë†’ì•„ì„œ)


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/domains/homework/urls.py
"""
Homework URLs

âœ… ë¼ìš°íŒ…
- policies:
    - GET/PATCH /homework/policies/session/?session_id=123
- scores:
    - GET        /homework/scores/
    - PATCH      /homework/scores/{id}/
    - PATCH      /homework/scores/quick/   â† quick patch
"""

from django.urls import path, include
from rest_framework.routers import DefaultRouter

from apps.domains.homework.views import (
    HomeworkScoreViewSet,
    HomeworkPolicyViewSet,
)

router = DefaultRouter()
router.register("scores", HomeworkScoreViewSet, basename="homework-scores")
router.register("policies", HomeworkPolicyViewSet, basename="homework-policies")

urlpatterns = [
    path("", include(router.urls)),
]


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# PATH: apps/domains/homework/migrations/0001_initial.py
# Generated by Django 5.2.x on 2026-01-18
#
# âœ… ì„¤ê³„ ê³ ì •:
# - HomeworkScoreëŠ” "ìš´ì˜ ì…ë ¥ ìŠ¤ëƒ…ìƒ·"
# - ì œì¶œ/ì±„ì  ë¡œì§ì€ ë‹¤ë¥¸ ë„ë©”ì¸(submissions/results/progress) ì±…ì„

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("lectures", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="HomeworkScore",
            fields=[
                ("id", models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),

                ("enrollment_id", models.PositiveIntegerField(db_index=True)),

                ("score", models.FloatField(blank=True, null=True)),
                ("max_score", models.FloatField(blank=True, null=True)),
                ("teacher_approved", models.BooleanField(default=False)),
                ("passed", models.BooleanField(default=False)),

                ("is_locked", models.BooleanField(default=False)),
                (
                    "lock_reason",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("GRADING", "ì±„ì ì¤‘"),
                            ("PUBLISHED", "ê²Œì‹œë¨"),
                            ("MANUAL", "ìˆ˜ë™ì ê¸ˆ"),
                            ("OTHER", "ê¸°íƒ€"),
                        ],
                        max_length=30,
                        null=True,
                    ),
                ),

                ("updated_by_user_id", models.PositiveIntegerField(blank=True, null=True)),
                ("meta", models.JSONField(blank=True, null=True)),

                (
                    "session",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="homework_scores",
                        to="lectures.session",
                    ),
                ),
            ],
            options={
                "ordering": ["-updated_at", "-id"],
            },
        ),
        migrations.AddConstraint(
            model_name="homeworkscore",
            constraint=models.UniqueConstraint(
                fields=("enrollment_id", "session"),
                name="unique_homework_score_per_enrollment_session",
            ),
        ),
        migrations.AddIndex(
            model_name="homeworkscore",
            index=models.Index(fields=["enrollment_id", "updated_at"], name="homework_hw_enroll_upd_idx"),
        ),
        migrations.AddIndex(
            model_name="homeworkscore",
            index=models.Index(fields=["session", "updated_at"], name="homework_hw_session_upd_idx"),
        ),
    ]


==========================================================================================
# FILE: migrations/0002_rename_homework_hw_enroll_upd_idx_homework_ho_enrollm_86158c_idx_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-18 02:52

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("homework", "0001_initial"),
    ]

    operations = [
        migrations.RenameIndex(
            model_name="homeworkscore",
            new_name="homework_ho_enrollm_86158c_idx",
            old_name="homework_hw_enroll_upd_idx",
        ),
        migrations.RenameIndex(
            model_name="homeworkscore",
            new_name="homework_ho_session_c66d2e_idx",
            old_name="homework_hw_session_upd_idx",
        ),
    ]


==========================================================================================
# FILE: migrations/0003_homeworkpolicy.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-18 10:57

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        (
            "homework",
            "0002_rename_homework_hw_enroll_upd_idx_homework_ho_enrollm_86158c_idx_and_more",
        ),
        ("lectures", "0002_remove_session_exam"),
    ]

    operations = [
        migrations.CreateModel(
            name="HomeworkPolicy",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("cutline_percent", models.PositiveSmallIntegerField(default=80)),
                ("clinic_enabled", models.BooleanField(default=True)),
                ("clinic_on_fail", models.BooleanField(default=True)),
                (
                    "session",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="homework_policy",
                        to="lectures.session",
                    ),
                ),
            ],
            options={
                "ordering": ["-updated_at"],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0004_homeworkscore_add_clinic_required.py
==========================================================================================
# PATH: apps/domains/homework/migrations/0004_homeworkscore_add_clinic_required.py
"""
âœ… MVP PATCH
- HomeworkScoreì— clinic_required í•„ë“œ ì¶”ê°€
- Scores íƒ­ì—ì„œ í´ë¦¬ë‹‰ ì›ì¸ í‘œì‹œë¥¼ ìœ„í•´ í•„ìš”
"""

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("homework", "0003_homeworkpolicy"),
    ]

    operations = [
        migrations.AddField(
            model_name="homeworkscore",
            name="clinic_required",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="homeworkpolicy",
            name="round_unit_percent",
            field=models.PositiveSmallIntegerField(default=5),
        ),
    ]


==========================================================================================
# FILE: migrations/0005_move_homeworkscore_to_homework_results.py
==========================================================================================
# apps/domains/homework/migrations/0005_move_homeworkscore_to_homework_results.py
# Generated by Django 5.2.x on 2026-01-21
#
# IMPORTANT:
# - HomeworkScore ëª¨ë¸ ì†Œìœ ê¶Œì„ homework_resultsë¡œ ì´ì „í•œë‹¤.
# - DB í…Œì´ë¸”(homework_homeworkscore)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•œë‹¤ (DROP ê¸ˆì§€).
# - ë”°ë¼ì„œ stateì—ì„œë§Œ ëª¨ë¸ì„ ì œê±°í•˜ëŠ” NO-OP DB migrationì„ ìˆ˜í–‰í•œë‹¤.

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("homework", "0004_homeworkscore_add_clinic_required"),
        ("homework_results", "0001_initial"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[
                # âŒ DBì—ëŠ” ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ
            ],
            state_operations=[
                migrations.DeleteModel(
                    name="HomeworkScore",
                ),
            ],
        )
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: utils/__init__.py
==========================================================================================



==========================================================================================
# FILE: utils/homework_policy.py
==========================================================================================
# PATH: apps/domains/homework/utils/homework_policy.py
"""
Homework policy calculation utilities

âœ… ì±…ì„
- percent ê³„ì‚°
- ë°˜ì˜¬ë¦¼
- cutline ë¹„êµ

ğŸš« ì±…ì„ ì•„ë‹˜
- progress ì§ì ‘ ê°±ì‹ 
"""

from __future__ import annotations
from typing import Optional, Tuple

from apps.domains.lectures.models import Session
from apps.domains.homework.models import HomeworkPolicy


def _round_percent(percent: float, unit: int) -> int:
    unit = int(unit or 1)
    if unit <= 0:
        unit = 1
    return int(round(percent / unit) * unit)


def calc_homework_percent(
    *,
    score: Optional[float],
    max_score: Optional[float],
) -> Optional[int]:
    """
    score/max_score -> percent ê³„ì‚°

    ê·œì¹™:
    - scoreê°€ None -> None
    - max_scoreê°€ None -> scoreë¥¼ "percent ê°’"ìœ¼ë¡œ ê°„ì£¼ (0~100)
    - max_scoreê°€ 0 -> None
    - percent = score/max_score*100
    """
    if score is None:
        return None

    if max_score is None:
        # percent ì§ì ‘ ì…ë ¥ (ì˜ˆ: 85)
        try:
            p = float(score)
        except Exception:
            return None
        return int(round(p))

    if max_score == 0:
        return None

    try:
        raw = (float(score) / float(max_score)) * 100.0
    except Exception:
        return None

    return int(round(raw))


def calc_homework_passed_and_clinic(
    *,
    session: Session,
    score: Optional[float],
    max_score: Optional[float],
) -> Tuple[bool, bool, Optional[int]]:
    """
    Homework í•©ë¶ˆ + í´ë¦¬ë‹‰ ê³„ì‚° (HomeworkPolicy ë‹¨ì¼ ì§„ì‹¤)

    ë°˜í™˜:
    - passed: bool
    - clinic_required: bool
    - percent: Optional[int] (ë””ë²„ê¹…/í™•ì¥ìš©)
    """
    policy, _ = HomeworkPolicy.objects.get_or_create(
        session=session,
        defaults={
            "cutline_percent": 80,
            "round_unit_percent": 5,
            "clinic_enabled": True,
            "clinic_on_fail": True,
        },
    )

    percent = calc_homework_percent(score=score, max_score=max_score)
    if percent is None:
        return False, False, None

    rounded = _round_percent(percent, policy.round_unit_percent)
    passed = bool(rounded >= int(policy.cutline_percent or 0))

    clinic_required = bool(
        policy.clinic_enabled and policy.clinic_on_fail and (not passed)
    )

    return passed, clinic_required, rounded


==========================================================================================
# FILE: views/__init__.py
==========================================================================================
# PATH: apps/domains/homework/views/__init__.py

from .homework_score_viewset import HomeworkScoreViewSet
from .homework_policy_viewset import HomeworkPolicyViewSet

__all__ = [
    "HomeworkScoreViewSet",
    "HomeworkPolicyViewSet",
]


==========================================================================================
# FILE: views/homework_policy_viewset.py
==========================================================================================
# PATH: apps/domains/homework/views/homework_policy_viewset.py
"""
HomeworkPolicy ViewSet

âœ… MVP ëª©í‘œ
- session ë‹¹ HomeworkPolicy 1ê°œ ë‹¨ì¼ ì§„ì‹¤
- ì—†ìœ¼ë©´ ìë™ ìƒì„± (GET/PATCH ì‹œ ë³´ì¥)
- cutline_percent PATCH í—ˆìš©
- round_unit_percent PATCH í—ˆìš©

âš ï¸ ì›ë³¸ ì¡´ì¤‘
- ê¸°ì¡´ ë¼ìš°íŒ…/ê¶Œí•œ êµ¬ì¡°ëŠ” ìœ ì§€
- ë³€ê²½ì€ "ë‹¨ì¼ ì •ì±… ë³´ì¥" + "PATCH ì œí•œ"ë§Œ
"""

from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.homework.models import HomeworkPolicy
from apps.domains.homework.serializers import (
    HomeworkPolicySerializer,
    HomeworkPolicyPatchSerializer,
)


class HomeworkPolicyViewSet(viewsets.ViewSet):
    permission_classes = [IsAuthenticated]

    def _get_or_create_policy(self, session_id: int) -> HomeworkPolicy:
        # âœ… sessionë‹¹ 1ê°œ ë³´ì¥ (ì—†ìœ¼ë©´ ìƒì„±)
        obj, _ = HomeworkPolicy.objects.get_or_create(
            session_id=session_id,
            defaults={
                "cutline_percent": 80,
                "round_unit_percent": 5,
            },
        )
        return obj

    @action(detail=False, methods=["get"], url_path="session")
    def session_policy(self, request):
        """
        GET /homework/policies/session/?session_id=123

        âœ… ì—†ìœ¼ë©´ ìë™ ìƒì„±
        """
        session_id = request.query_params.get("session_id")
        if not session_id:
            return Response({"detail": "session_id required"}, status=400)

        policy = self._get_or_create_policy(int(session_id))
        return Response(HomeworkPolicySerializer(policy).data)

    @action(detail=False, methods=["patch"], url_path="session")
    def patch_session_policy(self, request):
        """
        PATCH /homework/policies/session/?session_id=123
        body:
        {
            "cutline_percent": 80,
            "round_unit_percent": 5
        }

        âœ… ì—†ìœ¼ë©´ ìë™ ìƒì„± í›„ patch ì ìš©
        """
        session_id = request.query_params.get("session_id")
        if not session_id:
            return Response({"detail": "session_id required"}, status=400)

        policy = self._get_or_create_policy(int(session_id))

        ser = HomeworkPolicyPatchSerializer(policy, data=request.data, partial=True)
        ser.is_valid(raise_exception=True)
        ser.save()

        return Response(HomeworkPolicySerializer(policy).data, status=status.HTTP_200_OK)


==========================================================================================
# FILE: views/homework_score_viewset.py
==========================================================================================
"""
HomeworkScore API (Admin / Teacher)

Endpoint:
- GET    /homework/scores/?enrollment_id=&session=&lecture=&is_locked=
- PATCH  /homework/scores/{id}/
- PATCH  /homework/scores/quick/

ì„¤ê³„ ê³„ì•½ (LOCKED):
- Homework í•©ë¶ˆ(passed)ì€ PATCH ì‹œì ì—ë§Œ ê³„ì‚°
- SessionScores APIëŠ” passed / clinic_required ê°’ì„ ê·¸ëŒ€ë¡œ ì‹ ë¢°

âœ… IMPORTANT (ë¦¬íŒ©í† ë§)
- HomeworkScore ìŠ¤ëƒ…ìƒ·ì˜ ë‹¨ì¼ ì§„ì‹¤ì€ homework_results ë„ë©”ì¸ì´ë‹¤.
- í•˜ì§€ë§Œ /homework/scores/* ë¼ìš°íŒ…ì€ í”„ë¡ íŠ¸ í˜¸í™˜ì„ ìœ„í•´ ìœ ì§€í•œë‹¤.
"""

from __future__ import annotations

from django.db import transaction
from django.db.models import QuerySet

from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status as drf_status
from rest_framework.decorators import action

from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

# âœ… ë‹¨ì¼ ì§„ì‹¤: homework_results
from apps.domains.homework_results.models import HomeworkScore

from apps.domains.homework.serializers import (
    HomeworkScoreSerializer,
    HomeworkQuickPatchSerializer,
)
from apps.domains.homework.filters import HomeworkScoreFilter

from apps.domains.results.permissions import IsTeacherOrAdmin

# submissions ê¸°ì¤€ ë³´ì • (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
from apps.domains.submissions.models import Submission

# progress pipeline ë‹¨ì¼ ì§„ì‹¤ (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
from apps.domains.progress.dispatcher import dispatch_progress_pipeline

# homework policy ê³„ì‚° ìœ í‹¸ (HomeworkPolicy ë‹¨ì¼ ì§„ì‹¤)
from apps.domains.homework.utils.homework_policy import (
    calc_homework_passed_and_clinic,
)


def _safe_user_id(request) -> int | None:
    return getattr(getattr(request, "user", None), "id", None)


def _maybe_fix_submission(
    submission: Submission,
    *,
    score_obj: HomeworkScore,
    teacher_approved: bool | None,
) -> None:
    """
    Submission êµ¬ì¡°ëŠ” í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
    "í•„ë“œê°€ ì¡´ì¬í•  ë•Œë§Œ" ë°©ì–´ì ìœ¼ë¡œ ë³´ì •í•œë‹¤.
    """
    # âœ… ì›ë³¸ êµ¬ì¡° ì¡´ì¤‘ + ë°©ì–´ì  ì²˜ë¦¬
    if hasattr(submission, "homework_submitted"):
        submission.homework_submitted = True

    if hasattr(submission, "homework_teacher_approved") and teacher_approved is not None:
        submission.homework_teacher_approved = bool(teacher_approved)

    if hasattr(submission, "meta"):
        meta = submission.meta if isinstance(submission.meta, dict) else {}
        meta = dict(meta)

        meta.setdefault("homework", {})
        if isinstance(meta["homework"], dict):
            meta["homework"].update(
                {
                    "homework_score_id": score_obj.id,
                    "score": score_obj.score,
                    "max_score": score_obj.max_score,
                    "passed": score_obj.passed,
                    "clinic_required": score_obj.clinic_required,
                    "teacher_approved": getattr(
                        submission, "homework_teacher_approved", None
                    ),
                }
            )

        submission.meta = meta

    # update_fields ë™ì  êµ¬ì„± (í•„ë“œ ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ)
    update_fields = ["updated_at"]
    for f in ["homework_submitted", "homework_teacher_approved", "meta"]:
        if hasattr(submission, f):
            update_fields.append(f)

    submission.save(update_fields=list(dict.fromkeys(update_fields)))


class HomeworkScoreViewSet(ModelViewSet):
    """
    HomeworkScore ê´€ë¦¬ ViewSet
    """

    queryset: QuerySet[HomeworkScore] = HomeworkScore.objects.select_related(
        "session",
        "session__lecture",
    ).all()

    serializer_class = HomeworkScoreSerializer
    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    filter_backends = [
        DjangoFilterBackend,
        SearchFilter,
        OrderingFilter,
    ]
    filterset_class = HomeworkScoreFilter

    search_fields = [
        "enrollment_id",
        "session__title",
        "session__lecture__title",
    ]

    ordering_fields = [
        "id",
        "created_at",
        "updated_at",
        "is_locked",
        "score",
        "passed",
    ]
    ordering = ["-updated_at", "-id"]

    # =================================================
    # PATCH /homework/scores/{id}/
    # =================================================
    def partial_update(self, request, *args, **kwargs):
        """
        PATCH /homework/scores/{id}/

        LOCK ê·œì¹™:
        - is_locked == true â†’ 409 CONFLICT

        ì„±ê³µ ì‹œ:
        1) HomeworkScore ê°±ì‹  + passed/clinic_required ê³„ì‚°
        2) (ê°€ëŠ¥í•˜ë©´) Submission ë³´ì •(meta í¬í•¨)
        3) progress pipeline íŠ¸ë¦¬ê±° (ì‹¤íŒ¨í•´ë„ APIëŠ” ì„±ê³µ ìœ ì§€)

        ë³´ê°•:
        - Submissionì´ ì—†ì–´ë„ 409ë¡œ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•ŠìŒ
          â†’ ìš´ì˜ ì…ë ¥ í—ˆìš© (Score ì €ì¥ OK)
          â†’ progress dispatchëŠ” skipped ì²˜ë¦¬
        """
        obj: HomeworkScore = self.get_object()

        # -------------------------------------------------
        # 0) LOCK ë°©ì–´
        # -------------------------------------------------
        if getattr(obj, "is_locked", False):
            return Response(
                {
                    "detail": "score block is locked",
                    "code": "LOCKED",
                    "lock_reason": getattr(obj, "lock_reason", None),
                },
                status=drf_status.HTTP_409_CONFLICT,
            )

        # -------------------------------------------------
        # 1) validate (partial)
        # -------------------------------------------------
        serializer = self.get_serializer(obj, data=request.data, partial=True)
        serializer.is_valid(raise_exception=True)
        incoming = dict(serializer.validated_data)

        next_score = incoming.get("score", obj.score)
        next_max = incoming.get("max_score", obj.max_score)

        # -------------------------------------------------
        # 2) passed/clinic ê³„ì‚° (HomeworkPolicy ë‹¨ì¼ ì§„ì‹¤)
        # -------------------------------------------------
        passed, clinic_required, _percent = calc_homework_passed_and_clinic(
            session=obj.session,
            score=next_score,
            max_score=next_max,
        )

        # teacher_approvedê°€ ë“¤ì–´ì˜¤ë©´ submissionì—ë„ ë°˜ì˜(ê°€ëŠ¥í•  ë•Œë§Œ)
        teacher_approved = incoming.get("teacher_approved", None)

        progress_info = {"dispatched": False, "reason": None}

        # -------------------------------------------------
        # 3) atomic: Score ì €ì¥ + (ê°€ëŠ¥í•˜ë©´) Submission ë³´ì •
        # -------------------------------------------------
        with transaction.atomic():
            serializer.save(
                passed=bool(passed),
                clinic_required=bool(clinic_required),
                updated_by_user_id=_safe_user_id(request),
            )

            # ìµœì‹  score instance
            score_obj: HomeworkScore = serializer.instance

            # submission ì¡°íšŒ (ìˆìœ¼ë©´ ë³´ì •)
            submission = (
                Submission.objects.filter(
                    enrollment_id=score_obj.enrollment_id,
                    session_id=score_obj.session_id,
                )
                .order_by("-id")
                .first()
            )

            if submission:
                _maybe_fix_submission(
                    submission,
                    score_obj=score_obj,
                    teacher_approved=teacher_approved
                    if teacher_approved is not None
                    else getattr(score_obj, "teacher_approved", None),
                )

                # progress pipelineì€ ì»¤ë°‹ ì´í›„ íŠ¸ë¦¬ê±° (DB ë°˜ì˜ ë³´ì¥)
                sub_id = int(submission.id)

                def _dispatch():
                    try:
                        dispatch_progress_pipeline(sub_id)
                    except Exception:
                        # MVP: ì‹¤íŒ¨í•´ë„ APIëŠ” ì„±ê³µ ìœ ì§€
                        pass

                transaction.on_commit(_dispatch)
                progress_info = {"dispatched": True, "reason": None}
            else:
                # submissionì´ ì—†ìœ¼ë©´ ìš´ì˜ ì…ë ¥ë§Œ ë°˜ì˜í•˜ê³  progressëŠ” ìŠ¤í‚µ
                progress_info = {"dispatched": False, "reason": "NO_SUBMISSION"}

        data = self.get_serializer(serializer.instance).data
        data["progress"] = progress_info  # âœ… í”„ë¡ íŠ¸ê°€ â€œì™œ ê°±ì‹  ì•ˆ ëëŠ”ì§€â€ ì•Œ ìˆ˜ ìˆê²Œ

        return Response(data, status=drf_status.HTTP_200_OK)

    # =================================================
    # PATCH /homework/scores/quick/
    # =================================================
    @action(detail=False, methods=["patch"], url_path="quick")
    def quick_patch(self, request):
        """
        Quick input (MVP, ìµœì¢…)

        âœ… LOCK ì¡´ì¤‘
        - is_locked == true â†’ 409

        âœ… ë ˆì´ìŠ¤ ë°©ì§€
        - (session_id, enrollment_id) í–‰ì„ select_for_updateë¡œ ì ê·¸ê³  íŒë‹¨

        ì…ë ¥ í˜•íƒœ:
        - % ì…ë ¥: score=85 (max_score ìƒëµ ê°€ëŠ¥ â†’ 100)
        - ë¬¸í•­ìˆ˜ ì…ë ¥: score=32, max_score=64

        NOTE:
        - quick patchëŠ” "ì¡°êµ ìƒì‚°ì„± ì…ë ¥"ì— ì§‘ì¤‘
        - submission ë³´ì • / progress íŠ¸ë¦¬ê±°ëŠ” partial_updateì—ì„œë§Œ ìˆ˜í–‰
          (scores íƒ­ì€ refetch/invalidateë¡œ ê°±ì‹ í•˜ë©´ ì¶©ë¶„)
        """
        serializer = HomeworkQuickPatchSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        session_id = serializer.validated_data["session_id"]
        enrollment_id = serializer.validated_data["enrollment_id"]
        score = serializer.validated_data["score"]
        max_score = serializer.validated_data.get("max_score") or 100

        with transaction.atomic():
            # ê¸°ì¡´ rowë¥¼ ì ê·¸ê³ (lock) í™•ì¸
            existing = (
                HomeworkScore.objects.select_for_update()
                .filter(session_id=session_id, enrollment_id=enrollment_id)
                .select_related("session")
                .first()
            )

            if existing and getattr(existing, "is_locked", False):
                return Response(
                    {
                        "detail": "score block is locked",
                        "code": "LOCKED",
                        "lock_reason": getattr(existing, "lock_reason", None),
                    },
                    status=drf_status.HTTP_409_CONFLICT,
                )

            if existing:
                # update
                existing.score = score
                existing.max_score = max_score
                # passed/clinic ê³„ì‚°
                passed, clinic_required, _percent = calc_homework_passed_and_clinic(
                    session=existing.session,
                    score=existing.score,
                    max_score=existing.max_score,
                )
                existing.passed = bool(passed)
                existing.clinic_required = bool(clinic_required)
                existing.updated_by_user_id = _safe_user_id(request)
                existing.save(
                    update_fields=[
                        "score",
                        "max_score",
                        "passed",
                        "clinic_required",
                        "updated_by_user_id",
                        "updated_at",
                    ]
                )
                obj = existing
            else:
                # create
                obj = HomeworkScore.objects.create(
                    session_id=session_id,
                    enrollment_id=enrollment_id,
                    score=score,
                    max_score=max_score,
                    updated_by_user_id=_safe_user_id(request),
                )
                obj = HomeworkScore.objects.select_related("session").get(id=obj.id)

                passed, clinic_required, _percent = calc_homework_passed_and_clinic(
                    session=obj.session,
                    score=obj.score,
                    max_score=obj.max_score,
                )
                HomeworkScore.objects.filter(id=obj.id).update(
                    passed=bool(passed),
                    clinic_required=bool(clinic_required),
                )
                obj.refresh_from_db()

        return Response(
            HomeworkScoreSerializer(obj).data,
            status=drf_status.HTTP_200_OK,
        )
