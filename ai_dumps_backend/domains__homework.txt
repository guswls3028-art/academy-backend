====================================================================================================
# BACKEND APP: domains__homework
# ROOT PATH: C:\academy\apps\domains\homework
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================
# PATH: apps/domains/homework/__init__.py
# Ïó≠Ìï†: homework ÎèÑÎ©îÏù∏ Ìå®ÌÇ§ÏßÄ Î£®Ìä∏ (Ï†ïÏ±Ö/Í≥ÑÏÇ∞ Î†àÏù¥Ïñ¥)

# homework domain package


==========================================================================================
# FILE: apps.py
==========================================================================================
# PATH: apps/domains/homework/apps.py
# Ïó≠Ìï†: homework ÎèÑÎ©îÏù∏ Ïï± ÏÑ§Ï†ï(AppConfig)

from django.apps import AppConfig


class HomeworkConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.homework"
    label = "homework"


==========================================================================================
# FILE: filters.py
==========================================================================================
# PATH: apps/domains/homework/filters.py
# Ïó≠Ìï†: /homework/scores/ ÌïÑÌÑ∞ ÏßÄÏõê (score Îã®Ïùº ÏßÑÏã§ÏùÄ homework_results)

import django_filters

# DESIGN:
# - /homework/scores/* ÏóîÎìúÌè¨Ïù∏Ìä∏Îäî Ïú†ÏßÄÌïòÎêò
# - Score Ïä§ÎÉÖÏÉ∑Ïùò Îã®Ïùº ÏßÑÏã§ÏùÄ homework_results.HomeworkScore Ïù¥Îã§.
from apps.domains.homework_results.models import HomeworkScore


class HomeworkScoreFilter(django_filters.FilterSet):
    enrollment_id = django_filters.NumberFilter(field_name="enrollment_id")
    session = django_filters.NumberFilter(field_name="session_id")
    lecture = django_filters.NumberFilter(field_name="session__lecture_id")
    is_locked = django_filters.BooleanFilter(field_name="is_locked")

    class Meta:
        model = HomeworkScore
        fields = ["enrollment_id", "session", "lecture", "is_locked"]


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/domains/homework/urls.py
# Ïó≠Ìï†: homework ÎùºÏö∞ÌåÖ (policy + score endpoints)

"""
Homework URLs

‚úÖ ÎùºÏö∞ÌåÖ
- policies:
    - GET   /homework/policies/?session=
    - PATCH /homework/policies/{id}/
- scores:
    - GET        /homework/scores/
    - PATCH      /homework/scores/{id}/
    - PATCH      /homework/scores/quick/   ‚Üê quick patch
"""

from django.urls import path, include
from rest_framework.routers import DefaultRouter
from apps.domains.homework.views.homework_assignment_view import HomeworkAssignmentManageView
from apps.domains.homework.views import (
    HomeworkScoreViewSet,
    HomeworkPolicyViewSet,
    HomeworkEnrollmentManageView,   # ‚úÖ Ï∂îÍ∞Ä
)


router = DefaultRouter()
router.register("scores", HomeworkScoreViewSet, basename="homework-scores")
router.register("policies", HomeworkPolicyViewSet, basename="homework-policies")


urlpatterns = [
    path("", include(router.urls)),
    path("enrollments/", HomeworkEnrollmentManageView.as_view()),
      path("assignments/", HomeworkAssignmentManageView.as_view()),  # ‚úÖ Ï∂îÍ∞Ä
]


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# PATH: apps/domains/homework/migrations/0001_initial.py
# Ïó≠Ìï†: HomeworkPolicy ÌÖåÏù¥Î∏î ÏÉùÏÑ± migration (policyÎßå Ïù¥ ÎèÑÎ©îÏù∏ ÏÜåÏú†)

# Generated by Django 5.2.9 on 2026-01-21 12:55

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("lectures", "0002_remove_session_exam"),
    ]

    operations = [
        migrations.CreateModel(
            name="HomeworkPolicy",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("cutline_percent", models.PositiveSmallIntegerField(default=80)),
                ("round_unit_percent", models.PositiveSmallIntegerField(default=5)),
                ("clinic_enabled", models.BooleanField(default=True)),
                ("clinic_on_fail", models.BooleanField(default=True)),
                (
                    "session",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="homework_policy",
                        to="lectures.session",
                    ),
                ),
            ],
            options={
                "ordering": ["-updated_at"],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_homeworkenrollment.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-24 02:23

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("homework", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="HomeworkEnrollment",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("session_id", models.IntegerField(db_index=True)),
                ("enrollment_id", models.IntegerField(db_index=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
            ],
            options={
                "db_table": "homework_enrollment",
                "constraints": [
                    models.UniqueConstraint(
                        fields=("session_id", "enrollment_id"),
                        name="uniq_homework_enrollment_session_enrollment",
                    )
                ],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0003_homework_assignment.py
==========================================================================================
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("homework", "0002_homeworkenrollment"),
        ("homework_results", "0002_homework_and_more"),
        ("lectures", "0002_remove_session_exam"),
    ]

    operations = [
        migrations.CreateModel(
            name="HomeworkAssignment",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("enrollment_id", models.IntegerField(db_index=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "homework",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="assignments",
                        to="homework_results.homework",
                    ),
                ),
                (
                    "session",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        to="lectures.session",
                        db_index=True,
                    ),
                ),
            ],
            options={
                "db_table": "homework_assignment",
            },
        ),
        migrations.AddConstraint(
            model_name="homeworkassignment",
            constraint=models.UniqueConstraint(
                fields=("homework", "enrollment_id"),
                name="uniq_homework_assignment_homework_enrollment",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0004_remove_homeworkassignment_uniq_homework_assignment_homework_enrollment_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 07:21

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0003_attendance_expense_add_tenant"),
        ("homework", "0003_homework_assignment"),
        (
            "homework_results",
            "0008_remove_homeworkscore_unique_homework_score_per_enrollment_session",
        ),
        ("lectures", "0002_remove_session_exam"),
    ]

    operations = [
        migrations.RemoveConstraint(
            model_name="homeworkassignment",
            name="uniq_homework_assignment_homework_enrollment",
        ),
        migrations.RemoveConstraint(
            model_name="homeworkenrollment",
            name="uniq_homework_enrollment_session_enrollment",
        ),
        migrations.AddField(
            model_name="homeworkassignment",
            name="tenant",
            field=models.ForeignKey(
                default=1,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="homework_assignments",
                to="core.tenant",
            ),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="homeworkenrollment",
            name="tenant",
            field=models.ForeignKey(
                default=1,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="homework_enrollments",
                to="core.tenant",
            ),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="homeworkpolicy",
            name="tenant",
            field=models.ForeignKey(
                default=1,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="homework_policies",
                to="core.tenant",
            ),
            preserve_default=False,
        ),
        migrations.AddConstraint(
            model_name="homeworkassignment",
            constraint=models.UniqueConstraint(
                fields=("tenant", "homework", "enrollment_id"),
                name="uniq_homework_assignment_per_tenant",
            ),
        ),
        migrations.AddConstraint(
            model_name="homeworkenrollment",
            constraint=models.UniqueConstraint(
                fields=("tenant", "session_id", "enrollment_id"),
                name="uniq_homework_enrollment_per_tenant",
            ),
        ),
        migrations.AddConstraint(
            model_name="homeworkpolicy",
            constraint=models.UniqueConstraint(
                fields=("tenant", "session"),
                name="uniq_homework_policy_per_tenant_session",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================
# PATH: apps/domains/homework/migrations/__init__.py
# Ïó≠Ìï†: migration Ìå®ÌÇ§ÏßÄ


==========================================================================================
# FILE: models/__init__.py
==========================================================================================
from .homework_enrollment import HomeworkEnrollment
from .homework_policy import HomeworkPolicy
from .homework_assignment import HomeworkAssignment

__all__ = [
    "HomeworkEnrollment",
    "HomeworkPolicy",
    "HomeworkAssignment",
]


==========================================================================================
# FILE: models/homework_assignment.py
==========================================================================================
# PATH: apps/domains/homework/models/homework_assignment.py

from __future__ import annotations

from django.db import models

from apps.domains.homework_results.models import Homework
from apps.domains.lectures.models import Session
from apps.core.models import Tenant


class HomeworkAssignment(models.Model):
    """
    HomeworkAssignment (Í≥ºÏ†úÎ≥Ñ ÎåÄÏÉÅÏûê)
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="homework_assignments",
    )

    homework = models.ForeignKey(
        Homework,
        on_delete=models.CASCADE,
        related_name="assignments",
    )

    session = models.ForeignKey(
        Session,
        on_delete=models.CASCADE,
        db_index=True,
    )

    enrollment_id = models.IntegerField(db_index=True)

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = "homework_assignment"
        constraints = [
            models.UniqueConstraint(
                fields=["tenant", "homework", "enrollment_id"],
                name="uniq_homework_assignment_per_tenant",
            )
        ]

    def __str__(self) -> str:
        return (
            f"HomeworkAssignment("
            f"tenant={self.tenant_id}, "
            f"homework={self.homework_id}, "
            f"enrollment={self.enrollment_id})"
        )


==========================================================================================
# FILE: models/homework_enrollment.py
==========================================================================================
# PATH: apps/domains/homework/models/homework_enrollment.py

from __future__ import annotations

from django.db import models
from apps.core.models import Tenant


class HomeworkEnrollment(models.Model):
    """
    Session Îã®ÏúÑ Í≥ºÏ†ú ÏùëÏãú Îì±Î°ù
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="homework_enrollments",
    )

    session_id = models.IntegerField(db_index=True)
    enrollment_id = models.IntegerField(db_index=True)

    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = "homework_enrollment"
        constraints = [
            models.UniqueConstraint(
                fields=["tenant", "session_id", "enrollment_id"],
                name="uniq_homework_enrollment_per_tenant",
            )
        ]

    def __str__(self) -> str:
        return (
            f"HomeworkEnrollment("
            f"tenant={self.tenant_id}, "
            f"session={self.session_id}, "
            f"enrollment={self.enrollment_id})"
        )


==========================================================================================
# FILE: models/homework_policy.py
==========================================================================================
# PATH: apps/domains/homework/models/homework_policy.py

from __future__ import annotations

from django.db import models

from apps.api.common.models import TimestampModel
from apps.domains.lectures.models import Session
from apps.core.models import Tenant


class HomeworkPolicy(TimestampModel):
    """
    Session Îã®ÏúÑ Í≥ºÏ†ú ÌåêÏ†ï Ï†ïÏ±Ö
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="homework_policies",
    )

    session = models.OneToOneField(
        Session,
        on_delete=models.CASCADE,
        related_name="homework_policy",
    )

    cutline_percent = models.PositiveSmallIntegerField(default=80)
    round_unit_percent = models.PositiveSmallIntegerField(default=5)

    clinic_enabled = models.BooleanField(default=True)
    clinic_on_fail = models.BooleanField(default=True)

    class Meta:
        ordering = ["-updated_at"]
        constraints = [
            models.UniqueConstraint(
                fields=["tenant", "session"],
                name="uniq_homework_policy_per_tenant_session",
            )
        ]

    def __str__(self):
        return (
            f"HomeworkPolicy("
            f"tenant={self.tenant_id}, "
            f"session={self.session_id})"
        )


==========================================================================================
# FILE: serializers/__init__.py
==========================================================================================
# PATH: apps/domains/homework/serializers/__init__.py

from .core import (
    HomeworkPolicySerializer,
    HomeworkPolicyPatchSerializer,
    HomeworkScoreSerializer,
    HomeworkQuickPatchSerializer,
)

from .homework_enrollment_serializer import (
    HomeworkEnrollmentRowSerializer,
    HomeworkEnrollmentUpdateSerializer,
)

__all__ = [
    "HomeworkPolicySerializer",
    "HomeworkPolicyPatchSerializer",
    "HomeworkScoreSerializer",
    "HomeworkQuickPatchSerializer",
    "HomeworkEnrollmentRowSerializer",
    "HomeworkEnrollmentUpdateSerializer",
]


==========================================================================================
# FILE: serializers/core.py
==========================================================================================
# PATH: apps/domains/homework/serializers/core.py
"""
Homework Domain Serializers (core)

‚úÖ Ìè¨Ìï®
- HomeworkPolicySerializer / PatchSerializer
- HomeworkScoreSerializer
- HomeworkQuickPatchSerializer

‚ö†Ô∏è Ï£ºÏùò
- Ï†êÏàò Ïä§ÎÉÖÏÉ∑ Îã®Ïùº ÏßÑÏã§ÏùÄ homework_results.HomeworkScore
- /homework/scores/* Îäî ÌîÑÎ°†Ìä∏ Ìò∏ÌôòÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
"""

from __future__ import annotations

from rest_framework import serializers

from apps.domains.homework.models import HomeworkPolicy
from apps.domains.homework_results.models import HomeworkScore


class HomeworkPolicySerializer(serializers.ModelSerializer):
    class Meta:
        model = HomeworkPolicy
        fields = [
            "id",
            "session",
            "cutline_percent",
            "round_unit_percent",
            "clinic_enabled",
            "clinic_on_fail",
            "updated_at",
            "created_at",
        ]
        read_only_fields = ["id", "session", "updated_at", "created_at"]


class HomeworkPolicyPatchSerializer(serializers.ModelSerializer):
    """
    ‚úÖ PATCH Ï†ÑÏö©
    - ÌîÑÎ°†Ìä∏ Í≥ÑÏïΩÏóê ÎßûÏ∂∞ ÏàòÏ†ï Í∞ÄÎä• ÌïÑÎìúÎßå ÌóàÏö©
    """

    class Meta:
        model = HomeworkPolicy
        fields = [
            "cutline_percent",
            "round_unit_percent",
            "clinic_enabled",
            "clinic_on_fail",
        ]


class HomeworkScoreSerializer(serializers.ModelSerializer):
    class Meta:
        model = HomeworkScore
        fields = [
            "id",
            "homework",
            "session",
            "enrollment_id",
            "score",
            "max_score",
            "passed",
            "clinic_required",
            "teacher_approved",
            "is_locked",
            "lock_reason",
            "updated_at",
            "created_at",
        ]
        read_only_fields = [
            "id",
            "homework",
            "session",
            "enrollment_id",
            "passed",
            "clinic_required",
            "is_locked",
            "lock_reason",
            "updated_at",
            "created_at",
        ]


class HomeworkQuickPatchSerializer(serializers.Serializer):
    """
    ‚úÖ Ï°∞Íµê Ï†êÏàò ÏûÖÎ†• Quick Patch (LOCKED SPEC)

    ÏßÄÏõê ÏûÖÎ†•:
    - percent ÏûÖÎ†•: score=85, max_score ÏÉùÎûµ (None)
    - raw ÏûÖÎ†•: score=18, max_score=20

    Ìï¥ÏÑù Í∑úÏπô (backend Îã®Ïùº ÏßÑÏã§):
    - max_score == None ‚Üí scoreÎ•º percent Í∞íÏúºÎ°ú Í∞ÑÏ£º
    - max_score != None ‚Üí score/max_score*100 ÏúºÎ°ú percent Í≥ÑÏÇ∞
    """

    homework_id = serializers.IntegerField()
    enrollment_id = serializers.IntegerField()

    score = serializers.FloatField()
    max_score = serializers.FloatField(required=False, allow_null=True)


==========================================================================================
# FILE: serializers/homework_assignment_serializer.py
==========================================================================================
from rest_framework import serializers


class HomeworkAssignmentRowSerializer(serializers.Serializer):
    enrollment_id = serializers.IntegerField()
    student_name = serializers.CharField(allow_blank=True)
    is_selected = serializers.BooleanField()


class HomeworkAssignmentUpdateSerializer(serializers.Serializer):
    enrollment_ids = serializers.ListField(
        child=serializers.IntegerField(),
        allow_empty=True,
        required=True,
    )


==========================================================================================
# FILE: serializers/homework_enrollment_serializer.py
==========================================================================================
# PATH: apps/domains/homework/serializers/homework_enrollment_serializer.py
from __future__ import annotations

from rest_framework import serializers


class HomeworkEnrollmentRowSerializer(serializers.Serializer):
    enrollment_id = serializers.IntegerField()
    student_name = serializers.CharField(allow_blank=True, required=False)
    is_selected = serializers.BooleanField()


class HomeworkEnrollmentUpdateSerializer(serializers.Serializer):
    enrollment_ids = serializers.ListField(
        child=serializers.IntegerField(),
        allow_empty=True,
        required=True,
    )


==========================================================================================
# FILE: utils/__init__.py
==========================================================================================
# PATH: apps/domains/homework/utils/__init__.py
# Ïó≠Ìï†: homework Ï†ïÏ±Ö Í≥ÑÏÇ∞ Ïú†Ìã∏ Ìå®ÌÇ§ÏßÄ


==========================================================================================
# FILE: utils/homework_policy.py
==========================================================================================
# PATH: apps/domains/homework/utils/homework_policy.py
# Ïó≠Ìï†: Ï†êÏàò ÏûÖÎ†•(%) ÎòêÎäî (raw/max) ‚Üí percent Í≥ÑÏÇ∞ ÌõÑ policy Í∏∞Î∞ò passed/clinic_required Í≤∞Ï†ï

"""
Homework policy calculation utilities

‚úÖ Ï±ÖÏûÑ
- percent Í≥ÑÏÇ∞
- Î∞òÏò¨Î¶º
- cutline ÎπÑÍµê
- clinic_required Í≥ÑÏÇ∞(Ï†ïÏ±Ö Í∏∞Î∞ò)

üö´ Ï±ÖÏûÑ ÏïÑÎãò
- progress ÏßÅÏ†ë Í∞±Ïã†
"""

from __future__ import annotations
from typing import Optional, Tuple

from apps.domains.lectures.models import Session
from apps.domains.homework.models import HomeworkPolicy


def _round_percent(percent: float, unit: int) -> int:
    unit = int(unit or 1)
    if unit <= 0:
        unit = 1
    return int(round(percent / unit) * unit)


def calc_homework_percent(
    *,
    score: Optional[float],
    max_score: Optional[float],
) -> Optional[int]:
    """
    score/max_score -> percent Í≥ÑÏÇ∞

    Í∑úÏπô:
    - scoreÍ∞Ä None -> None
    - max_scoreÍ∞Ä None -> scoreÎ•º "percent Í∞í"ÏúºÎ°ú Í∞ÑÏ£º (0~100)
    - max_scoreÍ∞Ä 0 -> None
    - percent = score/max_score*100
    """
    if score is None:
        return None

    if max_score is None:
        # percent ÏßÅÏ†ë ÏûÖÎ†• (Ïòà: 85)
        try:
            p = float(score)
        except Exception:
            return None
        return int(round(p))

    if max_score == 0:
        return None

    try:
        raw = (float(score) / float(max_score)) * 100.0
    except Exception:
        return None

    return int(round(raw))


def calc_homework_passed_and_clinic(
    *,
    session: Session,
    score: Optional[float],
    max_score: Optional[float],
) -> Tuple[bool, bool, Optional[int]]:
    """
    Homework Ìï©Î∂à + ÌÅ¥Î¶¨Îãâ Í≥ÑÏÇ∞ (HomeworkPolicy Îã®Ïùº ÏßÑÏã§)

    Î∞òÌôò:
    - passed: bool
    - clinic_required: bool
    - percent: Optional[int] (rounded percent)
    """
    policy, _ = HomeworkPolicy.objects.get_or_create(
        session=session,
        defaults={
            "cutline_percent": 80,
            "round_unit_percent": 5,
            "clinic_enabled": True,
            "clinic_on_fail": True,
        },
    )

    percent = calc_homework_percent(score=score, max_score=max_score)
    if percent is None:
        return False, False, None

    rounded = _round_percent(percent, policy.round_unit_percent)
    passed = bool(rounded >= int(policy.cutline_percent or 0))

    clinic_required = bool(
        policy.clinic_enabled and policy.clinic_on_fail and (not passed)
    )

    return passed, clinic_required, rounded


==========================================================================================
# FILE: views/__init__.py
==========================================================================================
# PATH: apps/domains/homework/views/__init__.py

from .homework_score_viewset import HomeworkScoreViewSet
from .homework_policy_viewset import HomeworkPolicyViewSet
from .homework_enrollment_view import HomeworkEnrollmentManageView

__all__ = [
    "HomeworkScoreViewSet",
    "HomeworkPolicyViewSet",
    "HomeworkEnrollmentManageView",
]


==========================================================================================
# FILE: views/homework_assignment_view.py
==========================================================================================
# PATH: apps/domains/homework/views/homework_assignment_view.py

from __future__ import annotations

from typing import List, Set

from django.db import transaction
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework import status

from apps.domains.enrollment.models import SessionEnrollment
from apps.domains.homework.models import HomeworkAssignment
from apps.domains.homework_results.models import Homework
from apps.domains.homework.serializers.homework_assignment_serializer import (
    HomeworkAssignmentRowSerializer,
    HomeworkAssignmentUpdateSerializer,
)


class HomeworkAssignmentManageView(APIView):
    permission_classes = [IsAuthenticated]

    def _get_homework(self, request) -> Homework:
        hid = request.query_params.get("homework_id")
        if not hid:
            raise ValueError("homework_id is required")

        tenant = getattr(request, "tenant", None)

        return Homework.objects.select_related(
            "session",
            "session__lecture",
        ).get(
            id=int(hid),
            session__lecture__tenant=tenant,  # ‚úÖ tenant ÏïàÏ†ÑÏû•Ïπò
        )

    def get(self, request):
        try:
            homework = self._get_homework(request)
        except Exception as e:
            return Response({"detail": str(e)}, status=400)

        tenant = getattr(request, "tenant", None)
        session_id = homework.session_id

        session_enrollments = (
            SessionEnrollment.objects
            .filter(
                tenant=tenant,
                session_id=session_id,
            )
            .select_related("enrollment", "enrollment__student")
            .order_by("id")
        )

        selected_ids: Set[int] = set(
            HomeworkAssignment.objects
            .filter(
                tenant=tenant,
                homework=homework,
            )
            .values_list("enrollment_id", flat=True)
        )

        items: List[dict] = []
        for se in session_enrollments:
            enrollment = se.enrollment
            student_name = (
                enrollment.student.name
                if enrollment and hasattr(enrollment, "student")
                else ""
            )

            items.append(
                {
                    "enrollment_id": se.enrollment_id,
                    "student_name": student_name,
                    "is_selected": se.enrollment_id in selected_ids,
                }
            )

        return Response(
            {
                "homework_id": homework.id,
                "session_id": session_id,
                "items": HomeworkAssignmentRowSerializer(items, many=True).data,
            }
        )

    @transaction.atomic
    def put(self, request):
        try:
            homework = self._get_homework(request)
        except Exception as e:
            return Response({"detail": str(e)}, status=400)

        tenant = getattr(request, "tenant", None)

        ser = HomeworkAssignmentUpdateSerializer(data=request.data)
        ser.is_valid(raise_exception=True)

        incoming_ids = set(map(int, ser.validated_data["enrollment_ids"]))

        valid_ids = set(
            SessionEnrollment.objects
            .filter(
                tenant=tenant,
                session_id=homework.session_id,
            )
            .values_list("enrollment_id", flat=True)
        )

        invalid = list(incoming_ids - valid_ids)
        if invalid:
            return Response(
                {
                    "detail": "ÏÑ∏ÏÖò Îì±Î°ù ÌïôÏÉùÏù¥ ÏïÑÎãå enrollment_id Ìè¨Ìï®",
                    "invalid_enrollment_ids": invalid,
                },
                status=status.HTTP_400_BAD_REQUEST,
            )

        HomeworkAssignment.objects.filter(
            tenant=tenant,
            homework=homework,
        ).delete()

        HomeworkAssignment.objects.bulk_create(
            [
                HomeworkAssignment(
                    tenant=tenant,
                    homework=homework,
                    session=homework.session,
                    enrollment_id=eid,
                )
                for eid in sorted(incoming_ids)
            ]
        )

        return Response(
            {
                "homework_id": homework.id,
                "selected_count": len(incoming_ids),
            },
            status=status.HTTP_200_OK,
        )


==========================================================================================
# FILE: views/homework_enrollment_view.py
==========================================================================================
# PATH: apps/domains/homework/views/homework_enrollment_view.py

from __future__ import annotations

from typing import List, Set

from django.db import transaction
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework import status

from apps.domains.enrollment.models import SessionEnrollment
from apps.domains.homework.models import HomeworkEnrollment
from apps.domains.homework.serializers.homework_enrollment_serializer import (
    HomeworkEnrollmentRowSerializer,
    HomeworkEnrollmentUpdateSerializer,
)


class HomeworkEnrollmentManageView(APIView):
    permission_classes = [IsAuthenticated]

    def _get_session_id_or_400(self, request) -> int:
        raw = request.query_params.get("session_id") or request.data.get("session_id")
        if not raw:
            raise ValueError("session_id is required")
        return int(raw)

    def get(self, request):
        try:
            session_id = self._get_session_id_or_400(request)
        except Exception as e:
            return Response({"detail": str(e)}, status=400)

        tenant = getattr(request, "tenant", None)

        session_enrollments = (
            SessionEnrollment.objects
            .filter(
                tenant=tenant,
                session_id=session_id,
            )
            .select_related("enrollment", "enrollment__student")
            .order_by("id")
        )

        selected_ids: Set[int] = set(
            HomeworkEnrollment.objects
            .filter(
                tenant=tenant,
                session_id=session_id,
            )
            .values_list("enrollment_id", flat=True)
        )

        items: List[dict] = []
        for se in session_enrollments:
            enrollment = se.enrollment
            student_name = (
                enrollment.student.name
                if enrollment and hasattr(enrollment, "student")
                else ""
            )

            items.append(
                {
                    "enrollment_id": se.enrollment_id,
                    "student_name": student_name,
                    "is_selected": se.enrollment_id in selected_ids,
                }
            )

        return Response(
            {
                "session_id": session_id,
                "items": HomeworkEnrollmentRowSerializer(items, many=True).data,
            }
        )

    @transaction.atomic
    def put(self, request):
        try:
            session_id = self._get_session_id_or_400(request)
        except Exception as e:
            return Response({"detail": str(e)}, status=400)

        tenant = getattr(request, "tenant", None)

        ser = HomeworkEnrollmentUpdateSerializer(data=request.data)
        ser.is_valid(raise_exception=True)

        incoming_ids = set(map(int, ser.validated_data["enrollment_ids"]))

        valid_ids = set(
            SessionEnrollment.objects
            .filter(
                tenant=tenant,
                session_id=session_id,
            )
            .values_list("enrollment_id", flat=True)
        )

        invalid = list(incoming_ids - valid_ids)
        if invalid:
            return Response(
                {
                    "detail": "ÏÑ∏ÏÖò Îì±Î°ù ÌïôÏÉùÏù¥ ÏïÑÎãå enrollment_id Ìè¨Ìï®",
                    "invalid_enrollment_ids": invalid,
                },
                status=status.HTTP_400_BAD_REQUEST,
            )

        HomeworkEnrollment.objects.filter(
            tenant=tenant,
            session_id=session_id,
        ).delete()

        HomeworkEnrollment.objects.bulk_create(
            [
                HomeworkEnrollment(
                    tenant=tenant,
                    session_id=session_id,
                    enrollment_id=eid,
                )
                for eid in sorted(incoming_ids)
            ]
        )

        return Response(
            {
                "session_id": session_id,
                "selected_count": len(incoming_ids),
            },
            status=status.HTTP_200_OK,
        )


==========================================================================================
# FILE: views/homework_policy_viewset.py
==========================================================================================
# PATH: apps/domains/homework/views/homework_policy_viewset.py

from rest_framework import viewsets, status
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.homework.models import HomeworkPolicy
from apps.domains.homework.serializers import (
    HomeworkPolicySerializer,
    HomeworkPolicyPatchSerializer,
)


class HomeworkPolicyViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]
    serializer_class = HomeworkPolicySerializer

    def get_queryset(self):
        tenant = getattr(self.request, "tenant", None)
        qs = HomeworkPolicy.objects.select_related("session").filter(tenant=tenant)

        session_id = self.request.query_params.get("session")
        if not session_id:
            return qs.none()

        obj, _ = HomeworkPolicy.objects.get_or_create(
            tenant=tenant,
            session_id=int(session_id),
            defaults={
                "cutline_percent": 80,
                "round_unit_percent": 5,
                "clinic_enabled": True,
                "clinic_on_fail": True,
            },
        )

        return qs.filter(id=obj.id)

    def partial_update(self, request, *args, **kwargs):
        obj = self.get_object()

        ser = HomeworkPolicyPatchSerializer(obj, data=request.data, partial=True)
        ser.is_valid(raise_exception=True)
        ser.save()

        return Response(
            HomeworkPolicySerializer(obj).data,
            status=status.HTTP_200_OK,
        )


==========================================================================================
# FILE: views/homework_score_viewset.py
==========================================================================================
# PATH: apps/domains/homework/views/homework_score_viewset.py
# Ïó≠Ìï†: HomeworkScore Ï°∞Ìöå/ÏàòÏ†ï + quick_patch(upsert)Î°ú Ï†êÏàòÏûÖÎ†•(% or raw/max) ÏßÄÏõê

"""
HomeworkScore API (Admin / Teacher)

Endpoint:
- GET    /homework/scores/?enrollment_id=&session=&lecture=&is_locked=
- PATCH  /homework/scores/{id}/
- PATCH  /homework/scores/quick/

ÏÑ§Í≥Ñ Í≥ÑÏïΩ (LOCKED):
- Homework Ìï©Î∂à(passed)ÏùÄ PATCH ÏãúÏ†êÏóêÎßå Í≥ÑÏÇ∞
- SessionScores APIÎäî passed / clinic_required Í∞íÏùÑ Í∑∏ÎåÄÎ°ú Ïã†Î¢∞

‚úÖ IMPORTANT (Î¶¨Ìå©ÌÜ†ÎßÅ)
- HomeworkScore Ïä§ÎÉÖÏÉ∑Ïùò Îã®Ïùº ÏßÑÏã§ÏùÄ homework_results ÎèÑÎ©îÏù∏Ïù¥Îã§.
- ÌïòÏßÄÎßå /homework/scores/* ÎùºÏö∞ÌåÖÏùÄ ÌîÑÎ°†Ìä∏ Ìò∏ÌôòÏùÑ ÏúÑÌï¥ Ïú†ÏßÄÌïúÎã§.

Quick Patch (MVP):
- homework_id + enrollment_id Í∏∞Î∞ò upsert
- score ÏûÖÎ†• Î∞©Ïãù 2Í∞ú ÏßÄÏõê:
  - percent ÏßÅÏ†ë ÏûÖÎ†•(score=85, max_score=None)
  - raw/max ÏûÖÎ†•(score=18, max_score=20)
"""

from __future__ import annotations

from django.db import transaction
from django.db.models import QuerySet

from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status as drf_status
from rest_framework.decorators import action

from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

# ‚úÖ Îã®Ïùº ÏßÑÏã§
from apps.domains.homework_results.models import HomeworkScore
from apps.domains.homework_results.models import Homework

from apps.domains.homework.serializers import (
    HomeworkScoreSerializer,
    HomeworkQuickPatchSerializer,
)
from apps.domains.homework.filters import HomeworkScoreFilter

from apps.domains.results.permissions import IsTeacherOrAdmin

# submissions Í∏∞Ï§Ä Î≥¥Ï†ï (Í∏∞Ï°¥ Íµ¨Ï°∞ Ïú†ÏßÄ)
from apps.domains.submissions.models import Submission

# progress pipeline Îã®Ïùº ÏßÑÏã§ (Í∏∞Ï°¥ Íµ¨Ï°∞ Ïú†ÏßÄ)
from apps.domains.progress.dispatcher import dispatch_progress_pipeline

# homework policy Í≥ÑÏÇ∞ Ïú†Ìã∏ (HomeworkPolicy Îã®Ïùº ÏßÑÏã§)
from apps.domains.homework.utils.homework_policy import (
    calc_homework_passed_and_clinic,
)


# =====================================================
# helpers
# =====================================================
def _safe_user_id(request) -> int | None:
    return getattr(getattr(request, "user", None), "id", None)


def _locked_response(obj: HomeworkScore) -> Response:
    return Response(
        {
            "detail": "score block is locked",
            "code": "LOCKED",
            "lock_reason": getattr(obj, "lock_reason", None),
        },
        status=drf_status.HTTP_409_CONFLICT,
    )


def _apply_score_and_policy(
    *,
    obj: HomeworkScore,
    score: float | None,
    max_score: float | None,
    request,
    save_fields: list[str],
) -> HomeworkScore:
    """
    HomeworkScoreÏóê Ï†êÏàò Î∞òÏòÅ + HomeworkPolicy Í≥ÑÏÇ∞
    (ÎèôÏûë Î≥ÄÍ≤Ω ÏóÜÏùå / Ï§ëÎ≥µ Ï†úÍ±∞Ïö©)
    """
    obj.score = score
    obj.max_score = max_score

    passed, clinic_required, _ = calc_homework_passed_and_clinic(
        session=obj.session,
        score=score,
        max_score=max_score,
    )

    obj.passed = bool(passed)
    obj.clinic_required = bool(clinic_required)
    obj.updated_by_user_id = _safe_user_id(request)

    obj.save(update_fields=save_fields + ["updated_at"])
    return obj


def _maybe_fix_submission(
    submission: Submission,
    *,
    score_obj: HomeworkScore,
    teacher_approved: bool | None,
) -> None:
    """
    Submission Íµ¨Ï°∞Îäî ÌîÑÎ°úÏ†ùÌä∏ÎßàÎã§ Îã§Î•º Ïàò ÏûàÏúºÎØÄÎ°ú
    "ÌïÑÎìúÍ∞Ä Ï°¥Ïû¨Ìï† ÎïåÎßå" Î∞©Ïñ¥Ï†ÅÏúºÎ°ú Î≥¥Ï†ïÌïúÎã§.
    """
    if hasattr(submission, "homework_submitted"):
        submission.homework_submitted = True

    if hasattr(submission, "homework_teacher_approved") and teacher_approved is not None:
        submission.homework_teacher_approved = bool(teacher_approved)

    if hasattr(submission, "meta"):
        meta = submission.meta if isinstance(submission.meta, dict) else {}
        meta = {**meta}

        homework_meta = meta.get("homework")
        if not isinstance(homework_meta, dict):
            homework_meta = {}

        homework_meta.update(
            {
                "homework_score_id": score_obj.id,
                "homework_id": score_obj.homework_id,
                "score": score_obj.score,
                "max_score": score_obj.max_score,
                "passed": score_obj.passed,
                "clinic_required": score_obj.clinic_required,
                "teacher_approved": getattr(
                    submission, "homework_teacher_approved", None
                ),
            }
        )

        meta["homework"] = homework_meta
        submission.meta = meta

    update_fields = ["updated_at"]
    for f in ["homework_submitted", "homework_teacher_approved", "meta"]:
        if hasattr(submission, f):
            update_fields.append(f)

    submission.save(update_fields=list(dict.fromkeys(update_fields)))


# =====================================================
# ViewSet
# =====================================================
class HomeworkScoreViewSet(ModelViewSet):
    """
    HomeworkScore Í¥ÄÎ¶¨ ViewSet
    """

    queryset: QuerySet[HomeworkScore] = HomeworkScore.objects.select_related(
        "session",
        "session__lecture",
        "homework",
    ).all()

    serializer_class = HomeworkScoreSerializer
    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    filter_backends = [
        DjangoFilterBackend,
        SearchFilter,
        OrderingFilter,
    ]
    filterset_class = HomeworkScoreFilter

    search_fields = [
        "enrollment_id",
        "session__title",
        "session__lecture__title",
        "homework__title",
    ]

    ordering_fields = [
        "id",
        "created_at",
        "updated_at",
        "is_locked",
        "score",
        "passed",
    ]
    ordering = ["-updated_at", "-id"]

    # =================================================
    # PATCH /homework/scores/{id}/
    # =================================================
    def partial_update(self, request, *args, **kwargs):
        obj: HomeworkScore = self.get_object()

        if getattr(obj, "is_locked", False):
            return _locked_response(obj)

        serializer = self.get_serializer(obj, data=request.data, partial=True)
        serializer.is_valid(raise_exception=True)

        vd = serializer.validated_data
        next_score = vd.get("score", obj.score)
        next_max = vd.get("max_score", obj.max_score)
        teacher_approved = vd.get("teacher_approved")

        progress_info = {"dispatched": False, "reason": None}

        with transaction.atomic():
            serializer.save(
                passed=obj.passed,
                clinic_required=obj.clinic_required,
                updated_by_user_id=_safe_user_id(request),
            )

            score_obj: HomeworkScore = serializer.instance

            score_obj = _apply_score_and_policy(
                obj=score_obj,
                score=next_score,
                max_score=next_max,
                request=request,
                save_fields=[
                    "score",
                    "max_score",
                    "passed",
                    "clinic_required",
                    "updated_by_user_id",
                ],
            )

            submission = (
                Submission.objects.filter(
                    enrollment_id=score_obj.enrollment_id,
                    session_id=score_obj.session_id,
                )
                .order_by("-id")
                .first()
            )

            if submission:
                _maybe_fix_submission(
                    submission,
                    score_obj=score_obj,
                    teacher_approved=teacher_approved,
                )

                sub_id = int(submission.id)

                def _dispatch():
                    try:
                        dispatch_progress_pipeline(sub_id)
                    except Exception:
                        pass

                transaction.on_commit(_dispatch)
                progress_info = {"dispatched": True, "reason": None}
            else:
                progress_info = {"dispatched": False, "reason": "NO_SUBMISSION"}

        data = self.get_serializer(score_obj).data
        data["progress"] = progress_info

        return Response(data, status=drf_status.HTTP_200_OK)

    # =================================================
    # PATCH /homework/scores/quick/
    # =================================================
    @action(detail=False, methods=["patch"], url_path="quick")
    def quick_patch(self, request):
        """
        Quick input (MVP)

        - % ÏûÖÎ†•: score=85, max_score ÏÉùÎûµ (percent ÏßÅÏ†ë ÏûÖÎ†•)
        - raw/max: score=32, max_score=64
        """
        serializer = HomeworkQuickPatchSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        homework_id = serializer.validated_data["homework_id"]
        enrollment_id = serializer.validated_data["enrollment_id"]
        score = serializer.validated_data["score"]
        max_score = serializer.validated_data.get("max_score")

        # ‚úÖ Îã®Ïùº ÏßÑÏã§: homework ‚Üí session
        homework = Homework.objects.select_related("session").get(id=homework_id)
        session = homework.session

        with transaction.atomic():
            obj = (
                HomeworkScore.objects.select_for_update()
                .filter(
                    homework_id=homework_id,
                    enrollment_id=enrollment_id,
                )
                .select_related("session", "homework")
                .first()
            )

            if obj and obj.is_locked:
                return _locked_response(obj)

            if not obj:
                obj = HomeworkScore.objects.create(
                    homework=homework,
                    session=session,
                    enrollment_id=enrollment_id,
                    score=None,
                    max_score=None,
                    updated_by_user_id=_safe_user_id(request),
                )

            obj = _apply_score_and_policy(
                obj=obj,
                score=score,
                max_score=max_score,
                request=request,
                save_fields=[
                    "score",
                    "max_score",
                    "passed",
                    "clinic_required",
                    "updated_by_user_id",
                ],
            )

        return Response(
            HomeworkScoreSerializer(obj).data,
            status=drf_status.HTTP_200_OK,
        )
