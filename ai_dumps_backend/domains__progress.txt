====================================================================================================
# BACKEND APP: domains__progress
# ROOT PATH: C:\academy\apps\domains\progress
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================
# apps/domains/progress/__init__.py


==========================================================================================
# FILE: admin.py
==========================================================================================
# apps/domains/progress/admin.py
from django.contrib import admin

from .models import (
    ProgressPolicy,
    SessionProgress,
    LectureProgress,
    ClinicLink,
    RiskLog,
)


@admin.register(ProgressPolicy)
class ProgressPolicyAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "lecture",
        "video_required_rate",
        "exam_start_session_order",
        "exam_end_session_order",
        "exam_pass_score",
        "homework_start_session_order",
        "homework_end_session_order",
        "homework_pass_type",
        "created_at",
    )
    list_filter = ("homework_pass_type",)
    search_fields = ("lecture__title", "lecture__name")
    ordering = ("-id",)


@admin.register(SessionProgress)
class SessionProgressAdmin(admin.ModelAdmin):
    """
    âœ… SessionProgress Admin (ì§‘ê³„ ê²°ê³¼ ì „ìš©)

    ì„¤ê³„ ì›ì¹™:
    - âŒ ì‹œí—˜ ì ìˆ˜(exam_score)ëŠ” ì—¬ê¸° ì±…ì„ì´ ì•„ë‹˜
      â†’ Result / SessionExamsSummary APIì—ì„œë§Œ ì¡°íšŒ
    - âœ… pass/fail ì—¬ë¶€ëŠ” 'ì§‘ê³„ ê²°ê³¼'ì´ë¯€ë¡œ ìœ ì§€
    - âœ… clinic ì—¬ë¶€ëŠ” ClinicLink ë„ë©”ì¸ì—ì„œ ë³„ë„ ê´€ë¦¬
    """

    list_display = (
        "id",
        "enrollment_id",
        "session",
        "attendance_type",
        "video_progress_rate",
        "video_completed",

        # âŒ REMOVED:
        # "exam_score",  # ì‹œí—˜ ì ìˆ˜ëŠ” Result ë„ë©”ì¸ ì±…ì„

        "exam_passed",
        "homework_submitted",
        "homework_passed",
        "completed",
        "calculated_at",
        "updated_at",
    )

    list_filter = (
        "attendance_type",
        "completed",
        "exam_passed",
        "homework_passed",
    )

    search_fields = (
        "enrollment_id",
        "session__title",
        "session__lecture__title",
    )

    ordering = ("-updated_at", "-id")


@admin.register(LectureProgress)
class LectureProgressAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "enrollment_id",
        "lecture",
        "total_sessions",
        "completed_sessions",
        "failed_sessions",
        "consecutive_failed_sessions",
        "risk_level",
        "last_session",
        "last_updated",
        "updated_at",
    )
    list_filter = ("risk_level", "lecture")
    search_fields = ("enrollment_id", "lecture__title", "lecture__name")
    ordering = ("-updated_at", "-id")


@admin.register(ClinicLink)
class ClinicLinkAdmin(admin.ModelAdmin):
    """
    âœ… ClinicLink = í´ë¦¬ë‹‰ íŠ¸ë¦¬ê±° ë‹¨ì¼ ì§„ì‹¤
    SessionProgressì—ì„œ ë¶„ë¦¬ëœ êµ¬ì¡° ìœ ì§€
    """
    list_display = (
        "id",
        "enrollment_id",
        "session",
        "reason",
        "is_auto",
        "approved",
        "created_at",
    )
    list_filter = ("reason", "is_auto", "approved")
    search_fields = ("enrollment_id", "session__title", "session__lecture__title")
    ordering = ("-created_at", "-id")


@admin.register(RiskLog)
class RiskLogAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "enrollment_id",
        "session",
        "risk_level",
        "rule",
        "created_at",
    )
    list_filter = ("risk_level", "rule")
    search_fields = ("enrollment_id",)
    ordering = ("-created_at", "-id")


==========================================================================================
# FILE: apps.py
==========================================================================================
# apps/domains/progress/apps.py
from django.apps import AppConfig


class ProgressConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.progress"
    label = "progress"


==========================================================================================
# FILE: dispatcher.py
==========================================================================================
# apps/domains/progress/dispatcher.py
from apps.domains.progress.tasks.progress_pipeline_task import (
    run_progress_pipeline_task,
)


def dispatch_progress_pipeline(submission_id: int) -> None:
    """
    Results â†’ Progress ì§„ì…ì 
    """
    run_progress_pipeline_task.delay(submission_id)


==========================================================================================
# FILE: filters.py
==========================================================================================
# apps/domains/progress/filters.py
import django_filters

from .models import SessionProgress, LectureProgress, ClinicLink, RiskLog, ProgressPolicy


class ProgressPolicyFilter(django_filters.FilterSet):
    lecture = django_filters.NumberFilter(field_name="lecture_id")

    class Meta:
        model = ProgressPolicy
        fields = ["lecture"]


class SessionProgressFilter(django_filters.FilterSet):
    enrollment_id = django_filters.NumberFilter(field_name="enrollment_id")
    session = django_filters.NumberFilter(field_name="session_id")
    lecture = django_filters.NumberFilter(field_name="session__lecture_id")
    completed = django_filters.BooleanFilter(field_name="completed")

    class Meta:
        model = SessionProgress
        fields = ["enrollment_id", "session", "lecture", "completed"]


class LectureProgressFilter(django_filters.FilterSet):
    enrollment_id = django_filters.NumberFilter(field_name="enrollment_id")
    lecture = django_filters.NumberFilter(field_name="lecture_id")
    risk_level = django_filters.CharFilter(field_name="risk_level")

    class Meta:
        model = LectureProgress
        fields = ["enrollment_id", "lecture", "risk_level"]


class ClinicLinkFilter(django_filters.FilterSet):
    enrollment_id = django_filters.NumberFilter(field_name="enrollment_id")
    session = django_filters.NumberFilter(field_name="session_id")
    lecture = django_filters.NumberFilter(field_name="session__lecture_id")
    reason = django_filters.CharFilter(field_name="reason")
    is_auto = django_filters.BooleanFilter(field_name="is_auto")
    approved = django_filters.BooleanFilter(field_name="approved")

    class Meta:
        model = ClinicLink
        fields = ["enrollment_id", "session", "lecture", "reason", "is_auto", "approved"]


class RiskLogFilter(django_filters.FilterSet):
    enrollment_id = django_filters.NumberFilter(field_name="enrollment_id")
    session = django_filters.NumberFilter(field_name="session_id")
    risk_level = django_filters.CharFilter(field_name="risk_level")
    rule = django_filters.CharFilter(field_name="rule")

    class Meta:
        model = RiskLog
        fields = ["enrollment_id", "session", "risk_level", "rule"]


==========================================================================================
# FILE: models.py
==========================================================================================
# apps/domains/progress/models.py
from __future__ import annotations

from django.db import models

from apps.api.common.models import TimestampModel
from apps.domains.lectures.models import Lecture, Session


class ProgressPolicy(TimestampModel):
    """
    ê°•ì˜ë³„ ì§„í–‰/í†µê³¼ ì •ì±… (ì»¤ìŠ¤í…€ ê°€ëŠ¥)

    âœ… 1:N ì‹œí—˜ êµ¬ì¡° ëŒ€ì‘ í¬ì¸íŠ¸
    - exam_aggregate_strategy: Sessionì— ì—¬ëŸ¬ Examì´ ìˆì„ ë•Œ Resultë¥¼ ì–´ë–»ê²Œ ì§‘ê³„í• ì§€
    - exam_pass_source:
        - POLICY: ProgressPolicy.exam_pass_score ì‚¬ìš©
        - EXAM: exams.Exam.pass_score ì‚¬ìš© (ì‹œí—˜ë³„ ì»¤íŠ¸ë¼ì¸)
    """

    class HomeworkPassType(models.TextChoices):
        SUBMIT = "SUBMIT", "ì œì¶œë§Œ"
        SCORE = "SCORE", "ì ìˆ˜"
        TEACHER_APPROVAL = "TEACHER_APPROVAL", "ê°•ì‚¬ìŠ¹ì¸"

    # âœ… PATCH: ì‹œí—˜ ì§‘ê³„ ì „ëµ
    class ExamAggregateStrategy(models.TextChoices):
        MAX = "MAX", "ìµœê³ ì "
        AVG = "AVG", "í‰ê· "
        LATEST = "LATEST", "ìµœê·¼ ì œì¶œ"

    # âœ… PATCH: pass ê¸°ì¤€ ì¶œì²˜
    class ExamPassSource(models.TextChoices):
        POLICY = "POLICY", "ì •ì±… ê¸°ì¤€"
        EXAM = "EXAM", "ì‹œí—˜ ê¸°ì¤€"

    lecture = models.OneToOneField(
        Lecture,
        on_delete=models.CASCADE,
        related_name="progress_policy",
    )

    # ---------- Video ----------
    video_required_rate = models.PositiveIntegerField(default=90)  # 0~100

    # ---------- Exam (n~m ì£¼ì°¨) ----------
    exam_start_session_order = models.PositiveIntegerField(default=2)
    exam_end_session_order = models.PositiveIntegerField(default=9999)

    # (ë ˆê±°ì‹œ/ì •ì±…í˜• ì»¤íŠ¸ë¼ì¸)
    exam_pass_score = models.FloatField(default=60.0)

    # âœ… PATCH: ë‹¤ì¤‘ ì‹œí—˜ ì§‘ê³„ ì •ì±…
    exam_aggregate_strategy = models.CharField(
        max_length=10,
        choices=ExamAggregateStrategy.choices,
        default=ExamAggregateStrategy.MAX,
        help_text="Sessionì— ì—¬ëŸ¬ ì‹œí—˜ì´ ìˆì„ ë•Œ Result ì§‘ê³„ ë°©ì‹",
    )

    exam_pass_source = models.CharField(
        max_length=10,
        choices=ExamPassSource.choices,
        default=ExamPassSource.EXAM,
        help_text="í•©ê²© ê¸°ì¤€ì„ ì •ì±…(POLICY)ìœ¼ë¡œ ë³¼ì§€, ì‹œí—˜(EXAM)ë§ˆë‹¤ ë³¼ì§€",
    )

    # ---------- Homework (n~m ì£¼ì°¨) ----------
    homework_start_session_order = models.PositiveIntegerField(default=2)
    homework_end_session_order = models.PositiveIntegerField(default=9999)
    homework_pass_type = models.CharField(
        max_length=30,
        choices=HomeworkPassType.choices,
        default=HomeworkPassType.TEACHER_APPROVAL,
    )

    class Meta:
        ordering = ["-id"]

    def __str__(self):
        return f"Policy(lecture={self.lecture_id})"


class SessionProgress(TimestampModel):
    """
    Enrollment x Session ë‹¨ìœ„ ì§„í–‰ ìŠ¤ëƒ…ìƒ·

    âœ… 1:N ì‹œí—˜ êµ¬ì¡° ì›ì¹™ ì¤€ìˆ˜:
    - SessionProgressëŠ” íŠ¹ì • Exam ì ìˆ˜ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ë°˜ë“œì‹œ Resultë“¤ì„ "ì§‘ê³„"í•œ ìµœì¢… íŒë‹¨ë§Œ ì €ì¥í•œë‹¤.

    ì¶”ê°€ í•„ë“œ:
    - exam_attempted: ì´ sessionì—ì„œ ì‹œí—˜ Resultê°€ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€
    - exam_aggregate_score: ì „ëµ(MAX/AVG/LATEST) ê¸°ë°˜ ì§‘ê³„ ì ìˆ˜
    - exam_passed: ì§‘ê³„/ì •ì±… ê¸°ë°˜ ìµœì¢… ì‹œí—˜ í†µê³¼ ì—¬ë¶€
    - exam_meta: ì§‘ê³„ ìƒì„¸(ì‹œí—˜ë³„ score/passed/ê¸°ì¤€ ë“±)
    """

    class AttendanceType(models.TextChoices):
        ONLINE = "online", "Online"
        OFFLINE = "offline", "Offline"

    enrollment_id = models.PositiveIntegerField(db_index=True)
    session = models.ForeignKey(
        Session,
        on_delete=models.CASCADE,
        related_name="progress_rows",
    )

    # ----- attendance / video -----
    attendance_type = models.CharField(
        max_length=10,
        choices=AttendanceType.choices,
        default=AttendanceType.ONLINE,
    )
    video_progress_rate = models.PositiveIntegerField(default=0)  # 0~100
    video_completed = models.BooleanField(default=False)

    # ======================================================
    # âœ… PATCH: Exam aggregate (1 Session : N Exams)
    # ======================================================
    exam_attempted = models.BooleanField(default=False)
    exam_aggregate_score = models.FloatField(null=True, blank=True)
    exam_passed = models.BooleanField(default=False)
    exam_meta = models.JSONField(null=True, blank=True)

    # ----- homework -----
    homework_submitted = models.BooleanField(default=False)
    homework_passed = models.BooleanField(default=False)

    # ----- final -----
    completed = models.BooleanField(default=False)
    completed_at = models.DateTimeField(null=True, blank=True)

    # ----- meta -----
    calculated_at = models.DateTimeField(null=True, blank=True)
    meta = models.JSONField(null=True, blank=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=["enrollment_id", "session"],
                name="unique_session_progress_per_enrollment",
            )
        ]
        ordering = ["-updated_at", "-id"]

    def __str__(self):
        return (
            f"SessionProgress(enroll={self.enrollment_id}, "
            f"session={self.session_id}, completed={self.completed})"
        )


class LectureProgress(TimestampModel):
    class RiskLevel(models.TextChoices):
        NORMAL = "NORMAL", "Normal"
        WARNING = "WARNING", "Warning"
        DANGER = "DANGER", "Danger"

    enrollment_id = models.PositiveIntegerField(unique=True, db_index=True)
    lecture = models.ForeignKey(
        Lecture,
        on_delete=models.CASCADE,
        related_name="lecture_progress_rows",
    )

    total_sessions = models.PositiveIntegerField(default=0)
    completed_sessions = models.PositiveIntegerField(default=0)
    failed_sessions = models.PositiveIntegerField(default=0)

    consecutive_failed_sessions = models.PositiveIntegerField(default=0)
    risk_level = models.CharField(
        max_length=10,
        choices=RiskLevel.choices,
        default=RiskLevel.NORMAL,
    )

    last_session = models.ForeignKey(
        Session,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="last_lecture_progress_rows",
    )
    last_updated = models.DateTimeField(null=True, blank=True)

    meta = models.JSONField(null=True, blank=True)

    class Meta:
        ordering = ["-updated_at", "-id"]

    def __str__(self):
        return f"LectureProgress(enroll={self.enrollment_id}, lecture={self.lecture_id}, risk={self.risk_level})"


class ClinicLink(TimestampModel):
    class Reason(models.TextChoices):
        AUTO_FAILED = "AUTO_FAILED", "ìë™(ì°¨ì‹œ ë¯¸í†µê³¼)"
        AUTO_RISK = "AUTO_RISK", "ìë™(ìœ„í—˜ ì•Œë¦¼)"
        MANUAL_REQUEST = "MANUAL_REQUEST", "ìˆ˜ë™(í•™ìƒ/í•™ë¶€ëª¨ ìš”ì²­)"
        TEACHER_RECOMMEND = "TEACHER_RECOMMEND", "ê°•ì‚¬ ì¶”ì²œ"

    enrollment_id = models.PositiveIntegerField(db_index=True)
    session = models.ForeignKey(
        Session,
        on_delete=models.CASCADE,
        related_name="clinic_links",
    )

    reason = models.CharField(max_length=30, choices=Reason.choices)
    is_auto = models.BooleanField(default=False)
    approved = models.BooleanField(default=False)

    memo = models.TextField(null=True, blank=True)
    meta = models.JSONField(null=True, blank=True)

    class Meta:
        indexes = [
            models.Index(fields=["enrollment_id", "created_at"]),
            models.Index(fields=["session", "created_at"]),
            models.Index(fields=["reason"]),
        ]
        ordering = ["-created_at", "-id"]

    def __str__(self):
        return f"ClinicLink(enroll={self.enrollment_id}, session={self.session_id}, reason={self.reason})"


class RiskLog(TimestampModel):
    class RiskLevel(models.TextChoices):
        WARNING = "WARNING", "Warning"
        DANGER = "DANGER", "Danger"

    class Rule(models.TextChoices):
        CONSECUTIVE_INCOMPLETE = "CONSECUTIVE_INCOMPLETE", "ì—°ì† ë¯¸ì™„ë£Œ"
        CONSECUTIVE_LOW_SCORE = "CONSECUTIVE_LOW_SCORE", "ì—°ì† ì €ì ìˆ˜"
        OTHER = "OTHER", "ê¸°íƒ€"

    enrollment_id = models.PositiveIntegerField(db_index=True)
    session = models.ForeignKey(
        Session,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="risk_logs",
    )

    risk_level = models.CharField(max_length=10, choices=RiskLevel.choices)
    rule = models.CharField(max_length=40, choices=Rule.choices)

    reason = models.TextField(null=True, blank=True)
    meta = models.JSONField(null=True, blank=True)

    class Meta:
        indexes = [
            models.Index(fields=["enrollment_id", "created_at"]),
            models.Index(fields=["risk_level", "created_at"]),
            models.Index(fields=["rule", "created_at"]),
        ]
        ordering = ["-created_at", "-id"]

    def __str__(self):
        return f"RiskLog(enroll={self.enrollment_id}, level={self.risk_level}, rule={self.rule})"


==========================================================================================
# FILE: serializers.py
==========================================================================================
# apps/domains/progress/serializers.py
from rest_framework import serializers

from .models import ProgressPolicy, SessionProgress, LectureProgress, ClinicLink, RiskLog


class ProgressPolicySerializer(serializers.ModelSerializer):
    class Meta:
        model = ProgressPolicy
        fields = "__all__"


class SessionProgressSerializer(serializers.ModelSerializer):
    class Meta:
        model = SessionProgress
        fields = "__all__"


class LectureProgressSerializer(serializers.ModelSerializer):
    class Meta:
        model = LectureProgress
        fields = "__all__"


class ClinicLinkSerializer(serializers.ModelSerializer):
    class Meta:
        model = ClinicLink
        fields = "__all__"


class RiskLogSerializer(serializers.ModelSerializer):
    class Meta:
        model = RiskLog
        fields = "__all__"


==========================================================================================
# FILE: urls.py
==========================================================================================
# apps/domains/progress/urls.py
from rest_framework.routers import DefaultRouter

from .views import (
    ProgressPolicyViewSet,
    SessionProgressViewSet,
    LectureProgressViewSet,
    ClinicLinkViewSet,
    RiskLogViewSet,
)

router = DefaultRouter()
router.register("policies", ProgressPolicyViewSet, basename="progress-policy")
router.register("session-progress", SessionProgressViewSet, basename="session-progress")
router.register("lecture-progress", LectureProgressViewSet, basename="lecture-progress")
router.register("clinic-links", ClinicLinkViewSet, basename="clinic-link")
router.register("risk-logs", RiskLogViewSet, basename="risk-log")

urlpatterns = router.urls


==========================================================================================
# FILE: views.py
==========================================================================================
# apps/domains/progress/views.py
from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated
from rest_framework.filters import SearchFilter, OrderingFilter
from django_filters.rest_framework import DjangoFilterBackend

from .models import ProgressPolicy, SessionProgress, LectureProgress, ClinicLink, RiskLog
from .serializers import (
    ProgressPolicySerializer,
    SessionProgressSerializer,
    LectureProgressSerializer,
    ClinicLinkSerializer,
    RiskLogSerializer,
)
from .filters import (
    ProgressPolicyFilter,
    SessionProgressFilter,
    LectureProgressFilter,
    ClinicLinkFilter,
    RiskLogFilter,
)


class ProgressPolicyViewSet(ModelViewSet):
    queryset = ProgressPolicy.objects.select_related("lecture").all()
    serializer_class = ProgressPolicySerializer
    permission_classes = [IsAuthenticated]

    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_class = ProgressPolicyFilter
    search_fields = ["lecture__title", "lecture__name"]
    ordering_fields = ["id", "created_at", "updated_at"]
    ordering = ["-id"]


class SessionProgressViewSet(ModelViewSet):
    queryset = SessionProgress.objects.select_related("session", "session__lecture").all()
    serializer_class = SessionProgressSerializer
    permission_classes = [IsAuthenticated]

    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_class = SessionProgressFilter
    search_fields = ["enrollment_id", "session__title", "session__lecture__title"]
    ordering_fields = ["id", "created_at", "updated_at", "calculated_at", "completed"]
    ordering = ["-updated_at", "-id"]


class LectureProgressViewSet(ModelViewSet):
    queryset = LectureProgress.objects.select_related("lecture", "last_session").all()
    serializer_class = LectureProgressSerializer
    permission_classes = [IsAuthenticated]

    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_class = LectureProgressFilter
    search_fields = ["enrollment_id", "lecture__title", "lecture__name"]
    ordering_fields = ["id", "created_at", "updated_at", "risk_level", "completed_sessions"]
    ordering = ["-updated_at", "-id"]


class ClinicLinkViewSet(ModelViewSet):
    queryset = ClinicLink.objects.select_related("session", "session__lecture").all()
    serializer_class = ClinicLinkSerializer
    permission_classes = [IsAuthenticated]

    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_class = ClinicLinkFilter
    search_fields = ["enrollment_id", "session__title", "session__lecture__title", "memo"]
    ordering_fields = ["id", "created_at", "updated_at", "approved", "is_auto"]
    ordering = ["-created_at", "-id"]


class RiskLogViewSet(ModelViewSet):
    queryset = RiskLog.objects.select_related("session").all()
    serializer_class = RiskLogSerializer
    permission_classes = [IsAuthenticated]

    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_class = RiskLogFilter
    search_fields = ["enrollment_id", "reason"]
    ordering_fields = ["id", "created_at", "updated_at", "risk_level", "rule"]
    ordering = ["-created_at", "-id"]


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("lectures", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="LectureProgress",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "enrollment_id",
                    models.PositiveIntegerField(db_index=True, unique=True),
                ),
                ("total_sessions", models.PositiveIntegerField(default=0)),
                ("completed_sessions", models.PositiveIntegerField(default=0)),
                ("failed_sessions", models.PositiveIntegerField(default=0)),
                ("consecutive_failed_sessions", models.PositiveIntegerField(default=0)),
                (
                    "risk_level",
                    models.CharField(
                        choices=[
                            ("NORMAL", "Normal"),
                            ("WARNING", "Warning"),
                            ("DANGER", "Danger"),
                        ],
                        default="NORMAL",
                        max_length=10,
                    ),
                ),
                ("last_updated", models.DateTimeField(blank=True, null=True)),
                ("meta", models.JSONField(blank=True, null=True)),
                (
                    "last_session",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="last_lecture_progress_rows",
                        to="lectures.session",
                    ),
                ),
                (
                    "lecture",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="lecture_progress_rows",
                        to="lectures.lecture",
                    ),
                ),
            ],
            options={
                "ordering": ["-updated_at", "-id"],
            },
        ),
        migrations.CreateModel(
            name="ProgressPolicy",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("video_required_rate", models.PositiveIntegerField(default=90)),
                ("exam_start_session_order", models.PositiveIntegerField(default=2)),
                ("exam_end_session_order", models.PositiveIntegerField(default=9999)),
                ("exam_pass_score", models.FloatField(default=60.0)),
                (
                    "homework_start_session_order",
                    models.PositiveIntegerField(default=2),
                ),
                (
                    "homework_end_session_order",
                    models.PositiveIntegerField(default=9999),
                ),
                (
                    "homework_pass_type",
                    models.CharField(
                        choices=[
                            ("SUBMIT", "ì œì¶œë§Œ"),
                            ("SCORE", "ì ìˆ˜"),
                            ("TEACHER_APPROVAL", "ê°•ì‚¬ìŠ¹ì¸"),
                        ],
                        default="TEACHER_APPROVAL",
                        max_length=30,
                    ),
                ),
                (
                    "lecture",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="progress_policy",
                        to="lectures.lecture",
                    ),
                ),
            ],
            options={
                "ordering": ["-id"],
            },
        ),
        migrations.CreateModel(
            name="ClinicLink",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("enrollment_id", models.PositiveIntegerField(db_index=True)),
                (
                    "reason",
                    models.CharField(
                        choices=[
                            ("AUTO_FAILED", "ìë™(ì°¨ì‹œ ë¯¸í†µê³¼)"),
                            ("AUTO_RISK", "ìë™(ìœ„í—˜ ì•Œë¦¼)"),
                            ("MANUAL_REQUEST", "ìˆ˜ë™(í•™ìƒ/í•™ë¶€ëª¨ ìš”ì²­)"),
                            ("TEACHER_RECOMMEND", "ê°•ì‚¬ ì¶”ì²œ"),
                        ],
                        max_length=30,
                    ),
                ),
                ("is_auto", models.BooleanField(default=False)),
                ("approved", models.BooleanField(default=False)),
                ("memo", models.TextField(blank=True, null=True)),
                ("meta", models.JSONField(blank=True, null=True)),
                (
                    "session",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="clinic_links",
                        to="lectures.session",
                    ),
                ),
            ],
            options={
                "ordering": ["-created_at", "-id"],
                "indexes": [
                    models.Index(
                        fields=["enrollment_id", "created_at"],
                        name="progress_cl_enrollm_ec562f_idx",
                    ),
                    models.Index(
                        fields=["session", "created_at"],
                        name="progress_cl_session_8934be_idx",
                    ),
                    models.Index(
                        fields=["reason"], name="progress_cl_reason_441a74_idx"
                    ),
                ],
            },
        ),
        migrations.CreateModel(
            name="RiskLog",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("enrollment_id", models.PositiveIntegerField(db_index=True)),
                (
                    "risk_level",
                    models.CharField(
                        choices=[("WARNING", "Warning"), ("DANGER", "Danger")],
                        max_length=10,
                    ),
                ),
                (
                    "rule",
                    models.CharField(
                        choices=[
                            ("CONSECUTIVE_INCOMPLETE", "ì—°ì† ë¯¸ì™„ë£Œ"),
                            ("CONSECUTIVE_LOW_SCORE", "ì—°ì† ì €ì ìˆ˜"),
                            ("OTHER", "ê¸°íƒ€"),
                        ],
                        max_length=40,
                    ),
                ),
                ("reason", models.TextField(blank=True, null=True)),
                ("meta", models.JSONField(blank=True, null=True)),
                (
                    "session",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="risk_logs",
                        to="lectures.session",
                    ),
                ),
            ],
            options={
                "ordering": ["-created_at", "-id"],
                "indexes": [
                    models.Index(
                        fields=["enrollment_id", "created_at"],
                        name="progress_ri_enrollm_768c23_idx",
                    ),
                    models.Index(
                        fields=["risk_level", "created_at"],
                        name="progress_ri_risk_le_e55884_idx",
                    ),
                    models.Index(
                        fields=["rule", "created_at"],
                        name="progress_ri_rule_249149_idx",
                    ),
                ],
            },
        ),
        migrations.CreateModel(
            name="SessionProgress",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("enrollment_id", models.PositiveIntegerField(db_index=True)),
                (
                    "attendance_type",
                    models.CharField(
                        choices=[("online", "Online"), ("offline", "Offline")],
                        default="online",
                        max_length=10,
                    ),
                ),
                ("video_progress_rate", models.PositiveIntegerField(default=0)),
                ("video_completed", models.BooleanField(default=False)),
                ("exam_score", models.FloatField(blank=True, null=True)),
                ("exam_passed", models.BooleanField(default=False)),
                ("homework_submitted", models.BooleanField(default=False)),
                ("homework_passed", models.BooleanField(default=False)),
                ("completed", models.BooleanField(default=False)),
                ("completed_at", models.DateTimeField(blank=True, null=True)),
                ("calculated_at", models.DateTimeField(blank=True, null=True)),
                ("meta", models.JSONField(blank=True, null=True)),
                (
                    "session",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="progress_rows",
                        to="lectures.session",
                    ),
                ),
            ],
            options={
                "ordering": ["-updated_at", "-id"],
                "constraints": [
                    models.UniqueConstraint(
                        fields=("enrollment_id", "session"),
                        name="unique_session_progress_per_enrollment",
                    )
                ],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_exam_aggregate_fields.py
==========================================================================================
# apps/domains/progress/migrations/0002_exam_aggregate_fields.py

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("progress", "0001_initial"),
    ]

    operations = [
        # =====================================================
        # âš ï¸ IMPORTANT (DEV DB PATCH)
        #
        # exam_* í•„ë“œë“¤ì€ ê³¼ê±° migration / ìˆ˜ë™ SQLë¡œ
        # ì´ë¯¸ DBì— ì¡´ì¬í•˜ëŠ” ìƒíƒœì´ë¯€ë¡œ
        # AddFieldë¥¼ ë‹¤ì‹œ ìˆ˜í–‰í•˜ë©´ DuplicateColumn ì˜¤ë¥˜ ë°œìƒ.
        #
        # ë”°ë¼ì„œ:
        # - DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ì€ ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ
        # - Django migration stateë§Œ ìµœì‹  ëª¨ë¸ê³¼ ì •ë ¬
        #
        # ì¦‰, "noop migration" ì—­í• 
        # =====================================================

        migrations.SeparateDatabaseAndState(
            database_operations=[
                # âŒ DBì—ëŠ” ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ
            ],
            state_operations=[
                # âœ… Django stateì—ë§Œ í•„ë“œ ì¡´ì¬ë¥¼ ëª…ì‹œ

                migrations.AddField(
                    model_name="sessionprogress",
                    name="exam_attempted",
                    field=models.BooleanField(default=False),
                ),
                migrations.AddField(
                    model_name="sessionprogress",
                    name="exam_passed",
                    field=models.BooleanField(default=False),
                ),
                migrations.AddField(
                    model_name="sessionprogress",
                    name="exam_aggregate_score",
                    field=models.FloatField(null=True, blank=True),
                ),
                migrations.AddField(
                    model_name="sessionprogress",
                    name="exam_meta",
                    field=models.JSONField(null=True, blank=True),
                ),
            ],
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: services/__init__.py
==========================================================================================
# apps/domains/progress/services/__init__.py


==========================================================================================
# FILE: services/clinic_exam_rule_service.py
==========================================================================================
from __future__ import annotations
from django.db.models import Count

from apps.domains.results.models import Result, ResultFact
from apps.domains.exams.models import Exam


class ClinicExamRuleService:
    """
    ì‹œí—˜/OMR/ì˜¤ë‹µ ê¸°ë°˜ í´ë¦¬ë‹‰ íŒë‹¨ (íŒë‹¨ë§Œ í•¨, ì €ì¥ âŒ)
    """

    LOW_CONF_THRESHOLD = 2

    @classmethod
    def evaluate(
        cls,
        *,
        enrollment_id: int,
        exam_id: int,
    ) -> dict:
        reasons: dict = {}

        # ----------------------
        # 1ï¸âƒ£ ì ìˆ˜ ë¯¸ë‹¬
        # ----------------------
        result = Result.objects.filter(
            enrollment_id=enrollment_id,
            target_type="exam",
            target_id=exam_id,
        ).first()

        exam = Exam.objects.filter(id=exam_id).first()
        pass_score = float(getattr(exam, "pass_score", 0) or 0)

        if result and result.total_score < pass_score:
            reasons["LOW_SCORE"] = {
                "score": result.total_score,
                "pass_score": pass_score,
            }

        # ----------------------
        # 2ï¸âƒ£ OMR ì‹ ë¢°ë„ ë‚®ìŒ
        # ----------------------
        low_conf = ResultFact.objects.filter(
            enrollment_id=enrollment_id,
            target_type="exam",
            target_id=exam_id,
            meta__grading__invalid_reason="LOW_CONFIDENCE",
        ).count()

        if low_conf >= cls.LOW_CONF_THRESHOLD:
            reasons["LOW_CONFIDENCE_OMR"] = {
                "count": low_conf,
                "threshold": cls.LOW_CONF_THRESHOLD,
            }

        # ----------------------
        # 3ï¸âƒ£ ë°˜ë³µ ì˜¤ë‹µ
        # ----------------------
        repeated = (
            ResultFact.objects
            .filter(
                enrollment_id=enrollment_id,
                target_type="exam",
                target_id=exam_id,
                is_correct=False,
            )
            .values("question_id")
            .annotate(cnt=Count("attempt_id", distinct=True))
            .filter(cnt__gte=2)
        )

        if repeated.exists():
            reasons["REPEATED_WRONG"] = {
                "question_ids": [r["question_id"] for r in repeated]
            }

        return reasons


==========================================================================================
# FILE: services/clinic_trigger_service.py
==========================================================================================
# apps/domains/progress/services/clinic_trigger_service.py
from __future__ import annotations

from apps.domains.progress.models import ClinicLink, SessionProgress

# ======================================================
# ğŸ”§ PATCH: ì‹œí—˜ ê¸°ë°˜ í´ë¦¬ë‹‰ ìœ„í—˜ë„ íŒë‹¨ ì„œë¹„ìŠ¤
# ======================================================
from apps.domains.progress.services.clinic_exam_rule_service import (
    ClinicExamRuleService,
)


class ClinicTriggerService:
    """
    í´ë¦¬ë‹‰ 'í•„ìš” ìƒíƒœ'ë¥¼ ìƒì„±í•˜ëŠ” íŠ¸ë¦¬ê±° ì„œë¹„ìŠ¤

    â— ì‹¤ì œ í´ë¦¬ë‹‰ ìˆ˜ì—…(Session)ì€ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤
    â— clinic ë„ë©”ì¸ê³¼ ì§ì ‘ ê²°í•©í•˜ì§€ ì•ŠëŠ”ë‹¤

    ì—­í• :
    - ì°¨ì‹œ(SessionProgress) ê¸°ì¤€ìœ¼ë¡œ
      "ì´ í•™ìƒì€ í´ë¦¬ë‹‰ ëŒ€ìƒì´ë‹¤" ë¼ëŠ” ì‚¬ì‹¤ë§Œ ê¸°ë¡
    """

    @staticmethod
    def auto_create_if_failed(session_progress: SessionProgress) -> None:
        """
        ì°¨ì‹œ ë¯¸ì™„ë£Œ ì‹œ ìë™ í´ë¦¬ë‹‰ ëŒ€ìƒì ìƒì„±
        (ìë™ íŠ¸ë¦¬ê±°)
        """
        if session_progress.completed:
            return

        ClinicLink.objects.get_or_create(
            enrollment_id=session_progress.enrollment_id,
            session=session_progress.session,
            reason=ClinicLink.Reason.AUTO_FAILED,
            defaults={
                "is_auto": True,
                "approved": False,
            },
        )

    @staticmethod
    def manual_create(
        *,
        enrollment_id: int,
        session_id: int,
        reason: str,
        memo: str | None = None,
    ) -> ClinicLink:
        """
        ê°•ì‚¬/ì¡°êµê°€ ìˆ˜ë™ìœ¼ë¡œ í´ë¦¬ë‹‰ ëŒ€ìƒì ì§€ì •
        (í•©ê²©ìë„ í¬í•¨ ê°€ëŠ¥)
        """
        return ClinicLink.objects.create(
            enrollment_id=enrollment_id,
            session_id=session_id,
            reason=reason,
            is_auto=False,
            memo=memo,
        )

    # ======================================================
    # ğŸ”§ PATCH: ì‹œí—˜ ê²°ê³¼ ê¸°ë°˜ í´ë¦¬ë‹‰ ìœ„í—˜ ìë™ íŠ¸ë¦¬ê±°
    # ======================================================
    @staticmethod
    def auto_create_if_exam_risk(
        *,
        enrollment_id: int,
        session,
        exam_id: int,
    ) -> None:
        """
        ì‹œí—˜ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í´ë¦¬ë‹‰ 'ìœ„í—˜ ìƒíƒœ' ìë™ ìƒì„±

        - ClinicExamRuleServiceë¥¼ í†µí•´ ìœ„í—˜ ì‚¬ìœ  í‰ê°€
        - ì‹¤ì œ ì ìˆ˜/í•©ë¶ˆ íŒë‹¨ ë¡œì§ì€ ì´ ì„œë¹„ìŠ¤ì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ
        - meta.exam_reasons ì— 'ì™œ ìœ„í—˜í•œì§€' ê·¼ê±°ë§Œ ê¸°ë¡

        â— ì‹œí—˜ í•©ë¶ˆ ì •ì±… ë³€ê²½ ì‹œ ì´ ë©”ì„œë“œëŠ” ìˆ˜ì • ëŒ€ìƒ ì•„ë‹˜
        """

        # ğŸ”¹ ì‹œí—˜ ìœ„í—˜ë„ í‰ê°€ (ë‹¨ì¼ ì§„ì‹¤)
        reasons = ClinicExamRuleService.evaluate(
            enrollment_id=enrollment_id,
            exam_id=exam_id,
        )

        if not reasons:
            return

        ClinicLink.objects.get_or_create(
            enrollment_id=enrollment_id,
            session=session,
            # ğŸ”¹ ê¸°ì¡´ Reason ì¬ì‚¬ìš© (ì¶”í›„ AUTO_RISK_EXAM í™•ì¥ ê°€ëŠ¥)
            reason=ClinicLink.Reason.AUTO_FAILED,
            defaults={
                "is_auto": True,
                "approved": False,
                "meta": {
                    "exam_reasons": reasons,
                },
            },
        )


==========================================================================================
# FILE: services/lecture_calculator.py
==========================================================================================
# apps/domains/progress/services/lecture_calculator.py
from __future__ import annotations

from django.utils import timezone

from apps.domains.progress.models import LectureProgress, SessionProgress
from apps.domains.lectures.models import Lecture


class LectureProgressCalculator:
    """
    ê°•ì˜ ë‹¨ìœ„ ì§‘ê³„ ê³„ì‚°ê¸°
    """

    @staticmethod
    def calculate(*, enrollment_id: int, lecture: Lecture) -> LectureProgress:
        sessions = lecture.sessions.all()
        total_sessions = sessions.count()

        progress_qs = SessionProgress.objects.filter(
            enrollment_id=enrollment_id,
            session__lecture=lecture,
        ).order_by("session__order")

        completed_sessions = progress_qs.filter(completed=True).count()
        failed_sessions = progress_qs.filter(completed=False).count()

        # ì—°ì† ë¯¸ì™„ë£Œ ê³„ì‚°
        consecutive_failed = 0
        for p in progress_qs.reverse():
            if p.completed:
                break
            consecutive_failed += 1

        obj, _ = LectureProgress.objects.get_or_create(
            enrollment_id=enrollment_id,
            lecture=lecture,
        )

        obj.total_sessions = total_sessions
        obj.completed_sessions = completed_sessions
        obj.failed_sessions = failed_sessions
        obj.consecutive_failed_sessions = consecutive_failed
        obj.last_session = progress_qs.last().session if progress_qs.exists() else None
        obj.last_updated = timezone.now()

        obj.save()
        return obj


==========================================================================================
# FILE: services/risk_evaluator.py
==========================================================================================
# apps/domains/progress/services/risk_evaluator.py
from __future__ import annotations

from apps.domains.progress.models import LectureProgress, RiskLog


class RiskEvaluator:
    """
    ìœ„í—˜ íŒë‹¨ ë¡œì§ (í‘œì¤€ SaaS ë£°)
    """

    @staticmethod
    def evaluate(lecture_progress: LectureProgress) -> None:
        enroll_id = lecture_progress.enrollment_id

        # -----------------------
        # ì—°ì† ë¯¸ì™„ë£Œ
        # -----------------------
        if lecture_progress.consecutive_failed_sessions >= 3:
            lecture_progress.risk_level = LectureProgress.RiskLevel.DANGER

            RiskLog.objects.create(
                enrollment_id=enroll_id,
                session=lecture_progress.last_session,
                risk_level=RiskLog.RiskLevel.DANGER,
                rule=RiskLog.Rule.CONSECUTIVE_INCOMPLETE,
                reason="ì—°ì† 3ì°¨ì‹œ ë¯¸ì™„ë£Œ",
            )

        elif lecture_progress.consecutive_failed_sessions >= 2:
            lecture_progress.risk_level = LectureProgress.RiskLevel.WARNING

            RiskLog.objects.create(
                enrollment_id=enroll_id,
                session=lecture_progress.last_session,
                risk_level=RiskLog.RiskLevel.WARNING,
                rule=RiskLog.Rule.CONSECUTIVE_INCOMPLETE,
                reason="ì—°ì† 2ì°¨ì‹œ ë¯¸ì™„ë£Œ",
            )

        else:
            lecture_progress.risk_level = LectureProgress.RiskLevel.NORMAL

        lecture_progress.save(update_fields=["risk_level", "updated_at"])


==========================================================================================
# FILE: services/session_calculator.py
==========================================================================================
# apps/domains/progress/services/session_calculator.py
from __future__ import annotations

from typing import Any, Dict, List, Optional, Tuple

from django.utils import timezone

from apps.domains.progress.models import SessionProgress, ProgressPolicy
from apps.domains.lectures.models import Session

from apps.domains.results.models import Result
from apps.domains.exams.models import Exam


class SessionProgressCalculator:
    """
    ì°¨ì‹œ(Session) ë‹¨ìœ„ ì§„í–‰ ê³„ì‚°ê¸°

    âœ… 1:N ì‹œí—˜ êµ¬ì¡° ì›ì¹™ ì¤€ìˆ˜:
    - submission.exam_score ê°™ì€ ë‹¨ì¼ í•„ë“œì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤.
    - ë°˜ë“œì‹œ Result í…Œì´ë¸”ì—ì„œ:
        enrollment_id + (sessionì— ì—°ê²°ëœ ëª¨ë“  exam_id)
      ë¥¼ ì¡°íšŒí•´ ì§‘ê³„í•œë‹¤.
    """

    # -----------------------------
    # Policy (lazy create)
    # -----------------------------
    @staticmethod
    def _get_or_create_policy(session: Session) -> ProgressPolicy:
        policy, _ = ProgressPolicy.objects.get_or_create(
            lecture=session.lecture,
            defaults={
                "video_required_rate": 90,
                "exam_start_session_order": 2,
                "exam_end_session_order": 9999,
                "exam_pass_score": 60.0,
                "exam_aggregate_strategy": ProgressPolicy.ExamAggregateStrategy.MAX,
                "exam_pass_source": ProgressPolicy.ExamPassSource.EXAM,
                "homework_start_session_order": 2,
                "homework_end_session_order": 9999,
                "homework_pass_type": ProgressPolicy.HomeworkPassType.TEACHER_APPROVAL,
            },
        )
        return policy

    # -----------------------------
    # Session â†” Exam(s) resolver
    # -----------------------------
    @staticmethod
    def _has_relation(model, name: str) -> bool:
        try:
            return any(getattr(f, "name", None) == name for f in model._meta.get_fields())
        except Exception:
            return False

    @classmethod
    def _get_exam_ids_for_session(cls, session: Session) -> List[int]:
        """
        í”„ë¡œì íŠ¸ë§ˆë‹¤ Sessionâ†”Exam ê´€ê³„ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°©ì–´ì ìœ¼ë¡œ exam_id ëª©ë¡ì„ êµ¬í•œë‹¤.

        ì§€ì› ì¼€ì´ìŠ¤:
        - Session.exam_id (FK)
        - Session.exams (M2M)
        - Exam.sessions reverse (M2M)
        - Exam.session reverse (FK/1:1)
        """
        # 1) Sessionì— exam FKê°€ ìˆëŠ” ê²½ìš°
        exam_id = getattr(session, "exam_id", None)
        if exam_id:
            return [int(exam_id)]

        # 2) Session.exams (M2M)
        if cls._has_relation(Session, "exams"):
            try:
                return list(session.exams.values_list("id", flat=True))
            except Exception:
                pass

        # 3) Exam.session / Exam.sessions ë¥¼ í†µí•´ ì—­ìœ¼ë¡œ ì°¾ê¸°
        # (ì•ˆì „í•˜ê²Œ Exam ì „ì²´ì—ì„œ ì„¸ì…˜ ë§¤í•‘)
        qs = Exam.objects.all()

        if cls._has_relation(Exam, "sessions"):
            qs = qs.filter(sessions__id=int(session.id))
            return list(qs.values_list("id", flat=True))

        if cls._has_relation(Exam, "session"):
            qs = qs.filter(session__id=int(session.id))
            return list(qs.values_list("id", flat=True))

        return []

    # -----------------------------
    # Exam aggregate logic
    # -----------------------------
    @staticmethod
    def _pick_latest(results: List[Result]) -> Optional[Result]:
        if not results:
            return None
        # submitted_atì´ nullì¼ ìˆ˜ ìˆìœ¼ë‹ˆ (nullì€ ê³¼ê±° ì·¨ê¸‰) ë°©ì–´ ì •ë ¬
        return sorted(
            results,
            key=lambda r: (r.submitted_at is not None, r.submitted_at or timezone.datetime.min.replace(tzinfo=timezone.get_current_timezone())),
        )[-1]

    @staticmethod
    def _safe_float(v: Any, default: float = 0.0) -> float:
        try:
            return float(v)
        except Exception:
            return default

    @classmethod
    def _aggregate_exam_results(
        cls,
        *,
        enrollment_id: int,
        session: Session,
        policy: ProgressPolicy,
    ) -> Tuple[bool, Optional[float], bool, Dict[str, Any]]:
        """
        ë°˜í™˜:
          exam_attempted, aggregate_score, exam_passed, exam_meta
        """
        exam_ids = cls._get_exam_ids_for_session(session)

        # ì‹œí—˜ì´ ì•„ì˜ˆ ì—†ëŠ” session
        if not exam_ids:
            meta = {
                "strategy": str(policy.exam_aggregate_strategy),
                "pass_source": str(policy.exam_pass_source),
                "exams": [],
            }
            return False, None, True, meta  # ì‹œí—˜ ì—†ìŒ => progressìƒ ì‹œí—˜ í†µê³¼ë¡œ ì·¨ê¸‰(ì •ì±…ìƒ ë¹„ëŒ€ìƒ)

        # Result ì¡°íšŒ (ëŒ€í‘œ attempt ìŠ¤ëƒ…ìƒ·)
        results = list(
            Result.objects.filter(
                target_type="exam",
                enrollment_id=int(enrollment_id),
                target_id__in=[int(x) for x in exam_ids],
            )
        )

        # Resultê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ "ì‹œí—˜ì€ ìˆì—ˆëŠ”ë° ë¯¸ì‘ì‹œ"
        if not results:
            meta = {
                "strategy": str(policy.exam_aggregate_strategy),
                "pass_source": str(policy.exam_pass_source),
                "exams": [
                    {
                        "exam_id": int(eid),
                        "score": None,
                        "max_score": None,
                        "pass_score": None,
                        "passed": False,
                        "submitted_at": None,
                    }
                    for eid in exam_ids
                ],
            }
            return False, None, False, meta

        exam_attempted = True

        # examë³„ pass_score ë¡œë”© (EXAM pass_source ëŒ€ì‘)
        exams = {
            e.id: e
            for e in Exam.objects.filter(id__in=[int(x) for x in exam_ids])
        }

        # ì‹œí—˜ë³„ row êµ¬ì„±
        per_exam_rows: List[Dict[str, Any]] = []
        for r in results:
            ex = exams.get(int(r.target_id))
            exam_pass_score = cls._safe_float(getattr(ex, "pass_score", None), default=0.0) if ex else 0.0
            policy_pass_score = cls._safe_float(getattr(policy, "exam_pass_score", 0.0), default=0.0)

            pass_score = policy_pass_score if policy.exam_pass_source == ProgressPolicy.ExamPassSource.POLICY else exam_pass_score
            score = cls._safe_float(r.total_score, default=0.0)

            per_exam_rows.append({
                "exam_id": int(r.target_id),
                "score": score,
                "max_score": cls._safe_float(r.max_score, default=0.0),
                "pass_score": float(pass_score),
                "passed": bool(score >= float(pass_score)),
                "submitted_at": r.submitted_at,
            })

        # ì§‘ê³„ ì ìˆ˜ ê³„ì‚°
        strategy = policy.exam_aggregate_strategy

        aggregate_score: Optional[float] = None
        selected_pass_score: float = cls._safe_float(policy.exam_pass_score, 0.0)

        if strategy == ProgressPolicy.ExamAggregateStrategy.MAX:
            best = max(per_exam_rows, key=lambda x: cls._safe_float(x.get("score"), 0.0))
            aggregate_score = cls._safe_float(best.get("score"), 0.0)
            selected_pass_score = cls._safe_float(best.get("pass_score"), 0.0)

        elif strategy == ProgressPolicy.ExamAggregateStrategy.AVG:
            scores = [cls._safe_float(x.get("score"), 0.0) for x in per_exam_rows]
            aggregate_score = (sum(scores) / len(scores)) if scores else 0.0

            # AVGì—ì„œ pass_scoreë¥¼ EXAM ê¸°ì¤€ìœ¼ë¡œ í•˜ë ¤ë©´ "í‰ê·  pass_score"ë¡œ ë‘ëŠ”ê²Œ í•©ë¦¬ì (ì •ì±…í™” ê°€ëŠ¥)
            if policy.exam_pass_source == ProgressPolicy.ExamPassSource.EXAM:
                ps = [cls._safe_float(x.get("pass_score"), 0.0) for x in per_exam_rows]
                selected_pass_score = (sum(ps) / len(ps)) if ps else 0.0
            else:
                selected_pass_score = cls._safe_float(policy.exam_pass_score, 0.0)

        elif strategy == ProgressPolicy.ExamAggregateStrategy.LATEST:
            latest = cls._pick_latest(results)
            if latest is None:
                aggregate_score = 0.0
                selected_pass_score = cls._safe_float(policy.exam_pass_score, 0.0)
            else:
                row = next((x for x in per_exam_rows if int(x["exam_id"]) == int(latest.target_id)), None)
                aggregate_score = cls._safe_float(latest.total_score, 0.0)
                selected_pass_score = cls._safe_float(row.get("pass_score") if row else policy.exam_pass_score, 0.0)

        else:
            # ì•ˆì „ fallback: MAX
            best = max(per_exam_rows, key=lambda x: cls._safe_float(x.get("score"), 0.0))
            aggregate_score = cls._safe_float(best.get("score"), 0.0)
            selected_pass_score = cls._safe_float(best.get("pass_score"), 0.0)

        exam_passed = bool((aggregate_score or 0.0) >= float(selected_pass_score))

        meta = {
            "strategy": str(strategy),
            "pass_source": str(policy.exam_pass_source),
            "aggregate_pass_score": float(selected_pass_score),
            "exams": per_exam_rows,
        }

        return True, aggregate_score, exam_passed, meta

    # -----------------------------
    # Main calculate
    # -----------------------------
    @staticmethod
    def calculate(
        *,
        enrollment_id: int,
        session: Session,
        attendance_type: str,
        video_progress_rate: int = 0,
        homework_submitted: bool = False,
        homework_teacher_approved: bool = False,
    ) -> SessionProgress:
        """
        ì™¸ë¶€ ë„ë©”ì¸ ê°’ë“¤ì„ ë°›ì•„ì„œ SessionProgressë¥¼ ê³„ì‚°/ì—…ë°ì´íŠ¸

        âœ… ì‹œí—˜ì€ Result ê¸°ë°˜ìœ¼ë¡œë§Œ ê³„ì‚°í•œë‹¤.
        """

        policy = SessionProgressCalculator._get_or_create_policy(session)

        obj, _ = SessionProgress.objects.get_or_create(
            enrollment_id=enrollment_id,
            session=session,
        )

        # ----------------------
        # Attendance / Video
        # ----------------------
        obj.attendance_type = attendance_type
        obj.video_progress_rate = int(video_progress_rate or 0)

        if attendance_type == SessionProgress.AttendanceType.OFFLINE:
            obj.video_completed = True
        else:
            obj.video_completed = obj.video_progress_rate >= int(policy.video_required_rate)

        # ----------------------
        # Exam aggregate (Result ê¸°ë°˜)
        # ----------------------
        in_exam_range = bool(policy.exam_start_session_order <= session.order <= policy.exam_end_session_order)
        if in_exam_range:
            attempted, agg_score, passed, exam_meta = SessionProgressCalculator._aggregate_exam_results(
                enrollment_id=enrollment_id,
                session=session,
                policy=policy,
            )
            obj.exam_attempted = bool(attempted)
            obj.exam_aggregate_score = agg_score
            obj.exam_passed = bool(passed)
            obj.exam_meta = exam_meta
        else:
            # ì‹œí—˜ ë¹„ëŒ€ìƒ ì£¼ì°¨
            obj.exam_attempted = False
            obj.exam_aggregate_score = None
            obj.exam_passed = True
            obj.exam_meta = {
                "strategy": str(policy.exam_aggregate_strategy),
                "pass_source": str(policy.exam_pass_source),
                "exams": [],
                "note": "out_of_exam_range",
            }

        # ----------------------
        # Homework
        # ----------------------
        in_hw_range = bool(policy.homework_start_session_order <= session.order <= policy.homework_end_session_order)
        if in_hw_range:
            obj.homework_submitted = bool(homework_submitted)

            if policy.homework_pass_type == ProgressPolicy.HomeworkPassType.SUBMIT:
                obj.homework_passed = bool(homework_submitted)

            elif policy.homework_pass_type == ProgressPolicy.HomeworkPassType.SCORE:
                # (ë ˆê±°ì‹œ) ì ìˆ˜ ê¸°ë°˜ì´ í•„ìš”í•˜ë©´ ë³„ë„ í•„ë“œë¡œ í™•ì¥
                obj.homework_passed = bool(homework_teacher_approved)

            elif policy.homework_pass_type == ProgressPolicy.HomeworkPassType.TEACHER_APPROVAL:
                obj.homework_passed = bool(homework_teacher_approved)
        else:
            obj.homework_passed = True

        # ----------------------
        # Final Completion
        # ----------------------
        obj.completed = bool(
            obj.video_completed
            and obj.exam_passed
            and obj.homework_passed
        )

        if obj.completed and not obj.completed_at:
            obj.completed_at = timezone.now()

        obj.calculated_at = timezone.now()
        obj.save()

        return obj


==========================================================================================
# FILE: tasks/__init__.py
==========================================================================================
# apps/domains/progress/tasks/__init__.py


==========================================================================================
# FILE: tasks/progress_pipeline_task.py
==========================================================================================
# apps/domains/progress/tasks/progress_pipeline_task.py
from __future__ import annotations

from celery import shared_task
from django.db import transaction

from apps.domains.submissions.models import Submission
from apps.domains.progress.services.session_calculator import SessionProgressCalculator
from apps.domains.progress.services.lecture_calculator import LectureProgressCalculator
from apps.domains.progress.services.risk_evaluator import RiskEvaluator
from apps.domains.progress.services.clinic_trigger_service import ClinicTriggerService


@shared_task(
    bind=True,
    autoretry_for=(Exception,),
    retry_backoff=5,
    retry_kwargs={"max_retries": 3},
)
def run_progress_pipeline_task(self, submission_id: int) -> None:
    """
    Results â†’ Progress íŒŒì´í”„ë¼ì¸ (1:N ì‹œí—˜ êµ¬ì¡° ëŒ€ì‘)

    âœ… í•µì‹¬ ë³€ê²½:
    - SessionProgressCalculatorëŠ” ì‹œí—˜ ì ìˆ˜ë¥¼ submissionì—ì„œ ë°›ì§€ ì•ŠëŠ”ë‹¤.
    - ì‹œí—˜ì€ Result í…Œì´ë¸”ì—ì„œ (sessionì— ì—°ê²°ëœ ëª¨ë“  exam_id) ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„í•œë‹¤.
    """

    submission = Submission.objects.select_related().get(id=submission_id)

    if submission.enrollment_id is None:
        return

    with transaction.atomic():
        # 1) SessionProgress ê³„ì‚° (ì‹œí—˜ì€ Result ê¸°ë°˜ ì§‘ê³„)
        session_progress = SessionProgressCalculator.calculate(
            enrollment_id=submission.enrollment_id,
            session=submission.session,
            attendance_type=submission.attendance_type,
            video_progress_rate=submission.video_progress_rate or 0,
            homework_submitted=submission.homework_submitted,
            homework_teacher_approved=submission.homework_teacher_approved,
        )

        # 2) LectureProgress ì§‘ê³„
        lecture_progress = LectureProgressCalculator.calculate(
            enrollment_id=submission.enrollment_id,
            lecture=submission.session.lecture,
        )

        # 3) Risk í‰ê°€
        RiskEvaluator.evaluate(lecture_progress)

        # 4) Clinic ìë™ íŠ¸ë¦¬ê±° (ì°¨ì‹œ ë¯¸ì™„ë£Œ ê¸°ë°˜)
        ClinicTriggerService.auto_create_if_failed(session_progress)

        # (ì‹œí—˜ ê¸°ë°˜ í´ë¦¬ë‹‰ ì¶”ì²œì€ exam_id ë‹¨ìœ„ë¡œ ë³„ë„ íŠ¸ë¦¬ê±° ê°€ëŠ¥)
        # - ì´ ë©”ì„œë“œëŠ” "íŠ¹ì • exam"ì„ ì…ë ¥ìœ¼ë¡œ ë°›ëŠ” ì„¤ê³„ì´ë¯€ë¡œ,
        #   Session 1:N ìƒí™©ì—ì„œëŠ”:
        #     - submission.exam_idê°€ ìˆì„ ë•Œë§Œ í•´ë‹¹ examì— ëŒ€í•´ì„œ í‰ê°€
        if getattr(submission, "exam_id", None):
            ClinicTriggerService.auto_create_if_exam_risk(
                enrollment_id=submission.enrollment_id,
                session=submission.session,
                exam_id=submission.exam_id,
            )
