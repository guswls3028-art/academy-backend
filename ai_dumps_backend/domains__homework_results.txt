====================================================================================================
# BACKEND APP: domains__homework_results
# ROOT PATH: C:\academy\apps\domains\homework_results
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================
# apps/domains/homework_results/__init__.py
# homework_results domain package
#
# DESIGN:
# - Runtime ê²°ê³¼(ìŠ¤ëƒ…ìƒ·) ì „ìš© ë„ë©”ì¸
# - Homework ì •ì˜/ì •ì±…(homework ë„ë©”ì¸)ê³¼ ë¶„ë¦¬í•˜ì—¬
#   results(exam ê²°ê³¼)ì™€ ê°™ì€ ë ˆì´ì–´ë§ì„ ë§Œë“ ë‹¤.


==========================================================================================
# FILE: apps.py
==========================================================================================
# apps/domains/homework_results/apps.py
from django.apps import AppConfig


class HomeworkResultsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.homework_results"
    label = "homework_results"


==========================================================================================
# FILE: models.py
==========================================================================================
"""
Homework Results Domain Models

âœ… í•µì‹¬ ì„¤ê³„ (ì¤‘ìš” / ë ˆì´ì–´ ê³ ì •)
- homework_results ë„ë©”ì¸ì€ "ëŸ°íƒ€ì„ ê²°ê³¼(ìŠ¤ëƒ…ìƒ·)"ë§Œ ì†Œìœ í•œë‹¤.
- Homework ì •ì˜/ì •ì±…ì€ homework ë„ë©”ì¸ ì†Œìœ .
- clinic íŒë‹¨/ì°¨ì‹œ í†µê³¼/ì§‘ê³„ëŠ” progress ë„ë©”ì¸ ì†Œìœ .

âœ… ì´ ëª¨ë¸ì˜ ì—­í• 
- Enrollment x Session ë‹¨ìœ„ Homework ê²°ê³¼ ìŠ¤ëƒ…ìƒ·(ìš´ì˜ ì…ë ¥ í¬í•¨)
- lock ìƒíƒœ, ìš´ì˜ ìŠ¹ì¸ ì—¬ë¶€, ì ìˆ˜(ì›ì ìˆ˜/percent ëª¨ë‘)ë¥¼ ì €ì¥
- SessionScores APIëŠ” ì´ ì—”í‹°í‹°ë¥¼ 'ScoreBlock'ë¡œ ì‚¬ìš©í•œë‹¤.

ğŸš« ì´ ëª¨ë¸ì´ í•˜ì§€ ì•ŠëŠ” ê²ƒ
- ì œì¶œ/ì›ë³¸/ìƒíƒœ: submissions ë„ë©”ì¸
- ì‹œí—˜ ì±„ì /ê²°ê³¼: results ë„ë©”ì¸
- ì°¨ì‹œ í†µê³¼/ì§‘ê³„: progress ë„ë©”ì¸

âš ï¸ DB í˜¸í™˜ì„± (ì¤‘ìš”)
- ê¸°ì¡´ homework ë„ë©”ì¸ì˜ HomeworkScore í…Œì´ë¸”ì„ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©í•œë‹¤.
- db_table = "homework_homeworkscore" ê³ ì •
- ë”°ë¼ì„œ DB DROP/CREATE ì—†ì´ "ì•± ì†Œìœ ê¶Œ"ë§Œ ì´ì „í•œë‹¤.
"""

from __future__ import annotations

from django.db import models

from apps.api.common.models import TimestampModel
from apps.domains.lectures.models import Session


class HomeworkScore(TimestampModel):
    """
    Enrollment x Session ë‹¨ìœ„ ìˆ™ì œ ì ìˆ˜/ìŠ¹ì¸ ìŠ¤ëƒ…ìƒ·

    DESIGN:
    - ì´ ê°’ì€ progress ê³„ì‚°ì— ì§ì ‘ ì‚¬ìš©ë˜ê¸°ë³´ë‹¤ëŠ”,
      progress pipelineì´ ì½ëŠ” Submission.homework_* ë¥¼ ê°±ì‹ í•˜ê¸° ìœ„í•œ ìš´ì˜ ì…ë ¥/ê²°ê³¼ ìŠ¤ëƒ…ìƒ·ì´ë‹¤.
    - í”„ë¡ íŠ¸ëŠ” ì´ ì—”í‹°í‹°ë¥¼ 'ScoreBlock'ë¡œ ì‚¬ìš©í•œë‹¤.
    """

    class LockReason(models.TextChoices):
        GRADING = "GRADING", "ì±„ì ì¤‘"
        PUBLISHED = "PUBLISHED", "ê²Œì‹œë¨"
        MANUAL = "MANUAL", "ìˆ˜ë™ì ê¸ˆ"
        OTHER = "OTHER", "ê¸°íƒ€"

    enrollment_id = models.PositiveIntegerField(db_index=True)

    session = models.ForeignKey(
        Session,
        on_delete=models.CASCADE,
        related_name="homework_scores",
    )

    # -----------------------------
    # ìš´ì˜ ì ìˆ˜
    # -----------------------------
    # ì ìˆ˜ ì…ë ¥ ë°©ì‹ì€ í•™ì›ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ:
    # - percent ì…ë ¥: score=85, max_score=100
    # - raw ì…ë ¥: score=18, max_score=20
    score = models.FloatField(null=True, blank=True)
    max_score = models.FloatField(null=True, blank=True)

    # ê°•ì‚¬/ìš´ì˜ ìŠ¹ì¸(í†µê³¼ íŒë‹¨ì˜ ìš´ì˜ ì…ë ¥ê°’)
    teacher_approved = models.BooleanField(default=False)

    # í†µê³¼ ì—¬ë¶€(ìš´ì˜ í‘œê¸°ìš© ìŠ¤ëƒ…ìƒ·)
    # - ì‹¤ì œ ì°¨ì‹œ í†µê³¼(SessionProgress.homework_passed)ëŠ” ProgressPolicyì— ì˜í•´ ê²°ì •ë¨
    passed = models.BooleanField(default=False)

    # í´ë¦¬ë‹‰ ëŒ€ìƒ ì—¬ë¶€ (scores íƒ­ì—ì„œ ë°”ë¡œ í‘œí˜„í•˜ê¸° ìœ„í•œ ìš´ì˜ ìŠ¤ëƒ…ìƒ·)
    clinic_required = models.BooleanField(default=False)

    # -----------------------------
    # í¸ì§‘ ë½
    # -----------------------------
    is_locked = models.BooleanField(default=False)
    lock_reason = models.CharField(
        max_length=30,
        choices=LockReason.choices,
        null=True,
        blank=True,
    )

    # ëˆ„ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ˜ì •í–ˆëŠ”ì§€(í”„ë¡œì íŠ¸ User ëª¨ë¸ ì˜ì¡´ ë°©ì§€)
    updated_by_user_id = models.PositiveIntegerField(null=True, blank=True)

    # meta í™•ì¥
    meta = models.JSONField(null=True, blank=True)

    class Meta:
        # âœ… DB ì¬ì‚¬ìš© (ì¤‘ìš”)
        db_table = "homework_homeworkscore"

        constraints = [
            models.UniqueConstraint(
                fields=["enrollment_id", "session"],
                name="unique_homework_score_per_enrollment_session",
            )
        ]
        indexes = [
            models.Index(fields=["enrollment_id", "updated_at"]),
            models.Index(fields=["session", "updated_at"]),
        ]
        ordering = ["-updated_at", "-id"]

    def __str__(self) -> str:
        return (
            f"HomeworkScore(enroll={self.enrollment_id}, "
            f"session={self.session_id}, score={self.score}, max={self.max_score})"
        )


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# apps/domains/homework_results/migrations/0001_initial.py
# Generated by Django 5.2.x on 2026-01-21
#
# IMPORTANT:
# - ê¸°ì¡´ homework_homeworkscore í…Œì´ë¸”ì„ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©í•œë‹¤.
# - DB ìŠ¤í‚¤ë§ˆ ë³€ê²½ì€ ìˆ˜í–‰í•˜ì§€ ì•Šê³ , Django migration stateë§Œ ë“±ë¡í•œë‹¤.

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("lectures", "0002_remove_session_exam"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[
                # âŒ DBì—ëŠ” ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ (ê¸°ì¡´ í…Œì´ë¸” ì¬ì‚¬ìš©)
            ],
            state_operations=[
                migrations.CreateModel(
                    name="HomeworkScore",
                    fields=[
                        ("id", models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                        ("created_at", models.DateTimeField(auto_now_add=True)),
                        ("updated_at", models.DateTimeField(auto_now=True)),

                        ("enrollment_id", models.PositiveIntegerField(db_index=True)),

                        ("score", models.FloatField(blank=True, null=True)),
                        ("max_score", models.FloatField(blank=True, null=True)),
                        ("teacher_approved", models.BooleanField(default=False)),
                        ("passed", models.BooleanField(default=False)),
                        ("clinic_required", models.BooleanField(default=False)),

                        ("is_locked", models.BooleanField(default=False)),
                        (
                            "lock_reason",
                            models.CharField(
                                blank=True,
                                choices=[
                                    ("GRADING", "ì±„ì ì¤‘"),
                                    ("PUBLISHED", "ê²Œì‹œë¨"),
                                    ("MANUAL", "ìˆ˜ë™ì ê¸ˆ"),
                                    ("OTHER", "ê¸°íƒ€"),
                                ],
                                max_length=30,
                                null=True,
                            ),
                        ),

                        ("updated_by_user_id", models.PositiveIntegerField(blank=True, null=True)),
                        ("meta", models.JSONField(blank=True, null=True)),

                        (
                            "session",
                            models.ForeignKey(
                                on_delete=django.db.models.deletion.CASCADE,
                                related_name="homework_scores",
                                to="lectures.session",
                            ),
                        ),
                    ],
                    options={
                        "db_table": "homework_homeworkscore",
                        "ordering": ["-updated_at", "-id"],
                    },
                ),
                migrations.AddConstraint(
                    model_name="homeworkscore",
                    constraint=models.UniqueConstraint(
                        fields=("enrollment_id", "session"),
                        name="unique_homework_score_per_enrollment_session",
                    ),
                ),
                migrations.AddIndex(
                    model_name="homeworkscore",
                    index=models.Index(fields=["enrollment_id", "updated_at"], name="hwres_enroll_upd_idx"),
                ),
                migrations.AddIndex(
                    model_name="homeworkscore",
                    index=models.Index(fields=["session", "updated_at"], name="hwres_session_upd_idx"),
                ),
            ],
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================
# apps/domains/homework_results/migrations/__init__.py
