====================================================================================================
# BACKEND APP: domains__students
# ROOT PATH: C:\academy\apps\domains\students
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
from django.contrib import admin
from .models import Student, Tag, StudentTag


@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "name",
        "gender",
        "grade",
        "phone",
        "parent",
        "high_school",
        "is_managed",
        "created_at",
    )
    list_filter = (
        "gender",
        "grade",
        "high_school",
        "is_managed",
    )
    search_fields = ("name", "phone")


@admin.register(Tag)
class TagAdmin(admin.ModelAdmin):
    list_display = ("id", "name", "color")
    search_fields = ("name",)


@admin.register(StudentTag)
class StudentTagAdmin(admin.ModelAdmin):
    list_display = ("student", "tag")
    list_filter = ("tag",)


==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class StudentsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.students"
    label = "students"


==========================================================================================
# FILE: filters.py
==========================================================================================
import django_filters
from .models import Student


class StudentFilter(django_filters.FilterSet):
    name = django_filters.CharFilter(field_name="name", lookup_expr="icontains")
    gender = django_filters.CharFilter()
    grade = django_filters.NumberFilter()
    high_school = django_filters.CharFilter(lookup_expr="icontains")
    major = django_filters.CharFilter(lookup_expr="icontains")
    is_managed = django_filters.BooleanFilter()

    class Meta:
        model = Student
        fields = [
            "name",
            "gender",
            "grade",
            "high_school",
            "major",
            "is_managed",
        ]


==========================================================================================
# FILE: models.py
==========================================================================================
# PATH: apps/domains/students/models.py

from django.db import models
from django.conf import settings

from apps.api.common.models import TimestampModel
from apps.core.models import Tenant
from apps.core.db import TenantQuerySet  # âœ… ì¶”ê°€


class Student(TimestampModel):
    # ğŸ” tenant-safe manager (ì‹¤ìˆ˜ ë°©ì§€)
    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="students",
        help_text="ì†Œì† í•™ì› (Tenant)",
    )

    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="student_profile",
        help_text="í•™ìƒì´ ë¡œê·¸ì¸ ê³„ì •ì„ ê°€ì§€ëŠ” ê²½ìš° ì—°ê²°",
    )

    name = models.CharField(max_length=50)

    gender = models.CharField(
        max_length=1,
        choices=[("M", "ë‚¨"), ("F", "ì—¬")],
        null=True,
        blank=True,
    )

    grade = models.PositiveSmallIntegerField(
        choices=[(1, "1"), (2, "2"), (3, "3")],
        null=True,
        blank=True,
    )

    SCHOOL_TYPE_CHOICES = (
        ("MIDDLE", "ì¤‘ë“±"),
        ("HIGH", "ê³ ë“±"),
    )

    school_type = models.CharField(
        max_length=10,
        choices=SCHOOL_TYPE_CHOICES,
        default="HIGH",
    )

    phone = models.CharField(max_length=20, null=True, blank=True)
    parent_phone = models.CharField(max_length=20, null=True, blank=True)

    parent = models.ForeignKey(
        "parents.Parent",
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="students",
    )

    high_school = models.CharField(max_length=100, null=True, blank=True)
    high_school_class = models.CharField(max_length=100, null=True, blank=True)
    major = models.CharField(max_length=50, null=True, blank=True)
    middle_school = models.CharField(max_length=100, null=True, blank=True)

    memo = models.TextField(null=True, blank=True)
    is_managed = models.BooleanField(default=True)

    tags = models.ManyToManyField(
        "Tag",
        through="StudentTag",
        related_name="students",
        blank=True,
    )

    class Meta:
        ordering = ["-id"]
        constraints = [
            models.UniqueConstraint(
                fields=["tenant", "user"],
                name="uniq_student_user_per_tenant",
                condition=models.Q(user__isnull=False),
            )
        ]

    def __str__(self):
        return self.name


class Tag(models.Model):
    name = models.CharField(max_length=50)
    color = models.CharField(max_length=20, default="#000000")

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=["name"],
                name="uniq_tag_name",
            )
        ]

    def __str__(self):
        return self.name


class StudentTag(models.Model):
    student = models.ForeignKey(
        Student,
        on_delete=models.CASCADE,
        related_name="student_tags",
    )
    tag = models.ForeignKey(Tag, on_delete=models.CASCADE)

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=["student", "tag"],
                name="uniq_student_tag",
            )
        ]

    def __str__(self):
        return f"{self.student.name} - {self.tag.name}"


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/domains/students/serializers.py

from rest_framework import serializers

from apps.domains.students.models import Student, Tag
from apps.domains.enrollment.models import Enrollment
from apps.domains.interactions.counseling.models import Counseling
from apps.domains.interactions.questions.models import Question


class TagSerializer(serializers.ModelSerializer):
    class Meta:
        model = Tag
        fields = "__all__"
        ref_name = "StudentTagSerializer"


class CounselingSerializer(serializers.ModelSerializer):
    class Meta:
        model = Counseling
        fields = "__all__"
        ref_name = "StudentCounseling"


class QuestionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Question
        fields = "__all__"
        ref_name = "StudentQuestion"


class EnrollmentSerializer(serializers.ModelSerializer):
    lecture_name = serializers.CharField(source="lecture.title", read_only=True)

    class Meta:
        model = Enrollment
        fields = "__all__"
        ref_name = "StudentEnrollment"


class StudentListSerializer(serializers.ModelSerializer):
    tags = TagSerializer(many=True, read_only=True)
    is_enrolled = serializers.SerializerMethodField()

    class Meta:
        model = Student
        fields = "__all__"
        ref_name = "StudentList"

    def get_is_enrolled(self, obj):
        request = self.context.get("request")
        if not request:
            return False

        lecture_id = request.query_params.get("lecture")
        if lecture_id:
            return obj.enrollments.filter(lecture_id=lecture_id).exists()

        return False


class StudentDetailSerializer(serializers.ModelSerializer):
    tags = TagSerializer(many=True, read_only=True)
    enrollments = EnrollmentSerializer(many=True, read_only=True)
    counselings = CounselingSerializer(many=True, read_only=True)
    questions = QuestionSerializer(many=True, read_only=True)

    class Meta:
        model = Student
        fields = "__all__"
        ref_name = "StudentDetail"


class AddTagSerializer(serializers.Serializer):
    tag_id = serializers.IntegerField()


class StudentCreateSerializer(serializers.ModelSerializer):
    initial_password = serializers.CharField(
        write_only=True,
        required=True,
        min_length=4,
    )

    class Meta:
        model = Student
        fields = "__all__"

    def validate_phone(self, value):
        if not value:
            raise serializers.ValidationError("ì „í™”ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.")

        from django.contrib.auth import get_user_model
        User = get_user_model()

        if User.objects.filter(username=value).exists():
            raise serializers.ValidationError("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.")

        return value


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/domains/students/urls.py

from rest_framework.routers import DefaultRouter
from .views import StudentViewSet, TagViewSet

router = DefaultRouter()

# ğŸ”¥ basename ëª…ì‹œ (queryset ì—†ëŠ” ViewSet ëŒ€ì‘)
router.register(r"", StudentViewSet, basename="student")
router.register(r"tags", TagViewSet, basename="student-tag")

urlpatterns = router.urls


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/domains/students/views.py

from django.db import transaction
from django.contrib.auth import get_user_model

from rest_framework.viewsets import ModelViewSet
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

from apps.core.permissions import IsAdminOrStaff, IsStudent

from .models import Student, Tag, StudentTag
from .filters import StudentFilter
from .serializers import (
    StudentListSerializer,
    StudentDetailSerializer,
    TagSerializer,
    AddTagSerializer,
)


# ======================================================
# Tag
# ======================================================

class TagViewSet(ModelViewSet):
    """
    í•™ìƒ íƒœê·¸ ê´€ë¦¬
    - ê´€ë¦¬ì / ìŠ¤íƒœí”„ ì „ìš©
    - Tag ìì²´ëŠ” í…Œë„ŒíŠ¸ì— ì¢…ì†ë˜ì§€ ì•ŠìŒ (ê³µí†µ ë¶„ë¥˜)
    """
    serializer_class = TagSerializer
    permission_classes = [IsAdminOrStaff]

    def get_queryset(self):
        return Tag.objects.all()


# ======================================================
# Student
# ======================================================

class StudentViewSet(ModelViewSet):
    """
    í•™ìƒ ê´€ë¦¬ ViewSet

    âœ” tenant ë‹¨ìœ„ ì™„ì „ ë¶„ë¦¬
    âœ” í•™ìƒ ìƒì„± ì‹œ User ê³„ì • ìë™ ìƒì„±
    âœ” phone = username
    âœ” ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” êµì‚¬ê°€ ì„¤ì •
    âœ” í•™ìƒ CRUDëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
    """

    permission_classes = [IsAdminOrStaff]

    # ------------------------------
    # Tenant-aware QuerySet
    # ------------------------------
    def get_queryset(self):
        """
        ğŸ” í•µì‹¬ ë³´ì•ˆ í¬ì¸íŠ¸
        - request.tenant ê¸°ì¤€ìœ¼ë¡œë§Œ í•™ìƒ ë…¸ì¶œ
        """
        return Student.objects.filter(tenant=self.request.tenant)

    # ------------------------------
    # Serializer ì„ íƒ
    # ------------------------------
    def get_serializer_class(self):
        if self.action == "create":
            from .serializers import StudentCreateSerializer
            return StudentCreateSerializer

        if self.action == "list":
            return StudentListSerializer

        return StudentDetailSerializer

    # ------------------------------
    # Student + User ìƒì„±
    # ------------------------------
    @transaction.atomic
    def create(self, request, *args, **kwargs):
        """
        í•™ìƒ ìƒì„± ì‹œ ì²˜ë¦¬ íë¦„

        1. ì…ë ¥ê°’ ê²€ì¦ (StudentCreateSerializer)
        2. User ìƒì„± (username = phone)
        3. Student ìƒì„± + tenant / user ì—°ê²°
        """
        serializer = self.get_serializer(
            data=request.data,
            context={"request": request},
        )
        serializer.is_valid(raise_exception=True)

        User = get_user_model()

        phone = serializer.validated_data["phone"]
        password = serializer.validated_data.pop("initial_password")

        # 1ï¸âƒ£ User ìƒì„±
        user = User.objects.create(
            username=phone,
            phone=phone,
            name=serializer.validated_data.get("name", ""),
        )
        user.set_password(password)
        user.save()

        # 2ï¸âƒ£ Student ìƒì„± + tenant / user ì—°ê²°
        student = Student.objects.create(
            tenant=request.tenant,   # âœ… tenant ê°•ì œ ì£¼ì…
            user=user,
            **serializer.validated_data,
        )

        output = StudentDetailSerializer(
            student,
            context={"request": request},
        )
        return Response(output.data, status=201)

    # ------------------------------
    # DELETE: Student ì‚­ì œ ì‹œ Userë„ ê°™ì´ ì‚­ì œ
    # ------------------------------
    @transaction.atomic
    def destroy(self, request, *args, **kwargs):
        """
        í•™ìƒ ì‚­ì œ ì‹œ ì²˜ë¦¬ íë¦„

        âœ” Student ì‚­ì œ
        âœ” ì—°ê²°ëœ Userë„ ê°™ì´ ì‚­ì œ
        """
        student = self.get_object()
        user = student.user

        # Student ì‚­ì œ (StudentTag ë“±ì€ CASCADE)
        self.perform_destroy(student)

        # User ê°™ì´ ì‚­ì œ
        if user:
            user.delete()

        return Response(status=204)

    # ------------------------------
    # Filtering / Searching / Ordering
    # ------------------------------
    filter_backends = [
        DjangoFilterBackend,
        SearchFilter,
        OrderingFilter,
    ]
    filterset_class = StudentFilter
    search_fields = ["name", "high_school", "major"]
    ordering_fields = ["id", "created_at", "updated_at"]
    ordering = ["-id"]

    # ------------------------------
    # Tag ê´€ë¦¬
    # ------------------------------
    @action(detail=True, methods=["post"])
    def add_tag(self, request, pk=None):
        student = self.get_object()
        serializer = AddTagSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        tag = Tag.objects.get(id=serializer.validated_data["tag_id"])
        StudentTag.objects.get_or_create(student=student, tag=tag)

        return Response({"status": "ok"}, status=201)

    @action(detail=True, methods=["post"])
    def remove_tag(self, request, pk=None):
        student = self.get_object()
        serializer = AddTagSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        StudentTag.objects.filter(
            student=student,
            tag_id=serializer.validated_data["tag_id"],
        ).delete()

        return Response({"status": "ok"}, status=200)

    # --------------------------------------------------
    # Anchor API: /students/me/
    # --------------------------------------------------
    @action(
        detail=False,
        methods=["get"],
        url_path="me",
        permission_classes=[IsAuthenticated, IsStudent],
    )
    def me(self, request):
        """
        í•™ìƒ ë³¸ì¸ ì •ë³´ ì¡°íšŒ (Anchor API)

        ğŸ”’ ë³´ì•ˆ í¬ì¸íŠ¸
        - request.user + request.tenant ê¸°ì¤€ ê°•ì œ
        - ë‹¤ë¥¸ í•™ì› / ë‹¤ë¥¸ í•™ìƒ ì ‘ê·¼ ë¶ˆê°€
        """
        student = Student.objects.get(
            tenant=request.tenant,
            user=request.user,
        )

        serializer = StudentDetailSerializer(
            student,
            context={"request": request},
        )
        return Response(serializer.data)


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("parents", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name="Student",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("name", models.CharField(max_length=50)),
                (
                    "gender",
                    models.CharField(
                        blank=True,
                        choices=[("M", "ë‚¨"), ("F", "ì—¬")],
                        max_length=1,
                        null=True,
                    ),
                ),
                (
                    "grade",
                    models.PositiveSmallIntegerField(
                        blank=True, choices=[(1, "1"), (2, "2"), (3, "3")], null=True
                    ),
                ),
                (
                    "school_type",
                    models.CharField(
                        choices=[("MIDDLE", "ì¤‘ë“±"), ("HIGH", "ê³ ë“±")],
                        default="HIGH",
                        max_length=10,
                    ),
                ),
                ("phone", models.CharField(blank=True, max_length=20, null=True)),
                (
                    "parent_phone",
                    models.CharField(blank=True, max_length=20, null=True),
                ),
                (
                    "high_school",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                (
                    "high_school_class",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                ("major", models.CharField(blank=True, max_length=50, null=True)),
                (
                    "middle_school",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                ("memo", models.TextField(blank=True, null=True)),
                ("is_managed", models.BooleanField(default=True)),
                (
                    "parent",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="students",
                        to="parents.parent",
                    ),
                ),
                (
                    "user",
                    models.OneToOneField(
                        blank=True,
                        help_text="í•™ìƒì´ ë¡œê·¸ì¸ ê³„ì •ì„ ê°€ì§€ëŠ” ê²½ìš° ì—°ê²°",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="student_profile",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "ordering": ["-id"],
            },
        ),
        migrations.CreateModel(
            name="Tag",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=50)),
                ("color", models.CharField(default="#000000", max_length=20)),
            ],
            options={
                "constraints": [
                    models.UniqueConstraint(fields=("name",), name="uniq_tag_name")
                ],
            },
        ),
        migrations.CreateModel(
            name="StudentTag",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "student",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="student_tags",
                        to="students.student",
                    ),
                ),
                (
                    "tag",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="students.tag"
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="student",
            name="tags",
            field=models.ManyToManyField(
                blank=True,
                related_name="students",
                through="students.StudentTag",
                to="students.tag",
            ),
        ),
        migrations.AddConstraint(
            model_name="studenttag",
            constraint=models.UniqueConstraint(
                fields=("student", "tag"), name="uniq_student_tag"
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                condition=models.Q(("user__isnull", False)),
                fields=("user",),
                name="uniq_student_user",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0002_add_tenant.py
==========================================================================================
# PATH: apps/domains/students/migrations/0002_add_tenant.py

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0001_initial"),
        ("students", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="student",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="students",
                to="core.tenant",
                default=1,  # âš ï¸ ì´ˆê¸° ë°ì´í„°ìš© (ìš´ì˜ì—ì„œ ì¡°ì •)
            ),
            preserve_default=False,
        ),
    ]


==========================================================================================
# FILE: migrations/0003_remove_student_uniq_student_user_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 07:17

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0003_attendance_expense_add_tenant"),
        ("parents", "0001_initial"),
        ("students", "0002_add_tenant"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.RemoveConstraint(
            model_name="student",
            name="uniq_student_user",
        ),
        migrations.AlterField(
            model_name="student",
            name="tenant",
            field=models.ForeignKey(
                help_text="ì†Œì† í•™ì› (Tenant)",
                on_delete=django.db.models.deletion.CASCADE,
                related_name="students",
                to="core.tenant",
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                condition=models.Q(("user__isnull", False)),
                fields=("tenant", "user"),
                name="uniq_student_user_per_tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================

