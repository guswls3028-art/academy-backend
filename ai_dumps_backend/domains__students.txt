====================================================================================================
# BACKEND APP: domains__students
# ROOT PATH: C:\academy\apps\domains\students
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
from django.contrib import admin
from .models import Student, Tag, StudentTag


@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "ps_number",   # âœ… NEW
        "omr_code",    # âœ… NEW
        "name",
        "gender",
        "grade",
        "phone",
        "parent_phone",  # âœ… ìš´ì˜ í™•ì¸ìš©
        "parent",
        "high_school",
        "is_managed",
        "created_at",
    )
    list_filter = (
        "gender",
        "grade",
        "high_school",
        "is_managed",
    )
    search_fields = ("ps_number", "omr_code", "name", "phone")


@admin.register(Tag)
class TagAdmin(admin.ModelAdmin):
    list_display = ("id", "name", "color")
    search_fields = ("name",)


@admin.register(StudentTag)
class StudentTagAdmin(admin.ModelAdmin):
    list_display = ("student", "tag")
    list_filter = ("tag",)


==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class StudentsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.students"
    label = "students"


==========================================================================================
# FILE: filters.py
==========================================================================================
import django_filters
from .models import Student


class StudentFilter(django_filters.FilterSet):
    ps_number = django_filters.CharFilter(field_name="ps_number", lookup_expr="icontains")  # âœ… NEW
    omr_code = django_filters.CharFilter(field_name="omr_code", lookup_expr="icontains")    # âœ… NEW

    name = django_filters.CharFilter(field_name="name", lookup_expr="icontains")
    gender = django_filters.CharFilter()
    grade = django_filters.NumberFilter()
    high_school = django_filters.CharFilter(lookup_expr="icontains")
    major = django_filters.CharFilter(lookup_expr="icontains")
    is_managed = django_filters.BooleanFilter()

    class Meta:
        model = Student
        fields = [
            "ps_number",
            "omr_code",
            "name",
            "gender",
            "grade",
            "high_school",
            "major",
            "is_managed",
        ]


==========================================================================================
# FILE: models.py
==========================================================================================
# PATH: apps/domains/students/models.py

from django.db import models
from django.conf import settings

from apps.api.common.models import TimestampModel
from apps.core.models import Tenant
from apps.core.db import TenantQuerySet  # âœ… ì¶”ê°€


class Student(TimestampModel):
    # ğŸ” tenant-safe manager (ì‹¤ìˆ˜ ë°©ì§€)
    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="students",
        help_text="ì†Œì† í•™ì› (Tenant)",
        db_index=True,  # âœ… tenant_id ì¸ë±ìŠ¤ ì¶”ê°€
    )

    # âœ… ë´‰ì¸: StudentëŠ” User ì—†ì´ ì¡´ì¬ ë¶ˆê°€ / User ì‚­ì œë˜ë©´ Studentë„ ê°™ì´ ì‚­ì œ
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        null=False,
        blank=False,
        related_name="student_profile",
        help_text="í•™ìƒ ë¡œê·¸ì¸ ê³„ì • (í•„ìˆ˜)",
    )

    # âœ… NEW: PS ë²ˆí˜¸ (í•™ì› ê³µì‹ í•™ìƒ ID)
    ps_number = models.CharField(
        max_length=20,
        null=False,
        blank=False,
        help_text="PS ë²ˆí˜¸ (í•™ì› í•™ìƒ ID)",
    )

    # âœ… NEW: OMR ì‹ë³„ì (í•™ìƒ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ë¶€ëª¨ ì „í™”ë²ˆí˜¸ ë’¤ 8ìë¦¬)
    omr_code = models.CharField(
        max_length=8,
        null=False,
        blank=False,
        help_text="OMR ìë™ì±„ì  ì‹ë³„ì (í•™ìƒ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ë¶€ëª¨ ì „í™”ë²ˆí˜¸ ë’¤ 8ìë¦¬)",
    )

    name = models.CharField(max_length=50)

    gender = models.CharField(
        max_length=1,
        choices=[("M", "ë‚¨"), ("F", "ì—¬")],
        null=True,
        blank=True,
    )

    grade = models.PositiveSmallIntegerField(
        choices=[(1, "1"), (2, "2"), (3, "3")],
        null=True,
        blank=True,
    )

    SCHOOL_TYPE_CHOICES = (
        ("MIDDLE", "ì¤‘ë“±"),
        ("HIGH", "ê³ ë“±"),
    )

    school_type = models.CharField(
        max_length=10,
        choices=SCHOOL_TYPE_CHOICES,
        default="HIGH",
    )

    # í•™ìƒ ì „í™”ë²ˆí˜¸ (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ null)
    phone = models.CharField(
        max_length=20,
        null=True,
        blank=True,
        help_text="ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ (í•˜ì´í”ˆ ì œê±°, ì˜ˆ: 01012345678)",
    )
    # ë¶€ëª¨ ì „í™”ë²ˆí˜¸ (í•„ìˆ˜)
    parent_phone = models.CharField(
        max_length=20,
        null=False,
        blank=False,
        help_text="ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ (í•˜ì´í”ˆ ì œê±°, ì˜ˆ: 01012345678)",
    )

    uses_identifier = models.BooleanField(
        default=False,
        help_text="Trueë©´ í•™ìƒ ì „í™” ì—†ìŒ, ì‹ë³„ì(010+8ìë¦¬)ë¡œ ê°€ì…. í‘œì‹œ ì‹œ 'ì‹ë³„ì XXXX-XXXX'",
    )

    parent = models.ForeignKey(
        "parents.Parent",
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name="students",
    )

    high_school = models.CharField(max_length=100, null=True, blank=True)
    high_school_class = models.CharField(max_length=100, null=True, blank=True)
    major = models.CharField(max_length=50, null=True, blank=True)
    middle_school = models.CharField(max_length=100, null=True, blank=True)

    memo = models.TextField(null=True, blank=True)
    is_managed = models.BooleanField(default=True)

    deleted_at = models.DateTimeField(
        null=True,
        blank=True,
        db_index=True,
        help_text="ì‚­ì œì¼ì‹œ. ì„¤ì • ì‹œ 30ì¼ ë³´ê´€ í›„ ìë™ ì‚­ì œ",
    )

    tags = models.ManyToManyField(
        "Tag",
        through="StudentTag",
        related_name="students",
        blank=True,
    )

    class Meta:
        ordering = ["-id"]
        indexes = [
            models.Index(fields=["tenant", "created_at"]),  # âœ… ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€
        ]
        constraints = [
            # âœ… tenant ë‹¨ìœ„ User ìœ ì¼ (ê¸°ì¡´ ìœ ì§€, ë‹¨ userëŠ” ì´ì œ null ë¶ˆê°€)
            models.UniqueConstraint(
                fields=["tenant", "user"],
                name="uniq_student_user_per_tenant",
            ),
            # âœ… NEW: tenant ë‹¨ìœ„ PS ë²ˆí˜¸ ìœ ì¼
            models.UniqueConstraint(
                fields=["tenant", "ps_number"],
                name="uniq_student_ps_number_per_tenant",
            ),
            # OMR ì½”ë“œëŠ” unique ì œê±° (ìŒë‘¥ì´ ë“± ì¤‘ë³µ í—ˆìš©, ìë™ ì±„ì  í›„ ìˆ˜ë™ ë§¤ì¹­)
        ]

    def __str__(self):
        return self.name


class Tag(models.Model):
    name = models.CharField(max_length=50)
    color = models.CharField(max_length=20, default="#000000")

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=["name"],
                name="uniq_tag_name",
            )
        ]

    def __str__(self):
        return self.name


class StudentTag(models.Model):
    student = models.ForeignKey(
        Student,
        on_delete=models.CASCADE,
        related_name="student_tags",
    )
    tag = models.ForeignKey(Tag, on_delete=models.CASCADE)

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=["student", "tag"],
                name="uniq_student_tag",
            )
        ]

    def __str__(self):
        return f"{self.student.name} - {self.tag.name}"


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/domains/students/serializers.py

import random

from django.contrib.auth import get_user_model
from rest_framework import serializers

from apps.domains.students.models import Student, Tag


def _generate_unique_ps_number() -> str:
    """ì„ì˜ì˜ 6ìë¦¬ ìˆ«ì ì¤‘ë³µ ì—†ì´ ë¶€ì—¬ (User.username ì „ì—­ ìœ ì¼)"""
    User = get_user_model()
    for _ in range(100):
        candidate = str(random.randint(100000, 999999))
        if not User.objects.filter(username=candidate).exists():
            return candidate
    raise ValueError("ì•„ì´ë”” ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.")
from apps.domains.enrollment.models import Enrollment


class TagSerializer(serializers.ModelSerializer):
    class Meta:
        model = Tag
        fields = "__all__"
        ref_name = "StudentTagSerializer"


class EnrollmentSerializer(serializers.ModelSerializer):
    lecture_name = serializers.CharField(source="lecture.title", read_only=True)
    lecture_color = serializers.CharField(source="lecture.color", read_only=True, default="#3b82f6")

    class Meta:
        model = Enrollment
        fields = "__all__"
        ref_name = "StudentEnrollment"


class StudentListSerializer(serializers.ModelSerializer):
    tags = TagSerializer(many=True, read_only=True)
    enrollments = EnrollmentSerializer(many=True, read_only=True)
    is_enrolled = serializers.SerializerMethodField()

    class Meta:
        model = Student
        fields = "__all__"
        ref_name = "StudentList"

    def get_is_enrolled(self, obj):
        request = self.context.get("request")
        if not request:
            return False

        lecture_id = request.query_params.get("lecture")
        if lecture_id:
            try:
                lid = int(lecture_id)
            except (TypeError, ValueError):
                return False
            return obj.enrollments.filter(lecture_id=lid).exists()

        return False


class StudentDetailSerializer(serializers.ModelSerializer):
    tags = TagSerializer(many=True, read_only=True)
    enrollments = EnrollmentSerializer(many=True, read_only=True)

    class Meta:
        model = Student
        fields = "__all__"
        ref_name = "StudentDetail"


class AddTagSerializer(serializers.Serializer):
    tag_id = serializers.IntegerField()


class StudentBulkItemSerializer(serializers.Serializer):
    """ì—‘ì…€ ì¼ê´„ ë“±ë¡ìš© ë‹¨ì¼ í•™ìƒ ë°ì´í„°"""

    name = serializers.CharField(allow_blank=False, trim_whitespace=True)
    phone = serializers.CharField(allow_blank=True, trim_whitespace=True, required=False, default="")
    parent_phone = serializers.CharField(allow_blank=False, trim_whitespace=True)
    uses_identifier = serializers.BooleanField(required=False, default=False)
    gender = serializers.CharField(allow_blank=True, default="")
    school_type = serializers.ChoiceField(
        choices=[("HIGH", "ê³ ë“±"), ("MIDDLE", "ì¤‘ë“±")],
        default="HIGH",
    )
    school = serializers.CharField(allow_blank=True, default="", required=False)
    high_school_class = serializers.CharField(allow_blank=True, default="", required=False)
    major = serializers.CharField(allow_blank=True, default="", required=False)
    grade = serializers.IntegerField(allow_null=True, required=False)
    memo = serializers.CharField(allow_blank=True, default="", required=False)
    is_managed = serializers.BooleanField(default=True, required=False)

    def validate_phone(self, value):
        # í•™ìƒ ì „í™”ë²ˆí˜¸ëŠ” ì„ íƒì‚¬í•­
        if not value:
            return None
        v = str(value or "").replace(" ", "").replace("-", "").replace(".", "")
        if v and (len(v) != 11 or not v.startswith("010")):
            raise serializers.ValidationError("ì „í™”ë²ˆí˜¸ëŠ” 010XXXXXXXX 11ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.")
        return v if v else None

    def validate_parent_phone(self, value):
        v = str(value or "").replace(" ", "").replace("-", "").replace(".", "")
        if not v or len(v) != 11 or not v.startswith("010"):
            raise serializers.ValidationError("í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸ëŠ” 010XXXXXXXX 11ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.")
        return v


class StudentBulkCreateSerializer(serializers.Serializer):
    initial_password = serializers.CharField(min_length=4, write_only=True)
    students = StudentBulkItemSerializer(many=True)
    send_welcome_message = serializers.BooleanField(required=False, default=False)


class StudentCreateSerializer(serializers.ModelSerializer):
    initial_password = serializers.CharField(
        write_only=True,
        required=True,
        min_length=4,
    )
    send_welcome_message = serializers.BooleanField(
        write_only=True,
        required=False,
        default=False,
    )
    no_phone = serializers.BooleanField(
        write_only=True,
        required=False,
        default=False,
        help_text="Trueë©´ ì‹ë³„ìë¡œ ê°€ì… (uses_identifier=True)",
    )
    ps_number = serializers.CharField(
        required=False,
        allow_blank=True,
        help_text="ë¯¸ì…ë ¥ ì‹œ ì„ì˜ 6ìë¦¬ ìë™ ë¶€ì—¬ (í•™ìƒì´ ì¶”í›„ ë³€ê²½ ê°€ëŠ¥)",
    )

    class Meta:
        model = Student
        exclude = ("tenant", "user")

    def _require(self, attrs, key: str):
        v = attrs.get(key)
        if v is None:
            raise serializers.ValidationError({key: "í•„ìˆ˜ì…ë‹ˆë‹¤."})
        if isinstance(v, str) and not v.strip():
            raise serializers.ValidationError({key: "í•„ìˆ˜ì…ë‹ˆë‹¤."})
        return v

    def validate_phone(self, value):
        # í•™ìƒ ì „í™”ë²ˆí˜¸ëŠ” ì„ íƒì‚¬í•­ (ì—†ìœ¼ë©´ None)
        if not value or not str(value).strip():
            return None

        from django.contrib.auth import get_user_model
        User = get_user_model()

        if User.objects.filter(phone=value).exists():
            raise serializers.ValidationError("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.")

        return value

    # omr_codeëŠ” validateì—ì„œ ìë™ ì„¤ì •ë˜ë¯€ë¡œ ë³„ë„ validate ë¶ˆí•„ìš”

    def validate(self, attrs):
        request = self.context.get("request")
        tenant = getattr(request, "tenant", None) if request else None
        if tenant is None:
            raise serializers.ValidationError("Tenantê°€ resolveë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        ps_number_raw = attrs.get("ps_number") or ""
        ps_number = str(ps_number_raw).strip() if ps_number_raw else ""
        if not ps_number:
            try:
                ps_number = _generate_unique_ps_number()
            except ValueError as e:
                raise serializers.ValidationError({"ps_number": str(e)})
        parent_phone = str(self._require(attrs, "parent_phone")).strip()
        name = str(self._require(attrs, "name")).strip()
        phone = attrs.get("phone")
        phone_str = str(phone).strip() if phone else None

        # OMR ì½”ë“œ: í•™ìƒ ì „í™”ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•™ìƒ ì „í™”ë²ˆí˜¸ 8ìë¦¬, ì—†ìœ¼ë©´ ë¶€ëª¨ ì „í™”ë²ˆí˜¸ 8ìë¦¬
        if phone_str and len(phone_str) >= 8:
            omr_code = phone_str[-8:]
        elif parent_phone and len(parent_phone) >= 8:
            omr_code = parent_phone[-8:]
        else:
            raise serializers.ValidationError({"omr_code": "í•™ìƒ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ë¶€ëª¨ ì „í™”ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤."})

        attrs["ps_number"] = ps_number
        attrs["omr_code"] = omr_code
        attrs["phone"] = phone_str if phone_str else None
        attrs["parent_phone"] = parent_phone
        attrs["name"] = name

        # ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ê²½ìš°ì—ë§Œ ì¤‘ë³µ ì²´í¬ (ìë™ ìƒì„±ì€ ì´ë¯¸ User ì¤‘ë³µ ê²€ì‚¬ë¨)
        if ps_number_raw and Student.objects.filter(tenant=tenant, ps_number=ps_number).exists():
            raise serializers.ValidationError({"ps_number": "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ PS ë²ˆí˜¸ì…ë‹ˆë‹¤."})

        attrs["uses_identifier"] = attrs.pop("no_phone", False) or (phone_str is None)
        return attrs


class StudentUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Student
        exclude = ("tenant", "user")

    def validate(self, attrs):
        request = self.context.get("request")
        tenant = getattr(request, "tenant", None) if request else None
        if tenant is None:
            raise serializers.ValidationError("Tenantê°€ resolveë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        instance = self.instance

        phone = attrs.get("phone", instance.phone)
        parent_phone = attrs.get("parent_phone", instance.parent_phone)
        ps_number = attrs.get("ps_number", instance.ps_number)

        # OMR ì½”ë“œ: í•™ìƒ ì „í™”ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•™ìƒ ì „í™”ë²ˆí˜¸ 8ìë¦¬, ì—†ìœ¼ë©´ ë¶€ëª¨ ì „í™”ë²ˆí˜¸ 8ìë¦¬
        phone_str = str(phone).strip() if phone else None
        parent_phone_str = str(parent_phone).strip() if parent_phone else None
        
        if phone_str and len(phone_str) >= 8:
            omr_code = phone_str[-8:]
        elif parent_phone_str and len(parent_phone_str) >= 8:
            omr_code = parent_phone_str[-8:]
        else:
            omr_code = attrs.get("omr_code", instance.omr_code)  # ê¸°ì¡´ ê°’ ìœ ì§€

        attrs["omr_code"] = omr_code

        if ps_number:
            if Student.objects.filter(
                tenant=tenant, ps_number=ps_number
            ).exclude(id=instance.id).exists():
                raise serializers.ValidationError({"ps_number": "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ PS ë²ˆí˜¸ì…ë‹ˆë‹¤."})

        return attrs


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/domains/students/urls.py

from rest_framework.routers import DefaultRouter
from .views import StudentViewSet, TagViewSet

router = DefaultRouter()

# ğŸ”¥ basename ëª…ì‹œ (queryset ì—†ëŠ” ViewSet ëŒ€ì‘)
router.register(r"tags", TagViewSet, basename="student-tag")
router.register(r"", StudentViewSet, basename="student")


urlpatterns = router.urls


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/domains/students/views.py

from django.db import transaction, connection
from django.utils import timezone
from django.contrib.auth import get_user_model

from rest_framework.viewsets import ModelViewSet
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.pagination import PageNumberPagination

from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

from apps.core.permissions import IsAdminOrStaff, IsStudent
from apps.core.models import TenantMembership
from apps.core.permissions import TenantResolvedAndStaff

from apps.domains.parents.services import ensure_parent_for_student
from apps.support.messaging.services import send_welcome_messages, get_site_url

from .models import Student, Tag, StudentTag
from .filters import StudentFilter
from apps.domains.enrollment.models import Enrollment
from .serializers import (
    _generate_unique_ps_number,
    StudentListSerializer,
    StudentDetailSerializer,
    TagSerializer,
    AddTagSerializer,
    StudentBulkCreateSerializer,
)


# ======================================================
# Tag
# ======================================================

class TagViewSet(ModelViewSet):
    """
    í•™ìƒ íƒœê·¸ ê´€ë¦¬
    - ê´€ë¦¬ì / ìŠ¤íƒœí”„ ì „ìš©
    - Tag ìì²´ëŠ” í…Œë„ŒíŠ¸ì— ì¢…ì†ë˜ì§€ ì•ŠìŒ (ê³µí†µ ë¶„ë¥˜)
    """
    serializer_class = TagSerializer
    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]

    def get_queryset(self):
        return Tag.objects.all()


# ======================================================
# Student
# ======================================================

class StudentListPagination(PageNumberPagination):
    page_size = 50
    page_size_query_param = "page_size"
    max_page_size = 100


class StudentViewSet(ModelViewSet):
    """
    í•™ìƒ ê´€ë¦¬ ViewSet

    âœ” tenant ë‹¨ìœ„ ì™„ì „ ë¶„ë¦¬
    âœ” í•™ìƒ ìƒì„± ì‹œ User ê³„ì • ìë™ ìƒì„±
    âœ” phone = username
    âœ” ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” êµì‚¬ê°€ ì„¤ì •
    âœ” í•™ìƒ CRUDëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥

    âœ… ë´‰ì¸ ê°•í™”:
    - Student ìƒì„± ì‹œ TenantMembership(role=student) ë°˜ë“œì‹œ ìƒì„±
    - Student ì‚­ì œ ì‹œ User ì‚­ì œ(ê³ ì•„ìœ ì € ë°©ì§€)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    pagination_class = StudentListPagination

    # ------------------------------
    # Tenant-aware QuerySet
    # ------------------------------
    def get_queryset(self):
        """
        ğŸ” í•µì‹¬ ë³´ì•ˆ í¬ì¸íŠ¸
        - request.tenant ê¸°ì¤€ìœ¼ë¡œë§Œ í•™ìƒ ë…¸ì¶œ
        - list: ?deleted=true ì‹œ ì‚­ì œëœ í•™ìƒë§Œ, ê¸°ë³¸ì€ í™œì„± í•™ìƒë§Œ
        """
        qs = Student.objects.filter(tenant=self.request.tenant)

        if self.action == "list":
            show_deleted = self.request.query_params.get("deleted") == "true"
            if show_deleted:
                qs = qs.filter(deleted_at__isnull=False)
            else:
                qs = qs.filter(deleted_at__isnull=True)
            qs = qs.prefetch_related("enrollments__lecture")
        elif self.action == "retrieve":
            qs = qs.prefetch_related("enrollments__lecture")

        return qs

    # ------------------------------
    # Serializer ì„ íƒ
    # ------------------------------
    def get_serializer_class(self):
        if self.action == "create":
            from .serializers import StudentCreateSerializer
            return StudentCreateSerializer

        if self.action == "list":
            return StudentListSerializer

        return StudentDetailSerializer

    # ------------------------------
    # Student + User + Membership ìƒì„± (ë´‰ì¸)
    # ------------------------------
    @transaction.atomic
    def create(self, request, *args, **kwargs):
        """
        í•™ìƒ ìƒì„± ì‹œ ì²˜ë¦¬ íë¦„

        1. ì…ë ¥ê°’ ê²€ì¦ (StudentCreateSerializer)
        2. í•™ë¶€ëª¨ ê³„ì • ìƒì„±/ì—°ê²° (ensure_parent_for_student)
        3. User ìƒì„± (username = ps_number)
        4. Student ìƒì„± + tenant / user / parent ì—°ê²°
        5. TenantMembership(role=student) SSOT ê°•ì œ ìƒì„±
        6. (ì˜µì…˜) ê°€ì… ì„±ê³µ ë©”ì‹œì§€ ì¼ê´„ ë°œì†¡
        """
        serializer = self.get_serializer(
            data=request.data,
            context={"request": request},
        )
        serializer.is_valid(raise_exception=True)

        User = get_user_model()
        data = serializer.validated_data
        send_welcome = data.pop("send_welcome_message", False)

        phone = data.get("phone")  # nullable
        password = data.pop("initial_password")
        parent_phone = data.get("parent_phone", "")
        ps_number = data.get("ps_number")

        # 1ï¸âƒ£ í•™ë¶€ëª¨ ê³„ì • ìƒì„± (ID = í•™ë¶€ëª¨ ì „í™”ë²ˆí˜¸)
        parent = None
        if parent_phone:
            parent = ensure_parent_for_student(
                tenant=request.tenant,
                parent_phone=parent_phone,
                student_name=data.get("name", ""),
                parent_password=password,
            )

        # 2ï¸âƒ£ User ìƒì„± (phoneì´ ì—†ìœ¼ë©´ usernameë§Œ ì‚¬ìš©)
        user = User.objects.create_user(
            username=ps_number,
            phone=phone or "",  # phoneì´ Noneì´ë©´ ë¹ˆ ë¬¸ìì—´
            name=data.get("name", ""),
        )
        user.set_password(password)
        user.save()

        # 3ï¸âƒ£ Student ìƒì„± + parent ì—°ê²°
        student = Student.objects.create(
            tenant=request.tenant,
            user=user,
            parent=parent,
            **data,
        )

        # 4ï¸âƒ£ TenantMembership
        TenantMembership.ensure_active(
            tenant=request.tenant,
            user=user,
            role="student",
        )

        # 5ï¸âƒ£ ê°€ì… ì„±ê³µ ë©”ì‹œì§€ ë°œì†¡
        if send_welcome:
            site_url = get_site_url(request)
            send_welcome_messages(
                created_students=[student],
                student_password=password,
                parent_password_by_phone={parent_phone: password} if parent_phone else {},
                site_url=site_url,
            )

        output = StudentDetailSerializer(
            student,
            context={"request": request},
        )
        return Response(output.data, status=201)

    # ------------------------------
    # DELETE: ì†Œí”„íŠ¸ ì‚­ì œ (30ì¼ ë³´ê´€)
    # ------------------------------
    @transaction.atomic
    def destroy(self, request, *args, **kwargs):
        student = self.get_object()
        if student.deleted_at:
            return Response({"detail": "ì´ë¯¸ ì‚­ì œëœ í•™ìƒì…ë‹ˆë‹¤."}, status=400)
        now = timezone.now()
        student.deleted_at = now
        student.save(update_fields=["deleted_at"])
        if student.user:
            student.user.is_active = False
            student.user.save(update_fields=["is_active"])
        return Response(status=204)

    # ------------------------------
    # Filtering / Searching / Ordering
    # ------------------------------
    filter_backends = [
        DjangoFilterBackend,
        SearchFilter,
        OrderingFilter,
    ]
    filterset_class = StudentFilter
    search_fields = ["ps_number", "omr_code", "name", "high_school", "major", "phone"]
    ordering_fields = ["id", "created_at", "updated_at", "deleted_at"]
    ordering = ["-id"]

    # ------------------------------
    # Tag ê´€ë¦¬
    # ------------------------------
    @action(detail=True, methods=["post"])
    def add_tag(self, request, pk=None):
        student = self.get_object()
        serializer = AddTagSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        tag = Tag.objects.get(id=serializer.validated_data["tag_id"])
        StudentTag.objects.get_or_create(student=student, tag=tag)

        return Response({"status": "ok"}, status=201)

    @action(detail=True, methods=["post"])
    def remove_tag(self, request, pk=None):
        student = self.get_object()
        serializer = AddTagSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        StudentTag.objects.filter(
            student=student,
            tag_id=serializer.validated_data["tag_id"],
        ).delete()

        return Response({"status": "ok"}, status=200)

    # --------------------------------------------------
    # Anchor API: /students/me/ (ì›ë³¸ 100% ìœ ì§€)
    # --------------------------------------------------
    @action(
        detail=False,
        methods=["post"],
        url_path="bulk_create",
    )
    def bulk_create(self, request):
        """
        ì—‘ì…€ ì¼ê´„ ë“±ë¡ â€” 600ëª…+ ëŒ€ëŸ‰ ì—…ë¡œë“œ ëŒ€ì‘
        POST body: { "initial_password": "...", "students": [ {...}, ... ] }
        """
        serializer = StudentBulkCreateSerializer(
            data=request.data,
            context={"request": request},
        )
        serializer.is_valid(raise_exception=True)

        password = serializer.validated_data["initial_password"]
        students_data = serializer.validated_data["students"]
        send_welcome = serializer.validated_data.get("send_welcome_message", False)
        User = get_user_model()
        tenant = request.tenant

        created_count = 0
        failed = []
        created_students = []

        for idx, item in enumerate(students_data):
            phone = item.get("phone")  # nullable
            parent_phone = item.get("parent_phone", "")
            # ps_number: ì„ì˜ 6ìë¦¬ ìë™ ë¶€ì—¬ (í•™ìƒì´ ì¶”í›„ ë³€ê²½ ê°€ëŠ¥)
            ps_number = _generate_unique_ps_number()
            # omr_code: í•™ìƒ ì „í™”ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•™ìƒ ì „í™”ë²ˆí˜¸ 8ìë¦¬, ì—†ìœ¼ë©´ ë¶€ëª¨ ì „í™”ë²ˆí˜¸ 8ìë¦¬
            if phone and len(phone) >= 8:
                omr_code = phone[-8:]
            elif parent_phone and len(parent_phone) >= 8:
                omr_code = parent_phone[-8:]
            else:
                failed.append({
                    "row": idx + 1,
                    "name": item.get("name", ""),
                    "error": "í•™ìƒ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ë¶€ëª¨ ì „í™”ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
                })
                continue

            try:
                with transaction.atomic():
                    # í•™ìƒ ì „í™”ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ì¤‘ë³µ ì²´í¬
                    if phone:
                        conflict_deleted = Student.objects.filter(
                            tenant=tenant, phone=phone, deleted_at__isnull=False
                        ).values_list("id", flat=True).first()
                        if conflict_deleted:
                            raise ValueError("ì‚­ì œëœ í•™ìƒê³¼ ì „í™”ë²ˆí˜¸ ì¶©ëŒ. ë³µì› ë˜ëŠ” ì‚­ì œ í›„ ì¬ë“±ë¡ì„ ì„ íƒí•˜ì„¸ìš”.", conflict_deleted)
                        # í™œì„± Userë§Œ ì²´í¬ (ì‚­ì œëœ í•™ìƒì˜ UserëŠ” is_active=False)
                        if User.objects.filter(phone=phone, is_active=True).exists():
                            raise ValueError("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.")
                    if Student.objects.filter(tenant=tenant, ps_number=ps_number, deleted_at__isnull=True).exists():
                        raise ValueError("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ PS ë²ˆí˜¸ì…ë‹ˆë‹¤.")

                    # í•™ë¶€ëª¨ ê³„ì • ìƒì„±
                    parent = None
                    if parent_phone:
                        parent = ensure_parent_for_student(
                            tenant=tenant,
                            parent_phone=parent_phone,
                            student_name=item.get("name", ""),
                            parent_password=password,
                        )

                    user = User.objects.create_user(
                        username=ps_number,
                        phone=phone or "",  # phoneì´ Noneì´ë©´ ë¹ˆ ë¬¸ìì—´
                        name=item.get("name", ""),
                    )
                    user.set_password(password)
                    user.save()

                    school_val = (item.get("school") or "").strip() or None
                    st = item.get("school_type", "HIGH")
                    high_school = school_val if st == "HIGH" else None
                    middle_school = school_val if st == "MIDDLE" else None
                    high_school_class = (item.get("high_school_class") or "").strip() or None if st == "HIGH" else None
                    major = (item.get("major") or "").strip() or None if st == "HIGH" else None

                    student = Student.objects.create(
                        tenant=tenant,
                        user=user,
                        parent=parent,
                        name=item["name"],
                        phone=phone,  # nullable
                        parent_phone=item["parent_phone"],
                        ps_number=ps_number,
                        omr_code=omr_code,
                        uses_identifier=item.get("uses_identifier", False) or (phone is None),
                        gender=item.get("gender") or None,
                        school_type=item.get("school_type", "HIGH"),
                        high_school=high_school,
                        middle_school=middle_school,
                        high_school_class=high_school_class,
                        major=major,
                        grade=item.get("grade"),
                        memo=item.get("memo") or None,
                        is_managed=item.get("is_managed", True),
                    )

                    TenantMembership.ensure_active(
                        tenant=tenant,
                        user=user,
                        role="student",
                    )
                    created_count += 1
                    created_students.append(student)
            except Exception as e:
                err_msg = str(e)
                conflict_student_id = None
                if isinstance(e, ValueError) and len(e.args) >= 2:
                    conflict_student_id = e.args[1]
                    err_msg = e.args[0]
                failed.append({
                    "row": idx + 1,
                    "name": item.get("name", ""),
                    "error": err_msg,
                    "conflict_student_id": conflict_student_id,
                })

        if send_welcome and created_students:
            site_url = get_site_url(request)
            parent_pw = {s.parent_phone: password for s in created_students if getattr(s, "parent_phone", None)}
            send_welcome_messages(
                created_students=created_students,
                student_password=password,
                parent_password_by_phone=parent_pw,
                site_url=site_url,
            )

        return Response({
            "created": created_count,
            "failed": failed,
            "total": len(students_data),
        }, status=201)

    @action(
        detail=False,
        methods=["post"],
        url_path="bulk_resolve_conflicts",
    )
    def bulk_resolve_conflicts(self, request):
        """
        ì¶©ëŒ í•´ê²° í›„ ì¬ì‹œë„ â€” ì‚­ì œëœ í•™ìƒê³¼ ë²ˆí˜¸ ì¶©ëŒ ì‹œ ë³µì› ë˜ëŠ” ì˜êµ¬ ì‚­ì œ í›„ ì¬ë“±ë¡
        POST body: {
          "initial_password": "...",
          "send_welcome_message": false,
          "resolutions": [ { "row": 1, "student_id": 123, "action": "restore"|"delete", "student_data": {...} } ]
        }
        """
        password = request.data.get("initial_password") or ""
        if len(str(password)) < 4:
            return Response({"detail": "ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."}, status=400)
        send_welcome = request.data.get("send_welcome_message", False)
        resolutions = request.data.get("resolutions") or []
        if not isinstance(resolutions, (list, tuple)):
            return Response({"detail": "resolutionsëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."}, status=400)

        tenant = request.tenant
        User = get_user_model()
        created_count = 0
        restored_count = 0
        failed = []
        created_students = []

        for r in resolutions:
            row = r.get("row")
            student_id = r.get("student_id")
            action = r.get("action")
            student_data = r.get("student_data") or {}
            if not student_id or action not in ("restore", "delete"):
                failed.append({"row": row, "name": student_data.get("name", ""), "error": "ì˜ëª»ëœ resolution"})
                continue

            try:
                student = Student.objects.filter(
                    tenant=tenant, id=student_id, deleted_at__isnull=False
                ).select_related("user").first()
                if not student:
                    failed.append({"row": row, "name": student_data.get("name", ""), "error": "ì‚­ì œëœ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})
                    continue

                if action == "restore":
                    with transaction.atomic():
                        student.deleted_at = None
                        student.name = (student_data.get("name") or student.name or "").strip()
                        school_val = (student_data.get("school") or "").strip() or None
                        st = student_data.get("school_type", "HIGH") or "HIGH"
                        student.high_school = school_val if st == "HIGH" else None
                        student.middle_school = school_val if st == "MIDDLE" else None
                        student.high_school_class = (student_data.get("high_school_class") or "").strip() or None if st == "HIGH" else None
                        student.major = (student_data.get("major") or "").strip() or None if st == "HIGH" else None
                        student.gender = student_data.get("gender") or None
                        student.grade = student_data.get("grade")
                        student.memo = (student_data.get("memo") or "") or None
                        student.uses_identifier = student_data.get("uses_identifier", False)
                        student.save()
                        if student.user:
                            student.user.is_active = True
                            student.user.save(update_fields=["is_active"])
                        TenantMembership.ensure_active(tenant=tenant, user=student.user, role="student")
                    restored_count += 1
                    created_students.append(student)
                else:
                    with transaction.atomic():
                        Enrollment.objects.filter(student_id=student.id).delete()
                        if student.user_id:
                            student.user.delete()
                        else:
                            student.delete()
                    parent = None
                    parent_phone_raw = str(student_data.get("parent_phone") or student_data.get("parentPhone", "")).replace(" ", "").replace("-", "").replace(".", "")
                    parent_phone = parent_phone_raw if len(parent_phone_raw) >= 11 else ""
                    if parent_phone:
                        parent = ensure_parent_for_student(
                            tenant=tenant,
                            parent_phone=parent_phone,
                            student_name=student_data.get("name", ""),
                            parent_password=password,
                        )
                    phone_raw = str(student_data.get("phone", "")).replace(" ", "").replace("-", "").replace(".", "")
                    phone = phone_raw if phone_raw and len(phone_raw) == 11 and phone_raw.startswith("010") else None
                    parent_phone_val = student_data.get("parent_phone") or student_data.get("parentPhone", "")
                    parent_phone = str(parent_phone_val).replace(" ", "").replace("-", "").replace(".", "")
                    # ps_number: ì„ì˜ 6ìë¦¬ ìë™ ë¶€ì—¬
                    ps_number = _generate_unique_ps_number()
                    # omr_code: í•™ìƒ ì „í™”ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ í•™ìƒ ì „í™”ë²ˆí˜¸ 8ìë¦¬, ì—†ìœ¼ë©´ ë¶€ëª¨ ì „í™”ë²ˆí˜¸ 8ìë¦¬
                    if phone and len(phone) >= 8:
                        omr_code = phone[-8:]
                    elif parent_phone and len(parent_phone) >= 8:
                        omr_code = parent_phone[-8:]
                    else:
                        raise ValueError("í•™ìƒ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ë¶€ëª¨ ì „í™”ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
                    user = User.objects.create_user(
                        username=ps_number,
                        phone=phone or "",  # phoneì´ Noneì´ë©´ ë¹ˆ ë¬¸ìì—´
                        name=student_data.get("name", ""),
                    )
                    user.set_password(password)
                    user.save()
                    school_val = (student_data.get("school") or "").strip() or None
                    st = student_data.get("school_type", "HIGH")
                    high_school = school_val if st == "HIGH" else None
                    middle_school = school_val if st == "MIDDLE" else None
                    high_school_class = (student_data.get("high_school_class") or "").strip() or None if st == "HIGH" else None
                    major = (student_data.get("major") or "").strip() or None if st == "HIGH" else None
                    new_student = Student.objects.create(
                        tenant=tenant,
                        user=user,
                        parent=parent,
                        name=student_data.get("name", ""),
                        phone=phone,  # nullable
                        parent_phone=parent_phone,
                        ps_number=ps_number,
                        omr_code=omr_code,
                        uses_identifier=student_data.get("uses_identifier", False) or (phone is None),
                        gender=student_data.get("gender") or None,
                        school_type=st,
                        high_school=high_school,
                        middle_school=middle_school,
                        high_school_class=high_school_class,
                        major=major,
                        grade=student_data.get("grade"),
                        memo=student_data.get("memo") or None,
                        is_managed=student_data.get("is_managed", True),
                    )
                    TenantMembership.ensure_active(tenant=tenant, user=user, role="student")
                    created_count += 1
                    created_students.append(new_student)
            except Exception as e:
                failed.append({"row": row, "name": student_data.get("name", ""), "error": str(e)})

        if send_welcome and created_students:
            site_url = get_site_url(request)
            parent_pw = {s.parent_phone: password for s in created_students if getattr(s, "parent_phone", None)}
            send_welcome_messages(
                created_students=created_students,
                student_password=password,
                parent_password_by_phone=parent_pw,
                site_url=site_url,
            )

        return Response({
            "created": created_count,
            "restored": restored_count,
            "failed": failed,
        }, status=200)

    @action(
        detail=False,
        methods=["post"],
        url_path="bulk_delete",
    )
    def bulk_delete(self, request):
        """
        ì„ íƒ í•™ìƒ ì¼ê´„ ì†Œí”„íŠ¸ ì‚­ì œ (30ì¼ ë³´ê´€)
        POST body: { "ids": [1, 2, 3, ...] }
        """
        ids = request.data.get("ids") or []
        if not isinstance(ids, (list, tuple)):
            return Response({"detail": "idsëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."}, status=400)
        ids = [int(x) for x in ids if isinstance(x, (int, str)) and str(x).isdigit()]
        if not ids:
            return Response({"detail": "ì‚­ì œí•  IDê°€ ì—†ìŠµë‹ˆë‹¤."}, status=400)

        tenant = request.tenant
        to_delete = list(
            Student.objects.filter(
                tenant=tenant, id__in=ids, deleted_at__isnull=True
            ).select_related("user")
        )
        now = timezone.now()
        with transaction.atomic():
            for student in to_delete:
                student.deleted_at = now
                student.save(update_fields=["deleted_at"])
                if student.user:
                    student.user.is_active = False
                    student.user.save(update_fields=["is_active"])
        return Response({"deleted": len(to_delete)}, status=200)

    @action(
        detail=False,
        methods=["post"],
        url_path="bulk_restore",
    )
    def bulk_restore(self, request):
        """
        ì‚­ì œëœ í•™ìƒ ì¼ê´„ ë³µì›
        POST body: { "ids": [1, 2, 3, ...] }
        """
        ids = request.data.get("ids") or []
        if not isinstance(ids, (list, tuple)):
            return Response({"detail": "idsëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."}, status=400)
        ids = [int(x) for x in ids if isinstance(x, (int, str)) and str(x).isdigit()]
        if not ids:
            return Response({"detail": "ë³µì›í•  IDê°€ ì—†ìŠµë‹ˆë‹¤."}, status=400)

        tenant = request.tenant
        to_restore = list(
            Student.objects.filter(
                tenant=tenant, id__in=ids, deleted_at__isnull=False
            ).select_related("user")
        )
        with transaction.atomic():
            for student in to_restore:
                student.deleted_at = None
                student.save(update_fields=["deleted_at"])
                if student.user:
                    student.user.is_active = True
                    student.user.save(update_fields=["is_active"])
                    TenantMembership.ensure_active(
                        tenant=tenant, user=student.user, role="student"
                    )
        return Response({"restored": len(to_restore)}, status=200)

    @action(
        detail=False,
        methods=["post"],
        url_path="bulk_permanent_delete",
    )
    def bulk_permanent_delete(self, request):
        """
        ì‚­ì œëœ í•™ìƒ ì¦‰ì‹œ ì˜êµ¬ ì‚­ì œ
        POST body: { "ids": [1, 2, 3, ...] }
        """
        ids = request.data.get("ids") or []
        if not isinstance(ids, (list, tuple)):
            return Response({"detail": "idsëŠ” ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤."}, status=400)
        ids = [int(x) for x in ids if isinstance(x, (int, str)) and str(x).isdigit()]
        if not ids:
            return Response({"detail": "ì‚­ì œí•  IDê°€ ì—†ìŠµë‹ˆë‹¤."}, status=400)

        tenant = request.tenant
        to_delete = list(
            Student.objects.filter(
                tenant=tenant, id__in=ids, deleted_at__isnull=False
            ).select_related("user")
        )
        if not to_delete:
            return Response({"deleted": 0}, status=200)

        student_ids = [s.id for s in to_delete]
        user_ids = [s.user_id for s in to_delete if s.user_id]
        deleted = 0
        try:
            with transaction.atomic():
                with connection.cursor() as cursor:
                    # Enrollmentë¥¼ ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ë“¤ì„ ë¨¼ì € ì‚­ì œ (ì¡´ì¬í•˜ëŠ” í…Œì´ë¸”ë§Œ)
                    sub = "SELECT id FROM enrollment_enrollment WHERE student_id IN %s"
                    enrollment_child_tables = [
                        "attendance_attendance",
                        "enrollment_sessionenrollment",
                        "video_videopermission",
                        "video_videoprogress",
                        "video_playbacksession",
                        "video_videoplaybackevent",
                    ]
                    params = [tuple(student_ids)]
                    for tbl in enrollment_child_tables:
                        cursor.execute(
                            "SELECT 1 FROM information_schema.tables "
                            "WHERE table_schema = %s AND table_name = %s",
                            ["public", tbl],
                        )
                        if cursor.fetchone():
                            cursor.execute(
                                f"DELETE FROM {tbl} WHERE enrollment_id IN ({sub})",
                                params,
                            )
                    cursor.execute(
                        "DELETE FROM enrollment_enrollment WHERE student_id IN %s",
                        [tuple(student_ids)],
                    )
                    cursor.execute(
                        "DELETE FROM students_studenttag WHERE student_id IN %s",
                        [tuple(student_ids)],
                    )
                    cursor.execute(
                        "DELETE FROM students_student WHERE id IN %s",
                        [tuple(student_ids)],
                    )
                    if user_ids:
                        cursor.execute(
                            "DELETE FROM core_tenantmembership WHERE user_id IN %s",
                            [tuple(user_ids)],
                        )
                        cursor.execute(
                            "DELETE FROM accounts_user WHERE id IN %s",
                            [tuple(user_ids)],
                        )
                    deleted = len(to_delete)
        except Exception as e:
            import logging
            logging.getLogger(__name__).exception("bulk_permanent_delete failed")
            return Response(
                {"detail": f"ì˜êµ¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜: {str(e)}"},
                status=500,
            )
        return Response({"deleted": deleted}, status=200)

    @action(
        detail=False,
        methods=["get"],
        url_path="me",
        permission_classes=[IsAuthenticated, IsStudent],
    )
    def me(self, request):
        """
        í•™ìƒ ë³¸ì¸ ì •ë³´ ì¡°íšŒ (Anchor API)

        ğŸ”’ ë³´ì•ˆ í¬ì¸íŠ¸
        - request.user + request.tenant ê¸°ì¤€ ê°•ì œ
        - ë‹¤ë¥¸ í•™ì› / ë‹¤ë¥¸ í•™ìƒ ì ‘ê·¼ ë¶ˆê°€
        """
        student = Student.objects.get(
            tenant=request.tenant,
            user=request.user,
        )

        serializer = StudentDetailSerializer(
            student,
            context={"request": request},
        )
        return Response(serializer.data)


==========================================================================================
# FILE: management/__init__.py
==========================================================================================



==========================================================================================
# FILE: management/commands/__init__.py
==========================================================================================



==========================================================================================
# FILE: management/commands/purge_deleted_students.py
==========================================================================================
# PATH: apps/domains/students/management/commands/purge_deleted_students.py
"""
ì‚­ì œëœ í•™ìƒ ì¤‘ 30ì¼ ê²½ê³¼ë¶„ ì˜êµ¬ ì‚­ì œ.

- soft deleteëœ í•™ìƒ(deleted_at ì„¤ì •) ì¤‘ deleted_atì´ 30ì¼ ì´ˆê³¼ëœ ê²½ìš° ì˜êµ¬ ì‚­ì œ
- cronìœ¼ë¡œ ë§¤ì¼ ì‹¤í–‰ ê¶Œì¥

ì‚¬ìš©:
  python manage.py purge_deleted_students
"""
from datetime import timedelta

from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone

from django.contrib.auth import get_user_model

from apps.domains.students.models import Student
from apps.domains.enrollment.models import Enrollment


class Command(BaseCommand):
    help = "30ì¼ ì´ˆê³¼ëœ ì‚­ì œëœ í•™ìƒì„ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤."

    def add_arguments(self, parser):
        parser.add_argument(
            "--days",
            type=int,
            default=30,
            help="ì´ ê¸°ê°„(ì¼) ì´ˆê³¼ ì‹œ ì‚­ì œ (ê¸°ë³¸ 30)",
        )
        parser.add_argument(
            "--dry-run",
            action="store_true",
            help="ì‹¤ì œ ì‚­ì œ ì—†ì´ ëŒ€ìƒë§Œ ì¶œë ¥",
        )

    def handle(self, *args, **options):
        days = options["days"]
        dry_run = options["dry_run"]
        cutoff = timezone.now() - timedelta(days=days)

        to_purge = list(
            Student.objects.filter(deleted_at__lt=cutoff).select_related("user")
        )

        if not to_purge:
            self.stdout.write(f"ì‚­ì œ ëŒ€ìƒ ì—†ìŒ (deleted_at < {cutoff})")
            return

        self.stdout.write(f"ì˜êµ¬ ì‚­ì œ ëŒ€ìƒ: {len(to_purge)}ëª…")
        for s in to_purge[:5]:
            self.stdout.write(f"  - {s.name} (id={s.id}, deleted_at={s.deleted_at})")
        if len(to_purge) > 5:
            self.stdout.write(f"  ... ì™¸ {len(to_purge) - 5}ëª…")

        if dry_run:
            self.stdout.write(self.style.WARNING("--dry-run: ì‹¤ì œ ì‚­ì œí•˜ì§€ ì•ŠìŒ"))
            return

        User = get_user_model()
        deleted = 0
        with transaction.atomic():
            student_ids = [s.id for s in to_purge]
            Enrollment.objects.filter(student_id__in=student_ids).delete()
            for student in to_purge:
                user = student.user
                student.delete()
                if user:
                    user.delete()
                deleted += 1

        self.stdout.write(self.style.SUCCESS(f"ì˜êµ¬ ì‚­ì œ ì™„ë£Œ: {deleted}ëª…"))


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("parents", "0001_initial"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name="Student",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("name", models.CharField(max_length=50)),
                (
                    "gender",
                    models.CharField(
                        blank=True,
                        choices=[("M", "ë‚¨"), ("F", "ì—¬")],
                        max_length=1,
                        null=True,
                    ),
                ),
                (
                    "grade",
                    models.PositiveSmallIntegerField(
                        blank=True, choices=[(1, "1"), (2, "2"), (3, "3")], null=True
                    ),
                ),
                (
                    "school_type",
                    models.CharField(
                        choices=[("MIDDLE", "ì¤‘ë“±"), ("HIGH", "ê³ ë“±")],
                        default="HIGH",
                        max_length=10,
                    ),
                ),
                ("phone", models.CharField(blank=True, max_length=20, null=True)),
                (
                    "parent_phone",
                    models.CharField(blank=True, max_length=20, null=True),
                ),
                (
                    "high_school",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                (
                    "high_school_class",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                ("major", models.CharField(blank=True, max_length=50, null=True)),
                (
                    "middle_school",
                    models.CharField(blank=True, max_length=100, null=True),
                ),
                ("memo", models.TextField(blank=True, null=True)),
                ("is_managed", models.BooleanField(default=True)),
                (
                    "parent",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="students",
                        to="parents.parent",
                    ),
                ),
                (
                    "user",
                    models.OneToOneField(
                        blank=True,
                        help_text="í•™ìƒì´ ë¡œê·¸ì¸ ê³„ì •ì„ ê°€ì§€ëŠ” ê²½ìš° ì—°ê²°",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="student_profile",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "ordering": ["-id"],
            },
        ),
        migrations.CreateModel(
            name="Tag",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=50)),
                ("color", models.CharField(default="#000000", max_length=20)),
            ],
            options={
                "constraints": [
                    models.UniqueConstraint(fields=("name",), name="uniq_tag_name")
                ],
            },
        ),
        migrations.CreateModel(
            name="StudentTag",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "student",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="student_tags",
                        to="students.student",
                    ),
                ),
                (
                    "tag",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, to="students.tag"
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="student",
            name="tags",
            field=models.ManyToManyField(
                blank=True,
                related_name="students",
                through="students.StudentTag",
                to="students.tag",
            ),
        ),
        migrations.AddConstraint(
            model_name="studenttag",
            constraint=models.UniqueConstraint(
                fields=("student", "tag"), name="uniq_student_tag"
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                condition=models.Q(("user__isnull", False)),
                fields=("user",),
                name="uniq_student_user",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0002_add_tenant.py
==========================================================================================

# PATH: apps/domains/students/migrations/0002_add_tenant.py

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0001_initial"),
        ("students", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="student",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="students",
                to="core.tenant",
                default=1,  # âš ï¸ ì´ˆê¸° ë°ì´í„°ìš© (ìš´ì˜ì—ì„œ ì¡°ì •)
            ),
            preserve_default=False,
        ),
    ]


==========================================================================================
# FILE: migrations/0003_remove_student_uniq_student_user_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 07:17

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0003_attendance_expense_add_tenant"),
        ("parents", "0001_initial"),
        ("students", "0002_add_tenant"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.RemoveConstraint(
            model_name="student",
            name="uniq_student_user",
        ),
        migrations.AlterField(
            model_name="student",
            name="tenant",
            field=models.ForeignKey(
                help_text="ì†Œì† í•™ì› (Tenant)",
                on_delete=django.db.models.deletion.CASCADE,
                related_name="students",
                to="core.tenant",
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                condition=models.Q(("user__isnull", False)),
                fields=("tenant", "user"),
                name="uniq_student_user_per_tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0004_remove_student_uniq_student_user_per_tenant_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 19:33

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0005_make_attendance_expense_tenant_not_null"),
        ("parents", "0004_make_parent_tenant_not_null"),
        ("students", "0003_remove_student_uniq_student_user_and_more"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.RemoveConstraint(
            model_name="student",
            name="uniq_student_user_per_tenant",
        ),
        migrations.AddField(
            model_name="student",
            name="omr_code",
            field=models.CharField(blank=True, max_length=8, null=True),
        ),
        migrations.AddField(
            model_name="student",
            name="ps_number",
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AlterField(
            model_name="student",
            name="parent_phone",
            field=models.CharField(max_length=20),
        ),
        migrations.AlterField(
            model_name="student",
            name="phone",
            field=models.CharField(max_length=20),
        ),
        migrations.AlterField(
            model_name="student",
            name="user",
            field=models.OneToOneField(
                help_text="í•™ìƒ ë¡œê·¸ì¸ ê³„ì • (í•„ìˆ˜)",
                on_delete=django.db.models.deletion.CASCADE,
                related_name="student_profile",
                to=settings.AUTH_USER_MODEL,
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                fields=("tenant", "user"), name="uniq_student_user_per_tenant"
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                fields=("tenant", "ps_number"), name="uniq_student_ps_number_per_tenant"
            ),
        ),
        migrations.AddConstraint(
            model_name="student",
            constraint=models.UniqueConstraint(
                fields=("tenant", "omr_code"), name="uniq_student_omr_code_per_tenant"
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0005_alter_student_omr_code_alter_student_ps_number.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 19:36

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("students", "0004_remove_student_uniq_student_user_per_tenant_and_more"),
    ]

    operations = [
        migrations.AlterField(
            model_name="student",
            name="omr_code",
            field=models.CharField(
                help_text="OMR ìë™ì±„ì  ì‹ë³„ì (ì „í™”ë²ˆí˜¸ ë’¤ 8ìë¦¬)", max_length=8
            ),
        ),
        migrations.AlterField(
            model_name="student",
            name="ps_number",
            field=models.CharField(help_text="PS ë²ˆí˜¸ (í•™ì› í•™ìƒ ID)", max_length=20),
        ),
    ]


==========================================================================================
# FILE: migrations/0006_add_student_deleted_at.py
==========================================================================================
# Generated manually

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("students", "0005_alter_student_omr_code_alter_student_ps_number"),
    ]

    operations = [
        migrations.AddField(
            model_name="student",
            name="deleted_at",
            field=models.DateTimeField(
                blank=True,
                db_index=True,
                help_text="ì‚­ì œì¼ì‹œ. ì„¤ì • ì‹œ 30ì¼ ë³´ê´€ í›„ ìë™ ì‚­ì œ",
                null=True,
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0007_add_student_uses_identifier.py
==========================================================================================
# Generated manually

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("students", "0006_add_student_deleted_at"),
    ]

    operations = [
        migrations.AddField(
            model_name="student",
            name="uses_identifier",
            field=models.BooleanField(
                default=False,
                help_text="Trueë©´ í•™ìƒ ì „í™” ì—†ìŒ, ì‹ë³„ì(010+8ìë¦¬)ë¡œ ê°€ì…. í‘œì‹œ ì‹œ 'ì‹ë³„ì XXXX-XXXX'",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0008_make_phone_nullable_remove_omr_unique.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-12 10:32

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("students", "0007_add_student_uses_identifier"),
    ]

    operations = [
        migrations.RemoveConstraint(
            model_name="student",
            name="uniq_student_omr_code_per_tenant",
        ),
        migrations.AlterField(
            model_name="student",
            name="omr_code",
            field=models.CharField(
                help_text="OMR ìë™ì±„ì  ì‹ë³„ì (í•™ìƒ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ë¶€ëª¨ ì „í™”ë²ˆí˜¸ ë’¤ 8ìë¦¬)",
                max_length=8,
            ),
        ),
        migrations.AlterField(
            model_name="student",
            name="phone",
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
    ]


==========================================================================================
# FILE: migrations/0009_alter_student_parent_phone_alter_student_phone_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-12 12:00

from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0014_alter_user_phone_and_more"),
        ("parents", "0006_alter_parent_phone_and_more"),
        ("students", "0008_make_phone_nullable_remove_omr_unique"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name="student",
            name="parent_phone",
            field=models.CharField(
                help_text="ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ (í•˜ì´í”ˆ ì œê±°, ì˜ˆ: 01012345678)",
                max_length=20,
            ),
        ),
        migrations.AlterField(
            model_name="student",
            name="phone",
            field=models.CharField(
                blank=True,
                help_text="ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ (í•˜ì´í”ˆ ì œê±°, ì˜ˆ: 01012345678)",
                max_length=20,
                null=True,
            ),
        ),
        migrations.AddIndex(
            model_name="student",
            index=models.Index(
                fields=["tenant", "created_at"], name="students_st_tenant__c32d68_idx"
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================

