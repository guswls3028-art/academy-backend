====================================================================================================
# BACKEND APP: core
# ROOT PATH: C:\academy\apps\core
====================================================================================================


==========================================================================================
# FILE: CORE_SEAL.md
==========================================================================================
# PATH: apps/core/CORE_SEAL.md
# CORE ë´‰ì¸ ë¬¸ì„œ (SSOT / Enterprise Lock / FINAL)

ë³¸ ë¬¸ì„œëŠ” **apps/core ë„ë©”ì¸**ì„ â€œë´‰ì¸(LOCK)â€í•˜ê¸° ìœ„í•œ ìµœì¢… í—Œë²•ì´ë‹¤.  
ì´ ë¬¸ì„œ ì´í›„ì˜ core ë³€ê²½ì€ **ë¦¬íŒ©í„°ë§ì´ ì•„ë‹ˆë¼ ìš´ì˜ ì‚¬ê³ **ë¡œ ê°„ì£¼í•œë‹¤.

ë³¸ ë´‰ì¸ì€ â€œí”„ë¦¬ë¯¸ì—„ ë‹¨ì¼ ìš´ì˜â€ ìƒíƒœì—ì„œ ì¦‰ì‹œ ì¶œì‹œ ê°€ëŠ¥í•˜ë©°,  
í–¥í›„ ìš”ê¸ˆì œ/ì›Œì»¤/íŠ¸ë˜í”½ í™•ì¥ì€ **core ì™¸ë¶€ ë„ë©”ì¸**ì—ì„œë§Œ ìˆ˜í–‰í•œë‹¤.

---

## 0. ë´‰ì¸ ì„ ì–¸ (Final)

- apps/core ëŠ” **í”Œë«í¼ì˜ í—Œë²• ê³„ì¸µ**ì´ë‹¤.
- ê¸°ëŠ¥ ì¶”ê°€, ì¡°ê±´ ë¶„ê¸°, ì„ì‹œ ìš°íšŒëŠ” **ì „ë©´ ê¸ˆì§€**í•œë‹¤.
- core ëŠ” â€œí™•ì¥ë˜ëŠ” ê³³â€ì´ ì•„ë‹ˆë¼ â€œë‹¤ë¥¸ ë„ë©”ì¸ì´ ë¯¿ê³  ì˜¬ë¼ì„œëŠ” ê³³â€ì´ë‹¤.

---

## 1. Coreì˜ ì±…ì„ ë²”ìœ„ (Hard Boundary)

CoreëŠ” **ì•„ë˜ í•­ëª©ë§Œ** ì±…ì„ì§„ë‹¤.

1. Tenant(í•™ì›) ì‹ë³„ ë° request ë‹¨ìœ„ resolve
2. TenantMembership (tenant ë‚´ ì‚¬ìš©ì ì—­í•  SSOT)
3. Program (tenant 1:1, ë¸Œëœë”©/ë¡œê·¸ì¸/UI/ê¸°ëŠ¥í† ê¸€ SSOT)
4. TenantDomain (host â†’ tenant resolve SSOT)
5. ìµœì†Œ ê¶Œí•œ ê³„ì¸µ (apps/core/permissions.py)
   - TenantResolved
   - TenantResolvedAndMember
   - TenantResolvedAndStaff
   - TenantResolvedAndOwner (admin_app ì „ìš©)
   - IsAdminOrStaff, IsSuperuserOnly (Django admin/ê°œë°œììš©)

âŒ CoreëŠ” ë‹¤ìŒì„ **ì ˆëŒ€ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤**:
- ê³¼ê¸ˆ ë¡œì§
- ìš”ê¸ˆì œ íŒë‹¨
- ì›Œì»¤ ìˆ˜ / GPU / íŠ¸ë˜í”½ ì •ì±…
- ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™(exams, results, clinic ë“±)

---

## 2. í…Œë„ŒíŠ¸ ê²°ì • í—Œë²• (Tenant Resolution Constitution)

### 2.1 ë‹¨ì¼ ì§„ì‹¤ ì›ì¹™ (SSOT)

Tenant ê²°ì • ê²½ë¡œëŠ” **ì˜¤ì§ í•˜ë‚˜**ë§Œ í—ˆìš©í•œë‹¤.

request.get_host() (apps/core/tenant/resolver.py)
â†’ _normalize_host (í¬íŠ¸ ì œê±°, ì†Œë¬¸ì)
â†’ TenantDomain.host ì¡°íšŒ (core_repo.tenant_domain_filter_by_host)
â†’ TenantDomain.tenant

- Header / Query / Cookie / Env ê¸°ë°˜ fallback âŒ
- í…ŒìŠ¤íŠ¸ í¸ì˜ìš© ìš°íšŒ âŒ

---

### 2.2 bypass ê·œì¹™

ì•„ë˜ ê²½ë¡œë§Œ tenant=None í—ˆìš© (apps/api/config/settings/base.py):

```
TENANT_BYPASS_PATH_PREFIXES = [
    "/admin/",
    "/api/v1/token/",
    "/api/v1/token/refresh/",
    "/internal/",
    "/api/v1/internal/",
    "/swagger",
    "/redoc",
]
```

ì˜ë„:
- ë¡œê·¸ì¸ ì „ bootstrap
- í—¬ìŠ¤ì²´í¬
- ë‚´ë¶€ ê´€ë¦¬

ê·¸ ì™¸ ëª¨ë“  ìš”ì²­ì€ tenant resolve ì‹¤íŒ¨ ì‹œ **ì¦‰ì‹œ ì—ëŸ¬**.

---

## 3. TenantDomain ê·œì¹™ (Domain SSOT)

### 3.1 host ì „ì—­ ìœ ë‹ˆí¬

- `TenantDomain.host` ëŠ” **DB ì „ì—­ unique**
- í•˜ë‚˜ì˜ hostëŠ” í•˜ë‚˜ì˜ tenantì—ë§Œ ê·€ì†

---

### 3.2 primary ê·œì¹™ (ë´‰ì¸)

- tenant ë‹¹ `is_primary=True` ëŠ” **ìµœëŒ€ 1ê°œ**
- DB constraint ë¡œ ê°•ì œ

ì˜ë¯¸:
- ëŒ€í‘œ ë„ë©”ì¸ì€ í•˜ë‚˜
- ì»¤ìŠ¤í…€ ë„ë©”ì¸ ì¶”ê°€ëŠ” ê°€ëŠ¥
- ëŒ€í‘œ ë„ë©”ì¸ ë‹¤ì¤‘ í—ˆìš© âŒ

---

### 3.3 active ê·œì¹™

Resolve ëŒ€ìƒ ì¡°ê±´:

TenantDomain.is_active == True
AND
Tenant.is_active == True

yaml
ì½”ë“œ ë³µì‚¬

- ë¹„í™œì„± ìƒíƒœ ì ‘ê·¼ ì‹œ:
  - 403
  - code = tenant_inactive

---

## 4. Program ê·œì¹™ (Tenant 1:1 SSOT)

### 4.1 Programì˜ ì •ì²´ì„±

- Program == â€œì›ì¥ ê°œì¸ í”„ë¡œê·¸ë¨â€
- Tenantì™€ **1:1**
- ëª¨ë“  UI / ë¡œê·¸ì¸ / ê¸°ëŠ¥ ë¶„ê¸°ëŠ” Program ê¸°ì¤€

---

### 4.2 ìƒì„± ì±…ì„ ë‹¨ì¼í™”

Program row ìƒì„±ì€ ë‹¤ìŒ ì‹œì ì—ì„œë§Œ í—ˆìš©:

- Tenant ìƒì„± ì‹œ bootstrap
  - signals
  - migration bootstrap

âŒ API GET ì‹œ ìë™ ìƒì„±(write-on-read) ê¸ˆì§€  
âŒ í”„ë¡ íŠ¸ ì ‘ê·¼ì„ ì´ìœ ë¡œ ìƒì„± ê¸ˆì§€

---

### 4.3 ëˆ„ë½ì€ ìš´ì˜ ì‚¬ê³ 

- Program ëˆ„ë½ ìƒíƒœëŠ” **ì •ìƒ ìƒíƒœê°€ ì•„ë‹˜**
- ë°˜ë“œì‹œ ë‹¤ìŒìœ¼ë¡œ ì‹¤íŒ¨í•œë‹¤ (apps/core/views.py ProgramView.get):

HTTP 404
body: { "detail": "program not initialized for tenant", "code": "program_missing", "tenant": "<tenant.code>" }

ìë™ ìƒì„±ì€ ì¥ì• ë¥¼ ìˆ¨ê¸°ëŠ” í–‰ìœ„ë¡œ ê°„ì£¼í•œë‹¤.

---

## 5. Permission / Role SSOT

### 5.1 ë‹¨ì¼ ì‹ ë¢° ì›ì²œ

- í”„ë¡ íŠ¸ëŠ” roleì„ ì¶”ë¡ í•˜ì§€ ì•ŠëŠ”ë‹¤.
- `/api/v1/core/me/` ì‘ë‹µì˜ `tenantRole` ë§Œ ì‹ ë¢°í•œë‹¤.
- ëª¨ë“  ê¶Œí•œ í•´ì„ì€ Permission classì—ì„œë§Œ ìˆ˜í–‰í•œë‹¤.

---

### 5.2 í—ˆìš© Permission ê³„ì¸µ (ì‹¤ì œ ì½”ë“œ ê¸°ì¤€)

- TenantResolved (apps/core/permissions.py)
- TenantResolvedAndMember
- TenantResolvedAndStaff
- TenantResolvedAndOwner (role=owner ì „ìš©, tenant-branding/tenants API ë“±)

âŒ View ë‚´ë¶€ if role ë¶„ê¸° ê¸ˆì§€  
âŒ í”„ë¡ íŠ¸ ì¡°ê±´ë¬¸ ê¸°ë°˜ ê¶Œí•œ ì²˜ë¦¬ ê¸ˆì§€

---

## 6. ìš”ê¸ˆì œ / ì›Œì»¤ ì •ì±…ì— ëŒ€í•œ í—Œë²•ì  ìœ„ì¹˜

### 6.1 í˜„ì¬ ìš´ì˜ ìƒíƒœ

- ì¶œì‹œ ì´ˆê¸°: **Premium ë‹¨ì¼ ìš´ì˜**
- ëª¨ë“  tenantëŠ” Premiumìœ¼ë¡œ ê°„ì£¼

---

### 6.2 Lite / Basic / Premium í™•ì¥ ì›ì¹™

- ìš”ê¸ˆì œ ê°œë…ì€ **Coreì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤**
- í–¥í›„ í™•ì¥ì€ ë‹¤ìŒ ìœ„ì¹˜ì—ì„œë§Œ í—ˆìš©:
  - Program.feature_flags
  - ë³„ë„ billing / policy / worker ë„ë©”ì¸

CoreëŠ” ìš”ê¸ˆì œ íŒë‹¨ì„ **ì ˆëŒ€ ìˆ˜í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤**.

---

## 7. ë³€ê²½ ê¸ˆì§€ ëª©ë¡ (Hard Lock)

ë‹¤ìŒ í–‰ìœ„ëŠ” **ë´‰ì¸ ìœ„ë°˜**ì´ë‹¤.

- tenant resolve fallback ì¶”ê°€
- Program write-on-read ë¶€í™œ
- TenantDomain primary ë‹¤ì¤‘ í—ˆìš©
- host ì™¸ ì‹ë³„ì ê¸°ë°˜ ë©€í‹°í…Œë„ŒíŠ¸
- coreì— ê³¼ê¸ˆ/ìš”ê¸ˆì œ/ì›Œì»¤ ë¡œì§ ì¶”ê°€

---

## 8. í—ˆìš©ë˜ëŠ” í™•ì¥ (ëª…ì‹œì  í—ˆìš©)

ë‹¤ìŒì€ ë´‰ì¸ ìœ„ë°˜ì´ ì•„ë‹ˆë‹¤.

- TenantDomain ìš´ì˜ í•„ë“œ ì¶”ê°€
  - ì˜ˆ: verified_at, ssl_status
- Program.feature_flags / ui_config í™•ì¥
- TenantMembership role ì¶”ê°€
- core ì™¸ë¶€ ë„ë©”ì¸ì—ì„œì˜ ì •ì±… í™•ì¥

---

## 9. ìµœì¢… ê²°ë¡  (Seal)

apps/coreëŠ” **í”Œë«í¼ì˜ ê¸°ë°˜ í—Œë²•**ì´ë‹¤.  
ì´ ë¬¸ì„œ ì±„íƒ ì´í›„, apps/coreëŠ” **ë´‰ì¸(LOCK)** ìƒíƒœë¡œ ê°„ì£¼í•œë‹¤.

ì´í›„ ê°œë°œì€:
- ë” ë¹ ë¥´ê²Œ
- ë” ì•ˆì „í•˜ê²Œ
- ë” ë‹¨ìˆœí•˜ê²Œ

ì§„í–‰í•  ìˆ˜ ìˆë‹¤.

---

## ğŸ”’ SEAL STATUS

- Status: LOCKED
- Change Policy: Bugfix only
- Owner: Platform Core
- Violation = Production Incident


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
# PATH: apps/core/admin.py
from django.contrib import admin

from apps.core.models import Tenant, TenantDomain, TenantMembership, Program


@admin.register(Tenant)
class TenantAdmin(admin.ModelAdmin):
    list_display = ("id", "name", "code", "is_active")
    list_filter = ("is_active",)
    search_fields = ("name", "code")


@admin.register(TenantDomain)
class TenantDomainAdmin(admin.ModelAdmin):
    list_display = ("id", "tenant", "host", "is_primary", "is_active")
    list_filter = ("is_primary", "is_active")


@admin.register(TenantMembership)
class TenantMembershipAdmin(admin.ModelAdmin):
    list_display = ("id", "tenant", "user", "role", "is_active", "joined_at")
    list_filter = ("role", "is_active")


@admin.register(Program)
class ProgramAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "tenant",
        "display_name",
        "brand_key",
        "login_variant",
        "plan",
        "is_active",
    )
    list_filter = ("login_variant", "plan", "is_active")


==========================================================================================
# FILE: apps.py
==========================================================================================
# PATH: apps/core/apps.py
from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.core"
    label = "core"

    def ready(self):
        # signals import (tenant bootstrap SSOT)
        from . import signals  # noqa: F401


==========================================================================================
# FILE: authentication.py
==========================================================================================
# apps/core/authentication.py

from rest_framework.authentication import SessionAuthentication


class CsrfExemptSessionAuthentication(SessionAuthentication):
    """
    API ì „ìš© SessionAuthentication
    - ë¡œê·¸ì¸ ì„¸ì…˜ì€ ìœ ì§€
    - CSRF ê²€ì‚¬ëŠ” ë¹„í™œì„±í™”
    """
    def enforce_csrf(self, request):
        return


==========================================================================================
# FILE: permissions.py
==========================================================================================
# PATH: apps/core/permissions.py
from rest_framework.permissions import BasePermission

from apps.core.models import TenantMembership


class IsAdminOrStaff(BasePermission):
    """
    Django admin / staff ê³„ì • ì „ìš©
    (í…Œë„ŒíŠ¸ ë¬´ê´€, ë‚´ë¶€ ê´€ë¦¬ìš©)
    """

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and (user.is_superuser or user.is_staff)
        )


class IsSuperuserOnly(BasePermission):
    """
    ìŠˆí¼ìœ ì € ì „ìš© (ê°œë°œì ì „ìš©).
    admin_app ë“± ë³¸ì¸ë§Œ ì“°ëŠ” ê´€ë¦¬ ê¸°ëŠ¥ìš©.
    """

    message = "Superuser only."

    def has_permission(self, request, view):
        user = request.user
        return bool(user and user.is_authenticated and user.is_superuser)


class IsStudent(BasePermission):
    """
    í•™ìƒ ì „ìš© Permission
    - ë¡œê·¸ì¸ í•„ìˆ˜
    - User â†” Student OneToOne ì—°ê²° í•„ìˆ˜
    """

    message = "Student account required."

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and hasattr(user, "student_profile")
        )


class TenantResolved(BasePermission):
    """
    âœ… Tenant Resolve only (SSOT)

    - request.tenant ê°€ resolve ë˜ì–´ì•¼ í•¨
    - ì¸ì¦/ë©¤ë²„ì‹­ì€ ìš”êµ¬í•˜ì§€ ì•ŠìŒ

    ì‚¬ìš©ì²˜:
    - ë¡œê·¸ì¸ ì „ Public bootstrap (Program config, Tenant-bound public metadata)
    """

    message = "Tenant must be resolved."

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        return bool(tenant)


class TenantResolvedAndMember(BasePermission):
    """
    âœ… Core ê¸°ë³¸ Permission (SSOT)

    - request.tenant ê°€ resolve ë˜ì–´ì•¼ í•¨
    - ì¸ì¦ëœ ì‚¬ìš©ì
    - í™œì„± TenantMembership ì¡´ì¬

    â— role ì€ ì—¬ê¸°ì„œ ì ˆëŒ€ í•´ì„í•˜ì§€ ì•ŠìŒ
    """

    message = "Tenant membership required."

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        from academy.adapters.db.django import repositories_core as core_repo
        return core_repo.membership_exists(tenant=tenant, user=user, is_active=True)


class TenantResolvedAndStaff(BasePermission):
    """
    âœ… ìš´ì˜ë ˆë²¨ Staff ì „ìš© Permission

    í—ˆìš© role:
    - owner
    - admin
    - staff
    - teacher

    í•™ìƒ / í•™ë¶€ëª¨ ì ‘ê·¼ ì°¨ë‹¨ìš©
    """

    message = "Staff membership required."

    STAFF_ROLES = ("owner", "admin", "staff", "teacher")

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        from academy.adapters.db.django import repositories_core as core_repo
        return core_repo.membership_exists_staff(tenant=tenant, user=user, staff_roles=self.STAFF_ROLES)


class TenantResolvedAndOwner(BasePermission):
    """
    âœ… Owner ì „ìš© Permission

    admin_app ë“± ownerë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ ê¸°ëŠ¥ìš©.
    """

    message = "Owner membership required."

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        from academy.adapters.db.django import repositories_core as core_repo
        return core_repo.membership_exists_staff(tenant=tenant, user=user, staff_roles=("owner",))


==========================================================================================
# FILE: r2_paths.py
==========================================================================================
# PATH: apps/core/r2_paths.py
"""
R2 ê°ì²´ í‚¤ SSOT â€” ë©€í‹°í…Œë„ŒíŠ¸ + Aurora í™•ì¥ ëŒ€ë¹„

ëª¨ë“  R2 í‚¤ëŠ” tenants/{tenant_id}/... ë¡œ í†µì¼ (storage ì¸ë²¤í† ë¦¬ì™€ ë™ì¼ íŒ¨í„´).
- Video: tenants/{tenant_id}/video/raw|hls/...
- AI:    tenants/{tenant_id}/ai/submissions|exams/...
- Storage(ì¸ë²¤í† ë¦¬): apps.domains.inventory.r2_path.build_r2_key (ê¸°ì¡´ ìœ ì§€)
"""

from __future__ import annotations


def video_raw_key(
    *,
    tenant_id: int,
    session_id: int,
    unique_id: str,
    ext: str,
) -> str:
    """ì›ë³¸ ì˜ìƒ ì—…ë¡œë“œ í‚¤ (presigned PUT ëŒ€ìƒ)."""
    return f"tenants/{tenant_id}/video/raw/{session_id}/{unique_id}.{ext}"


def video_hls_prefix(tenant_id: int, video_id: int) -> str:
    """HLS ì¶œë ¥ prefix (master.m3u8, thumbnail.jpg, v1/index.m3u8 ë“±ì´ ì´ ì•„ë˜ì—)."""
    return f"tenants/{tenant_id}/video/hls/{video_id}"


def video_hls_master_path(tenant_id: int, video_id: int) -> str:
    """HLS ë§ˆìŠ¤í„° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒëŒ€ ê²½ë¡œ (DB hls_path / CDN path)."""
    return f"tenants/{tenant_id}/video/hls/{video_id}/master.m3u8"


def ai_submission_key(
    *,
    tenant_id: int,
    submission_id: int,
    unique_id: str,
    ext: str,
) -> str:
    """ì œì¶œë¬¼ íŒŒì¼ í‚¤ (AI ë²„í‚·)."""
    return f"tenants/{tenant_id}/ai/submissions/{submission_id}/{unique_id}.{ext}"


def ai_exam_asset_key(
    *,
    tenant_id: int,
    exam_id: int,
    asset_type: str,
    unique_id: str,
    ext: str,
) -> str:
    """ì‹œí—˜ ìì‚° íŒŒì¼ í‚¤ (OMR ì‹œíŠ¸, ë¬¸ì œ PDF ë“±)."""
    return f"tenants/{tenant_id}/ai/exams/{exam_id}/assets/{asset_type}/{unique_id}.{ext}"


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/core/serializers.py
from rest_framework import serializers
from django.contrib.auth import get_user_model

from apps.core.models import Attendance, Expense, TenantMembership, Program
from academy.adapters.db.django import repositories_core as core_repo

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    tenantRole = serializers.SerializerMethodField()
    linkedStudentId = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = [
            "id",
            "username",
            "name",
            "phone",
            "is_staff",
            "is_superuser",
            "tenantRole",
            "linkedStudentId",
        ]

    def get_tenantRole(self, user):
        request = self.context.get("request")
        tenant = getattr(request, "tenant", None)

        if not tenant:
            return None

        membership = core_repo.membership_get(tenant=tenant, user=user, is_active=True)
        return membership.role if membership else None

    def get_linkedStudentId(self, user):
        """í•™ë¶€ëª¨(role=parent)ì¼ ë•Œ ì—°ê²°ëœ í•™ìƒ ID (ì²« ë²ˆì§¸)"""
        request = self.context.get("request")
        tenant = getattr(request, "tenant", None)
        if not tenant:
            return None

        membership = core_repo.membership_get(tenant=tenant, user=user, is_active=True)
        if not membership or membership.role != "parent":
            return None

        parent = core_repo.parent_get_by_user(user)
        if not parent:
            return None
        first_student = parent.students.filter(deleted_at__isnull=True).first()
        return first_student.id if first_student else None


class ProgramPublicSerializer(serializers.ModelSerializer):
    tenantCode = serializers.SerializerMethodField()

    class Meta:
        model = Program
        fields = [
            "tenantCode",
            "display_name",
            "brand_key",
            "login_variant",
            "plan",
            "feature_flags",
            "ui_config",
            "is_active",
        ]

    def get_tenantCode(self, obj: Program) -> str:
        return obj.tenant.code


class ProgramUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Program
        fields = [
            "display_name",
            "brand_key",
            "login_variant",
            "plan",
            "feature_flags",
            "ui_config",
            "is_active",
        ]


class ProfileSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ["id", "name", "phone"]


class AttendanceSerializer(serializers.ModelSerializer):
    class Meta:
        model = Attendance
        fields = "__all__"
        read_only_fields = ["user", "tenant", "duration_hours", "amount"]


class ExpenseSerializer(serializers.ModelSerializer):
    class Meta:
        model = Expense
        fields = "__all__"
        read_only_fields = ["user", "tenant"]


==========================================================================================
# FILE: signals.py
==========================================================================================
# PATH: apps/core/signals.py
from __future__ import annotations

from django.db import transaction
from django.db.models.signals import post_save
from django.dispatch import receiver

from apps.core.models import Tenant, Program
from academy.adapters.db.django import repositories_core as core_repo


def _normalize_host(host: str) -> str:
    v = str(host or "").strip().lower()
    if not v:
        return ""
    return v.split(":")[0].strip()


@receiver(post_save, sender=Tenant)
def bootstrap_tenant_core_rows(sender, instance: Tenant, created: bool, **kwargs):
    if not created:
        return

    host = _normalize_host(instance.code)

    with transaction.atomic():
        core_repo.program_get_or_create(
            instance,
            defaults={
                "display_name": "HakwonPlus",
                "brand_key": "hakwonplus",
                "login_variant": Program.LoginVariant.HAKWONPLUS,
                "plan": Program.Plan.PREMIUM,
                "feature_flags": {
                    "student_app_enabled": True,
                    "admin_enabled": True,
                    "attendance_hourly_rate": 15000,
                },
                "ui_config": {
                    "login_title": "HakwonPlus ê´€ë¦¬ì ë¡œê·¸ì¸",
                    "login_subtitle": "",
                },
                "is_active": True,
            },
        )

        if host:
            core_repo.tenant_domain_get_or_create_by_defaults(
                host,
                defaults={
                    "tenant": instance,
                    "is_primary": True,
                    "is_active": True,
                },
            )


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/core/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter

from apps.core.views import (
    MeView,
    ProgramView,
    ProfileViewSet,
    MyAttendanceViewSet,
    MyExpenseViewSet,
    JobProgressView,
    TenantBrandingView,
    TenantBrandingUploadLogoView,
    TenantListView,
    TenantDetailView,
    TenantCreateView,
    TenantOwnerView,
    TenantOwnerListView,
    TenantOwnerDetailView,
)

router = DefaultRouter()
router.register("profile", ProfileViewSet, basename="profile")
router.register("profile/attendance", MyAttendanceViewSet, basename="my-attendance")
router.register("profile/expenses", MyExpenseViewSet, basename="my-expense")

urlpatterns = [
    path("me/", MeView.as_view(), name="core-me"),
    path("program/", ProgramView.as_view(), name="core-program"),
    path("job_progress/<str:job_id>/", JobProgressView.as_view(), name="core-job-progress"),
    path("tenant-branding/<int:tenant_id>/", TenantBrandingView.as_view(), name="core-tenant-branding"),
    path("tenant-branding/<int:tenant_id>/upload-logo/", TenantBrandingUploadLogoView.as_view(), name="core-tenant-branding-upload-logo"),
    path("tenants/", TenantListView.as_view(), name="core-tenants"),
    path("tenants/<int:tenant_id>/", TenantDetailView.as_view(), name="core-tenant-detail"),
    path("tenants/create/", TenantCreateView.as_view(), name="core-tenant-create"),
    path("tenants/<int:tenant_id>/owner/", TenantOwnerView.as_view(), name="core-tenant-owner"),
    path("tenants/<int:tenant_id>/owners/", TenantOwnerListView.as_view(), name="core-tenant-owners"),
    path("tenants/<int:tenant_id>/owners/<int:user_id>/", TenantOwnerDetailView.as_view(), name="core-tenant-owner-detail"),
    path("", include(router.urls)),
]


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/core/views.py
from datetime import datetime
from django.db import transaction
from django.db.models import Sum

from rest_framework.views import APIView
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated, AllowAny
from rest_framework.response import Response

from drf_yasg.utils import swagger_auto_schema

from apps.core.models import Attendance, Expense, Program, Tenant, TenantDomain, TenantMembership
from academy.adapters.db.django import repositories_core as core_repo
from apps.core.permissions import IsAdminOrStaff, IsSuperuserOnly
from academy.adapters.db.django import repositories_ai as ai_repo
from apps.core.permissions import (
    TenantResolved,
    TenantResolvedAndMember,
    TenantResolvedAndStaff,
    TenantResolvedAndOwner,
)
from apps.core.serializers import (
    UserSerializer,
    ProfileSerializer,
    AttendanceSerializer,
    ExpenseSerializer,
    ProgramPublicSerializer,
    ProgramUpdateSerializer,
)
from apps.core.services.attendance_policy import calculate_duration_hours, calculate_amount
from apps.core.services.expense_policy import normalize_expense_amount


# --------------------------------------------------
# Auth: /core/me/
# --------------------------------------------------

class MeView(APIView):
    """
    âœ… Core Auth Endpoint (Enterprise Final)

    - ì¸ì¦ í•„ìˆ˜
    - tenant í™•ì • í•„ìˆ˜
    - TenantMembership ì¡´ì¬ í•„ìˆ˜
    - tenant ê¸°ì¤€ role ì„ tenantRole ë¡œ ë°˜í™˜
    - í”„ë¡ íŠ¸ëŠ” ì´ ì‘ë‹µë§Œ ì‹ ë¢° (SSOT)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndMember]

    @swagger_auto_schema(auto_schema=None)
    def get(self, request):
        serializer = UserSerializer(
            request.user,
            context={"request": request},  # âœ… í•µì‹¬
        )
        return Response(serializer.data)


# --------------------------------------------------
# Program: /core/program/
# --------------------------------------------------

class ProgramView(APIView):
    """
    âœ… Program SSOT Endpoint (Enterprise)

    GET  /api/v1/core/program/
      - ë¡œê·¸ì¸ ì „ AllowAny
      - tenant resolve í•„ìˆ˜
      - DB write ë°œìƒ ê¸ˆì§€ (read-only ë³´ì¥)

    PATCH /api/v1/core/program/
      - Staff only
      - tenant resolve í•„ìˆ˜
      - í•´ë‹¹ tenantì˜ Programë§Œ ìˆ˜ì • ê°€ëŠ¥ (1:1)
    """

    @swagger_auto_schema(auto_schema=None)
    def get(self, request):
        tenant = getattr(request, "tenant", None)
        if tenant is None:
            return Response({"detail": "tenant must be resolved"}, status=400)

        program = core_repo.program_get_by_tenant(tenant)
        if program is None:
            # ìš´ì˜ì—ì„œëŠ” Tenant ìƒì„± ì‹œ signalìœ¼ë¡œ Program ìƒì„±. ì—†ìœ¼ë©´ 404 (í”„ë¡ íŠ¸ì—ì„œ ì²˜ë¦¬)
            return Response(
                {
                    "detail": "program not initialized for tenant",
                    "code": "program_missing",
                    "tenant": tenant.code,
                },
                status=404,
            )

        data = ProgramPublicSerializer(program).data
        return Response(data)

    @swagger_auto_schema(auto_schema=None)
    def patch(self, request):
        tenant = getattr(request, "tenant", None)
        if tenant is None:
            return Response({"detail": "tenant must be resolved"}, status=400)

        program = core_repo.program_get_by_tenant(tenant)
        if program is None:
            return Response(
                {
                    "detail": "program not initialized for tenant",
                    "code": "program_missing",
                    "tenant": tenant.code,
                },
                status=404,
            )

        serializer = ProgramUpdateSerializer(
            program,
            data=(request.data if isinstance(request.data, dict) else {}),
            partial=True,
        )
        serializer.is_valid(raise_exception=True)
        serializer.save()

        return Response(ProgramPublicSerializer(program).data)

    def get_permissions(self):
        if self.request.method == "GET":
            return [AllowAny(), TenantResolved()]
        return [IsAuthenticated(), TenantResolvedAndStaff()]


# --------------------------------------------------
# Profile (Staff ì˜ì—­)
# --------------------------------------------------

class ProfileViewSet(viewsets.ViewSet):
    """
    ì§ì›/ê°•ì‚¬/ê´€ë¦¬ì ì „ìš© Profile API
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["get"])
    def me(self, request):
        serializer = ProfileSerializer(request.user)
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["patch"])
    def update_me(self, request):
        serializer = ProfileSerializer(
            request.user,
            data=request.data,
            partial=True,
        )
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["post"], url_path="change-password")
    def change_password(self, request):
        old_pw = request.data.get("old_password")
        new_pw = request.data.get("new_password")

        if not old_pw or not new_pw:
            return Response({"error": "old_password, new_password í•„ìš”"}, status=400)

        if not request.user.check_password(old_pw):
            return Response({"error": "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."}, status=400)

        request.user.set_password(new_pw)
        request.user.save()

        return Response({"message": "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ"})


# --------------------------------------------------
# Attendance (Staff ì „ìš©)
# --------------------------------------------------

class MyAttendanceViewSet(viewsets.ModelViewSet):
    """
    ì§ì› ê·¼íƒœ ê´€ë¦¬ (tenant ë‹¨ìœ„ ê²©ë¦¬)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    serializer_class = AttendanceSerializer

    def get_queryset(self):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = core_repo.attendance_filter(user=user, tenant=tenant, month=month)
        return qs

    def perform_create(self, serializer):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)

        start = self.request.data.get("start_time")
        end = self.request.data.get("end_time")

        duration = calculate_duration_hours(start, end)
        amount = calculate_amount(tenant, duration) if tenant is not None else 0

        serializer.save(
            tenant=tenant,
            user=user,
            duration_hours=duration,
            amount=amount,
        )

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["get"], url_path="summary")
    def summary(self, request):
        user = request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = core_repo.attendance_filter(user=user, tenant=tenant, month=month)
        total_hours = qs.aggregate(Sum("duration_hours"))["duration_hours__sum"] or 0
        total_amount = qs.aggregate(Sum("amount"))["amount__sum"] or 0
        after_tax = int(total_amount * 0.967)

        return Response(
            {
                "total_hours": total_hours,
                "total_amount": total_amount,
                "total_after_tax": after_tax,
            }
        )


# --------------------------------------------------
# Expense (Staff ì „ìš©)
# --------------------------------------------------

class MyExpenseViewSet(viewsets.ModelViewSet):
    """
    ì§ì› ì§€ì¶œ ê´€ë¦¬ (tenant ë‹¨ìœ„ ê²©ë¦¬)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    serializer_class = ExpenseSerializer

    def get_queryset(self):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = core_repo.expense_filter(user=user, tenant=tenant, month=month)
        return qs

    def perform_create(self, serializer):
        tenant = getattr(self.request, "tenant", None)
        raw_amount = self.request.data.get("amount")
        serializer.save(
            tenant=tenant,
            user=self.request.user,
            amount=normalize_expense_amount(raw_amount),
        )


# --------------------------------------------------
# Worker job progress (Redis) â€” ìš°í•˜ë‹¨ ì‹¤ì‹œê°„ í”„ë¡œê·¸ë˜ìŠ¤ë°”ìš©
# --------------------------------------------------


class JobProgressView(APIView):
    """
    GET /api/v1/core/job_progress/<job_id>/
    Redisì— ê¸°ë¡ëœ ì›Œì»¤ ì§„í–‰ë¥  ì¡°íšŒ. tenant ì†Œì† jobë§Œ í—ˆìš©.
    """
    permission_classes = [IsAuthenticated]

    def get(self, request, job_id: str):
        from src.infrastructure.cache.redis_progress_adapter import RedisProgressAdapter

        tenant = getattr(request, "tenant", None)
        if not tenant:
            return Response({"detail": "tenantê°€ í•„ìš”í•©ë‹ˆë‹¤."}, status=400)
        job = ai_repo.get_job_model_for_status(job_id, str(tenant.id))
        if not job:
            return Response({"detail": "í•´ë‹¹ ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}, status=404)
        progress = RedisProgressAdapter().get_progress(job_id)
        if not progress:
            return Response({"step": None, "percent": None})
        return Response({
            "step": progress.get("step"),
            "percent": progress.get("percent"),
            **{k: v for k, v in progress.items() if k not in ("step", "percent")},
        })


# --------------------------------------------------
# Tenant Branding (admin_app) â€” í…Œë„ŒíŠ¸ë³„ ë¡œê³ Â·ë¡œê·¸ì¸ íƒ€ì´í‹€, R2 academy-admin
# --------------------------------------------------


def _tenant_branding_dto(program):
    """Program.ui_config â†’ TenantBrandingDto í˜•íƒœ."""
    cfg = getattr(program, "ui_config", None) or {}
    return {
        "tenantId": program.tenant_id,
        "loginTitle": cfg.get("login_title") or "",
        "loginSubtitle": cfg.get("login_subtitle") or "",
        "logoUrl": cfg.get("logo_url") or None,
        "windowTitle": cfg.get("window_title") or "",
        "displayName": program.display_name,
    }


class TenantBrandingView(APIView):
    """
    GET/PATCH /api/v1/core/tenant-branding/<tenant_id>/
    admin_app ì „ìš© â€” owner roleë§Œ. Program.ui_config ê¸°ë°˜.
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def get(self, request, tenant_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return Response({"detail": "Tenant not found."}, status=404)
        program = core_repo.program_get_by_tenant(tenant)
        if not program:
            return Response({"detail": "Program not found for tenant."}, status=404)
        return Response(_tenant_branding_dto(program))

    def patch(self, request, tenant_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return Response({"detail": "Tenant not found."}, status=404)
        program = core_repo.program_get_by_tenant(tenant)
        if not program:
            return Response({"detail": "Program not found for tenant."}, status=404)
        cfg = dict(program.ui_config or {})
        if "loginTitle" in request.data:
            cfg["login_title"] = request.data.get("loginTitle")
        if "loginSubtitle" in request.data:
            cfg["login_subtitle"] = request.data.get("loginSubtitle")
        if "logoUrl" in request.data:
            cfg["logo_url"] = request.data.get("logoUrl") or None
        if "windowTitle" in request.data:
            cfg["window_title"] = request.data.get("windowTitle") or None
        if "displayName" in request.data:
            program.display_name = request.data.get("displayName")
            program.save(update_fields=["display_name"])
        program.ui_config = cfg
        program.save(update_fields=["ui_config"])
        return Response(_tenant_branding_dto(program))


class TenantBrandingUploadLogoView(APIView):
    """
    POST /api/v1/core/tenant-branding/<tenant_id>/upload-logo/
    multipart/form-data file â†’ R2 academy-admin, Program.ui_config.logo_url ì €ì¥.
    admin_app ì „ìš© â€” owner roleë§Œ.
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def post(self, request, tenant_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return Response({"detail": "Tenant not found."}, status=404)
        program = core_repo.program_get_by_tenant(tenant)
        if not program:
            return Response({"detail": "Program not found for tenant."}, status=404)

        file = request.FILES.get("file")
        if not file:
            return Response({"detail": "file is required."}, status=400)
        if not (getattr(file, "content_type", "") or "").startswith("image/"):
            return Response({"detail": "Image file required."}, status=400)

        ext = (file.name or "").split(".")[-1].lower() or "png"
        if ext not in ("png", "jpg", "jpeg", "gif", "webp", "svg"):
            ext = "png"
        key = f"tenant-logos/{tenant_id}/logo.{ext}"

        from apps.infrastructure.storage import r2 as r2_storage
        r2_storage.upload_fileobj_to_r2_admin(
            fileobj=file,
            key=key,
            content_type=file.content_type or "image/png",
        )

        logo_url = r2_storage.get_admin_object_public_url(key=key)
        if not logo_url:
            logo_url = r2_storage.generate_presigned_get_url_admin(key=key, expires_in=86400 * 7)

        cfg = dict(program.ui_config or {})
        cfg["logo_url"] = logo_url
        program.ui_config = cfg
        program.save(update_fields=["ui_config"])

        return Response({"logoUrl": logo_url})


# --------------------------------------------------
# Tenant Management: /core/tenants/
# --------------------------------------------------

class TenantListView(APIView):
    """
    GET /api/v1/core/tenants/
    admin_app ì „ìš© â€” owner roleë§Œ. ëª¨ë“  í…Œë„ŒíŠ¸ ëª©ë¡.
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def get(self, request):
        tenants = Tenant.objects.all().order_by('id')
        data = []
        for tenant in tenants:
            domains = TenantDomain.objects.filter(tenant=tenant, is_active=True)
            primary_domain = domains.filter(is_primary=True).first()
            data.append({
                "id": tenant.id,
                "code": tenant.code,
                "name": tenant.name,
                "isActive": tenant.is_active,
                "primaryDomain": primary_domain.host if primary_domain else None,
                "domains": [d.host for d in domains],
            })
        return Response(data)


class TenantDetailView(APIView):
    """
    GET/PATCH /api/v1/core/tenants/<tenant_id>/
    admin_app ì „ìš© â€” owner roleë§Œ. í…Œë„ŒíŠ¸ ìƒì„¸ ì •ë³´.
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def get(self, request, tenant_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return Response({"detail": "Tenant not found."}, status=404)
        
        domains = TenantDomain.objects.filter(tenant=tenant, is_active=True)
        primary_domain = domains.filter(is_primary=True).first()
        program = core_repo.program_get_by_tenant(tenant)
        
        data = {
            "id": tenant.id,
            "code": tenant.code,
            "name": tenant.name,
            "isActive": tenant.is_active,
            "primaryDomain": primary_domain.host if primary_domain else None,
            "domains": [{"host": d.host, "isPrimary": d.is_primary} for d in domains],
            "hasProgram": program is not None,
        }
        return Response(data)

    def patch(self, request, tenant_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return Response({"detail": "Tenant not found."}, status=404)
        
        if "name" in request.data:
            tenant.name = request.data["name"]
        if "isActive" in request.data:
            tenant.is_active = bool(request.data["isActive"])
        tenant.save(update_fields=["name", "is_active"])
        
        return self.get(request, tenant_id)


class TenantCreateView(APIView):
    """
    POST /api/v1/core/tenants/
    admin_app ì „ìš© â€” owner roleë§Œ. ìƒˆ í…Œë„ŒíŠ¸ ìƒì„±.
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def post(self, request):
        code = request.data.get("code")
        name = request.data.get("name")
        domain = request.data.get("domain")
        
        if not code or not name:
            return Response({"detail": "code and name are required."}, status=400)
        
        # í…Œë„ŒíŠ¸ ìƒì„±
        tenant, created = core_repo.tenant_get_or_create(
            code,
            defaults={"name": name, "is_active": True}
        )
        
        if not created:
            return Response({"detail": f"Tenant with code '{code}' already exists."}, status=400)
        
        # ë„ë©”ì¸ ì„¤ì •
        if domain:
            domain_obj, _ = core_repo.tenant_domain_get_or_create_by_defaults(
                domain,
                defaults={
                    "tenant": tenant,
                    "is_primary": True,
                    "is_active": True,
                }
            )
        
        # Program ìƒì„±
        program, _ = core_repo.program_get_or_create(
            tenant,
            defaults={
                "display_name": name,
                "brand_key": code,
                "login_variant": Program.LoginVariant.HAKWONPLUS,
                "plan": Program.Plan.PREMIUM,
                "feature_flags": {
                    "student_app_enabled": True,
                    "admin_enabled": True,
                },
                "ui_config": {"login_title": name},
                "is_active": True,
            }
        )
        
        return Response({
            "id": tenant.id,
            "code": tenant.code,
            "name": tenant.name,
        }, status=201)


class TenantOwnerView(APIView):
    """
    POST /api/v1/core/tenants/<tenant_id>/owner/
    admin_app ì „ìš© â€” owner roleë§Œ. í…Œë„ŒíŠ¸ì— owner ë“±ë¡.
    Userê°€ ì—†ìœ¼ë©´ ìƒì„± ê°€ëŠ¥ (username, password í•„ìˆ˜; name, phone ì„ íƒ).
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def post(self, request, tenant_id: int):
        import logging
        logger = logging.getLogger(__name__)
        try:
            tenant = core_repo.tenant_get_by_id_any(tenant_id)
            if not tenant:
                return Response({"detail": "Tenant not found."}, status=404)

            username = request.data.get("username")
            password = request.data.get("password")
            name = request.data.get("name")
            phone = request.data.get("phone")

            if not username:
                return Response({"detail": "username is required."}, status=400)

            from django.contrib.auth import get_user_model
            User = get_user_model()

            with transaction.atomic():
                user = core_repo.user_get_by_username(username)

                if user:
                    if password:
                        user.set_password(password)
                        user.save(update_fields=["password"])
                    if name is not None:
                        user.name = name
                    if phone is not None:
                        user.phone = phone
                    if name is not None or phone is not None:
                        user.save(update_fields=["name", "phone"])
                else:
                    if not password:
                        return Response(
                            {"detail": "password is required when creating a new user."},
                            status=400,
                        )
                    user = User.objects.create_user(
                        username=username,
                        password=password,
                        email="",
                        name=name or "",
                        phone=phone or "",
                    )

                membership = core_repo.membership_ensure_active(
                    tenant=tenant,
                    user=user,
                    role="owner",
                )
                if membership.role != "owner":
                    membership.role = "owner"
                    membership.save(update_fields=["role"])

            return Response({
                "tenantId": tenant.id,
                "tenantCode": tenant.code,
                "userId": user.id,
                "username": user.username,
                "name": getattr(user, "name", "") or "",
                "role": membership.role,
            })
        except Exception as e:
            logger.exception("TenantOwnerView post failed: %s", e)
            return Response(
                {"detail": str(e)},
                status=500,
            )


class TenantOwnerListView(APIView):
    """
    GET /api/v1/core/tenants/<tenant_id>/owners/
    admin_app ì „ìš© â€” owner roleë§Œ. í•´ë‹¹ í…Œë„ŒíŠ¸ì˜ Owner ëª©ë¡ ì¡°íšŒ.
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def get(self, request, tenant_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return Response({"detail": "Tenant not found."}, status=404)
        memberships = (
            TenantMembership.objects.filter(
                tenant=tenant,
                role="owner",
                is_active=True,
            )
            .select_related("user")
            .order_by("user__username")
        )
        data = [
            {
                "userId": m.user_id,
                "username": m.user.username,
                "name": getattr(m.user, "name", "") or "",
                "phone": getattr(m.user, "phone", "") or "",
                "role": m.role,
            }
            for m in memberships
        ]
        return Response(data)


class TenantOwnerDetailView(APIView):
    """
    PATCH /api/v1/core/tenants/<tenant_id>/owners/<user_id>/
      - owner ì‚¬ìš©ì ì´ë¦„/ì „í™”ë²ˆí˜¸ ìˆ˜ì •
    DELETE /api/v1/core/tenants/<tenant_id>/owners/<user_id>/
      - í•´ë‹¹ í…Œë„ŒíŠ¸ì—ì„œ owner ì œê±° (TenantMembership is_active=False)
    """
    permission_classes = [IsAuthenticated, TenantResolvedAndOwner]

    def _get_owner_membership(self, tenant_id: int, user_id: int):
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            return None, None, 404
        from django.contrib.auth import get_user_model
        User = get_user_model()
        user = User.objects.filter(id=user_id).first()
        if not user:
            return None, None, 404
        membership = TenantMembership.objects.filter(
            tenant=tenant,
            user=user,
            role="owner",
            is_active=True,
        ).first()
        if not membership:
            return None, None, 404
        return tenant, membership, None

    def patch(self, request, tenant_id: int, user_id: int):
        tenant, membership, err = self._get_owner_membership(tenant_id, user_id)
        if err:
            return Response({"detail": "Owner not found."}, status=err)
        user = membership.user
        if "name" in request.data:
            user.name = request.data.get("name") or ""
        if "phone" in request.data:
            user.phone = request.data.get("phone") or ""
        user.save(update_fields=["name", "phone"])
        return Response({
            "userId": user.id,
            "username": user.username,
            "name": getattr(user, "name", "") or "",
            "role": membership.role,
        })

    def delete(self, request, tenant_id: int, user_id: int):
        tenant, membership, err = self._get_owner_membership(tenant_id, user_id)
        if err:
            return Response({"detail": "Owner not found."}, status=err)
        membership.is_active = False
        membership.save(update_fields=["is_active"])
        return Response(status=204)


==========================================================================================
# FILE: db/__init__.py
==========================================================================================
from .tenant_queryset import TenantQuerySet

__all__ = ["TenantQuerySet"]


==========================================================================================
# FILE: db/tenant_queryset.py
==========================================================================================
# ======================================================================
# PATH: apps/core/db/tenant_queryset.py
# ======================================================================
from __future__ import annotations

from django.db import models

from apps.core.tenant.context import get_current_tenant


class TenantQuerySet(models.QuerySet):
    """
    Tenant-aware QuerySet (SSOT)

    ê·œì¹™:
    - tenantê°€ resolveë˜ì§€ ì•Šìœ¼ë©´ ê²°ê³¼ëŠ” í•­ìƒ empty
    - domain ëª¨ë¸ì— tenant FKê°€ ë¶™ëŠ” ìˆœê°„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
    """

    def for_current_tenant(self):
        tenant = get_current_tenant()
        if tenant is None:
            return self.none()
        return self.filter(tenant=tenant)

    def require_tenant(self):
        """
        ë‚´ë¶€/ìš´ì˜ ë¡œì§ì—ì„œ tenant ê°•ì œìš©
        """
        tenant = get_current_tenant()
        if tenant is None:
            raise RuntimeError("Tenant is required but not resolved")
        return self.filter(tenant=tenant)


==========================================================================================
# FILE: management/__init__.py
==========================================================================================



==========================================================================================
# FILE: management/commands/__init__.py
==========================================================================================



==========================================================================================
# FILE: management/commands/check_tenants.py
==========================================================================================
# PATH: apps/core/management/commands/check_tenants.py
"""
DB í…Œë„ŒíŠ¸ ëª©ë¡ í™•ì¸ (ID, code, name, í™œì„± ì—¬ë¶€).

ì‚¬ìš©:
  python manage.py check_tenants
"""
from django.core.management.base import BaseCommand
from django.db import connection


class Command(BaseCommand):
    help = "List all tenants (id, code, name, active)."

    def handle(self, *args, **options):
        with connection.cursor() as cursor:
            cursor.execute("""
                SELECT id, code, name, is_active
                FROM core_tenant
                ORDER BY id
            """)
            rows = cursor.fetchall()
        self.stdout.write("All tenants:")
        self.stdout.write("=" * 60)
        for row in rows:
            tid, code, name, is_active = row
            status = "ACTIVE" if is_active else "INACTIVE"
            self.stdout.write(f"ID: {tid:5d} | Code: {code:15s} | Name: {name:30s} | {status}")
        self.stdout.write("")
        self.stdout.write(f"Total: {len(rows)} tenants")


==========================================================================================
# FILE: management/commands/delete_r2_legacy.py
==========================================================================================
# PATH: apps/core/management/commands/delete_r2_legacy.py
"""
R2 ë²„í‚·ì—ì„œ ë ˆê°€ì‹œ prefix(ë˜ëŠ” ì „ì²´) ê°ì²´ ì¼ê´„ ì‚­ì œ.

ì‚¬ìš©:
  # ë ˆê°€ì‹œ prefixë§Œ ì‚­ì œ (ê¸°ë³¸ prefix='legacy/')
  python manage.py delete_r2_legacy

  # í†µìœ¼ë¡œ ë‹¤ ì§€ìš°ê¸° (ë²„í‚· ì „ì²´) â€” ê²½ë¡œ/í‚¤ ì„¤ì • ë‹¤ì‹œ í•  ë•Œ
  python manage.py delete_r2_legacy --wipe --confirm-wipe
  python manage.py delete_r2_legacy --wipe --confirm-wipe --bucket video   # videoë§Œ ì „ì²´ ì‚­ì œ
  python manage.py delete_r2_legacy --wipe --dry-run   # ì „ì²´ ì‚­ì œ ëŒ€ìƒë§Œ í™•ì¸

  # ì‚­ì œ ëŒ€ìƒë§Œ í™•ì¸ (ì‚­ì œ ì•ˆ í•¨)
  python manage.py delete_r2_legacy --dry-run

  # íŠ¹ì • prefix ì§€ì •
  python manage.py delete_r2_legacy --prefix "old/"
  python manage.py delete_r2_legacy --bucket video --prefix "legacy/"
"""
from __future__ import annotations

import logging
from django.conf import settings
from django.core.management.base import BaseCommand

logger = logging.getLogger(__name__)

# delete_objects ìµœëŒ€ 1000ê°œ
DELETE_BATCH = 1000
LIST_PAGE = 1000


def get_s3_client():
    import boto3
    return boto3.client(
        "s3",
        endpoint_url=settings.R2_ENDPOINT,
        aws_access_key_id=settings.R2_ACCESS_KEY,
        aws_secret_access_key=settings.R2_SECRET_KEY,
        region_name="auto",
    )


def get_bucket_name(bucket_key: str) -> str:
    if bucket_key == "ai":
        return getattr(settings, "R2_AI_BUCKET", "academy-ai")
    if bucket_key == "video":
        return getattr(settings, "R2_VIDEO_BUCKET", "academy-video")
    if bucket_key == "storage":
        return getattr(settings, "R2_STORAGE_BUCKET", "academy-storage")
    raise ValueError(f"Unknown bucket key: {bucket_key}")


def list_and_delete_prefix(s3, bucket: str, prefix: str, dry_run: bool, stdout):
    total_listed = 0
    total_deleted = 0
    continuation_token = None

    while True:
        list_kw = {
            "Bucket": bucket,
            "MaxKeys": LIST_PAGE,
        }
        if prefix:
            list_kw["Prefix"] = prefix
        if continuation_token:
            list_kw["ContinuationToken"] = continuation_token

        resp = s3.list_objects_v2(**list_kw)
        contents = resp.get("Contents") or []
        total_listed += len(contents)

        if not contents:
            if not resp.get("IsTruncated"):
                break
            continuation_token = resp.get("NextContinuationToken")
            continue

        keys_to_delete = [{"Key": obj["Key"]} for obj in contents]
        if dry_run:
            for k in keys_to_delete[:5]:
                stdout.write(f"  (dry-run) would delete: {k['Key']}")
            if len(keys_to_delete) > 5:
                stdout.write(f"  ... and {len(keys_to_delete) - 5} more in this batch")
            total_deleted += len(keys_to_delete)
        else:
            # ìµœëŒ€ 1000ê°œì”© ì‚­ì œ
            for i in range(0, len(keys_to_delete), DELETE_BATCH):
                batch = keys_to_delete[i : i + DELETE_BATCH]
                s3.delete_objects(
                    Bucket=bucket,
                    Delete={"Objects": batch, "Quiet": True},
                )
                total_deleted += len(batch)
                stdout.write(f"  Deleted batch of {len(batch)} objects")

        if not resp.get("IsTruncated"):
            break
        continuation_token = resp.get("NextContinuationToken")

    return total_listed, total_deleted


class Command(BaseCommand):
    help = "R2 ë²„í‚·ì—ì„œ ë ˆê°€ì‹œ(ë˜ëŠ” ì§€ì • prefix) ê°ì²´ ì¼ê´„ ì‚­ì œ. --dry-run ìœ¼ë¡œ ëŒ€ìƒë§Œ í™•ì¸."

    def add_arguments(self, parser):
        parser.add_argument(
            "--prefix",
            type=str,
            default="legacy/",
            help="ì‚­ì œí•  ê°ì²´ prefix (ê¸°ë³¸: legacy/). ì „ì²´ ë²„í‚·ì€ ë¹ˆ ë¬¸ìì—´ ''.",
        )
        parser.add_argument(
            "--bucket",
            type=str,
            choices=["ai", "video", "storage", "all"],
            default="all",
            help="ëŒ€ìƒ ë²„í‚· (ê¸°ë³¸: all)",
        )
        parser.add_argument(
            "--dry-run",
            action="store_true",
            help="ì‚­ì œí•˜ì§€ ì•Šê³  ëŒ€ìƒ í‚¤ë§Œ ì¶œë ¥",
        )
        parser.add_argument(
            "--wipe",
            action="store_true",
            help="ë²„í‚· ì „ì²´ ì‚­ì œ (prefix ì—†ìŒ). ì‚¬ìš© ì‹œ --confirm-wipe í•„ìš” (--dry-run ì œì™¸).",
        )
        parser.add_argument(
            "--confirm-wipe",
            action="store_true",
            help="ì „ì²´ ì‚­ì œ(--wipe) ì‹¤í–‰ í™•ì¸. ì—†ìœ¼ë©´ ì „ì²´ ì‚­ì œ ì‹œ ì¤‘ë‹¨.",
        )

    def handle(self, *args, **options):
        prefix = options["prefix"]
        if options.get("wipe"):
            prefix = ""
        bucket_key = options["bucket"]
        dry_run = options["dry_run"]
        confirm_wipe = options.get("confirm_wipe", False)

        # ë²„í‚· ì „ì²´ ì‚­ì œ ì‹œ í™•ì¸ í•„ìˆ˜ (dry-runì€ ê´œì°®ìŒ)
        if prefix == "" and not dry_run and not confirm_wipe:
            self.stderr.write(
                self.style.ERROR(
                    "ë²„í‚· ì „ì²´ ì‚­ì œëŠ” --confirm-wipe ë¥¼ í•¨ê»˜ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. "
                    "ì˜ˆ: python manage.py delete_r2_legacy --wipe --confirm-wipe"
                )
            )
            return

        if not getattr(settings, "R2_ENDPOINT", None) or not getattr(settings, "R2_ACCESS_KEY", None):
            self.stderr.write(self.style.ERROR("R2_ENDPOINT / R2_ACCESS_KEY ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."))
            return

        buckets = ["ai", "video", "storage"] if bucket_key == "all" else [bucket_key]
        s3 = get_s3_client()

        total_listed = 0
        total_deleted = 0

        for key in buckets:
            bucket = get_bucket_name(key)
            prefix_label = "(ì „ì²´ ë²„í‚·)" if prefix == "" else f"prefix={repr(prefix)}"
            self.stdout.write(f"Bucket: {bucket} (key={key}) {prefix_label} dry_run={dry_run}")
            try:
                listed, deleted = list_and_delete_prefix(s3, bucket, prefix, dry_run, self.stdout)
                total_listed += listed
                total_deleted += deleted
                self.stdout.write(self.style.SUCCESS(f"  Listed {listed}, deleted/would-delete {deleted}"))
            except Exception as e:
                try:
                    from botocore.exceptions import ClientError
                    if isinstance(e, ClientError) and (e.response.get("Error") or {}).get("Code") in ("AccessDenied", "403"):
                        self.stdout.write(self.style.WARNING(f"  Skip (Access Denied): {bucket} â€” ê¶Œí•œ ì—†ìŒ, ë‹¤ìŒ ë²„í‚· ê³„ì†"))
                        continue
                except ImportError:
                    pass
                self.stderr.write(self.style.ERROR(f"  Error: {e}"))
                raise

        self.stdout.write(
            self.style.SUCCESS(
                f"Done. Total listed={total_listed}, deleted/would-delete={total_deleted}"
                + (" (dry-run, no changes)" if dry_run else "")
            )
        )


==========================================================================================
# FILE: management/commands/dump_tenant_and_user.py
==========================================================================================
# PATH: apps/core/management/commands/dump_tenant_and_user.py
"""
1ë²ˆ í…Œë„ŒíŠ¸ + í•´ë‹¹ í…Œë„ŒíŠ¸ ì†Œì† admin97 ìœ ì €(kjkszpj123) ì •ë³´ë¥¼ í™•ì¸Â·ë¤í”„.
AI ë“± ì™¸ë¶€ì— ì œê³µí•  ëª©ì ìœ¼ë¡œ ë³µì‚¬í•˜ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥.

ì‚¬ìš©:
  python manage.py dump_tenant_and_user
  python manage.py dump_tenant_and_user --tenant=1 --username=admin97 --password=kjkszpj123
"""
import json
from django.core.management.base import BaseCommand


def _safe_value(val):
    if val is None:
        return None
    if hasattr(val, "isoformat"):
        return val.isoformat()
    if hasattr(val, "pk"):
        return val.pk
    if isinstance(val, (str, int, float, bool)):
        return val
    return str(val)


def _serialize_model(inst, *, exclude=None):
    """ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ  ê°€ëŠ¥í•œ dictë¡œ (password ë“± ì œì™¸)."""
    exclude = set(exclude or [])
    exclude.add("password")
    data = {}
    for f in inst._meta.get_fields():
        if f.name in exclude or (getattr(f, "remote_field", None) and f.concrete and f.name.endswith("_set")):
            continue
        if not f.concrete and f.name != "id":
            continue
        key = getattr(f, "attname", f.name)
        if not hasattr(inst, key):
            continue
        try:
            val = getattr(inst, key, None)
        except Exception:
            continue
        try:
            data[f.name] = _safe_value(val)
        except Exception:
            data[f.name] = "<non-serializable>"
    return data


class Command(BaseCommand):
    help = "1ë²ˆ í…Œë„ŒíŠ¸ì™€ í•´ë‹¹ í…Œë„ŒíŠ¸ ë‚´ ì§€ì • ìœ ì €(admin97 ë“±) ì •ë³´ë¥¼ ë¤í”„ (AI ì œê³µìš©)."

    def add_arguments(self, parser):
        parser.add_argument(
            "--tenant",
            type=int,
            default=1,
            help="í…Œë„ŒíŠ¸ id (ê¸°ë³¸ 1)",
        )
        parser.add_argument(
            "--username",
            default="admin97",
            help="ìœ ì €ëª… (ê¸°ë³¸ admin97)",
        )
        parser.add_argument(
            "--password",
            default="kjkszpj123",
            help="ë¹„ë°€ë²ˆí˜¸ í™•ì¸ìš© (ë¤í”„ì—ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŒ)",
        )

    def handle(self, *args, **options):
        tenant_id = options["tenant"]
        username = options["username"]
        password = options["password"]

        out = {
            "tenant_id": tenant_id,
            "username": username,
            "password_check": None,
            "tenant": None,
            "tenant_domains": [],
            "program": None,
            "user": None,
            "membership": None,
            "errors": [],
        }

        from academy.adapters.db.django import repositories_core as core_repo

        # 1) Tenant
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            out["errors"].append(f"Tenant id={tenant_id} not found.")
            self._print(out)
            return
        out["tenant"] = _serialize_model(tenant)

        # 2) TenantDomain (í•´ë‹¹ í…Œë„ŒíŠ¸ì˜ host ëª©ë¡)
        out["tenant_domains"] = [
            {"id": d.id, "host": d.host, "is_primary": d.is_primary, "is_active": d.is_active}
            for d in core_repo.tenant_domain_filter_by_tenant(tenant)
        ]

        # 3) Program (tenant 1:1)
        program = core_repo.program_get_by_tenant(tenant)
        if program:
            out["program"] = _serialize_model(program)
        else:
            out["errors"].append("Program not found for this tenant.")

        # 4) User (username) + Membership (ì´ í…Œë„ŒíŠ¸)
        user = core_repo.user_get_by_username(username)
        if not user:
            out["errors"].append(f"User username={username!r} not found.")
            self._print(out)
            return
        out["user"] = _serialize_model(user)

        # ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ë§Œ ìˆ˜í–‰ (í•´ì‹œëŠ” ì¶œë ¥í•˜ì§€ ì•ŠìŒ)
        if user.check_password(password):
            out["password_check"] = "OK"
        else:
            out["password_check"] = "MISMATCH"

        membership = core_repo.membership_get_full(tenant=tenant, user=user)
        if membership:
            out["membership"] = _serialize_model(membership)
        else:
            out["errors"].append(f"User {username} has no TenantMembership for tenant id={tenant_id}.")

        self._print(out)

    def _print(self, data):
        self.stdout.write("--- ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ ì œê³µí•˜ë©´ ë©ë‹ˆë‹¤ ---\n")
        self.stdout.write(json.dumps(data, ensure_ascii=False, indent=2, default=str))
        self.stdout.write("\n--- ë ---\n")


==========================================================================================
# FILE: management/commands/ensure_api_domain.py
==========================================================================================
# PATH: apps/core/management/commands/ensure_api_domain.py
"""
í”„ë¡œë•ì…˜ API í˜¸ìŠ¤íŠ¸(api.hakwonplus.com ë“±)ë¥¼ í…Œë„ŒíŠ¸ì— ì—°ê²°.

- í”„ë¡ íŠ¸ê°€ https://api.hakwonplus.com ìœ¼ë¡œ API í˜¸ì¶œ ì‹œ Host=api.hakwonplus.com
- TenantDomainì— api.hakwonplus.com ì´ ì—†ìœ¼ë©´ "Tenant not found for host" 404
- ì´ ëª…ë ¹ì„ í•œ ë²ˆ ì‹¤í–‰í•˜ë©´ api.hakwonplus.com(ë° ì„ íƒ host)ì´ ì§€ì • í…Œë„ŒíŠ¸ì— ì—°ê²°ë¨.

ì‚¬ìš©:
  python manage.py ensure_api_domain
  python manage.py ensure_api_domain --tenant=1
  python manage.py ensure_api_domain --tenant=1 --host=api.hakwonplus.com
"""
from django.core.management.base import BaseCommand

from academy.adapters.db.django import repositories_core as core_repo

DEFAULT_API_HOSTS = (
    "api.hakwonplus.com",
    "www.hakwonplus.com",
    "hakwonplus.com",
)


class Command(BaseCommand):
    help = "Ensure API/production hosts (e.g. api.hakwonplus.com) are mapped to a tenant."

    def add_arguments(self, parser):
        parser.add_argument(
            "--tenant",
            type=int,
            default=1,
            help="Tenant id to attach hosts to (default: 1)",
        )
        parser.add_argument(
            "--host",
            type=str,
            action="append",
            dest="hosts",
            default=None,
            help="Host to add (can repeat). If not set, uses api.hakwonplus.com, www.hakwonplus.com, hakwonplus.com",
        )

    def handle(self, *args, **options):
        tenant_id = options.get("tenant")
        tenant = core_repo.tenant_get_by_id_any(tenant_id)
        if not tenant:
            self.stderr.write(
                self.style.ERROR(f"Tenant id={tenant_id} not found.")
            )
            return

        hosts = options.get("hosts") or list(DEFAULT_API_HOSTS)
        for host in hosts:
            host = (host or "").strip().lower()
            if not host:
                continue
            domain, created = core_repo.tenant_domain_get_or_create_by_defaults(
                host,
                defaults={
                    "tenant": tenant,
                    "is_primary": (host == "hakwonplus.com"),
                    "is_active": True,
                },
            )
            if created:
                self.stdout.write(
                    self.style.SUCCESS(f"Created TenantDomain: {host} -> {tenant.code}")
                )
            else:
                if domain.tenant_id != tenant.id or not domain.is_active:
                    domain.tenant = tenant
                    domain.is_active = True
                    domain.save()
                    self.stdout.write(
                        self.style.WARNING(f"Updated TenantDomain: {host} -> {tenant.code}")
                    )
                else:
                    self.stdout.write(f"Already exists: {host} -> {tenant.code}")

        self.stdout.write(
            self.style.SUCCESS("Done. API requests to these hosts will resolve to this tenant.")
        )


==========================================================================================
# FILE: management/commands/ensure_dev_user.py
==========================================================================================
# PATH: apps/core/management/commands/ensure_dev_user.py
"""
ë¡œì»¬ ê°œë°œìš© í…Œë„ŒíŠ¸ + ê¸°ì¡´ ìœ ì €(admin97 / ê°œë°œìš©) ë¹„ë°€ë²ˆí˜¸Â·ë©¤ë²„ì‹­ + localhost ë„ë©”ì¸ ì±„ìš°ê¸°.

- Tenant(code=admin97) ì—†ìœ¼ë©´ ìƒì„±
- Program(tenant 1:1) ì—†ìœ¼ë©´ ìƒì„±
- localhost, 127.0.0.1 â†’ í•´ë‹¹ í…Œë„ŒíŠ¸ë¡œ TenantDomain ì—°ê²°
- username=admin97 ìœ ì € ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ë§Œ kjkszpj123ìœ¼ë¡œ ë§ì¶”ê³  TenantMembership(admin) ì—°ê²°
  ì—†ìœ¼ë©´ User ìƒì„± (ì´ë¦„ ê°œë°œìš©) + ë¹„ë°€ë²ˆí˜¸ + TenantMembership

ì‚¬ìš© (ì´ë¯¸ ID admin97 ì´ë¦„ ê°œë°œìš© ìœ ì € ìˆì„ ë•Œ):
  python manage.py ensure_dev_user --tenant=admin97 --password=kjkszpj123 --username=admin97 --name=ê°œë°œìš©
"""
from django.core.management.base import BaseCommand
from django.db import transaction
from django.contrib.auth import get_user_model

from academy.adapters.db.django import repositories_core as core_repo


def normalize_host(host: str) -> str:
    v = str(host or "").strip().lower()
    if not v:
        return ""
    return v.split(":")[0].strip()


class Command(BaseCommand):
    help = "Ensure dev tenant + admin user + localhost domain for local login (e.g. tenant=admin97, password=kjkszpj123)."

    def add_arguments(self, parser):
        parser.add_argument(
            "--tenant",
            type=str,
            default="admin97",
            help="Tenant code (default: admin97)",
        )
        parser.add_argument(
            "--password",
            type=str,
            default="kjkszpj123",
            help="Password for the admin user (default: kjkszpj123)",
        )
        parser.add_argument(
            "--username",
            type=str,
            default=None,
            help="Login username (default: same as --tenant)",
        )
        parser.add_argument(
            "--name",
            type=str,
            default="ê°œë°œìš©",
            help="Display name when creating user (default: ê°œë°œìš©)",
        )
        parser.add_argument(
            "--hosts",
            type=str,
            default="localhost,127.0.0.1",
            help="Comma-separated hosts to map to this tenant (default: localhost,127.0.0.1)",
        )

    def handle(self, *args, **options):
        tenant_code = (options["tenant"] or "admin97").strip()
        password = (options["password"] or "kjkszpj123").strip()
        username = (options["username"] or tenant_code).strip()
        display_name = (options["name"] or "ê°œë°œìš©").strip()
        hosts_str = options["hosts"] or "localhost,127.0.0.1"
        hosts = [normalize_host(h) for h in hosts_str.split(",") if normalize_host(h)]

        from apps.core.models import Program

        User = get_user_model()

        with transaction.atomic():
            # 1) Tenant
            tenant, tenant_created = core_repo.tenant_get_or_create(
                tenant_code,
                defaults={"name": tenant_code, "is_active": True},
            )
            if tenant_created:
                self.stdout.write(self.style.SUCCESS(f"Created Tenant: code={tenant.code}, name={tenant.name}"))
            else:
                if not tenant.is_active:
                    tenant.is_active = True
                    tenant.save(update_fields=["is_active"])
                self.stdout.write(f"Tenant already exists: code={tenant.code}")

            # 2) Program (tenant 1:1)
            program, program_created = core_repo.program_get_or_create(
                tenant,
                defaults={
                    "display_name": "HakwonPlus",
                    "brand_key": "hakwonplus",
                    "login_variant": Program.LoginVariant.HAKWONPLUS,
                    "plan": Program.Plan.PREMIUM,
                    "feature_flags": {
                        "student_app_enabled": True,
                        "admin_enabled": True,
                        "attendance_hourly_rate": 15000,
                    },
                    "ui_config": {"login_title": "HakwonPlus ê´€ë¦¬ì ë¡œê·¸ì¸", "login_subtitle": ""},
                    "is_active": True,
                },
            )
            if program_created:
                self.stdout.write(self.style.SUCCESS(f"Created Program for tenant {tenant.code}"))
            else:
                self.stdout.write(f"Program already exists for tenant {tenant.code}")

            # 3) TenantDomain (localhost, 127.0.0.1 â†’ this tenant)
            for host in hosts:
                domain, dom_created = core_repo.tenant_domain_get_or_create_by_defaults(
                    host,
                    defaults={
                        "tenant": tenant,
                        "is_primary": False,
                        "is_active": True,
                    },
                )
                if dom_created:
                    self.stdout.write(self.style.SUCCESS(f"Created TenantDomain: {host} -> {tenant.code}"))
                else:
                    if domain.tenant_id != tenant.id:
                        domain.tenant = tenant
                        domain.is_active = True
                        domain.save()
                        self.stdout.write(self.style.WARNING(f"Updated TenantDomain: {host} -> {tenant.code}"))
                    else:
                        self.stdout.write(f"TenantDomain already exists: {host} -> {tenant.code}")

            # 4) User (ê¸°ì¡´ admin97 / ê°œë°œìš© ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ë§Œ ë§ì¶”ê³ , ì—†ìœ¼ë©´ ìƒì„±)
            user, user_created = core_repo.user_get_or_create(
                username,
                defaults={
                    "is_active": True,
                    "is_staff": True,
                    "is_superuser": False,
                    "email": f"{username}@local.dev",
                    "name": display_name,
                },
            )
            user.set_password(password)
            user.is_active = True
            user.is_staff = True
            if user.name != display_name and not user_created:
                user.name = display_name
            user.save(update_fields=["password", "is_active", "is_staff", "name"])
            if user_created:
                self.stdout.write(self.style.SUCCESS(f"Created User: username={username}, name={display_name}"))
            else:
                self.stdout.write(self.style.SUCCESS(f"Updated User: username={username}, password set, name={getattr(user, 'name', display_name)}"))

            # 5) TenantMembership (admin)
            membership = core_repo.membership_ensure_active(tenant=tenant, user=user, role="admin")
            self.stdout.write(self.style.SUCCESS(f"TenantMembership: {user.username} @ {tenant.code} ({membership.role})"))

        self.stdout.write(
            self.style.SUCCESS(
                f"Done. Log in with username={username}, password={password} (tenant {tenant_code} via http://localhost:8000)"
            )
        )


==========================================================================================
# FILE: management/commands/ensure_localhost_tenant.py
==========================================================================================
# PATH: apps/core/management/commands/ensure_localhost_tenant.py
"""
ë¡œì»¬ ê°œë°œ ì‹œ localhost â†’ tenant ì—°ê²°.

- Host ê¸°ë°˜ tenant resolverëŠ” DBì˜ TenantDomainë§Œ ì‚¬ìš©í•¨.
- localhost:8000 ìœ¼ë¡œ ì ‘ì†í•˜ë©´ host='localhost' ë¡œ ì¡°íšŒí•˜ëŠ”ë°,
  í•´ë‹¹ TenantDomainì´ ì—†ìœ¼ë©´ /api/v1/core/me/, /api/v1/core/program/ ë“±ì´ 404.
- ì´ ëª…ë ¹ì„ í•œ ë²ˆ ì‹¤í–‰í•˜ë©´ localhost(ë° 127.0.0.1)ê°€ ì§€ì • tenant(ë˜ëŠ” ì²« ë²ˆì§¸)ì— ì—°ê²°ë¨.

ì‚¬ìš©:
  python manage.py ensure_localhost_tenant
  python manage.py ensure_localhost_tenant --tenant=1   # 1ë²ˆ í…Œë„ŒíŠ¸ ê°œë°œìš© ê³ ì •
"""
from django.core.management.base import BaseCommand

from academy.adapters.db.django import repositories_core as core_repo


class Command(BaseCommand):
    help = "Ensure localhost (and 127.0.0.1) are mapped to a tenant for local dev."

    def add_arguments(self, parser):
        parser.add_argument(
            "--tenant",
            type=int,
            default=None,
            help="ì§€ì • í…Œë„ŒíŠ¸ idë¡œ ê³ ì • (ë¯¸ì§€ì • ì‹œ ì²« ë²ˆì§¸ í™œì„± í…Œë„ŒíŠ¸)",
        )

    def handle(self, *args, **options):
        tenant_id = options.get("tenant")
        if tenant_id is not None:
            tenant = core_repo.tenant_get_by_id(tenant_id)
            if not tenant:
                self.stderr.write(
                    self.style.ERROR(f"Tenant id={tenant_id} not found or inactive.")
                )
                return
        else:
            tenant = core_repo.tenant_first_active()
        if not tenant:
            self.stderr.write(
                self.style.ERROR("No active Tenant found. Create a tenant first (e.g. via admin or migration).")
            )
            return

        for host in ("localhost", "127.0.0.1"):
            domain, created = core_repo.tenant_domain_get_or_create_by_defaults(
                host,
                defaults={
                    "tenant": tenant,
                    "is_primary": False,
                    "is_active": True,
                },
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f"Created TenantDomain: {host} -> {tenant.code}"))
            else:
                if domain.tenant_id != tenant.id:
                    domain.tenant = tenant
                    domain.is_active = True
                    domain.save()
                    self.stdout.write(self.style.WARNING(f"Updated TenantDomain: {host} -> {tenant.code}"))
                else:
                    self.stdout.write(f"Already exists: {host} -> {tenant.code}")

        self.stdout.write(
            self.style.SUCCESS("Done. Requests to http://localhost:8000 will now resolve to this tenant.")
        )


==========================================================================================
# FILE: management/commands/renumber_tenant_ids.py
==========================================================================================
# PATH: apps/core/management/commands/renumber_tenant_ids.py
"""
í…Œë„ŒíŠ¸ IDë¥¼ configì™€ ë§ì¶¤: 4(9999)â†’9999, 5(tchul)â†’2, 6(limglish)â†’3, 7(ymath)â†’4.
5,6,7ì€ ë¹„ìš°ê³  tchul/limglish/ymathê°€ 2,3,4ë¡œ ë“¤ì–´ê°€ê²Œ í•¨.

ì‚¬ìš©:
  python manage.py renumber_tenant_ids --dry-run   # ë³€ê²½ ë‚´ìš©ë§Œ ì¶œë ¥
  python manage.py renumber_tenant_ids            # ì‹¤ì œ ë°˜ì˜
í™•ì¸ (ë°˜ì˜ ì „/í›„):
  python manage.py check_tenants
  ë˜ëŠ” (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ): python scripts/check_all_tenants.py
"""
from django.core.management.base import BaseCommand
from django.db import connection, transaction


# (old_id, new_id) â€” ìˆœì„œ ì¤‘ìš”: ë¨¼ì € 4ë¥¼ ë¹„ìš°ê³ , 5,6,7ì„ 2,3,4ë¡œ
RENUMBER_MAP = [
    (4, 9999),   # Local Dev Tenant (9999) â†’ id 9999
    (5, 2),      # tchul â†’ 2
    (6, 3),      # limglish â†’ 3
    (7, 4),      # ymath â†’ 4
]


def get_tenant_fk_tables(cursor):
    """PostgreSQL: core_tenant.idë¥¼ ì°¸ì¡°í•˜ëŠ” (table, column) ëª©ë¡."""
    cursor.execute("""
        SELECT c.relname AS table_name, a.attname AS column_name
        FROM pg_constraint con
        JOIN pg_class c ON c.oid = con.conrelid
        JOIN pg_attribute a ON a.attrelid = c.oid AND a.attnum = ANY(con.conkey) AND NOT a.attisdropped
        JOIN pg_class ref ON ref.oid = con.confrelid
        WHERE con.contype = 'f'
          AND ref.relname = 'core_tenant'
          AND c.relkind = 'r'
          AND c.relnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public')
    """)
    return [row for row in cursor.fetchall()]


class Command(BaseCommand):
    help = "Renumber tenant IDs so tchul=2, limglish=3, ymath=4; 9999â†’id 9999; 5,6,7 ë¹„ì›€."

    def add_arguments(self, parser):
        parser.add_argument(
            "--dry-run",
            action="store_true",
            help="ì‹¤ì œ ë³€ê²½ ì—†ì´ í•  ì‘ì—…ë§Œ ì¶œë ¥",
        )

    def handle(self, *args, **options):
        dry_run = options.get("dry_run", False)
        if dry_run:
            self.stdout.write(self.style.WARNING("DRY RUN â€” DB ë³€ê²½ ì—†ìŒ"))

        with connection.cursor() as cursor:
            tables = get_tenant_fk_tables(cursor)
            if not tables:
                self.stdout.write(self.style.WARNING("core_tenantë¥¼ ì°¸ì¡°í•˜ëŠ” í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤."))
                return

            self.stdout.write(f"tenant_id FK í…Œì´ë¸”: {[t[0] for t in tables]}")

            for old_id, new_id in RENUMBER_MAP:
                cursor.execute("SELECT id, code, name FROM core_tenant WHERE id = %s", [old_id])
                row = cursor.fetchone()
                if not row:
                    self.stdout.write(f"  ê±´ë„ˆëœ€: id={old_id} ì¸ í…Œë„ŒíŠ¸ ì—†ìŒ")
                    continue
                _id, code, name = row
                self.stdout.write(f"  {old_id} ({code}) â†’ {new_id}")

            if dry_run:
                self.stdout.write(self.style.SUCCESS("Dry run ì™„ë£Œ. ì ìš©í•˜ë ¤ë©´ --dry-run ì—†ì´ ì‹¤í–‰í•˜ì„¸ìš”."))
                return

        with transaction.atomic():
            with connection.cursor() as cursor:
                for old_id, new_id in RENUMBER_MAP:
                    cursor.execute("SELECT id FROM core_tenant WHERE id = %s", [old_id])
                    if not cursor.fetchone():
                        continue
                    for table_name, column_name in tables:
                        cursor.execute(
                            f'UPDATE "{table_name}" SET "{column_name}" = %s WHERE "{column_name}" = %s',
                            [new_id, old_id],
                        )
                        if cursor.rowcount:
                            self.stdout.write(f"    {table_name}.{column_name}: {cursor.rowcount} rows")
                    cursor.execute("UPDATE core_tenant SET id = %s WHERE id = %s", [new_id, old_id])
                    self.stdout.write(self.style.SUCCESS(f"  core_tenant: {old_id} â†’ {new_id}"))

        self.stdout.write(self.style.SUCCESS("ì™„ë£Œ. í™•ì¸: python manage.py check_tenants"))


==========================================================================================
# FILE: management/commands/setup_three_tenants.py
==========================================================================================
# PATH: apps/core/management/commands/setup_three_tenants.py
"""
limglish.kr, tchul.com, ymath.co.kr 3ê°œ ë„ë©”ì¸ì— ëŒ€ì‘í•˜ëŠ” í…Œë„ŒíŠ¸Â·ë„ë©”ì¸Â·Program ì…‹ì—….

ë„ë©”ì¸ì€ ì´ë¯¸ Cloudflare ë“±ì— ë“±ë¡ë˜ì–´ ìˆë‹¤ê³  ê°€ì •.
- í…Œë„ŒíŠ¸ get_or_create (code=tchul, limglish, ymath)
- ê° í…Œë„ŒíŠ¸ì— Program get_or_create
- TenantDomain: tchul.com, www.tchul.com -> tchul / limglish.kr, www.limglish.kr -> limglish / ymath.co.kr, www.ymath.co.kr -> ymath

ì‚¬ìš©:
  python manage.py setup_three_tenants
"""
from django.core.management.base import BaseCommand

from academy.adapters.db.django import repositories_core as core_repo
from apps.core.models import Program

TENANTS_CONFIG = [
    {
        "code": "tchul",
        "name": "Tchul",
        "hosts": ["tchul.com", "www.tchul.com"],
        "primary_host": "tchul.com",
    },
    {
        "code": "limglish",
        "name": "Limglish",
        "hosts": ["limglish.kr", "www.limglish.kr"],
        "primary_host": "limglish.kr",
    },
    {
        "code": "ymath",
        "name": "Ymath",
        "hosts": ["ymath.co.kr", "www.ymath.co.kr"],
        "primary_host": "ymath.co.kr",
    },
]


class Command(BaseCommand):
    help = "Setup 3 tenants (tchul, limglish, ymath) and their domains (tchul.com, limglish.kr, ymath.co.kr)."

    def handle(self, *args, **options):
        for cfg in TENANTS_CONFIG:
            code = cfg["code"]
            name = cfg["name"]
            hosts = cfg["hosts"]
            primary_host = cfg["primary_host"]

            tenant, tenant_created = core_repo.tenant_get_or_create(
                code,
                defaults={"name": name, "is_active": True},
            )
            self.stdout.write(
                self.style.SUCCESS(f"Tenant: {tenant.code} (id={tenant.id}) {'created' if tenant_created else 'exists'}")
            )

            program, prog_created = core_repo.program_get_or_create(
                tenant,
                defaults={
                    "display_name": name,
                    "brand_key": code,
                    "login_variant": Program.LoginVariant.HAKWONPLUS,
                    "plan": Program.Plan.PREMIUM,
                    "feature_flags": {
                        "student_app_enabled": True,
                        "admin_enabled": True,
                    },
                    "ui_config": {"login_title": f"{name} ë¡œê·¸ì¸"},
                    "is_active": True,
                },
            )
            self.stdout.write(f"  Program: {'created' if prog_created else 'exists'}")

            # Signalì´ host=code ë¡œ ì´ë¯¸ primary ë„ë©”ì¸ì„ ë§Œë“¤ì—ˆì„ ìˆ˜ ìˆìŒ â†’ primary í•´ì œ í›„ ìš°ë¦¬ ë„ë©”ì¸ë§Œ primary ì‚¬ìš©
            existing_domains = core_repo.tenant_domain_filter_by_tenant(tenant)
            for d in existing_domains:
                if d.is_primary and d.host != primary_host:
                    d.is_primary = False
                    d.save()
                    self.stdout.write(self.style.WARNING(f"  TenantDomain: {d.host} -> is_primary=False (ê¸°ì¡´ í•´ì œ)"))

            for host in hosts:
                host = host.strip().lower()
                if not host:
                    continue
                domain, dom_created = core_repo.tenant_domain_get_or_create_by_defaults(
                    host,
                    defaults={
                        "tenant": tenant,
                        "is_primary": host == primary_host,
                        "is_active": True,
                    },
                )
                if dom_created:
                    self.stdout.write(self.style.SUCCESS(f"  TenantDomain: {host} -> {tenant.code} (created)"))
                else:
                    if domain.tenant_id != tenant.id or not domain.is_active:
                        domain.tenant = tenant
                        domain.is_primary = host == primary_host
                        domain.is_active = True
                        domain.save()
                        self.stdout.write(self.style.WARNING(f"  TenantDomain: {host} -> {tenant.code} (updated)"))
                    else:
                        self.stdout.write(f"  TenantDomain: {host} -> {tenant.code} (exists)")

        self.stdout.write(
            self.style.SUCCESS("Done. limglish.kr, tchul.com, ymath.co.kr tenants and domains are set.")
        )


==========================================================================================
# FILE: middleware/__init__.py
==========================================================================================



==========================================================================================
# FILE: middleware/tenant.py
==========================================================================================
# PATH: apps/core/middleware/tenant.py
from __future__ import annotations

from django.http import JsonResponse

from apps.core.tenant.context import set_current_tenant, clear_current_tenant
from apps.core.tenant.resolver import resolve_tenant_from_request
from apps.core.tenant.exceptions import TenantResolutionError


# í…Œë„ŒíŠ¸ í•´ì„ ì—†ì´ í†µê³¼ì‹œí‚¤ëŠ” ê²½ë¡œ (ALB/ì»¨í…Œì´ë„ˆ health checkìš©)
BYPASS_PATHS = {"/health", "/health/"}


class TenantMiddleware:
    """
    Enterprise Tenant Middleware (Domain 1:1)

    - Request ë‹¨ìœ„ tenant í™•ì •
    - tenant source: request.get_host() -> TenantDomain.host
    - bypass pathë§Œ tenant=None í—ˆìš©

    âœ… ê°œì„ (ë´‰ì¸ ë ˆë²¨):
    - request ì²˜ë¦¬ ì¢…ë£Œ í›„, ì–´ë–¤ ê²½ìš°ì—ë„ clear_current_tenant() (finally)
      -> contextvars ëˆ„ìˆ˜/ì˜¤ì—¼ ë°©ì§€
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        clear_current_tenant()
        request.tenant = None  # type: ignore[attr-defined]

        if request.path in BYPASS_PATHS:
            try:
                return self.get_response(request)
            finally:
                clear_current_tenant()

        try:
            tenant = resolve_tenant_from_request(request)
        except TenantResolutionError as e:
            # tenant contextëŠ” ì´ë¯¸ clear ìƒíƒœ (403=tenant_inactive, 404=tenant_invalid ë“±)
            payload = {
                "detail": "tenant resolution failed",
                "code": e.code,
                "message": e.message,
            }
            host = getattr(request, "META", {}).get("HTTP_HOST", "")
            if host:
                payload["host"] = host.split(":")[0].strip().lower()
            return JsonResponse(payload, status=e.http_status)

        try:
            if tenant is not None:
                request.tenant = tenant  # type: ignore[attr-defined]
                set_current_tenant(tenant)

            response = self.get_response(request)

            if tenant is not None:
                response["X-Tenant-Code"] = tenant.code
                response["X-Tenant-Id"] = str(tenant.id)

            return response
        finally:
            # âœ… ì–´ë–¤ ì˜ˆì™¸/ë¦¬í„´ ê²½ë¡œë“  tenant ì»¨í…ìŠ¤íŠ¸ ì¢…ë£Œ
            clear_current_tenant()


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-15 06:03

import django.contrib.auth.models
import django.contrib.auth.validators
import django.db.models.deletion
import django.utils.timezone
from decimal import Decimal
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("auth", "0012_alter_user_first_name_max_length"),
    ]

    operations = [
        migrations.CreateModel(
            name="Tenant",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=255)),
                ("code", models.CharField(max_length=50, unique=True)),
                ("owner_name", models.CharField(blank=True, max_length=100)),
                ("phone", models.CharField(blank=True, max_length=50)),
                ("address", models.CharField(blank=True, max_length=255)),
                (
                    "logo",
                    models.ImageField(blank=True, null=True, upload_to="academy/logo/"),
                ),
                ("is_active", models.BooleanField(default=True)),
                (
                    "kakao_pfid",
                    models.CharField(blank=True, default="", max_length=100),
                ),
                (
                    "credit_balance",
                    models.DecimalField(
                        decimal_places=0, default=Decimal("0"), max_digits=12
                    ),
                ),
                ("messaging_is_active", models.BooleanField(default=False)),
                (
                    "messaging_base_price",
                    models.DecimalField(
                        decimal_places=2, default=Decimal("0"), max_digits=10
                    ),
                ),
            ],
            options={
                "verbose_name": "Tenant",
                "verbose_name_plural": "Tenants",
            },
        ),
        migrations.CreateModel(
            name="User",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("password", models.CharField(max_length=128, verbose_name="password")),
                (
                    "last_login",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="last login"
                    ),
                ),
                (
                    "is_superuser",
                    models.BooleanField(
                        default=False,
                        help_text="Designates that this user has all permissions without explicitly assigning them.",
                        verbose_name="superuser status",
                    ),
                ),
                (
                    "username",
                    models.CharField(
                        error_messages={
                            "unique": "A user with that username already exists."
                        },
                        help_text="Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.",
                        max_length=150,
                        unique=True,
                        validators=[
                            django.contrib.auth.validators.UnicodeUsernameValidator()
                        ],
                        verbose_name="username",
                    ),
                ),
                (
                    "first_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="first name"
                    ),
                ),
                (
                    "last_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="last name"
                    ),
                ),
                (
                    "email",
                    models.EmailField(
                        blank=True, max_length=254, verbose_name="email address"
                    ),
                ),
                (
                    "is_staff",
                    models.BooleanField(
                        default=False,
                        help_text="Designates whether the user can log into this admin site.",
                        verbose_name="staff status",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Designates whether this user should be treated as active. Unselect this instead of deleting accounts.",
                        verbose_name="active",
                    ),
                ),
                (
                    "date_joined",
                    models.DateTimeField(
                        default=django.utils.timezone.now, verbose_name="date joined"
                    ),
                ),
                ("name", models.CharField(blank=True, max_length=50, null=True)),
                (
                    "phone",
                    models.CharField(
                        blank=True,
                        db_index=True,
                        help_text="ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ (í•˜ì´í”ˆ ì œê±°, ì˜ˆ: 01012345678)",
                        max_length=20,
                        null=True,
                    ),
                ),
                (
                    "groups",
                    models.ManyToManyField(
                        blank=True, related_name="core_users", to="auth.group"
                    ),
                ),
                (
                    "user_permissions",
                    models.ManyToManyField(
                        blank=True, related_name="core_users", to="auth.permission"
                    ),
                ),
            ],
            options={
                "db_table": "accounts_user",
                "ordering": ["-id"],
            },
            managers=[
                ("objects", django.contrib.auth.models.UserManager()),
            ],
        ),
        migrations.CreateModel(
            name="Program",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "display_name",
                    models.CharField(default="HakwonPlus", max_length=120),
                ),
                (
                    "brand_key",
                    models.CharField(
                        default="hakwonplus",
                        help_text="í”„ë¡ íŠ¸ í…Œë§ˆ/ë¦¬ì†ŒìŠ¤ ë¡œë”© í‚¤",
                        max_length=80,
                    ),
                ),
                (
                    "login_variant",
                    models.CharField(
                        choices=[
                            ("hakwonplus", "HakwonPlus Admin"),
                            ("limglish", "Limglish Teacher"),
                            ("custom", "Custom"),
                        ],
                        default="hakwonplus",
                        max_length=30,
                    ),
                ),
                (
                    "plan",
                    models.CharField(
                        choices=[
                            ("lite", "Lite"),
                            ("basic", "Basic"),
                            ("premium", "Premium"),
                        ],
                        default="premium",
                        help_text="ìš”ê¸ˆì œ (lite/basic/premium)",
                        max_length=20,
                    ),
                ),
                ("feature_flags", models.JSONField(blank=True, default=dict)),
                ("ui_config", models.JSONField(blank=True, default=dict)),
                ("is_active", models.BooleanField(default=True)),
                (
                    "tenant",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="program",
                        to="core.tenant",
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(
                        fields=["tenant"], name="core_progra_tenant__551fe8_idx"
                    ),
                    models.Index(
                        fields=["brand_key"], name="core_progra_brand_k_e09627_idx"
                    ),
                    models.Index(
                        fields=["login_variant"], name="core_progra_login_v_7300df_idx"
                    ),
                    models.Index(fields=["plan"], name="core_progra_plan_eaf985_idx"),
                ],
            },
        ),
        migrations.CreateModel(
            name="Expense",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("date", models.DateField()),
                ("title", models.CharField(max_length=255)),
                ("amount", models.IntegerField()),
                ("memo", models.TextField(blank=True, null=True)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="expenses",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="expenses",
                        to="core.tenant",
                    ),
                ),
            ],
            options={
                "ordering": ["-date"],
                "indexes": [
                    models.Index(
                        fields=["tenant", "date"], name="core_expens_tenant__5ab126_idx"
                    )
                ],
            },
        ),
        migrations.CreateModel(
            name="Attendance",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("date", models.DateField()),
                ("start_time", models.TimeField()),
                ("end_time", models.TimeField()),
                ("work_type", models.CharField(max_length=50)),
                ("memo", models.TextField(blank=True, null=True)),
                ("duration_hours", models.FloatField(default=0)),
                ("amount", models.IntegerField(default=0)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="attendances",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="attendances",
                        to="core.tenant",
                    ),
                ),
            ],
            options={
                "ordering": ["-date", "-start_time"],
                "indexes": [
                    models.Index(
                        fields=["tenant", "date"], name="core_attend_tenant__397c84_idx"
                    )
                ],
            },
        ),
        migrations.CreateModel(
            name="TenantDomain",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "host",
                    models.CharField(
                        help_text="ë„ë©”ì¸/í˜¸ìŠ¤íŠ¸(í¬íŠ¸ ì œì™¸, ì†Œë¬¸ì). ì˜ˆ: example.com, academy.example.com",
                        max_length=255,
                        unique=True,
                    ),
                ),
                (
                    "is_primary",
                    models.BooleanField(
                        default=True,
                        help_text="ëŒ€í‘œ ë„ë©”ì¸ ì—¬ë¶€. tenant ë‹¹ ìµœëŒ€ 1ê°œë§Œ True í—ˆìš©.",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True, help_text="ìš´ì˜ ì¤‘ì¸ ë„ë©”ì¸ë§Œ resolve ëŒ€ìƒ"
                    ),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="domains",
                        to="core.tenant",
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(fields=["host"], name="core_tenant_host_573fcb_idx"),
                    models.Index(
                        fields=["tenant", "is_active"],
                        name="core_tenant_tenant__ad1be6_idx",
                    ),
                ],
                "constraints": [
                    models.UniqueConstraint(
                        condition=models.Q(("is_primary", True)),
                        fields=("tenant",),
                        name="core_tenantdomain_one_primary_per_tenant",
                    )
                ],
            },
        ),
        migrations.CreateModel(
            name="TenantMembership",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "role",
                    models.CharField(
                        choices=[
                            ("owner", "Owner"),
                            ("admin", "Admin"),
                            ("teacher", "Teacher"),
                            ("staff", "Staff"),
                            ("student", "Student"),
                            ("parent", "Parent"),
                        ],
                        max_length=20,
                    ),
                ),
                ("is_active", models.BooleanField(default=True)),
                ("joined_at", models.DateTimeField(auto_now_add=True)),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="memberships",
                        to="core.tenant",
                    ),
                ),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="tenant_memberships",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(
                        fields=["tenant", "user"], name="core_tenant_tenant__644160_idx"
                    )
                ],
                "unique_together": {("user", "tenant")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: models/__init__.py
==========================================================================================
# PATH: apps/core/models/__init__.py
from .tenant import Tenant
from .tenant_domain import TenantDomain
from .tenant_membership import TenantMembership
from .user import User, Attendance, Expense
from .program import Program

__all__ = [
    "Tenant",
    "TenantDomain",
    "TenantMembership",
    "User",
    "Attendance",
    "Expense",
    "Program",
]


==========================================================================================
# FILE: models/base.py
==========================================================================================
# PATH: apps/core/models/base.py
"""
ê³µí†µ ë² ì´ìŠ¤ ëª¨ë¸ (TimestampModel, BaseModel)

Worker/API ê³µìœ  â€” apps.api ì˜ì¡´ ì œê±°ë¥¼ ìœ„í•´ coreì— ì •ì˜.
"""
from django.db import models


class TimestampModel(models.Model):
    """ìƒì„±/ìˆ˜ì • ì‹œê°„ ìë™ ê¸°ë¡ ì¶”ìƒ ëª¨ë¸"""
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True


class BaseModel(TimestampModel):
    """ê³µí†µ íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨ ë² ì´ìŠ¤ ëª¨ë¸"""
    class Meta:
        abstract = True


==========================================================================================
# FILE: models/program.py
==========================================================================================
# PATH: apps/core/models/program.py
from __future__ import annotations

from django.db import models

from apps.core.models.base import TimestampModel
from apps.core.models.tenant import Tenant


class Program(TimestampModel):
    """
    Program (Tenant 1:1) â€” ì›ì¥ ê°œì¸ í”„ë¡œê·¸ë¨ SSOT

    ğŸ”’ ë´‰ì¸ ì›ì¹™:
    - Tenant ìƒì„± ì‹œì ì—ë§Œ ìƒì„±
    - read ê²½ë¡œì—ì„œ write ê¸ˆì§€
    - ëˆ„ë½ì€ ìš´ì˜ ë°ì´í„° ë¬´ê²°ì„± ìœ„ë°˜
    """

    class LoginVariant(models.TextChoices):
        HAKWONPLUS = "hakwonplus", "HakwonPlus Admin"
        LIMGLISH = "limglish", "Limglish Teacher"
        CUSTOM = "custom", "Custom"

    class Plan(models.TextChoices):
        LITE = "lite", "Lite"
        BASIC = "basic", "Basic"
        PREMIUM = "premium", "Premium"

    tenant = models.OneToOneField(
        Tenant,
        on_delete=models.CASCADE,
        related_name="program",
    )

    display_name = models.CharField(max_length=120, default="HakwonPlus")
    brand_key = models.CharField(
        max_length=80,
        default="hakwonplus",
        help_text="í”„ë¡ íŠ¸ í…Œë§ˆ/ë¦¬ì†ŒìŠ¤ ë¡œë”© í‚¤",
    )

    login_variant = models.CharField(
        max_length=30,
        choices=LoginVariant.choices,
        default=LoginVariant.HAKWONPLUS,
    )

    # âœ… ìš”ê¸ˆì œ (ë¦¬ì†ŒìŠ¤ ê³„ì•½ ì„ ì–¸)
    plan = models.CharField(
        max_length=20,
        choices=Plan.choices,
        default=Plan.PREMIUM,
        help_text="ìš”ê¸ˆì œ (lite/basic/premium)",
    )

    feature_flags = models.JSONField(default=dict, blank=True)
    ui_config = models.JSONField(default=dict, blank=True)

    is_active = models.BooleanField(default=True)

    class Meta:
        app_label = "core"
        indexes = [
            models.Index(fields=["tenant"]),
            models.Index(fields=["brand_key"]),
            models.Index(fields=["login_variant"]),
            models.Index(fields=["plan"]),
        ]

    def __str__(self) -> str:
        return f"Program<{self.tenant.code}>:{self.display_name}"

    @classmethod
    def ensure_for_tenant(cls, *, tenant: Tenant) -> "Program":
        from academy.adapters.db.django import repositories_core as core_repo
        obj = core_repo.program_get_by_tenant(tenant)
        if obj:
            return obj
        raise RuntimeError(
            f"Program missing for tenant '{tenant.code}'. "
            "This violates core SSOT."
        )


==========================================================================================
# FILE: models/tenant.py
==========================================================================================
# PATH: apps/core/models/tenant.py
from decimal import Decimal

from django.db import models


class Tenant(models.Model):
    """
    Tenant == Academy
    SaaS ë‹¨ìœ„ì˜ í•™ì›
    """

    name = models.CharField(max_length=255)
    code = models.CharField(max_length=50, unique=True)

    owner_name = models.CharField(max_length=100, blank=True)
    phone = models.CharField(max_length=50, blank=True)
    address = models.CharField(max_length=255, blank=True)

    logo = models.ImageField(
        upload_to="academy/logo/",
        null=True,
        blank=True,
    )

    is_active = models.BooleanField(default=True)

    # ---------- ë©”ì‹œì§•(ì•Œë¦¼í†¡) ----------
    # í•™ì› ê°œë³„ ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ID (ì—°ë™ ì‹œ ì €ì¥)
    kakao_pfid = models.CharField(max_length=100, blank=True, default="")
    # ì„ ë¶ˆ ì¶©ì „ ì”ì•¡ (ì›)
    credit_balance = models.DecimalField(
        max_digits=12, decimal_places=0, default=Decimal("0")
    )
    # ì•Œë¦¼í†¡ ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€
    messaging_is_active = models.BooleanField(default=False)
    # ê±´ë‹¹ ë°œì†¡ ë‹¨ê°€ (ì›, í•™ì›ë§ˆë‹¤ ë‹¤ë¥´ê²Œ ì±…ì • ê°€ëŠ¥)
    messaging_base_price = models.DecimalField(
        max_digits=10, decimal_places=2, default=Decimal("0")
    )

    class Meta:
        app_label = "core"
        verbose_name = "Tenant"
        verbose_name_plural = "Tenants"

    def __str__(self):
        return self.name


==========================================================================================
# FILE: models/tenant_domain.py
==========================================================================================
# PATH: apps/core/models/tenant_domain.py
from __future__ import annotations

from django.db import models
from django.db.models import Q

from apps.core.models.tenant import Tenant


class TenantDomain(models.Model):
    """
    TenantDomain (Enterprise SSOT)

    âœ… ëª©ì :
    - Tenant.code(ì‹ë³„ì)ì™€ Host(ì ‘ì† ë„ë©”ì¸)ë¥¼ ë¶„ë¦¬í•˜ì—¬ ìš´ì˜ ìœ ì—°ì„± í™•ë³´
    - ResolverëŠ” TenantDomain.hostë¥¼ í†µí•´ tenantë¥¼ í™•ì •í•œë‹¤.

    ğŸ”’ ë´‰ì¸ ì›ì¹™:
    - host ëŠ” ì „ì—­ unique (ë‹¨ì¼ í…Œë„ŒíŠ¸ì—ë§Œ ê·€ì†)
    - tenant ë‹¹ is_primary=True ëŠ” ìµœëŒ€ 1ê°œ (DB ì œì•½ìœ¼ë¡œ ê°•ì œ)
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="domains",
        null=False,
        blank=False,
    )

    host = models.CharField(
        max_length=255,
        unique=True,
        help_text="ë„ë©”ì¸/í˜¸ìŠ¤íŠ¸(í¬íŠ¸ ì œì™¸, ì†Œë¬¸ì). ì˜ˆ: example.com, academy.example.com",
    )

    is_primary = models.BooleanField(
        default=True,
        help_text="ëŒ€í‘œ ë„ë©”ì¸ ì—¬ë¶€. tenant ë‹¹ ìµœëŒ€ 1ê°œë§Œ True í—ˆìš©.",
    )

    is_active = models.BooleanField(
        default=True,
        help_text="ìš´ì˜ ì¤‘ì¸ ë„ë©”ì¸ë§Œ resolve ëŒ€ìƒ",
    )

    class Meta:
        app_label = "core"
        indexes = [
            models.Index(fields=["host"]),
            models.Index(fields=["tenant", "is_active"]),
        ]
        constraints = [
            # âœ… tenant ë‹¹ primaryëŠ” ìµœëŒ€ 1ê°œ
            models.UniqueConstraint(
                fields=["tenant"],
                condition=Q(is_primary=True),
                name="core_tenantdomain_one_primary_per_tenant",
            ),
        ]

    def __str__(self) -> str:
        return f"TenantDomain<{self.host}> -> {self.tenant.code}"


==========================================================================================
# FILE: models/tenant_membership.py
==========================================================================================
# PATH: apps/core/models/tenant_membership.py
from __future__ import annotations

from django.conf import settings
from django.db import models, transaction

from apps.core.models.tenant import Tenant


class TenantMembership(models.Model):
    """
    User â†” Tenant ê´€ê³„ SSOT

    - í•œ UserëŠ” ì—¬ëŸ¬ Tenantì— ì†í•  ìˆ˜ ìˆìŒ (M2M)
    - Tenant ë‚´ì—ì„œ role / í™œì„± ìƒíƒœë¥¼ ëª…ì‹œ
    - unique_togetherë¡œ "ê°™ì€ tenantì— ì¤‘ë³µ ê°€ì…" ë°©ì§€
    """

    ROLE_CHOICES = [
        ("owner", "Owner"),
        ("admin", "Admin"),
        ("teacher", "Teacher"),
        ("staff", "Staff"),
        ("student", "Student"),
        ("parent", "Parent"),
    ]

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="tenant_memberships",
    )
    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="memberships",
    )

    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    is_active = models.BooleanField(default=True)

    joined_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        app_label = "core"
        unique_together = ("user", "tenant")
        indexes = [
            models.Index(fields=["tenant", "user"]),
        ]

    def __str__(self) -> str:
        return f"{self.user} @ {self.tenant} ({self.role})"

    @classmethod
    @transaction.atomic
    def ensure_active(cls, *, tenant: Tenant, user, role: str) -> "TenantMembership":
        from academy.adapters.db.django import repositories_core as core_repo
        return core_repo.membership_ensure_active(tenant=tenant, user=user, role=role)


==========================================================================================
# FILE: models/user.py
==========================================================================================
# PATH: apps/core/models/user.py
from django.db import models
from django.conf import settings
from django.contrib.auth.models import AbstractUser, Group, Permission

from apps.core.models.base import TimestampModel
from apps.core.models.tenant import Tenant
from apps.core.db import TenantQuerySet


class User(AbstractUser):
    """
    Custom User ëª¨ë¸
    - AUTH_USER_MODEL = core.User
    - auth.User ì™€ì˜ groups / permissions reverse accessor ì¶©ëŒ ë°©ì§€
    """

    name = models.CharField(max_length=50, blank=True, null=True)
    phone = models.CharField(
        max_length=20,
        blank=True,
        null=True,
        db_index=True,  # âœ… phone ì¸ë±ìŠ¤ ì¶”ê°€ (ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ)
        help_text="ì •ê·œí™”ëœ ì „í™”ë²ˆí˜¸ (í•˜ì´í”ˆ ì œê±°, ì˜ˆ: 01012345678)",
    )

    groups = models.ManyToManyField(
        Group,
        related_name="core_users",
        blank=True,
    )
    user_permissions = models.ManyToManyField(
        Permission,
        related_name="core_users",
        blank=True,
    )

    class Meta:
        app_label = "core"
        db_table = "accounts_user"
        ordering = ["-id"]

    def __str__(self):
        return self.username


class Attendance(TimestampModel):
    """
    âœ… ìš´ì˜ë ˆë²¨ í•µì‹¬:
    - AttendanceëŠ” tenant ë‹¨ìœ„ë¡œ ê²©ë¦¬ë˜ì–´ì•¼ í•¨ (13+ í•™ì› ì „ì œ)
    - tenant ì—†ìœ¼ë©´ ì¡°íšŒ/ìƒì„± ë¶ˆê°€(ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ)
    """

    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="attendances",
        null=False,
        blank=False,
        db_index=True,  # âœ… tenant_id ì¸ë±ìŠ¤ ì¶”ê°€
    )

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="attendances",
    )

    date = models.DateField()
    start_time = models.TimeField()
    end_time = models.TimeField()

    work_type = models.CharField(max_length=50)
    memo = models.TextField(blank=True, null=True)

    duration_hours = models.FloatField(default=0)
    amount = models.IntegerField(default=0)

    class Meta:
        app_label = "core"
        ordering = ["-date", "-start_time"]
        indexes = [
            models.Index(fields=["tenant", "date"]),  # âœ… ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€
        ]

    def __str__(self):
        return f"{self.user.username} - {self.date}"


class Expense(TimestampModel):
    """
    âœ… ìš´ì˜ë ˆë²¨ í•µì‹¬:
    - Expenseë„ tenant ë‹¨ìœ„ë¡œ ê²©ë¦¬ë˜ì–´ì•¼ í•¨ (13+ í•™ì› ì „ì œ)
    - tenant ì—†ìœ¼ë©´ ì¡°íšŒ/ìƒì„± ë¶ˆê°€(ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ)
    """

    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="expenses",
        null=False,
        blank=False,
        db_index=True,  # âœ… tenant_id ì¸ë±ìŠ¤ ì¶”ê°€
    )

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="expenses",
    )

    date = models.DateField()
    title = models.CharField(max_length=255)
    amount = models.IntegerField()
    memo = models.TextField(blank=True, null=True)

    class Meta:
        app_label = "core"
        ordering = ["-date"]
        indexes = [
            models.Index(fields=["tenant", "date"]),  # âœ… ë³µí•© ì¸ë±ìŠ¤ ì¶”ê°€
        ]

    def __str__(self):
        return f"{self.user.username} - {self.title}"


==========================================================================================
# FILE: services/attendance_policy.py
==========================================================================================
# PATH: apps/core/services/attendance_policy.py
from __future__ import annotations

from datetime import datetime, time
from typing import Optional, Union

from apps.core.models import Program, Tenant


TimeLike = Union[str, time]


def _to_time(v: TimeLike) -> Optional[time]:
    if v is None:
        return None
    if isinstance(v, time):
        return v

    s = str(v or "").strip()
    if not s:
        return None

    # "HH:MM" or "HH:MM:SS"
    for fmt in ("%H:%M", "%H:%M:%S"):
        try:
            return datetime.strptime(s, fmt).time()
        except Exception:
            continue
    return None


def calculate_duration_hours(start: TimeLike, end: TimeLike) -> float:
    """
    - ë‚ ì§œ ì—†ì´ ì‹œê°„ë§Œ ë“¤ì–´ì˜¤ëŠ” ê·¼íƒœ ì…ë ¥ ì „ì œ
    - end < start ì¸ ê²½ìš°(ì•¼ê°„ ê·¼ë¬´)ê¹Œì§€ëŠ” ì •ì±… ì •ì˜ê°€ í•„ìš”í•˜ë¯€ë¡œ ê¸°ë³¸ì€ 0 ì²˜ë¦¬
    """
    st = _to_time(start)
    et = _to_time(end)
    if not st or not et:
        return 0.0

    start_dt = datetime(2000, 1, 1, st.hour, st.minute, st.second)
    end_dt = datetime(2000, 1, 1, et.hour, et.minute, et.second)

    if end_dt < start_dt:
        return 0.0

    seconds = (end_dt - start_dt).total_seconds()
    if seconds <= 0:
        return 0.0

    return float(seconds / 3600.0)


def get_hourly_rate_for_tenant(tenant: Tenant) -> int:
    """
    Enterprise ì •ì±…:
    - ì‹œê¸‰ì€ Program.feature_flags['attendance_hourly_rate'] ë¡œ ì œê³µ
    - ì—†ìœ¼ë©´ 15000 ê¸°ë³¸ê°’
    """
    from academy.adapters.db.django import repositories_core as core_repo
    program = core_repo.program_get_by_tenant_only_feature_flags(tenant)
    flags = getattr(program, "feature_flags", {}) or {}
    try:
        v = int(flags.get("attendance_hourly_rate", 15000))
        return v if v > 0 else 15000
    except Exception:
        return 15000


def calculate_amount(tenant: Tenant, duration_hours: float) -> int:
    hourly = get_hourly_rate_for_tenant(tenant)
    if duration_hours <= 0:
        return 0
    return int(duration_hours * hourly)


==========================================================================================
# FILE: services/expense_policy.py
==========================================================================================
# PATH: apps/core/services/expense_policy.py
from __future__ import annotations


def normalize_expense_amount(amount) -> int:
    """
    Enterprise ì •ì±…:
    - amountëŠ” í•­ìƒ int >= 0 ìœ¼ë¡œ ì •ê·œí™”
    - ì…ë ¥ ì‹¤ìˆ˜(ë¬¸ìì—´/ê³µë°±)ë¥¼ ì•ˆì „í•˜ê²Œ í¡ìˆ˜
    """
    try:
        v = int(str(amount).strip())
        return v if v >= 0 else 0
    except Exception:
        return 0


==========================================================================================
# FILE: tenant/__init__.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/__init__.py
# ======================================================================
from .context import (
    get_current_tenant,
    set_current_tenant,
    clear_current_tenant,
)
from .resolver import resolve_tenant_from_request
from .exceptions import TenantResolutionError

__all__ = [
    "get_current_tenant",
    "set_current_tenant",
    "clear_current_tenant",
    "resolve_tenant_from_request",
    "TenantResolutionError",
]


==========================================================================================
# FILE: tenant/context.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/context.py
# ======================================================================
from __future__ import annotations

from contextvars import ContextVar
from typing import Optional

from apps.core.models import Tenant

_current_tenant: ContextVar[Optional[Tenant]] = ContextVar("current_tenant", default=None)


def set_current_tenant(tenant: Tenant) -> None:
    _current_tenant.set(tenant)


def get_current_tenant() -> Optional[Tenant]:
    return _current_tenant.get()


def clear_current_tenant() -> None:
    _current_tenant.set(None)


==========================================================================================
# FILE: tenant/exceptions.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/exceptions.py
# ======================================================================
from __future__ import annotations


class TenantResolutionError(Exception):
    """
    Tenant resolution failures are explicit & ops-friendly.

    code:
      - tenant_missing
      - tenant_invalid
      - tenant_inactive
      - tenant_ambiguous
    """

    def __init__(
        self,
        *,
        code: str,
        message: str,
        http_status: int = 400,
    ):
        super().__init__(message)
        self.code = str(code)
        self.message = str(message)
        self.http_status = int(http_status)


==========================================================================================
# FILE: tenant/resolver.py
==========================================================================================
# PATH: apps/core/tenant/resolver.py
from __future__ import annotations

from typing import Optional

from django.conf import settings

from apps.core.models import Tenant
from apps.core.tenant.exceptions import TenantResolutionError
from academy.adapters.db.django import repositories_core as core_repo


def _is_bypass_path(path: str) -> bool:
    p = str(path or "/")
    for prefix in getattr(settings, "TENANT_BYPASS_PATH_PREFIXES", []):
        if p.startswith(prefix):
            return True
    return False


def _normalize_host(host: str) -> str:
    """
    - í¬íŠ¸ ì œê±°
    - ì†Œë¬¸ì ì •ê·œí™”
    """
    if not host:
        return ""
    return host.split(":")[0].strip().lower()


def _resolve_tenant_from_host(host: str) -> Optional[Tenant]:
    """
    Host -> TenantDomain.host -> Tenant (SSOT)

    âœ… ì—ëŸ¬ ë¶„ê¸° (Enterprise):
    - domain row ì—†ìŒ            -> None
    - domain inactive            -> TenantResolutionError(tenant_inactive)
    - tenant inactive            -> TenantResolutionError(tenant_inactive)
    - (DB ë¬´ê²°ì„± ê¹¨ì§) ì¤‘ë³µ host  -> TenantResolutionError(tenant_ambiguous)
    """
    if not host:
        return None

    qs = core_repo.tenant_domain_filter_by_host(host)
    # host ëŠ” unique ê°€ ì •ìƒì´ë‚˜, ìš´ì˜ ì‚¬ê³ /ìˆ˜ë™ SQL ë“± ìµœì•…ì˜ ìƒí™© ëŒ€ë¹„
    cnt = qs.count()
    if cnt == 0:
        return None
    if cnt > 1:
        raise TenantResolutionError(
            code="tenant_ambiguous",
            message=f"Multiple TenantDomain rows exist for host '{host}'",
            http_status=500,
        )

    td = qs.first()
    if td is None:
        return None

    if not td.is_active:
        raise TenantResolutionError(
            code="tenant_inactive",
            message=f"TenantDomain is inactive for host '{host}'",
            http_status=403,
        )

    if not td.tenant or not td.tenant.is_active:
        raise TenantResolutionError(
            code="tenant_inactive",
            message=f"Tenant is inactive for host '{host}'",
            http_status=403,
        )

    return td.tenant


def _resolve_tenant_from_header(request) -> Optional[Tenant]:
    """
    ì¤‘ì•™ API(api.hakwonplus.com ë“±)ë¡œ ìš”ì²­ì´ ì˜¬ ë•Œ,
    í”„ë¡ íŠ¸ê°€ ë³´ë‚¸ X-Tenant-Code ë¡œ í…Œë„ŒíŠ¸ ê²°ì •.
    (SPAê°€ tchul.comì—ì„œ ì—´ë¦¬ì§€ë§Œ APIëŠ” api.hakwonplus.comìœ¼ë¡œ ê°€ëŠ” ê²½ìš°)
    """
    allowed_hosts = getattr(
        settings,
        "TENANT_HEADER_CODE_ALLOWED_HOSTS",
        ("api.hakwonplus.com",),
    )
    host = _normalize_host(request.get_host())
    if host not in allowed_hosts:
        return None
    raw = (request.META.get("HTTP_X_TENANT_CODE") or "").strip()
    if not raw:
        return None
    tenant = core_repo.tenant_get_by_code(raw)
    return tenant


def resolve_tenant_from_request(request) -> Optional[Tenant]:
    """
    Enterprise Resolver (Domain 1:1 with operational flexibility)

    Rules:
    - 1) Hostê°€ ì¤‘ì•™ APIì´ê³  X-Tenant-Code ìˆìœ¼ë©´ â†’ ì½”ë“œë¡œ í…Œë„ŒíŠ¸ ê²°ì •
    - 2) ê·¸ ì™¸ tenantëŠ” request.get_host() -> TenantDomain.host ë¡œë§Œ ê²°ì •
    - fallback ì—†ìŒ
    - bypass pathë§Œ tenant=None í—ˆìš©
    """
    path = getattr(request, "path", "") or "/"
    bypass = _is_bypass_path(path)

    # ì¤‘ì•™ API + X-Tenant-Code ìš°ì„  (tchul.com SPA â†’ api.hakwonplus.com í˜¸ì¶œ ì‹œ)
    tenant = _resolve_tenant_from_header(request)
    if tenant:
        return tenant

    host = _normalize_host(request.get_host())

    try:
        tenant = _resolve_tenant_from_host(host)
    except TenantResolutionError:
        raise

    if tenant:
        return tenant

    if bypass:
        return None

    raise TenantResolutionError(
        code="tenant_invalid",
        message=f"Tenant not found for host '{host}'",
        http_status=404,
    )
