====================================================================================================
# BACKEND APP: core
# ROOT PATH: C:\academy\apps\core
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: apps.py
==========================================================================================
# apps/core/apps.py

from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.core"
    label = "core"


==========================================================================================
# FILE: authentication.py
==========================================================================================
# apps/core/authentication.py

from rest_framework.authentication import SessionAuthentication


class CsrfExemptSessionAuthentication(SessionAuthentication):
    """
    API ì „ìš© SessionAuthentication
    - ë¡œê·¸ì¸ ì„¸ì…˜ì€ ìœ ì§€
    - CSRF ê²€ì‚¬ëŠ” ë¹„í™œì„±í™”
    """
    def enforce_csrf(self, request):
        return


==========================================================================================
# FILE: permissions.py
==========================================================================================
# ======================================================================
# PATH: apps/core/permissions.py
# ======================================================================
from rest_framework.permissions import BasePermission

from apps.core.models import TenantMembership


class IsAdminOrStaff(BasePermission):
    """
    Django admin / staff ê³„ì • ì „ìš©
    (í…Œë„ŒíŠ¸ ë¬´ê´€, ë‚´ë¶€ ê´€ë¦¬ìš©)
    """

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and (user.is_superuser or user.is_staff)
        )


class IsStudent(BasePermission):
    """
    í•™ìƒ ì „ìš© Permission
    - ë¡œê·¸ì¸ í•„ìˆ˜
    - User â†” Student OneToOne ì—°ê²° í•„ìˆ˜
    """

    message = "Student account required."

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and hasattr(user, "student_profile")
        )


class TenantResolvedAndMember(BasePermission):
    """
    âœ… Core ê¸°ë³¸ Permission (SSOT)

    - request.tenant ê°€ resolve ë˜ì–´ì•¼ í•¨
    - ì¸ì¦ëœ ì‚¬ìš©ìž
    - í™œì„± TenantMembership ì¡´ìž¬

    â— role ì€ ì—¬ê¸°ì„œ ì ˆëŒ€ í•´ì„í•˜ì§€ ì•ŠìŒ
    """

    message = "Tenant membership required."

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        return TenantMembership.objects.filter(
            tenant=tenant,
            user=user,
            is_active=True,
        ).exists()


class TenantResolvedAndStaff(BasePermission):
    """
    âœ… ìš´ì˜ë ˆë²¨ Staff ì „ìš© Permission

    í—ˆìš© role:
    - owner
    - admin
    - staff
    - teacher

    í•™ìƒ / í•™ë¶€ëª¨ ì ‘ê·¼ ì°¨ë‹¨ìš©
    """

    message = "Staff membership required."

    STAFF_ROLES = ("owner", "admin", "staff", "teacher")

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        return TenantMembership.objects.filter(
            tenant=tenant,
            user=user,
            is_active=True,
            role__in=self.STAFF_ROLES,
        ).exists()


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/core/serializers.py
from rest_framework import serializers
from django.contrib.auth import get_user_model

from apps.core.models import Attendance, Expense

User = get_user_model()


# ------------------------------------
# User Base
# ------------------------------------

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = [
            "id",
            "username",
            "name",
            "phone",
            "is_staff",
            "is_superuser",
        ]


# ------------------------------------
# Profile
# ------------------------------------

class ProfileSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ["id", "name", "phone"]


# ------------------------------------
# Attendance
# ------------------------------------

class AttendanceSerializer(serializers.ModelSerializer):
    class Meta:
        model = Attendance
        fields = "__all__"
        read_only_fields = [
            "user",
            "tenant",
            "duration_hours",
            "amount",
        ]


# ------------------------------------
# Expense
# ------------------------------------

class ExpenseSerializer(serializers.ModelSerializer):
    class Meta:
        model = Expense
        fields = "__all__"
        read_only_fields = [
            "user",
            "tenant",
        ]


==========================================================================================
# FILE: urls.py
==========================================================================================
# apps/core/urls.py

from django.urls import path, include
from rest_framework.routers import DefaultRouter

from apps.core.views import (
    MeView,
    ProfileViewSet,
    MyAttendanceViewSet,
    MyExpenseViewSet,
)

router = DefaultRouter()
router.register("profile", ProfileViewSet, basename="profile")
router.register("profile/attendance", MyAttendanceViewSet, basename="my-attendance")
router.register("profile/expenses", MyExpenseViewSet, basename="my-expense")

urlpatterns = [
    path("me/", MeView.as_view(), name="core-me"),
    path("", include(router.urls)),
]


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/core/views.py
from datetime import datetime
from django.db.models import Sum

from rest_framework.views import APIView
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response

from drf_yasg.utils import swagger_auto_schema

from apps.core.models import Attendance, Expense
from apps.core.permissions import (
    TenantResolvedAndMember,
    TenantResolvedAndStaff,
)
from apps.core.serializers import (
    UserSerializer,
    ProfileSerializer,
    AttendanceSerializer,
    ExpenseSerializer,
)


# --------------------------------------------------
# Auth: /core/me/
# --------------------------------------------------

class MeView(APIView):
    """
    ì¸ì¦ + í…Œë„ŒíŠ¸ í™•ì • + ë©¤ë²„ì‹­ ì¡´ìž¬ í™•ì¸
    (role ë¹„í•´ì„)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndMember]

    @swagger_auto_schema(auto_schema=None)
    def get(self, request):
        serializer = UserSerializer(request.user)
        return Response(serializer.data)


# --------------------------------------------------
# Profile (Staff ì˜ì—­)
# --------------------------------------------------

class ProfileViewSet(viewsets.ViewSet):
    """
    ì§ì›/ê°•ì‚¬/ê´€ë¦¬ìž ì „ìš© Profile API
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["get"])
    def me(self, request):
        serializer = ProfileSerializer(request.user)
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["patch"])
    def update_me(self, request):
        serializer = ProfileSerializer(
            request.user,
            data=request.data,
            partial=True,
        )
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["post"], url_path="change-password")
    def change_password(self, request):
        old_pw = request.data.get("old_password")
        new_pw = request.data.get("new_password")

        if not old_pw or not new_pw:
            return Response({"error": "old_password, new_password í•„ìš”"}, status=400)

        if not request.user.check_password(old_pw):
            return Response({"error": "í˜„ìž¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."}, status=400)

        request.user.set_password(new_pw)
        request.user.save()

        return Response({"message": "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ"})


# --------------------------------------------------
# Attendance (Staff ì „ìš©)
# --------------------------------------------------

class MyAttendanceViewSet(viewsets.ModelViewSet):
    """
    ì§ì› ê·¼íƒœ ê´€ë¦¬ (tenant ë‹¨ìœ„ ê²©ë¦¬)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    serializer_class = AttendanceSerializer

    def get_queryset(self):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = Attendance.objects.filter(
            user=user,
            tenant=tenant,
        )

        if month:
            qs = qs.filter(date__startswith=month)

        return qs

    def perform_create(self, serializer):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)

        start = self.request.data.get("start_time")
        end = self.request.data.get("end_time")

        try:
            start_dt = datetime.strptime(start, "%H:%M")
            end_dt = datetime.strptime(end, "%H:%M")
            duration = (end_dt - start_dt).seconds / 3600
        except Exception:
            duration = 0

        hourly = 15000
        amount = int(duration * hourly)

        serializer.save(
            tenant=tenant,
            user=user,
            duration_hours=duration,
            amount=amount,
        )

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["get"], url_path="summary")
    def summary(self, request):
        user = request.user
        tenant = getattr(request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = Attendance.objects.filter(
            user=user,
            tenant=tenant,
        )

        if month:
            qs = qs.filter(date__startswith=month)

        total_hours = qs.aggregate(Sum("duration_hours"))["duration_hours__sum"] or 0
        total_amount = qs.aggregate(Sum("amount"))["amount__sum"] or 0
        after_tax = int(total_amount * 0.967)

        return Response(
            {
                "total_hours": total_hours,
                "total_amount": total_amount,
                "total_after_tax": after_tax,
            }
        )


# --------------------------------------------------
# Expense (Staff ì „ìš©)
# --------------------------------------------------

class MyExpenseViewSet(viewsets.ModelViewSet):
    """
    ì§ì› ì§€ì¶œ ê´€ë¦¬ (tenant ë‹¨ìœ„ ê²©ë¦¬)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    serializer_class = ExpenseSerializer

    def get_queryset(self):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = Expense.objects.filter(
            user=user,
            tenant=tenant,
        )

        if month:
            qs = qs.filter(date__startswith=month)

        return qs

    def perform_create(self, serializer):
        tenant = getattr(self.request, "tenant", None)
        serializer.save(
            tenant=tenant,
            user=self.request.user,
        )


==========================================================================================
# FILE: db/__init__.py
==========================================================================================
from .tenant_queryset import TenantQuerySet

__all__ = ["TenantQuerySet"]


==========================================================================================
# FILE: db/tenant_queryset.py
==========================================================================================
# ======================================================================
# PATH: apps/core/db/tenant_queryset.py
# ======================================================================
from __future__ import annotations

from django.db import models

from apps.core.tenant.context import get_current_tenant


class TenantQuerySet(models.QuerySet):
    """
    Tenant-aware QuerySet (SSOT)

    ê·œì¹™:
    - tenantê°€ resolveë˜ì§€ ì•Šìœ¼ë©´ ê²°ê³¼ëŠ” í•­ìƒ empty
    - domain ëª¨ë¸ì— tenant FKê°€ ë¶™ëŠ” ìˆœê°„ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
    """

    def for_current_tenant(self):
        tenant = get_current_tenant()
        if tenant is None:
            return self.none()
        return self.filter(tenant=tenant)

    def require_tenant(self):
        """
        ë‚´ë¶€/ìš´ì˜ ë¡œì§ì—ì„œ tenant ê°•ì œìš©
        """
        tenant = get_current_tenant()
        if tenant is None:
            raise RuntimeError("Tenant is required but not resolved")
        return self.filter(tenant=tenant)


==========================================================================================
# FILE: middleware/__init__.py
==========================================================================================



==========================================================================================
# FILE: middleware/tenant.py
==========================================================================================
# ======================================================================
# PATH: apps/core/middleware/tenant.py
# ======================================================================
from __future__ import annotations

from dataclasses import dataclass
from typing import Optional

from django.conf import settings
from django.http import JsonResponse

from apps.core.models import Tenant
from apps.core.tenant.context import set_current_tenant, clear_current_tenant
from apps.core.tenant.resolver import resolve_tenant_from_request
from apps.core.tenant.exceptions import TenantResolutionError


@dataclass(frozen=True)
class TenantResolutionResult:
    tenant: Optional[Tenant]
    reason: str


class TenantMiddleware:
    """
    âœ… Enterprise-grade Tenant Middleware (SSOT)

    Goals:
    - Request ë‹¨ìœ„ë¡œ tenant í™•ì • (request.tenant + contextvar)
    - ë‹¨ì¼ í…Œë„ŒíŠ¸(dev/ì´ˆê¸° ìš´ì˜)ì—ì„œëŠ” í—¤ë” ì—†ì´ë„ "ì¦‰ì‹œ ë™ìž‘"
      - TENANT_DEFAULT_CODE ìžˆìœ¼ë©´ ìš°ì„ 
      - ì—†ìœ¼ë©´ í™œì„± tenantê°€ 1ê°œë©´ ìžë™ ì„ íƒ
    - ë©€í‹° í…Œë„ŒíŠ¸ ìš´ì˜ì—ì„œëŠ” tenant header ê°•ì œ ê°€ëŠ¥ (settings.TENANT_STRICT=True)

    Resolution priority:
    1) Header (default: X-Tenant-Code)
    2) Query param (optional: ?tenant=CODE)
    3) settings.TENANT_DEFAULT_CODE / env
    4) If active tenant count == 1 -> auto
    5) If exempt path -> tenant=None (bypass)
    6) Else error (400)

    Response:
    - X-Tenant-Code / X-Tenant-Id í—¤ë” ì£¼ìž… (tenant ìžˆì„ ë•Œ)
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # í•­ìƒ ì´ˆê¸°í™” (ì•ˆì „)
        clear_current_tenant()
        request.tenant = None  # type: ignore[attr-defined]

        try:
            tenant = resolve_tenant_from_request(request)
        except TenantResolutionError as e:
            return JsonResponse(
                {
                    "detail": "tenant resolution failed",
                    "code": e.code,
                    "message": e.message,
                },
                status=e.http_status,
            )

        # tenant context attach
        if tenant is not None:
            request.tenant = tenant  # type: ignore[attr-defined]
            set_current_tenant(tenant)

        response = self.get_response(request)

        # response headers (helpful for debugging / ops)
        if tenant is not None:
            response["X-Tenant-Code"] = tenant.code
            response["X-Tenant-Id"] = str(tenant.id)

        return response


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.contrib.auth.models
import django.contrib.auth.validators
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("auth", "0012_alter_user_first_name_max_length"),
    ]

    operations = [
        migrations.CreateModel(
            name="Tenant",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=255)),
                ("code", models.CharField(max_length=50, unique=True)),
                ("owner_name", models.CharField(blank=True, max_length=100)),
                ("phone", models.CharField(blank=True, max_length=50)),
                ("address", models.CharField(blank=True, max_length=255)),
                (
                    "logo",
                    models.ImageField(blank=True, null=True, upload_to="academy/logo/"),
                ),
                ("is_active", models.BooleanField(default=True)),
            ],
            options={
                "verbose_name": "Tenant",
                "verbose_name_plural": "Tenants",
            },
        ),
        migrations.CreateModel(
            name="User",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("password", models.CharField(max_length=128, verbose_name="password")),
                (
                    "last_login",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="last login"
                    ),
                ),
                (
                    "is_superuser",
                    models.BooleanField(
                        default=False,
                        help_text="Designates that this user has all permissions without explicitly assigning them.",
                        verbose_name="superuser status",
                    ),
                ),
                (
                    "username",
                    models.CharField(
                        error_messages={
                            "unique": "A user with that username already exists."
                        },
                        help_text="Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.",
                        max_length=150,
                        unique=True,
                        validators=[
                            django.contrib.auth.validators.UnicodeUsernameValidator()
                        ],
                        verbose_name="username",
                    ),
                ),
                (
                    "first_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="first name"
                    ),
                ),
                (
                    "last_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="last name"
                    ),
                ),
                (
                    "email",
                    models.EmailField(
                        blank=True, max_length=254, verbose_name="email address"
                    ),
                ),
                (
                    "is_staff",
                    models.BooleanField(
                        default=False,
                        help_text="Designates whether the user can log into this admin site.",
                        verbose_name="staff status",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Designates whether this user should be treated as active. Unselect this instead of deleting accounts.",
                        verbose_name="active",
                    ),
                ),
                (
                    "date_joined",
                    models.DateTimeField(
                        default=django.utils.timezone.now, verbose_name="date joined"
                    ),
                ),
                ("name", models.CharField(blank=True, max_length=50, null=True)),
                ("phone", models.CharField(blank=True, max_length=20, null=True)),
                (
                    "groups",
                    models.ManyToManyField(
                        blank=True, related_name="core_users", to="auth.group"
                    ),
                ),
                (
                    "user_permissions",
                    models.ManyToManyField(
                        blank=True, related_name="core_users", to="auth.permission"
                    ),
                ),
            ],
            options={
                "db_table": "accounts_user",
                "ordering": ["-id"],
            },
            managers=[
                ("objects", django.contrib.auth.models.UserManager()),
            ],
        ),
        migrations.CreateModel(
            name="Attendance",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("date", models.DateField()),
                ("start_time", models.TimeField()),
                ("end_time", models.TimeField()),
                ("work_type", models.CharField(max_length=50)),
                ("memo", models.TextField(blank=True, null=True)),
                ("duration_hours", models.FloatField(default=0)),
                ("amount", models.IntegerField(default=0)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="attendances",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "ordering": ["-date", "-start_time"],
            },
        ),
        migrations.CreateModel(
            name="Expense",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("date", models.DateField()),
                ("title", models.CharField(max_length=255)),
                ("amount", models.IntegerField()),
                ("memo", models.TextField(blank=True, null=True)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="expenses",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "ordering": ["-date"],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_tenantmembership.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 06:36

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="TenantMembership",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "role",
                    models.CharField(
                        choices=[
                            ("owner", "Owner"),
                            ("admin", "Admin"),
                            ("teacher", "Teacher"),
                            ("staff", "Staff"),
                            ("student", "Student"),
                            ("parent", "Parent"),
                        ],
                        max_length=20,
                    ),
                ),
                ("is_active", models.BooleanField(default=True)),
                ("joined_at", models.DateTimeField(auto_now_add=True)),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="memberships",
                        to="core.tenant",
                    ),
                ),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="tenant_memberships",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(
                        fields=["tenant", "user"], name="core_tenant_tenant__644160_idx"
                    )
                ],
                "unique_together": {("user", "tenant")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0003_attendance_expense_add_tenant.py
==========================================================================================
# PATH: apps/core/migrations/0003_attendance_expense_add_tenant.py
# Generated by Django 5.2.9 on 2026-02-04

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0002_tenantmembership"),
    ]

    operations = [
        migrations.AddField(
            model_name="attendance",
            name="tenant",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="attendances",
                to="core.tenant",
            ),
        ),
        migrations.AddField(
            model_name="expense",
            name="tenant",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="expenses",
                to="core.tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0004_backfill_attendance_expense_tenant.py
==========================================================================================
# PATH: apps/core/migrations/0004_backfill_attendance_expense_tenant.py
from __future__ import annotations

from django.db import migrations


def backfill_core_attendance_expense_tenant(apps, schema_editor):
    Tenant = apps.get_model("core", "Tenant")
    Attendance = apps.get_model("core", "Attendance")
    Expense = apps.get_model("core", "Expense")

    # ì´ë¯¸ ë‹¤ ì±„ì›Œì ¸ ìžˆìœ¼ë©´ ë
    if not Attendance.objects.filter(tenant__isnull=True).exists() and not Expense.objects.filter(tenant__isnull=True).exists():
        return

    # âœ… ì•ˆì „ ê°€ë“œ:
    # - ë‹¨ì¼ í™œì„± tenantë©´ ìžë™ ë°±í•„
    # - TENANT_DEFAULT_CODE(í™˜ê²½)ë¡œ ì´ë¯¸ ìš´ì˜ ê¸°ì¤€ tenantë¥¼ ê³ ì •í•˜ëŠ” ê²½ìš°ë„ ì•ˆì „í•˜ì§€ë§Œ,
    #   ë§ˆì´ê·¸ë ˆì´ì…˜ ë ˆë²¨ì—ì„œëŠ” settings ì ‘ê·¼ì„ ì•ˆ ì“°ê³  â€œDB ì‚¬ì‹¤â€ë§Œ ë³¸ë‹¤.
    active_qs = Tenant.objects.filter(is_active=True).order_by("id")
    active_count = active_qs.count()

    if active_count == 1:
        t = active_qs.first()
        Attendance.objects.filter(tenant__isnull=True).update(tenant=t)
        Expense.objects.filter(tenant__isnull=True).update(tenant=t)
        return

    # í™œì„± tenantê°€ 0ê°œ/ì—¬ëŸ¬ê°œì¸ë° tenant null ë°ì´í„°ê°€ ì¡´ìž¬í•˜ë©´
    # ìžë™ ì¶”ë¡ ì€ ìš´ì˜ì‚¬ê³ . ëª…ì‹œì ìœ¼ë¡œ ì‹¤íŒ¨í•´ì„œ ìˆ˜ë™ ì •ë¦¬ ìœ ë„.
    raise RuntimeError(
        "Cannot auto-backfill tenant for core.Attendance/core.Expense: "
        f"active_tenant_count={active_count}, but tenant NULL rows exist. "
        "Fix data manually (assign correct tenant) then re-run migration."
    )


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0003_attendance_expense_add_tenant"),
    ]

    operations = [
        migrations.RunPython(backfill_core_attendance_expense_tenant, migrations.RunPython.noop),
    ]


==========================================================================================
# FILE: migrations/0005_make_attendance_expense_tenant_not_null.py
==========================================================================================
# PATH: apps/core/migrations/0005_make_attendance_expense_tenant_not_null.py
from __future__ import annotations

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0004_backfill_attendance_expense_tenant"),
    ]

    operations = [
        migrations.AlterField(
            model_name="attendance",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="attendances",
                to="core.tenant",
                null=False,
                blank=False,
            ),
        ),
        migrations.AlterField(
            model_name="expense",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="expenses",
                to="core.tenant",
                null=False,
                blank=False,
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: models/__init__.py
==========================================================================================
# PATH: apps/core/models/__init__.py

from .tenant import Tenant
from .tenant_membership import TenantMembership
from .user import User, Attendance, Expense

__all__ = [
    "Tenant",
    "TenantMembership",
    "User",
    "Attendance",
    "Expense",
]


==========================================================================================
# FILE: models/tenant.py
==========================================================================================
from django.db import models


class Tenant(models.Model):
    """
    Tenant == Academy
    SaaS ë‹¨ìœ„ì˜ í•™ì›
    """

    name = models.CharField(max_length=255)
    code = models.CharField(max_length=50, unique=True)

    owner_name = models.CharField(max_length=100, blank=True)
    phone = models.CharField(max_length=50, blank=True)
    address = models.CharField(max_length=255, blank=True)

    logo = models.ImageField(
        upload_to="academy/logo/",
        null=True,
        blank=True,
    )

    is_active = models.BooleanField(default=True)

    class Meta:
        app_label = "core"
        verbose_name = "Tenant"
        verbose_name_plural = "Tenants"

    def __str__(self):
        return self.name


==========================================================================================
# FILE: models/tenant_membership.py
==========================================================================================
# PATH: apps/core/models/tenant_membership.py
from __future__ import annotations

from django.conf import settings
from django.db import models, transaction

from apps.core.models.tenant import Tenant


class TenantMembership(models.Model):
    """
    User â†” Tenant ê´€ê³„ SSOT

    - í•œ UserëŠ” ì—¬ëŸ¬ Tenantì— ì†í•  ìˆ˜ ìžˆìŒ (M2M)
    - Tenant ë‚´ì—ì„œ role / í™œì„± ìƒíƒœë¥¼ ëª…ì‹œ
    - unique_togetherë¡œ "ê°™ì€ tenantì— ì¤‘ë³µ ê°€ìž…" ë°©ì§€
    """

    ROLE_CHOICES = [
        ("owner", "Owner"),
        ("admin", "Admin"),
        ("teacher", "Teacher"),
        ("staff", "Staff"),
        ("student", "Student"),
        ("parent", "Parent"),
    ]

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="tenant_memberships",
    )
    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="memberships",
    )

    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    is_active = models.BooleanField(default=True)

    joined_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        app_label = "core"
        unique_together = ("user", "tenant")
        indexes = [
            models.Index(fields=["tenant", "user"]),
        ]

    def __str__(self) -> str:
        return f"{self.user} @ {self.tenant} ({self.role})"

    # ------------------------------------------------------------------
    # âœ… ìš´ì˜ SSOT helper
    # - â€œí•™ìƒ/ë¶€ëª¨ role ì—°ê²°â€ì„ í…Œë„ŒíŠ¸ ë‹¨ìœ„ë¡œ í•­ìƒ ì¼ê´€ë˜ê²Œ ë§Œë“œëŠ” ìµœì†Œ API
    # - ë„ë©”ì¸ì—ì„œ userë§Œ ìžˆìœ¼ë©´ ì´ê±¸ í˜¸ì¶œí•´ì„œ membershipì„ í™•ì •í•˜ë©´ ë¨
    # ------------------------------------------------------------------
    @classmethod
    @transaction.atomic
    def ensure_active(cls, *, tenant: Tenant, user, role: str) -> "TenantMembership":
        role = str(role).strip().lower()
        allowed = {c[0] for c in cls.ROLE_CHOICES}
        if role not in allowed:
            raise ValueError(f"invalid role: {role}")

        obj = cls.objects.select_for_update().filter(tenant=tenant, user=user).first()
        if obj:
            # role ë³€ê²½ì€ â€œìš´ì˜ ì •ì±…â€ ì˜ì—­ì´ë¼ ì—¬ê¸°ì„œ ê°•ì œ ë³€ê²½í•˜ì§€ ì•ŠìŒ.
            # ë‹¨, ë¹„í™œì„±ì´ë©´ í™œì„±í™”ëŠ” SSOTë¡œ í—ˆìš©
            if not obj.is_active:
                obj.is_active = True
                obj.save(update_fields=["is_active"])
            return obj

        return cls.objects.create(
            tenant=tenant,
            user=user,
            role=role,
            is_active=True,
        )


==========================================================================================
# FILE: models/user.py
==========================================================================================
# PATH: apps/core/models/user.py
from django.db import models
from django.conf import settings
from django.contrib.auth.models import AbstractUser, Group, Permission

from apps.api.common.models import TimestampModel
from apps.core.models.tenant import Tenant
from apps.core.db import TenantQuerySet


# --------------------------------------------------
# Custom User (AUTH_USER_MODEL)
# --------------------------------------------------

class User(AbstractUser):
    """
    Custom User ëª¨ë¸
    - AUTH_USER_MODEL = core.User
    - auth.User ì™€ì˜ groups / permissions reverse accessor ì¶©ëŒ ë°©ì§€
    """

    name = models.CharField(max_length=50, blank=True, null=True)
    phone = models.CharField(max_length=20, blank=True, null=True)

    # ðŸ”¥ í•µì‹¬: auth.User ì™€ reverse accessor ì¶©ëŒ ë°©ì§€
    groups = models.ManyToManyField(
        Group,
        related_name="core_users",
        blank=True,
    )
    user_permissions = models.ManyToManyField(
        Permission,
        related_name="core_users",
        blank=True,
    )

    class Meta:
        app_label = "core"
        db_table = "accounts_user"
        ordering = ["-id"]

    def __str__(self):
        return self.username


# --------------------------------------------------
# Attendance
# --------------------------------------------------

class Attendance(TimestampModel):
    """
    âœ… ìš´ì˜ë ˆë²¨ í•µì‹¬:
    - AttendanceëŠ” tenant ë‹¨ìœ„ë¡œ ê²©ë¦¬ë˜ì–´ì•¼ í•¨ (13+ í•™ì› ì „ì œ)
    - tenant ì—†ìœ¼ë©´ ì¡°íšŒ/ìƒì„± ë¶ˆê°€(ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ)
    """

    # âœ… ìµœì†Œìˆ˜ì •: tenant-aware manager (ìš´ì˜ ì‚¬ê³  ë°©ì§€)
    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="attendances",
        null=False,
        blank=False,
    )

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="attendances",
    )

    date = models.DateField()
    start_time = models.TimeField()
    end_time = models.TimeField()

    work_type = models.CharField(max_length=50)
    memo = models.TextField(blank=True, null=True)

    duration_hours = models.FloatField(default=0)
    amount = models.IntegerField(default=0)

    class Meta:
        app_label = "core"
        ordering = ["-date", "-start_time"]

    def __str__(self):
        return f"{self.user.username} - {self.date}"


# --------------------------------------------------
# Expense
# --------------------------------------------------

class Expense(TimestampModel):
    """
    âœ… ìš´ì˜ë ˆë²¨ í•µì‹¬:
    - Expenseë„ tenant ë‹¨ìœ„ë¡œ ê²©ë¦¬ë˜ì–´ì•¼ í•¨ (13+ í•™ì› ì „ì œ)
    - tenant ì—†ìœ¼ë©´ ì¡°íšŒ/ìƒì„± ë¶ˆê°€(ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ)
    """

    # âœ… ìµœì†Œìˆ˜ì •: tenant-aware manager (ìš´ì˜ ì‚¬ê³  ë°©ì§€)
    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="expenses",
        null=False,
        blank=False,
    )

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="expenses",
    )

    date = models.DateField()
    title = models.CharField(max_length=255)
    amount = models.IntegerField()
    memo = models.TextField(blank=True, null=True)

    class Meta:
        app_label = "core"
        ordering = ["-date"]

    def __str__(self):
        return f"{self.user.username} - {self.title}"


==========================================================================================
# FILE: tenant/__init__.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/__init__.py
# ======================================================================
from .context import (
    get_current_tenant,
    set_current_tenant,
    clear_current_tenant,
)
from .resolver import resolve_tenant_from_request
from .exceptions import TenantResolutionError

__all__ = [
    "get_current_tenant",
    "set_current_tenant",
    "clear_current_tenant",
    "resolve_tenant_from_request",
    "TenantResolutionError",
]


==========================================================================================
# FILE: tenant/context.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/context.py
# ======================================================================
from __future__ import annotations

from contextvars import ContextVar
from typing import Optional

from apps.core.models import Tenant

_current_tenant: ContextVar[Optional[Tenant]] = ContextVar("current_tenant", default=None)


def set_current_tenant(tenant: Tenant) -> None:
    _current_tenant.set(tenant)


def get_current_tenant() -> Optional[Tenant]:
    return _current_tenant.get()


def clear_current_tenant() -> None:
    _current_tenant.set(None)


==========================================================================================
# FILE: tenant/exceptions.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/exceptions.py
# ======================================================================
from __future__ import annotations


class TenantResolutionError(Exception):
    """
    Tenant resolution failures are explicit & ops-friendly.

    code:
      - tenant_missing
      - tenant_invalid
      - tenant_inactive
      - tenant_ambiguous
    """

    def __init__(
        self,
        *,
        code: str,
        message: str,
        http_status: int = 400,
    ):
        super().__init__(message)
        self.code = str(code)
        self.message = str(message)
        self.http_status = int(http_status)


==========================================================================================
# FILE: tenant/resolver.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/resolver.py
# ======================================================================
from __future__ import annotations

from typing import Optional

from django.conf import settings

from apps.core.models import Tenant
from apps.core.tenant.exceptions import TenantResolutionError


def _normalize_code(v: object) -> str:
    return str(v or "").strip()


def _header_name() -> str:
    return str(getattr(settings, "TENANT_HEADER_NAME", "X-Tenant-Code") or "X-Tenant-Code").strip()


def _query_name() -> str:
    return str(getattr(settings, "TENANT_QUERY_PARAM_NAME", "tenant") or "tenant").strip()


def _default_code() -> str:
    return _normalize_code(getattr(settings, "TENANT_DEFAULT_CODE", ""))


def _strict_mode() -> bool:
    return bool(getattr(settings, "TENANT_STRICT", False))


def _allow_inactive() -> bool:
    return bool(getattr(settings, "TENANT_ALLOW_INACTIVE", False))


def _bypass_paths() -> list[str]:
    """
    Tenantê°€ ì—†ì–´ë„ ë˜ëŠ” endpointë“¤.
    - í† í° ë°œê¸‰/ê°±ì‹ ì€ tenant ì„ í–‰ì´ ì–´ë ¤ìš´ ê²½ìš°ê°€ ìžˆì–´ ê¸°ë³¸ bypass
    - ë‚´ë¶€ ì›Œì»¤ ë£¨íŠ¸ëŠ” ê¸°ì¡´ í˜¸í™˜ ìœ„í•´ ê¸°ë³¸ bypass (workerê°€ í—¤ë” ë³´ë‚´ë©´ ìžë™ ì ìš©ë¨)
    """
    return list(
        getattr(
            settings,
            "TENANT_BYPASS_PATH_PREFIXES",
            [
                "/admin/",
                "/api/v1/token/",
                "/api/v1/token/refresh/",
                "/internal/",          # root-level internal (video worker)
                "/api/v1/internal/",   # api v1 internal (ai/video worker)
                "/swagger",
                "/redoc",
            ],
        )
    )


def _is_bypass_path(path: str) -> bool:
    p = str(path or "/")
    for prefix in _bypass_paths():
        if p.startswith(prefix):
            return True
    return False


def _get_header_value(request, header_name: str) -> str:
    # Django request.headers handles normalization
    v = request.headers.get(header_name) or ""
    return _normalize_code(v)


def _get_query_value(request, query_name: str) -> str:
    try:
        v = request.GET.get(query_name) or ""
    except Exception:
        v = ""
    return _normalize_code(v)


def _find_tenant_by_code(code: str) -> Optional[Tenant]:
    if not code:
        return None

    qs = Tenant.objects.filter(code=code)
    if not _allow_inactive():
        qs = qs.filter(is_active=True)
    return qs.first()


def _auto_pick_single_active_tenant() -> Optional[Tenant]:
    qs = Tenant.objects.filter(is_active=True).order_by("id")
    cnt = qs.count()
    if cnt == 1:
        return qs.first()
    return None


def resolve_tenant_from_request(request) -> Optional[Tenant]:
    """
    Returns:
      - Tenant instance, or
      - None (bypass path only)

    Raises:
      - TenantResolutionError
    """
    path = getattr(request, "path", "") or "/"

    # 0) bypass path: don't require tenant, but still allow if provided
    bypass = _is_bypass_path(path)

    header_name = _header_name()
    query_name = _query_name()

    # 1) explicit from header
    code = _get_header_value(request, header_name)
    if code:
        tenant = _find_tenant_by_code(code)
        if not tenant:
            # if exists but inactive, make it explicit
            exists = Tenant.objects.filter(code=code).exists()
            if exists:
                raise TenantResolutionError(
                    code="tenant_inactive",
                    message=f"Tenant '{code}' is inactive",
                    http_status=403,
                )
            raise TenantResolutionError(
                code="tenant_invalid",
                message=f"Tenant '{code}' not found",
                http_status=404,
            )
        return tenant

    # 2) optional query param
    code = _get_query_value(request, query_name)
    if code:
        tenant = _find_tenant_by_code(code)
        if not tenant:
            exists = Tenant.objects.filter(code=code).exists()
            if exists:
                raise TenantResolutionError(
                    code="tenant_inactive",
                    message=f"Tenant '{code}' is inactive",
                    http_status=403,
                )
            raise TenantResolutionError(
                code="tenant_invalid",
                message=f"Tenant '{code}' not found",
                http_status=404,
            )
        return tenant

    # 3) settings default code
    code = _default_code()
    if code:
        tenant = _find_tenant_by_code(code)
        if not tenant:
            exists = Tenant.objects.filter(code=code).exists()
            if exists:
                raise TenantResolutionError(
                    code="tenant_inactive",
                    message=f"Default tenant '{code}' is inactive",
                    http_status=403,
                )
            raise TenantResolutionError(
                code="tenant_invalid",
                message=f"Default tenant '{code}' not found",
                http_status=404,
            )
        return tenant

    # 4) auto-pick (single-tenant bootstrap)
    tenant = _auto_pick_single_active_tenant()
    if tenant:
        return tenant

    # 5) bypass path -> allow None
    if bypass:
        return None

    # 6) strict / non-strict handling
    # - strict: must specify tenant (and cannot infer)
    # - non-strict: still cannot proceed because ambiguous (multiple tenants)
    if _strict_mode():
        raise TenantResolutionError(
            code="tenant_missing",
            message=f"Tenant header '{header_name}' required",
            http_status=400,
        )

    raise TenantResolutionError(
        code="tenant_ambiguous",
        message=f"Tenant not resolved. Provide '{header_name}' header.",
        http_status=400,
    )
