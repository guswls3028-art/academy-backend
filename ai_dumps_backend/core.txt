====================================================================================================
# BACKEND APP: core
# ROOT PATH: C:\academy\apps\core
====================================================================================================


==========================================================================================
# FILE: CORE_SEAL.md
==========================================================================================
# PATH: apps/core/CORE_SEAL.md
# CORE Î¥âÏù∏ Î¨∏ÏÑú (SSOT / Enterprise Lock / FINAL)

Î≥∏ Î¨∏ÏÑúÎäî **apps/core ÎèÑÎ©îÏù∏**ÏùÑ ‚ÄúÎ¥âÏù∏(LOCK)‚ÄùÌïòÍ∏∞ ÏúÑÌïú ÏµúÏ¢Ö ÌóåÎ≤ïÏù¥Îã§.  
Ïù¥ Î¨∏ÏÑú Ïù¥ÌõÑÏùò core Î≥ÄÍ≤ΩÏùÄ **Î¶¨Ìå©ÌÑ∞ÎßÅÏù¥ ÏïÑÎãàÎùº Ïö¥ÏòÅ ÏÇ¨Í≥†**Î°ú Í∞ÑÏ£ºÌïúÎã§.

Î≥∏ Î¥âÏù∏ÏùÄ ‚ÄúÌîÑÎ¶¨ÎØ∏ÏóÑ Îã®Ïùº Ïö¥ÏòÅ‚Äù ÏÉÅÌÉúÏóêÏÑú Ï¶âÏãú Ï∂úÏãú Í∞ÄÎä•ÌïòÎ©∞,  
Ìñ•ÌõÑ ÏöîÍ∏àÏ†ú/ÏõåÏª§/Ìä∏ÎûòÌîΩ ÌôïÏû•ÏùÄ **core Ïô∏Î∂Ä ÎèÑÎ©îÏù∏**ÏóêÏÑúÎßå ÏàòÌñâÌïúÎã§.

---

## 0. Î¥âÏù∏ ÏÑ†Ïñ∏ (Final)

- apps/core Îäî **ÌîåÎû´ÌèºÏùò ÌóåÎ≤ï Í≥ÑÏ∏µ**Ïù¥Îã§.
- Í∏∞Îä• Ï∂îÍ∞Ä, Ï°∞Í±¥ Î∂ÑÍ∏∞, ÏûÑÏãú Ïö∞ÌöåÎäî **Ï†ÑÎ©¥ Í∏àÏßÄ**ÌïúÎã§.
- core Îäî ‚ÄúÌôïÏû•ÎêòÎäî Í≥≥‚ÄùÏù¥ ÏïÑÎãàÎùº ‚ÄúÎã§Î•∏ ÎèÑÎ©îÏù∏Ïù¥ ÎØøÍ≥† Ïò¨ÎùºÏÑúÎäî Í≥≥‚ÄùÏù¥Îã§.

---

## 1. CoreÏùò Ï±ÖÏûÑ Î≤îÏúÑ (Hard Boundary)

CoreÎäî **ÏïÑÎûò Ìï≠Î™©Îßå** Ï±ÖÏûÑÏßÑÎã§.

1. Tenant(ÌïôÏõê) ÏãùÎ≥Ñ Î∞è request Îã®ÏúÑ resolve
2. TenantMembership (tenant ÎÇ¥ ÏÇ¨Ïö©Ïûê Ïó≠Ìï† SSOT)
3. Program (tenant 1:1, Î∏åÎûúÎî©/Î°úÍ∑∏Ïù∏/UI/Í∏∞Îä•ÌÜ†Í∏Ä SSOT)
4. TenantDomain (host ‚Üí tenant resolve SSOT)
5. ÏµúÏÜå Í∂åÌïú Í≥ÑÏ∏µ
   - TenantResolved
   - TenantResolvedAndMember
   - TenantResolvedAndStaff

‚ùå CoreÎäî Îã§ÏùåÏùÑ **Ï†àÎåÄ Ìè¨Ìï®ÌïòÏßÄ ÏïäÎäîÎã§**:
- Í≥ºÍ∏à Î°úÏßÅ
- ÏöîÍ∏àÏ†ú ÌåêÎã®
- ÏõåÏª§ Ïàò / GPU / Ìä∏ÎûòÌîΩ Ï†ïÏ±Ö
- ÎπÑÏ¶àÎãàÏä§ Í∑úÏπô(exams, results, clinic Îì±)

---

## 2. ÌÖåÎÑåÌä∏ Í≤∞Ï†ï ÌóåÎ≤ï (Tenant Resolution Constitution)

### 2.1 Îã®Ïùº ÏßÑÏã§ ÏõêÏπô (SSOT)

Tenant Í≤∞Ï†ï Í≤ΩÎ°úÎäî **Ïò§ÏßÅ ÌïòÎÇò**Îßå ÌóàÏö©ÌïúÎã§.

request.get_host()
‚Üí normalize
‚Üí TenantDomain.host
‚Üí TenantDomain.tenant

yaml
ÏΩîÎìú Î≥µÏÇ¨

- Header / Query / Cookie / Env Í∏∞Î∞ò fallback ‚ùå
- ÌÖåÏä§Ìä∏ Ìé∏ÏùòÏö© Ïö∞Ìöå ‚ùå

---

### 2.2 bypass Í∑úÏπô

ÏïÑÎûò Í≤ΩÎ°úÎßå tenant=None ÌóàÏö©:

settings.TENANT_BYPASS_PATH_PREFIXES

yaml
ÏΩîÎìú Î≥µÏÇ¨

ÏùòÎèÑ:
- Î°úÍ∑∏Ïù∏ Ï†Ñ bootstrap
- Ìó¨Ïä§Ï≤¥ÌÅ¨
- ÎÇ¥Î∂Ä Í¥ÄÎ¶¨

Í∑∏ Ïô∏ Î™®Îì† ÏöîÏ≤≠ÏùÄ tenant resolve Ïã§Ìå® Ïãú **Ï¶âÏãú ÏóêÎü¨**.

---

## 3. TenantDomain Í∑úÏπô (Domain SSOT)

### 3.1 host Ï†ÑÏó≠ Ïú†ÎãàÌÅ¨

- `TenantDomain.host` Îäî **DB Ï†ÑÏó≠ unique**
- ÌïòÎÇòÏùò hostÎäî ÌïòÎÇòÏùò tenantÏóêÎßå Í∑ÄÏÜç

---

### 3.2 primary Í∑úÏπô (Î¥âÏù∏)

- tenant Îãπ `is_primary=True` Îäî **ÏµúÎåÄ 1Í∞ú**
- DB constraint Î°ú Í∞ïÏ†ú

ÏùòÎØ∏:
- ÎåÄÌëú ÎèÑÎ©îÏù∏ÏùÄ ÌïòÎÇò
- Ïª§Ïä§ÌÖÄ ÎèÑÎ©îÏù∏ Ï∂îÍ∞ÄÎäî Í∞ÄÎä•
- ÎåÄÌëú ÎèÑÎ©îÏù∏ Îã§Ï§ë ÌóàÏö© ‚ùå

---

### 3.3 active Í∑úÏπô

Resolve ÎåÄÏÉÅ Ï°∞Í±¥:

TenantDomain.is_active == True
AND
Tenant.is_active == True

yaml
ÏΩîÎìú Î≥µÏÇ¨

- ÎπÑÌôúÏÑ± ÏÉÅÌÉú Ï†ëÍ∑º Ïãú:
  - 403
  - code = tenant_inactive

---

## 4. Program Í∑úÏπô (Tenant 1:1 SSOT)

### 4.1 ProgramÏùò Ï†ïÏ≤¥ÏÑ±

- Program == ‚ÄúÏõêÏû• Í∞úÏù∏ ÌîÑÎ°úÍ∑∏Îû®‚Äù
- TenantÏôÄ **1:1**
- Î™®Îì† UI / Î°úÍ∑∏Ïù∏ / Í∏∞Îä• Î∂ÑÍ∏∞Îäî Program Í∏∞Ï§Ä

---

### 4.2 ÏÉùÏÑ± Ï±ÖÏûÑ Îã®ÏùºÌôî

Program row ÏÉùÏÑ±ÏùÄ Îã§Ïùå ÏãúÏ†êÏóêÏÑúÎßå ÌóàÏö©:

- Tenant ÏÉùÏÑ± Ïãú bootstrap
  - signals
  - migration bootstrap

‚ùå API GET Ïãú ÏûêÎèô ÏÉùÏÑ±(write-on-read) Í∏àÏßÄ  
‚ùå ÌîÑÎ°†Ìä∏ Ï†ëÍ∑ºÏùÑ Ïù¥Ïú†Î°ú ÏÉùÏÑ± Í∏àÏßÄ

---

### 4.3 ÎàÑÎùΩÏùÄ Ïö¥ÏòÅ ÏÇ¨Í≥†

- Program ÎàÑÎùΩ ÏÉÅÌÉúÎäî **Ï†ïÏÉÅ ÏÉÅÌÉúÍ∞Ä ÏïÑÎãò**
- Î∞òÎìúÏãú Îã§ÏùåÏúºÎ°ú Ïã§Ìå®ÌïúÎã§:

HTTP 500
code = program_missing

yaml
ÏΩîÎìú Î≥µÏÇ¨

ÏûêÎèô ÏÉùÏÑ±ÏùÄ Ïû•Ïï†Î•º Ïà®Í∏∞Îäî ÌñâÏúÑÎ°ú Í∞ÑÏ£ºÌïúÎã§.

---

## 5. Permission / Role SSOT

### 5.1 Îã®Ïùº Ïã†Î¢∞ ÏõêÏ≤ú

- ÌîÑÎ°†Ìä∏Îäî roleÏùÑ Ï∂îÎ°†ÌïòÏßÄ ÏïäÎäîÎã§.
- `/api/v1/core/me/` ÏùëÎãµÏùò `tenantRole` Îßå Ïã†Î¢∞ÌïúÎã§.
- Î™®Îì† Í∂åÌïú Ìï¥ÏÑùÏùÄ Permission classÏóêÏÑúÎßå ÏàòÌñâÌïúÎã§.

---

### 5.2 ÌóàÏö© Permission Í≥ÑÏ∏µ

- TenantResolved
- TenantResolvedAndMember
- TenantResolvedAndStaff

‚ùå View ÎÇ¥Î∂Ä if role Î∂ÑÍ∏∞ Í∏àÏßÄ  
‚ùå ÌîÑÎ°†Ìä∏ Ï°∞Í±¥Î¨∏ Í∏∞Î∞ò Í∂åÌïú Ï≤òÎ¶¨ Í∏àÏßÄ

---

## 6. ÏöîÍ∏àÏ†ú / ÏõåÏª§ Ï†ïÏ±ÖÏóê ÎåÄÌïú ÌóåÎ≤ïÏ†Å ÏúÑÏπò

### 6.1 ÌòÑÏû¨ Ïö¥ÏòÅ ÏÉÅÌÉú

- Ï∂úÏãú Ï¥àÍ∏∞: **Premium Îã®Ïùº Ïö¥ÏòÅ**
- Î™®Îì† tenantÎäî PremiumÏúºÎ°ú Í∞ÑÏ£º

---

### 6.2 Lite / Basic / Premium ÌôïÏû• ÏõêÏπô

- ÏöîÍ∏àÏ†ú Í∞úÎÖêÏùÄ **CoreÏóê Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäîÎã§**
- Ìñ•ÌõÑ ÌôïÏû•ÏùÄ Îã§Ïùå ÏúÑÏπòÏóêÏÑúÎßå ÌóàÏö©:
  - Program.feature_flags
  - Î≥ÑÎèÑ billing / policy / worker ÎèÑÎ©îÏù∏

CoreÎäî ÏöîÍ∏àÏ†ú ÌåêÎã®ÏùÑ **Ï†àÎåÄ ÏàòÌñâÌïòÏßÄ ÏïäÎäîÎã§**.

---

## 7. Î≥ÄÍ≤Ω Í∏àÏßÄ Î™©Î°ù (Hard Lock)

Îã§Ïùå ÌñâÏúÑÎäî **Î¥âÏù∏ ÏúÑÎ∞ò**Ïù¥Îã§.

- tenant resolve fallback Ï∂îÍ∞Ä
- Program write-on-read Î∂ÄÌôú
- TenantDomain primary Îã§Ï§ë ÌóàÏö©
- host Ïô∏ ÏãùÎ≥ÑÏûê Í∏∞Î∞ò Î©ÄÌã∞ÌÖåÎÑåÌä∏
- coreÏóê Í≥ºÍ∏à/ÏöîÍ∏àÏ†ú/ÏõåÏª§ Î°úÏßÅ Ï∂îÍ∞Ä

---

## 8. ÌóàÏö©ÎêòÎäî ÌôïÏû• (Î™ÖÏãúÏ†Å ÌóàÏö©)

Îã§ÏùåÏùÄ Î¥âÏù∏ ÏúÑÎ∞òÏù¥ ÏïÑÎãàÎã§.

- TenantDomain Ïö¥ÏòÅ ÌïÑÎìú Ï∂îÍ∞Ä
  - Ïòà: verified_at, ssl_status
- Program.feature_flags / ui_config ÌôïÏû•
- TenantMembership role Ï∂îÍ∞Ä
- core Ïô∏Î∂Ä ÎèÑÎ©îÏù∏ÏóêÏÑúÏùò Ï†ïÏ±Ö ÌôïÏû•

---

## 9. ÏµúÏ¢Ö Í≤∞Î°† (Seal)

apps/coreÎäî **ÌîåÎû´ÌèºÏùò Í∏∞Î∞ò ÌóåÎ≤ï**Ïù¥Îã§.  
Ïù¥ Î¨∏ÏÑú Ï±ÑÌÉù Ïù¥ÌõÑ, apps/coreÎäî **Î¥âÏù∏(LOCK)** ÏÉÅÌÉúÎ°ú Í∞ÑÏ£ºÌïúÎã§.

Ïù¥ÌõÑ Í∞úÎ∞úÏùÄ:
- Îçî Îπ†Î•¥Í≤å
- Îçî ÏïàÏ†ÑÌïòÍ≤å
- Îçî Îã®ÏàúÌïòÍ≤å

ÏßÑÌñâÌï† Ïàò ÏûàÎã§.

---

## üîí SEAL STATUS

- Status: LOCKED
- Change Policy: Bugfix only
- Owner: Platform Core
- Violation = Production Incident


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: admin.py
==========================================================================================
# PATH: apps/core/admin.py
from django.contrib import admin

from apps.core.models import Tenant, TenantDomain, TenantMembership, Program


@admin.register(Tenant)
class TenantAdmin(admin.ModelAdmin):
    list_display = ("id", "name", "code", "is_active")
    list_filter = ("is_active",)
    search_fields = ("name", "code")


@admin.register(TenantDomain)
class TenantDomainAdmin(admin.ModelAdmin):
    list_display = ("id", "tenant", "host", "is_primary", "is_active")
    list_filter = ("is_primary", "is_active")


@admin.register(TenantMembership)
class TenantMembershipAdmin(admin.ModelAdmin):
    list_display = ("id", "tenant", "user", "role", "is_active", "joined_at")
    list_filter = ("role", "is_active")


@admin.register(Program)
class ProgramAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "tenant",
        "display_name",
        "brand_key",
        "login_variant",
        "plan",
        "is_active",
    )
    list_filter = ("login_variant", "plan", "is_active")


==========================================================================================
# FILE: apps.py
==========================================================================================
# PATH: apps/core/apps.py
from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.core"
    label = "core"

    def ready(self):
        # signals import (tenant bootstrap SSOT)
        from . import signals  # noqa: F401


==========================================================================================
# FILE: authentication.py
==========================================================================================
# apps/core/authentication.py

from rest_framework.authentication import SessionAuthentication


class CsrfExemptSessionAuthentication(SessionAuthentication):
    """
    API Ï†ÑÏö© SessionAuthentication
    - Î°úÍ∑∏Ïù∏ ÏÑ∏ÏÖòÏùÄ Ïú†ÏßÄ
    - CSRF Í≤ÄÏÇ¨Îäî ÎπÑÌôúÏÑ±Ìôî
    """
    def enforce_csrf(self, request):
        return


==========================================================================================
# FILE: permissions.py
==========================================================================================
# PATH: apps/core/permissions.py
from rest_framework.permissions import BasePermission

from apps.core.models import TenantMembership


class IsAdminOrStaff(BasePermission):
    """
    Django admin / staff Í≥ÑÏ†ï Ï†ÑÏö©
    (ÌÖåÎÑåÌä∏ Î¨¥Í¥Ä, ÎÇ¥Î∂Ä Í¥ÄÎ¶¨Ïö©)
    """

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and (user.is_superuser or user.is_staff)
        )


class IsStudent(BasePermission):
    """
    ÌïôÏÉù Ï†ÑÏö© Permission
    - Î°úÍ∑∏Ïù∏ ÌïÑÏàò
    - User ‚Üî Student OneToOne Ïó∞Í≤∞ ÌïÑÏàò
    """

    message = "Student account required."

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and hasattr(user, "student_profile")
        )


class TenantResolved(BasePermission):
    """
    ‚úÖ Tenant Resolve only (SSOT)

    - request.tenant Í∞Ä resolve ÎêòÏñ¥Ïïº Ìï®
    - Ïù∏Ï¶ù/Î©§Î≤ÑÏã≠ÏùÄ ÏöîÍµ¨ÌïòÏßÄ ÏïäÏùå

    ÏÇ¨Ïö©Ï≤ò:
    - Î°úÍ∑∏Ïù∏ Ï†Ñ Public bootstrap (Program config, Tenant-bound public metadata)
    """

    message = "Tenant must be resolved."

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        return bool(tenant)


class TenantResolvedAndMember(BasePermission):
    """
    ‚úÖ Core Í∏∞Î≥∏ Permission (SSOT)

    - request.tenant Í∞Ä resolve ÎêòÏñ¥Ïïº Ìï®
    - Ïù∏Ï¶ùÎêú ÏÇ¨Ïö©Ïûê
    - ÌôúÏÑ± TenantMembership Ï°¥Ïû¨

    ‚ùó role ÏùÄ Ïó¨Í∏∞ÏÑú Ï†àÎåÄ Ìï¥ÏÑùÌïòÏßÄ ÏïäÏùå
    """

    message = "Tenant membership required."

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        return TenantMembership.objects.filter(
            tenant=tenant,
            user=user,
            is_active=True,
        ).exists()


class TenantResolvedAndStaff(BasePermission):
    """
    ‚úÖ Ïö¥ÏòÅÎ†àÎ≤® Staff Ï†ÑÏö© Permission

    ÌóàÏö© role:
    - owner
    - admin
    - staff
    - teacher

    ÌïôÏÉù / ÌïôÎ∂ÄÎ™® Ï†ëÍ∑º Ï∞®Îã®Ïö©
    """

    message = "Staff membership required."

    STAFF_ROLES = ("owner", "admin", "staff", "teacher")

    def has_permission(self, request, view):
        tenant = getattr(request, "tenant", None)
        user = request.user

        if not tenant:
            return False

        if not user or not user.is_authenticated:
            return False

        return TenantMembership.objects.filter(
            tenant=tenant,
            user=user,
            is_active=True,
            role__in=self.STAFF_ROLES,
        ).exists()


==========================================================================================
# FILE: serializers.py
==========================================================================================
# PATH: apps/core/serializers.py
from rest_framework import serializers
from django.contrib.auth import get_user_model

from apps.core.models import Attendance, Expense, TenantMembership, Program

User = get_user_model()


class UserSerializer(serializers.ModelSerializer):
    tenantRole = serializers.SerializerMethodField()
    linkedStudentId = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = [
            "id",
            "username",
            "name",
            "phone",
            "is_staff",
            "is_superuser",
            "tenantRole",
            "linkedStudentId",
        ]

    def get_tenantRole(self, user):
        request = self.context.get("request")
        tenant = getattr(request, "tenant", None)

        if not tenant:
            return None

        membership = (
            TenantMembership.objects
            .filter(tenant=tenant, user=user, is_active=True)
            .only("role")
            .first()
        )

        return membership.role if membership else None

    def get_linkedStudentId(self, user):
        """ÌïôÎ∂ÄÎ™®(role=parent)Ïùº Îïå Ïó∞Í≤∞Îêú ÌïôÏÉù ID (Ï≤´ Î≤àÏß∏)"""
        request = self.context.get("request")
        tenant = getattr(request, "tenant", None)
        if not tenant:
            return None

        membership = (
            TenantMembership.objects
            .filter(tenant=tenant, user=user, is_active=True)
            .only("role")
            .first()
        )
        if not membership or membership.role != "parent":
            return None

        from apps.domains.parents.models import Parent
        parent = Parent.objects.filter(user=user).first()
        if not parent:
            return None
        first_student = parent.students.filter(deleted_at__isnull=True).first()
        return first_student.id if first_student else None


class ProgramPublicSerializer(serializers.ModelSerializer):
    tenantCode = serializers.SerializerMethodField()

    class Meta:
        model = Program
        fields = [
            "tenantCode",
            "display_name",
            "brand_key",
            "login_variant",
            "plan",
            "feature_flags",
            "ui_config",
            "is_active",
        ]

    def get_tenantCode(self, obj: Program) -> str:
        return obj.tenant.code


class ProgramUpdateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Program
        fields = [
            "display_name",
            "brand_key",
            "login_variant",
            "plan",
            "feature_flags",
            "ui_config",
            "is_active",
        ]


class ProfileSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ["id", "name", "phone"]


class AttendanceSerializer(serializers.ModelSerializer):
    class Meta:
        model = Attendance
        fields = "__all__"
        read_only_fields = ["user", "tenant", "duration_hours", "amount"]


class ExpenseSerializer(serializers.ModelSerializer):
    class Meta:
        model = Expense
        fields = "__all__"
        read_only_fields = ["user", "tenant"]


==========================================================================================
# FILE: signals.py
==========================================================================================
# PATH: apps/core/signals.py
from __future__ import annotations

from django.db import transaction
from django.db.models.signals import post_save
from django.dispatch import receiver

from apps.core.models import Tenant, TenantDomain, Program


def _normalize_host(host: str) -> str:
    v = str(host or "").strip().lower()
    if not v:
        return ""
    return v.split(":")[0].strip()


@receiver(post_save, sender=Tenant)
def bootstrap_tenant_core_rows(sender, instance: Tenant, created: bool, **kwargs):
    if not created:
        return

    host = _normalize_host(instance.code)

    with transaction.atomic():
        Program.objects.get_or_create(
            tenant=instance,
            defaults={
                "display_name": "HakwonPlus",
                "brand_key": "hakwonplus",
                "login_variant": Program.LoginVariant.HAKWONPLUS,
                "plan": Program.Plan.PREMIUM,
                "feature_flags": {
                    "student_app_enabled": True,
                    "admin_enabled": True,
                    "attendance_hourly_rate": 15000,
                },
                "ui_config": {
                    "login_title": "HakwonPlus Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏",
                    "login_subtitle": "",
                },
                "is_active": True,
            },
        )

        if host:
            TenantDomain.objects.get_or_create(
                host=host,
                defaults={
                    "tenant": instance,
                    "is_primary": True,
                    "is_active": True,
                },
            )


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/core/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter

from apps.core.views import (
    MeView,
    ProgramView,
    ProfileViewSet,
    MyAttendanceViewSet,
    MyExpenseViewSet,
)

router = DefaultRouter()
router.register("profile", ProfileViewSet, basename="profile")
router.register("profile/attendance", MyAttendanceViewSet, basename="my-attendance")
router.register("profile/expenses", MyExpenseViewSet, basename="my-expense")

urlpatterns = [
    path("me/", MeView.as_view(), name="core-me"),
    path("program/", ProgramView.as_view(), name="core-program"),
    path("", include(router.urls)),
]


==========================================================================================
# FILE: views.py
==========================================================================================
# PATH: apps/core/views.py
from datetime import datetime
from django.db.models import Sum

from rest_framework.views import APIView
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated, AllowAny
from rest_framework.response import Response

from drf_yasg.utils import swagger_auto_schema

from apps.core.models import Attendance, Expense, Program
from apps.core.permissions import (
    TenantResolved,
    TenantResolvedAndMember,
    TenantResolvedAndStaff,
)
from apps.core.serializers import (
    UserSerializer,
    ProfileSerializer,
    AttendanceSerializer,
    ExpenseSerializer,
    ProgramPublicSerializer,
    ProgramUpdateSerializer,
)
from apps.core.services.attendance_policy import calculate_duration_hours, calculate_amount
from apps.core.services.expense_policy import normalize_expense_amount


# --------------------------------------------------
# Auth: /core/me/
# --------------------------------------------------

class MeView(APIView):
    """
    ‚úÖ Core Auth Endpoint (Enterprise Final)

    - Ïù∏Ï¶ù ÌïÑÏàò
    - tenant ÌôïÏ†ï ÌïÑÏàò
    - TenantMembership Ï°¥Ïû¨ ÌïÑÏàò
    - tenant Í∏∞Ï§Ä role ÏùÑ tenantRole Î°ú Î∞òÌôò
    - ÌîÑÎ°†Ìä∏Îäî Ïù¥ ÏùëÎãµÎßå Ïã†Î¢∞ (SSOT)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndMember]

    @swagger_auto_schema(auto_schema=None)
    def get(self, request):
        serializer = UserSerializer(
            request.user,
            context={"request": request},  # ‚úÖ ÌïµÏã¨
        )
        return Response(serializer.data)


# --------------------------------------------------
# Program: /core/program/
# --------------------------------------------------

class ProgramView(APIView):
    """
    ‚úÖ Program SSOT Endpoint (Enterprise)

    GET  /api/v1/core/program/
      - Î°úÍ∑∏Ïù∏ Ï†Ñ AllowAny
      - tenant resolve ÌïÑÏàò
      - DB write Î∞úÏÉù Í∏àÏßÄ (read-only Î≥¥Ïû•)

    PATCH /api/v1/core/program/
      - Staff only
      - tenant resolve ÌïÑÏàò
      - Ìï¥Îãπ tenantÏùò ProgramÎßå ÏàòÏ†ï Í∞ÄÎä• (1:1)
    """

    @swagger_auto_schema(auto_schema=None)
    def get(self, request):
        tenant = getattr(request, "tenant", None)
        if tenant is None:
            return Response({"detail": "tenant must be resolved"}, status=400)

        program = Program.objects.filter(tenant=tenant).first()
        if program is None:
            # Ïö¥ÏòÅÏóêÏÑúÎäî Tenant ÏÉùÏÑ± Ïãú signalÏúºÎ°ú Program ÏÉùÏÑ±. ÏóÜÏúºÎ©¥ 404 (ÌîÑÎ°†Ìä∏ÏóêÏÑú Ï≤òÎ¶¨)
            return Response(
                {
                    "detail": "program not initialized for tenant",
                    "code": "program_missing",
                    "tenant": tenant.code,
                },
                status=404,
            )

        data = ProgramPublicSerializer(program).data
        return Response(data)

    @swagger_auto_schema(auto_schema=None)
    def patch(self, request):
        tenant = getattr(request, "tenant", None)
        if tenant is None:
            return Response({"detail": "tenant must be resolved"}, status=400)

        program = Program.objects.filter(tenant=tenant).first()
        if program is None:
            return Response(
                {
                    "detail": "program not initialized for tenant",
                    "code": "program_missing",
                    "tenant": tenant.code,
                },
                status=404,
            )

        serializer = ProgramUpdateSerializer(
            program,
            data=(request.data if isinstance(request.data, dict) else {}),
            partial=True,
        )
        serializer.is_valid(raise_exception=True)
        serializer.save()

        return Response(ProgramPublicSerializer(program).data)

    def get_permissions(self):
        if self.request.method == "GET":
            return [AllowAny(), TenantResolved()]
        return [IsAuthenticated(), TenantResolvedAndStaff()]


# --------------------------------------------------
# Profile (Staff ÏòÅÏó≠)
# --------------------------------------------------

class ProfileViewSet(viewsets.ViewSet):
    """
    ÏßÅÏõê/Í∞ïÏÇ¨/Í¥ÄÎ¶¨Ïûê Ï†ÑÏö© Profile API
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["get"])
    def me(self, request):
        serializer = ProfileSerializer(request.user)
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["patch"])
    def update_me(self, request):
        serializer = ProfileSerializer(
            request.user,
            data=request.data,
            partial=True,
        )
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["post"], url_path="change-password")
    def change_password(self, request):
        old_pw = request.data.get("old_password")
        new_pw = request.data.get("new_password")

        if not old_pw or not new_pw:
            return Response({"error": "old_password, new_password ÌïÑÏöî"}, status=400)

        if not request.user.check_password(old_pw):
            return Response({"error": "ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§."}, status=400)

        request.user.set_password(new_pw)
        request.user.save()

        return Response({"message": "ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω ÏôÑÎ£å"})


# --------------------------------------------------
# Attendance (Staff Ï†ÑÏö©)
# --------------------------------------------------

class MyAttendanceViewSet(viewsets.ModelViewSet):
    """
    ÏßÅÏõê Í∑ºÌÉú Í¥ÄÎ¶¨ (tenant Îã®ÏúÑ Í≤©Î¶¨)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    serializer_class = AttendanceSerializer

    def get_queryset(self):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = Attendance.objects.filter(
            user=user,
            tenant=tenant,
        )

        if month:
            qs = qs.filter(date__startswith=month)

        return qs

    def perform_create(self, serializer):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)

        start = self.request.data.get("start_time")
        end = self.request.data.get("end_time")

        duration = calculate_duration_hours(start, end)
        amount = calculate_amount(tenant, duration) if tenant is not None else 0

        serializer.save(
            tenant=tenant,
            user=user,
            duration_hours=duration,
            amount=amount,
        )

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=["get"], url_path="summary")
    def summary(self, request):
        user = request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = Attendance.objects.filter(
            user=user,
            tenant=tenant,
        )

        if month:
            qs = qs.filter(date__startswith=month)

        total_hours = qs.aggregate(Sum("duration_hours"))["duration_hours__sum"] or 0
        total_amount = qs.aggregate(Sum("amount"))["amount__sum"] or 0
        after_tax = int(total_amount * 0.967)

        return Response(
            {
                "total_hours": total_hours,
                "total_amount": total_amount,
                "total_after_tax": after_tax,
            }
        )


# --------------------------------------------------
# Expense (Staff Ï†ÑÏö©)
# --------------------------------------------------

class MyExpenseViewSet(viewsets.ModelViewSet):
    """
    ÏßÅÏõê ÏßÄÏ∂ú Í¥ÄÎ¶¨ (tenant Îã®ÏúÑ Í≤©Î¶¨)
    """

    permission_classes = [IsAuthenticated, TenantResolvedAndStaff]
    serializer_class = ExpenseSerializer

    def get_queryset(self):
        user = self.request.user
        tenant = getattr(self.request, "tenant", None)
        month = self.request.query_params.get("month")

        qs = Expense.objects.filter(
            user=user,
            tenant=tenant,
        )

        if month:
            qs = qs.filter(date__startswith=month)

        return qs

    def perform_create(self, serializer):
        tenant = getattr(self.request, "tenant", None)
        raw_amount = self.request.data.get("amount")
        serializer.save(
            tenant=tenant,
            user=self.request.user,
            amount=normalize_expense_amount(raw_amount),
        )


==========================================================================================
# FILE: db/__init__.py
==========================================================================================
from .tenant_queryset import TenantQuerySet

__all__ = ["TenantQuerySet"]


==========================================================================================
# FILE: db/tenant_queryset.py
==========================================================================================
# ======================================================================
# PATH: apps/core/db/tenant_queryset.py
# ======================================================================
from __future__ import annotations

from django.db import models

from apps.core.tenant.context import get_current_tenant


class TenantQuerySet(models.QuerySet):
    """
    Tenant-aware QuerySet (SSOT)

    Í∑úÏπô:
    - tenantÍ∞Ä resolveÎêòÏßÄ ÏïäÏúºÎ©¥ Í≤∞Í≥ºÎäî Ìï≠ÏÉÅ empty
    - domain Î™®Îç∏Ïóê tenant FKÍ∞Ä Î∂ôÎäî ÏàúÍ∞Ñ Î∞îÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•
    """

    def for_current_tenant(self):
        tenant = get_current_tenant()
        if tenant is None:
            return self.none()
        return self.filter(tenant=tenant)

    def require_tenant(self):
        """
        ÎÇ¥Î∂Ä/Ïö¥ÏòÅ Î°úÏßÅÏóêÏÑú tenant Í∞ïÏ†úÏö©
        """
        tenant = get_current_tenant()
        if tenant is None:
            raise RuntimeError("Tenant is required but not resolved")
        return self.filter(tenant=tenant)


==========================================================================================
# FILE: management/__init__.py
==========================================================================================



==========================================================================================
# FILE: management/commands/__init__.py
==========================================================================================



==========================================================================================
# FILE: management/commands/ensure_localhost_tenant.py
==========================================================================================
# PATH: apps/core/management/commands/ensure_localhost_tenant.py
"""
Î°úÏª¨ Í∞úÎ∞ú Ïãú localhost ‚Üí tenant Ïó∞Í≤∞.

- Host Í∏∞Î∞ò tenant resolverÎäî DBÏùò TenantDomainÎßå ÏÇ¨Ïö©Ìï®.
- localhost:8000 ÏúºÎ°ú Ï†ëÏÜçÌïòÎ©¥ host='localhost' Î°ú Ï°∞ÌöåÌïòÎäîÎç∞,
  Ìï¥Îãπ TenantDomainÏù¥ ÏóÜÏúºÎ©¥ /api/v1/core/me/, /api/v1/core/program/ Îì±Ïù¥ 404.
- Ïù¥ Î™ÖÎ†πÏùÑ Ìïú Î≤à Ïã§ÌñâÌïòÎ©¥ localhost(Î∞è 127.0.0.1)Í∞Ä Ï≤´ Î≤àÏß∏ tenantÏóê Ïó∞Í≤∞Îê®.

ÏÇ¨Ïö©:
  python manage.py ensure_localhost_tenant
"""
from django.core.management.base import BaseCommand

from apps.core.models import Tenant, TenantDomain


def normalize_host(host: str) -> str:
    v = str(host or "").strip().lower()
    if not v:
        return ""
    return v.split(":")[0].strip()


class Command(BaseCommand):
    help = "Ensure localhost (and 127.0.0.1) are mapped to a tenant for local dev."

    def handle(self, *args, **options):
        tenant = Tenant.objects.filter(is_active=True).order_by("id").first()
        if not tenant:
            self.stderr.write(
                self.style.ERROR("No active Tenant found. Create a tenant first (e.g. via admin or migration).")
            )
            return

        for host in ("localhost", "127.0.0.1"):
            domain, created = TenantDomain.objects.get_or_create(
                host=host,
                defaults={
                    "tenant": tenant,
                    "is_primary": False,
                    "is_active": True,
                },
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f"Created TenantDomain: {host} -> {tenant.code}"))
            else:
                if domain.tenant_id != tenant.id:
                    domain.tenant = tenant
                    domain.is_active = True
                    domain.save()
                    self.stdout.write(self.style.WARNING(f"Updated TenantDomain: {host} -> {tenant.code}"))
                else:
                    self.stdout.write(f"Already exists: {host} -> {tenant.code}")

        self.stdout.write(
            self.style.SUCCESS("Done. Requests to http://localhost:8000 will now resolve to this tenant.")
        )


==========================================================================================
# FILE: middleware/__init__.py
==========================================================================================



==========================================================================================
# FILE: middleware/tenant.py
==========================================================================================
# PATH: apps/core/middleware/tenant.py
from __future__ import annotations

from django.http import JsonResponse

from apps.core.tenant.context import set_current_tenant, clear_current_tenant
from apps.core.tenant.resolver import resolve_tenant_from_request
from apps.core.tenant.exceptions import TenantResolutionError


class TenantMiddleware:
    """
    Enterprise Tenant Middleware (Domain 1:1)

    - Request Îã®ÏúÑ tenant ÌôïÏ†ï
    - tenant source: request.get_host() -> TenantDomain.host
    - bypass pathÎßå tenant=None ÌóàÏö©

    ‚úÖ Í∞úÏÑ†(Î¥âÏù∏ Î†àÎ≤®):
    - request Ï≤òÎ¶¨ Ï¢ÖÎ£å ÌõÑ, Ïñ¥Îñ§ Í≤ΩÏö∞ÏóêÎèÑ clear_current_tenant() (finally)
      -> contextvars ÎàÑÏàò/Ïò§Ïóº Î∞©ÏßÄ
    """

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        clear_current_tenant()
        request.tenant = None  # type: ignore[attr-defined]

        try:
            tenant = resolve_tenant_from_request(request)
        except TenantResolutionError as e:
            # tenant contextÎäî Ïù¥ÎØ∏ clear ÏÉÅÌÉú
            return JsonResponse(
                {
                    "detail": "tenant resolution failed",
                    "code": e.code,
                    "message": e.message,
                },
                status=e.http_status,
            )

        try:
            if tenant is not None:
                request.tenant = tenant  # type: ignore[attr-defined]
                set_current_tenant(tenant)

            response = self.get_response(request)

            if tenant is not None:
                response["X-Tenant-Code"] = tenant.code
                response["X-Tenant-Id"] = str(tenant.id)

            return response
        finally:
            # ‚úÖ Ïñ¥Îñ§ ÏòàÏô∏/Î¶¨ÌÑ¥ Í≤ΩÎ°úÎì† tenant Ïª®ÌÖçÏä§Ìä∏ Ï¢ÖÎ£å
            clear_current_tenant()


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.contrib.auth.models
import django.contrib.auth.validators
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ("auth", "0012_alter_user_first_name_max_length"),
    ]

    operations = [
        migrations.CreateModel(
            name="Tenant",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("name", models.CharField(max_length=255)),
                ("code", models.CharField(max_length=50, unique=True)),
                ("owner_name", models.CharField(blank=True, max_length=100)),
                ("phone", models.CharField(blank=True, max_length=50)),
                ("address", models.CharField(blank=True, max_length=255)),
                (
                    "logo",
                    models.ImageField(blank=True, null=True, upload_to="academy/logo/"),
                ),
                ("is_active", models.BooleanField(default=True)),
            ],
            options={
                "verbose_name": "Tenant",
                "verbose_name_plural": "Tenants",
            },
        ),
        migrations.CreateModel(
            name="User",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("password", models.CharField(max_length=128, verbose_name="password")),
                (
                    "last_login",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="last login"
                    ),
                ),
                (
                    "is_superuser",
                    models.BooleanField(
                        default=False,
                        help_text="Designates that this user has all permissions without explicitly assigning them.",
                        verbose_name="superuser status",
                    ),
                ),
                (
                    "username",
                    models.CharField(
                        error_messages={
                            "unique": "A user with that username already exists."
                        },
                        help_text="Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.",
                        max_length=150,
                        unique=True,
                        validators=[
                            django.contrib.auth.validators.UnicodeUsernameValidator()
                        ],
                        verbose_name="username",
                    ),
                ),
                (
                    "first_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="first name"
                    ),
                ),
                (
                    "last_name",
                    models.CharField(
                        blank=True, max_length=150, verbose_name="last name"
                    ),
                ),
                (
                    "email",
                    models.EmailField(
                        blank=True, max_length=254, verbose_name="email address"
                    ),
                ),
                (
                    "is_staff",
                    models.BooleanField(
                        default=False,
                        help_text="Designates whether the user can log into this admin site.",
                        verbose_name="staff status",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(
                        default=True,
                        help_text="Designates whether this user should be treated as active. Unselect this instead of deleting accounts.",
                        verbose_name="active",
                    ),
                ),
                (
                    "date_joined",
                    models.DateTimeField(
                        default=django.utils.timezone.now, verbose_name="date joined"
                    ),
                ),
                ("name", models.CharField(blank=True, max_length=50, null=True)),
                ("phone", models.CharField(blank=True, max_length=20, null=True)),
                (
                    "groups",
                    models.ManyToManyField(
                        blank=True, related_name="core_users", to="auth.group"
                    ),
                ),
                (
                    "user_permissions",
                    models.ManyToManyField(
                        blank=True, related_name="core_users", to="auth.permission"
                    ),
                ),
            ],
            options={
                "db_table": "accounts_user",
                "ordering": ["-id"],
            },
            managers=[
                ("objects", django.contrib.auth.models.UserManager()),
            ],
        ),
        migrations.CreateModel(
            name="Attendance",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("date", models.DateField()),
                ("start_time", models.TimeField()),
                ("end_time", models.TimeField()),
                ("work_type", models.CharField(max_length=50)),
                ("memo", models.TextField(blank=True, null=True)),
                ("duration_hours", models.FloatField(default=0)),
                ("amount", models.IntegerField(default=0)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="attendances",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "ordering": ["-date", "-start_time"],
            },
        ),
        migrations.CreateModel(
            name="Expense",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("date", models.DateField()),
                ("title", models.CharField(max_length=255)),
                ("amount", models.IntegerField()),
                ("memo", models.TextField(blank=True, null=True)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="expenses",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "ordering": ["-date"],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_tenantmembership.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-04 06:36

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="TenantMembership",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "role",
                    models.CharField(
                        choices=[
                            ("owner", "Owner"),
                            ("admin", "Admin"),
                            ("teacher", "Teacher"),
                            ("staff", "Staff"),
                            ("student", "Student"),
                            ("parent", "Parent"),
                        ],
                        max_length=20,
                    ),
                ),
                ("is_active", models.BooleanField(default=True)),
                ("joined_at", models.DateTimeField(auto_now_add=True)),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="memberships",
                        to="core.tenant",
                    ),
                ),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="tenant_memberships",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(
                        fields=["tenant", "user"], name="core_tenant_tenant__644160_idx"
                    )
                ],
                "unique_together": {("user", "tenant")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0003_attendance_expense_add_tenant.py
==========================================================================================
# PATH: apps/core/migrations/0003_attendance_expense_add_tenant.py
# Generated by Django 5.2.9 on 2026-02-04

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0002_tenantmembership"),
    ]

    operations = [
        migrations.AddField(
            model_name="attendance",
            name="tenant",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="attendances",
                to="core.tenant",
            ),
        ),
        migrations.AddField(
            model_name="expense",
            name="tenant",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="expenses",
                to="core.tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0004_backfill_attendance_expense_tenant.py
==========================================================================================
# PATH: apps/core/migrations/0004_backfill_attendance_expense_tenant.py
from __future__ import annotations

from django.db import migrations


def backfill_core_attendance_expense_tenant(apps, schema_editor):
    Tenant = apps.get_model("core", "Tenant")
    Attendance = apps.get_model("core", "Attendance")
    Expense = apps.get_model("core", "Expense")

    # Ïù¥ÎØ∏ Îã§ Ï±ÑÏõåÏ†∏ ÏûàÏúºÎ©¥ ÎÅù
    if not Attendance.objects.filter(tenant__isnull=True).exists() and not Expense.objects.filter(tenant__isnull=True).exists():
        return

    # ‚úÖ ÏïàÏ†Ñ Í∞ÄÎìú:
    # - Îã®Ïùº ÌôúÏÑ± tenantÎ©¥ ÏûêÎèô Î∞±ÌïÑ
    # - TENANT_DEFAULT_CODE(ÌôòÍ≤Ω)Î°ú Ïù¥ÎØ∏ Ïö¥ÏòÅ Í∏∞Ï§Ä tenantÎ•º Í≥†Ï†ïÌïòÎäî Í≤ΩÏö∞ÎèÑ ÏïàÏ†ÑÌïòÏßÄÎßå,
    #   ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò Î†àÎ≤®ÏóêÏÑúÎäî settings Ï†ëÍ∑ºÏùÑ Ïïà Ïì∞Í≥† ‚ÄúDB ÏÇ¨Ïã§‚ÄùÎßå Î≥∏Îã§.
    active_qs = Tenant.objects.filter(is_active=True).order_by("id")
    active_count = active_qs.count()

    if active_count == 1:
        t = active_qs.first()
        Attendance.objects.filter(tenant__isnull=True).update(tenant=t)
        Expense.objects.filter(tenant__isnull=True).update(tenant=t)
        return

    # ÌôúÏÑ± tenantÍ∞Ä 0Í∞ú/Ïó¨Îü¨Í∞úÏù∏Îç∞ tenant null Îç∞Ïù¥ÌÑ∞Í∞Ä Ï°¥Ïû¨ÌïòÎ©¥
    # ÏûêÎèô Ï∂îÎ°†ÏùÄ Ïö¥ÏòÅÏÇ¨Í≥†. Î™ÖÏãúÏ†ÅÏúºÎ°ú Ïã§Ìå®Ìï¥ÏÑú ÏàòÎèô Ï†ïÎ¶¨ Ïú†ÎèÑ.
    raise RuntimeError(
        "Cannot auto-backfill tenant for core.Attendance/core.Expense: "
        f"active_tenant_count={active_count}, but tenant NULL rows exist. "
        "Fix data manually (assign correct tenant) then re-run migration."
    )


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0003_attendance_expense_add_tenant"),
    ]

    operations = [
        migrations.RunPython(backfill_core_attendance_expense_tenant, migrations.RunPython.noop),
    ]


==========================================================================================
# FILE: migrations/0005_make_attendance_expense_tenant_not_null.py
==========================================================================================
# PATH: apps/core/migrations/0005_make_attendance_expense_tenant_not_null.py
from __future__ import annotations

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0004_backfill_attendance_expense_tenant"),
    ]

    operations = [
        migrations.AlterField(
            model_name="attendance",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="attendances",
                to="core.tenant",
                null=False,
                blank=False,
            ),
        ),
        migrations.AlterField(
            model_name="expense",
            name="tenant",
            field=models.ForeignKey(
                on_delete=django.db.models.deletion.CASCADE,
                related_name="expenses",
                to="core.tenant",
                null=False,
                blank=False,
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0006_program.py
==========================================================================================
# PATH: apps/core/migrations/0006_program.py
# Generated by Django 5.2.9 on 2026-02-08 12:00

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0005_make_attendance_expense_tenant_not_null"),
    ]

    operations = [
        migrations.CreateModel(
            name="Program",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("display_name", models.CharField(default="HakwonPlus", max_length=120)),
                (
                    "brand_key",
                    models.CharField(
                        default="hakwonplus",
                        help_text="ÌîÑÎ°†Ìä∏ÏóêÏÑú ÌÖåÎßà/Î¶¨ÏÜåÏä§ Î°úÎî© ÌÇ§Î°ú ÏÇ¨Ïö© Í∞ÄÎä• (ÌïòÎìúÏΩîÎî© Í∏àÏßÄ, Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)",
                        max_length=80,
                    ),
                ),
                (
                    "login_variant",
                    models.CharField(
                        choices=[
                            ("hakwonplus", "HakwonPlus Admin"),
                            ("limglish", "Limglish Teacher"),
                            ("custom", "Custom"),
                        ],
                        default="hakwonplus",
                        max_length=30,
                    ),
                ),
                ("feature_flags", models.JSONField(blank=True, default=dict)),
                ("ui_config", models.JSONField(blank=True, default=dict)),
                ("is_active", models.BooleanField(default=True)),
                (
                    "tenant",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="program",
                        to="core.tenant",
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(fields=["tenant"], name="core_program_tenant__idx"),
                    models.Index(fields=["brand_key"], name="core_program_brand_k_idx"),
                    models.Index(fields=["login_variant"], name="core_program_login_v_idx"),
                ],
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0007_rename_core_program_tenant__idx_core_progra_tenant__551fe8_idx_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-07 20:40

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0006_program"),
    ]

    operations = [
        migrations.RenameIndex(
            model_name="program",
            new_name="core_progra_tenant__551fe8_idx",
            old_name="core_program_tenant__idx",
        ),
        migrations.RenameIndex(
            model_name="program",
            new_name="core_progra_brand_k_e09627_idx",
            old_name="core_program_brand_k_idx",
        ),
        migrations.RenameIndex(
            model_name="program",
            new_name="core_progra_login_v_7300df_idx",
            old_name="core_program_login_v_idx",
        ),
    ]


==========================================================================================
# FILE: migrations/0008_tenantdomain_and_bootstrap_rows.py
==========================================================================================
# PATH: apps/core/migrations/0008_tenantdomain_and_bootstrap_rows.py
from __future__ import annotations

from django.db import migrations, models
import django.db.models.deletion


def backfill_tenantdomain_and_program(apps, schema_editor):
    Tenant = apps.get_model("core", "Tenant")
    TenantDomain = apps.get_model("core", "TenantDomain")
    Program = apps.get_model("core", "Program")

    def normalize_host(host: str) -> str:
        v = str(host or "").strip().lower()
        if not v:
            return ""
        return v.split(":")[0].strip()

    tenants = Tenant.objects.all().order_by("id")
    for t in tenants:
        # Program backfill
        if not Program.objects.filter(tenant=t).exists():
            Program.objects.create(
                tenant=t,
                display_name="HakwonPlus",
                brand_key="hakwonplus",
                login_variant="hakwonplus",
                feature_flags={
                    "student_app_enabled": True,
                    "admin_enabled": True,
                    "attendance_hourly_rate": 15000,
                },
                ui_config={
                    "login_title": "HakwonPlus Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏",
                    "login_subtitle": "",
                },
                is_active=True,
            )

        # TenantDomain backfill (primary)
        host = normalize_host(getattr(t, "code", ""))
        if host and not TenantDomain.objects.filter(host=host).exists():
            TenantDomain.objects.create(
                tenant=t,
                host=host,
                is_primary=True,
                is_active=True,
            )


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0007_rename_core_program_tenant__idx_core_progra_tenant__551fe8_idx_and_more"),
    ]

    operations = [
        migrations.CreateModel(
            name="TenantDomain",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "host",
                    models.CharField(
                        help_text="ÎèÑÎ©îÏù∏/Ìò∏Ïä§Ìä∏(Ìè¨Ìä∏ Ï†úÏô∏, ÏÜåÎ¨∏Ïûê). Ïòà: example.com, academy.example.com",
                        max_length=255,
                        unique=True,
                    ),
                ),
                (
                    "is_primary",
                    models.BooleanField(
                        default=True,
                        help_text="ÎåÄÌëú ÎèÑÎ©îÏù∏ Ïó¨Î∂Ä. ÏùºÎ∞òÏ†ÅÏúºÎ°ú 1Í∞úÎßå True Í∂åÏû•.",
                    ),
                ),
                (
                    "is_active",
                    models.BooleanField(default=True, help_text="Ïö¥ÏòÅ Ï§ëÏù∏ ÎèÑÎ©îÏù∏Îßå resolve ÎåÄÏÉÅ"),
                ),
                (
                    "tenant",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="domains",
                        to="core.tenant",
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(fields=["host"], name="core_tenantd_host_7f8e3a_idx"),
                    models.Index(fields=["tenant", "is_active"], name="core_tenantd_tenant__c4b2d7_idx"),
                ],
            },
        ),
        migrations.RunPython(backfill_tenantdomain_and_program, migrations.RunPython.noop),
    ]


==========================================================================================
# FILE: migrations/0009_rename_core_tenantd_host_7f8e3a_idx_core_tenant_host_573fcb_idx_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-07 20:54

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0008_tenantdomain_and_bootstrap_rows"),
    ]

    operations = [
        migrations.RenameIndex(
            model_name="tenantdomain",
            new_name="core_tenant_host_573fcb_idx",
            old_name="core_tenantd_host_7f8e3a_idx",
        ),
        migrations.RenameIndex(
            model_name="tenantdomain",
            new_name="core_tenant_tenant__ad1be6_idx",
            old_name="core_tenantd_tenant__c4b2d7_idx",
        ),
    ]


==========================================================================================
# FILE: migrations/0010_tenantdomain_primary_constraint.py
==========================================================================================
# PATH: apps/core/migrations/0010_tenantdomain_primary_constraint.py
from __future__ import annotations

from django.db import migrations, models
from django.db.models import Q


def normalize_primary_domain_per_tenant(apps, schema_editor):
    TenantDomain = apps.get_model("core", "TenantDomain")

    # tenantÎ≥Ñ primaryÍ∞Ä Ïó¨Îü¨ Í∞úÎ©¥ Í∞ÄÏû• ÏûëÏùÄ idÎßå Ïú†ÏßÄÌïòÍ≥† ÎÇòÎ®∏ÏßÄÎäî FalseÎ°ú Ï†ïÎ¶¨
    tenant_ids = (
        TenantDomain.objects.values_list("tenant_id", flat=True)
        .distinct()
    )

    for tenant_id in tenant_ids:
        primaries = (
            TenantDomain.objects
            .filter(tenant_id=tenant_id, is_primary=True)
            .order_by("id")
        )
        if primaries.count() <= 1:
            continue

        keep = primaries.first()
        if keep is None:
            continue

        TenantDomain.objects.filter(
            tenant_id=tenant_id,
            is_primary=True,
        ).exclude(id=keep.id).update(is_primary=False)


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0009_rename_core_tenantd_host_7f8e3a_idx_core_tenant_host_573fcb_idx_and_more"),
    ]

    operations = [
        migrations.RunPython(normalize_primary_domain_per_tenant, migrations.RunPython.noop),
        migrations.AddConstraint(
            model_name="tenantdomain",
            constraint=models.UniqueConstraint(
                fields=("tenant",),
                condition=Q(("is_primary", True)),
                name="core_tenantdomain_one_primary_per_tenant",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0011_alter_tenantdomain_is_primary.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-07 21:04

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0010_tenantdomain_primary_constraint"),
    ]

    operations = [
        migrations.AlterField(
            model_name="tenantdomain",
            name="is_primary",
            field=models.BooleanField(
                default=True,
                help_text="ÎåÄÌëú ÎèÑÎ©îÏù∏ Ïó¨Î∂Ä. tenant Îãπ ÏµúÎåÄ 1Í∞úÎßå True ÌóàÏö©.",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0012_program_plan.py
==========================================================================================
# PATH: apps/core/migrations/0012_program_plan.py
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0011_alter_tenantdomain_is_primary"),
    ]

    operations = [
        migrations.AddField(
            model_name="program",
            name="plan",
            field=models.CharField(
                max_length=20,
                choices=[
                    ("lite", "Lite"),
                    ("basic", "Basic"),
                    ("premium", "Premium"),
                ],
                default="premium",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0013_alter_program_brand_key_alter_program_plan_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-07 22:53

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0012_program_plan"),
    ]

    operations = [
        migrations.AlterField(
            model_name="program",
            name="brand_key",
            field=models.CharField(
                default="hakwonplus",
                help_text="ÌîÑÎ°†Ìä∏ ÌÖåÎßà/Î¶¨ÏÜåÏä§ Î°úÎî© ÌÇ§",
                max_length=80,
            ),
        ),
        migrations.AlterField(
            model_name="program",
            name="plan",
            field=models.CharField(
                choices=[("lite", "Lite"), ("basic", "Basic"), ("premium", "Premium")],
                default="premium",
                help_text="ÏöîÍ∏àÏ†ú (lite/basic/premium)",
                max_length=20,
            ),
        ),
        migrations.AddIndex(
            model_name="program",
            index=models.Index(fields=["plan"], name="core_progra_plan_eaf985_idx"),
        ),
    ]


==========================================================================================
# FILE: migrations/0014_alter_user_phone_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-12 12:00

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0013_alter_program_brand_key_alter_program_plan_and_more"),
    ]

    operations = [
        migrations.AlterField(
            model_name="user",
            name="phone",
            field=models.CharField(
                blank=True,
                db_index=True,
                help_text="Ï†ïÍ∑úÌôîÎêú Ï†ÑÌôîÎ≤àÌò∏ (ÌïòÏù¥Ìîà Ï†úÍ±∞, Ïòà: 01012345678)",
                max_length=20,
                null=True,
            ),
        ),
        migrations.AddIndex(
            model_name="attendance",
            index=models.Index(
                fields=["tenant", "date"], name="core_attend_tenant__397c84_idx"
            ),
        ),
        migrations.AddIndex(
            model_name="expense",
            index=models.Index(
                fields=["tenant", "date"], name="core_expens_tenant__5ab126_idx"
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/0015_add_tenant_messaging_fields.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-02-13 02:02

from decimal import Decimal
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("core", "0014_alter_user_phone_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="tenant",
            name="credit_balance",
            field=models.DecimalField(
                decimal_places=0, default=Decimal("0"), max_digits=12
            ),
        ),
        migrations.AddField(
            model_name="tenant",
            name="kakao_pfid",
            field=models.CharField(blank=True, default="", max_length=100),
        ),
        migrations.AddField(
            model_name="tenant",
            name="messaging_base_price",
            field=models.DecimalField(
                decimal_places=2, default=Decimal("0"), max_digits=10
            ),
        ),
        migrations.AddField(
            model_name="tenant",
            name="messaging_is_active",
            field=models.BooleanField(default=False),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: models/__init__.py
==========================================================================================
# PATH: apps/core/models/__init__.py
from .tenant import Tenant
from .tenant_domain import TenantDomain
from .tenant_membership import TenantMembership
from .user import User, Attendance, Expense
from .program import Program

__all__ = [
    "Tenant",
    "TenantDomain",
    "TenantMembership",
    "User",
    "Attendance",
    "Expense",
    "Program",
]


==========================================================================================
# FILE: models/base.py
==========================================================================================
# PATH: apps/core/models/base.py
"""
Í≥µÌÜµ Î≤†Ïù¥Ïä§ Î™®Îç∏ (TimestampModel, BaseModel)

Worker/API Í≥µÏú† ‚Äî apps.api ÏùòÏ°¥ Ï†úÍ±∞Î•º ÏúÑÌï¥ coreÏóê Ï†ïÏùò.
"""
from django.db import models


class TimestampModel(models.Model):
    """ÏÉùÏÑ±/ÏàòÏ†ï ÏãúÍ∞Ñ ÏûêÎèô Í∏∞Î°ù Ï∂îÏÉÅ Î™®Îç∏"""
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        abstract = True


class BaseModel(TimestampModel):
    """Í≥µÌÜµ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ìè¨Ìï® Î≤†Ïù¥Ïä§ Î™®Îç∏"""
    class Meta:
        abstract = True


==========================================================================================
# FILE: models/program.py
==========================================================================================
# PATH: apps/core/models/program.py
from __future__ import annotations

from django.db import models

from apps.core.models.base import TimestampModel
from apps.core.models.tenant import Tenant


class Program(TimestampModel):
    """
    Program (Tenant 1:1) ‚Äî ÏõêÏû• Í∞úÏù∏ ÌîÑÎ°úÍ∑∏Îû® SSOT

    üîí Î¥âÏù∏ ÏõêÏπô:
    - Tenant ÏÉùÏÑ± ÏãúÏ†êÏóêÎßå ÏÉùÏÑ±
    - read Í≤ΩÎ°úÏóêÏÑú write Í∏àÏßÄ
    - ÎàÑÎùΩÏùÄ Ïö¥ÏòÅ Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± ÏúÑÎ∞ò
    """

    class LoginVariant(models.TextChoices):
        HAKWONPLUS = "hakwonplus", "HakwonPlus Admin"
        LIMGLISH = "limglish", "Limglish Teacher"
        CUSTOM = "custom", "Custom"

    class Plan(models.TextChoices):
        LITE = "lite", "Lite"
        BASIC = "basic", "Basic"
        PREMIUM = "premium", "Premium"

    tenant = models.OneToOneField(
        Tenant,
        on_delete=models.CASCADE,
        related_name="program",
    )

    display_name = models.CharField(max_length=120, default="HakwonPlus")
    brand_key = models.CharField(
        max_length=80,
        default="hakwonplus",
        help_text="ÌîÑÎ°†Ìä∏ ÌÖåÎßà/Î¶¨ÏÜåÏä§ Î°úÎî© ÌÇ§",
    )

    login_variant = models.CharField(
        max_length=30,
        choices=LoginVariant.choices,
        default=LoginVariant.HAKWONPLUS,
    )

    # ‚úÖ ÏöîÍ∏àÏ†ú (Î¶¨ÏÜåÏä§ Í≥ÑÏïΩ ÏÑ†Ïñ∏)
    plan = models.CharField(
        max_length=20,
        choices=Plan.choices,
        default=Plan.PREMIUM,
        help_text="ÏöîÍ∏àÏ†ú (lite/basic/premium)",
    )

    feature_flags = models.JSONField(default=dict, blank=True)
    ui_config = models.JSONField(default=dict, blank=True)

    is_active = models.BooleanField(default=True)

    class Meta:
        app_label = "core"
        indexes = [
            models.Index(fields=["tenant"]),
            models.Index(fields=["brand_key"]),
            models.Index(fields=["login_variant"]),
            models.Index(fields=["plan"]),
        ]

    def __str__(self) -> str:
        return f"Program<{self.tenant.code}>:{self.display_name}"

    @classmethod
    def ensure_for_tenant(cls, *, tenant: Tenant) -> "Program":
        obj = cls.objects.filter(tenant=tenant).first()
        if obj:
            return obj
        raise RuntimeError(
            f"Program missing for tenant '{tenant.code}'. "
            "This violates core SSOT."
        )


==========================================================================================
# FILE: models/tenant.py
==========================================================================================
# PATH: apps/core/models/tenant.py
from decimal import Decimal

from django.db import models


class Tenant(models.Model):
    """
    Tenant == Academy
    SaaS Îã®ÏúÑÏùò ÌïôÏõê
    """

    name = models.CharField(max_length=255)
    code = models.CharField(max_length=50, unique=True)

    owner_name = models.CharField(max_length=100, blank=True)
    phone = models.CharField(max_length=50, blank=True)
    address = models.CharField(max_length=255, blank=True)

    logo = models.ImageField(
        upload_to="academy/logo/",
        null=True,
        blank=True,
    )

    is_active = models.BooleanField(default=True)

    # ---------- Î©îÏãúÏßï(ÏïåÎ¶ºÌÜ°) ----------
    # ÌïôÏõê Í∞úÎ≥Ñ Ïπ¥Ïπ¥Ïò§ ÌîÑÎ°úÌïÑ ID (Ïó∞Îèô Ïãú Ï†ÄÏû•)
    kakao_pfid = models.CharField(max_length=100, blank=True, default="")
    # ÏÑ†Î∂à Ï∂©Ï†Ñ ÏûîÏï° (Ïõê)
    credit_balance = models.DecimalField(
        max_digits=12, decimal_places=0, default=Decimal("0")
    )
    # ÏïåÎ¶ºÌÜ° Í∏∞Îä• ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
    messaging_is_active = models.BooleanField(default=False)
    # Í±¥Îãπ Î∞úÏÜ° Îã®Í∞Ä (Ïõê, ÌïôÏõêÎßàÎã§ Îã§Î•¥Í≤å Ï±ÖÏ†ï Í∞ÄÎä•)
    messaging_base_price = models.DecimalField(
        max_digits=10, decimal_places=2, default=Decimal("0")
    )

    class Meta:
        app_label = "core"
        verbose_name = "Tenant"
        verbose_name_plural = "Tenants"

    def __str__(self):
        return self.name


==========================================================================================
# FILE: models/tenant_domain.py
==========================================================================================
# PATH: apps/core/models/tenant_domain.py
from __future__ import annotations

from django.db import models
from django.db.models import Q

from apps.core.models.tenant import Tenant


class TenantDomain(models.Model):
    """
    TenantDomain (Enterprise SSOT)

    ‚úÖ Î™©Ï†Å:
    - Tenant.code(ÏãùÎ≥ÑÏûê)ÏôÄ Host(Ï†ëÏÜç ÎèÑÎ©îÏù∏)Î•º Î∂ÑÎ¶¨ÌïòÏó¨ Ïö¥ÏòÅ Ïú†Ïó∞ÏÑ± ÌôïÎ≥¥
    - ResolverÎäî TenantDomain.hostÎ•º ÌÜµÌï¥ tenantÎ•º ÌôïÏ†ïÌïúÎã§.

    üîí Î¥âÏù∏ ÏõêÏπô:
    - host Îäî Ï†ÑÏó≠ unique (Îã®Ïùº ÌÖåÎÑåÌä∏ÏóêÎßå Í∑ÄÏÜç)
    - tenant Îãπ is_primary=True Îäî ÏµúÎåÄ 1Í∞ú (DB Ï†úÏïΩÏúºÎ°ú Í∞ïÏ†ú)
    """

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="domains",
        null=False,
        blank=False,
    )

    host = models.CharField(
        max_length=255,
        unique=True,
        help_text="ÎèÑÎ©îÏù∏/Ìò∏Ïä§Ìä∏(Ìè¨Ìä∏ Ï†úÏô∏, ÏÜåÎ¨∏Ïûê). Ïòà: example.com, academy.example.com",
    )

    is_primary = models.BooleanField(
        default=True,
        help_text="ÎåÄÌëú ÎèÑÎ©îÏù∏ Ïó¨Î∂Ä. tenant Îãπ ÏµúÎåÄ 1Í∞úÎßå True ÌóàÏö©.",
    )

    is_active = models.BooleanField(
        default=True,
        help_text="Ïö¥ÏòÅ Ï§ëÏù∏ ÎèÑÎ©îÏù∏Îßå resolve ÎåÄÏÉÅ",
    )

    class Meta:
        app_label = "core"
        indexes = [
            models.Index(fields=["host"]),
            models.Index(fields=["tenant", "is_active"]),
        ]
        constraints = [
            # ‚úÖ tenant Îãπ primaryÎäî ÏµúÎåÄ 1Í∞ú
            models.UniqueConstraint(
                fields=["tenant"],
                condition=Q(is_primary=True),
                name="core_tenantdomain_one_primary_per_tenant",
            ),
        ]

    def __str__(self) -> str:
        return f"TenantDomain<{self.host}> -> {self.tenant.code}"


==========================================================================================
# FILE: models/tenant_membership.py
==========================================================================================
# PATH: apps/core/models/tenant_membership.py
from __future__ import annotations

from django.conf import settings
from django.db import models, transaction

from apps.core.models.tenant import Tenant


class TenantMembership(models.Model):
    """
    User ‚Üî Tenant Í¥ÄÍ≥Ñ SSOT

    - Ìïú UserÎäî Ïó¨Îü¨ TenantÏóê ÏÜçÌï† Ïàò ÏûàÏùå (M2M)
    - Tenant ÎÇ¥ÏóêÏÑú role / ÌôúÏÑ± ÏÉÅÌÉúÎ•º Î™ÖÏãú
    - unique_togetherÎ°ú "Í∞ôÏùÄ tenantÏóê Ï§ëÎ≥µ Í∞ÄÏûÖ" Î∞©ÏßÄ
    """

    ROLE_CHOICES = [
        ("owner", "Owner"),
        ("admin", "Admin"),
        ("teacher", "Teacher"),
        ("staff", "Staff"),
        ("student", "Student"),
        ("parent", "Parent"),
    ]

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="tenant_memberships",
    )
    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="memberships",
    )

    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    is_active = models.BooleanField(default=True)

    joined_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        app_label = "core"
        unique_together = ("user", "tenant")
        indexes = [
            models.Index(fields=["tenant", "user"]),
        ]

    def __str__(self) -> str:
        return f"{self.user} @ {self.tenant} ({self.role})"

    @classmethod
    @transaction.atomic
    def ensure_active(cls, *, tenant: Tenant, user, role: str) -> "TenantMembership":
        role = str(role).strip().lower()
        allowed = {c[0] for c in cls.ROLE_CHOICES}
        if role not in allowed:
            raise ValueError(f"invalid role: {role}")

        obj = cls.objects.select_for_update().filter(tenant=tenant, user=user).first()
        if obj:
            if not obj.is_active:
                obj.is_active = True
                obj.save(update_fields=["is_active"])
            return obj

        return cls.objects.create(
            tenant=tenant,
            user=user,
            role=role,
            is_active=True,
        )


==========================================================================================
# FILE: models/user.py
==========================================================================================
# PATH: apps/core/models/user.py
from django.db import models
from django.conf import settings
from django.contrib.auth.models import AbstractUser, Group, Permission

from apps.core.models.base import TimestampModel
from apps.core.models.tenant import Tenant
from apps.core.db import TenantQuerySet


class User(AbstractUser):
    """
    Custom User Î™®Îç∏
    - AUTH_USER_MODEL = core.User
    - auth.User ÏôÄÏùò groups / permissions reverse accessor Ï∂©Îèå Î∞©ÏßÄ
    """

    name = models.CharField(max_length=50, blank=True, null=True)
    phone = models.CharField(
        max_length=20,
        blank=True,
        null=True,
        db_index=True,  # ‚úÖ phone Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä (Í≤ÄÏÉâ ÏÑ±Îä• Ìñ•ÏÉÅ)
        help_text="Ï†ïÍ∑úÌôîÎêú Ï†ÑÌôîÎ≤àÌò∏ (ÌïòÏù¥Ìîà Ï†úÍ±∞, Ïòà: 01012345678)",
    )

    groups = models.ManyToManyField(
        Group,
        related_name="core_users",
        blank=True,
    )
    user_permissions = models.ManyToManyField(
        Permission,
        related_name="core_users",
        blank=True,
    )

    class Meta:
        app_label = "core"
        db_table = "accounts_user"
        ordering = ["-id"]

    def __str__(self):
        return self.username


class Attendance(TimestampModel):
    """
    ‚úÖ Ïö¥ÏòÅÎ†àÎ≤® ÌïµÏã¨:
    - AttendanceÎäî tenant Îã®ÏúÑÎ°ú Í≤©Î¶¨ÎêòÏñ¥Ïïº Ìï® (13+ ÌïôÏõê Ï†ÑÏ†ú)
    - tenant ÏóÜÏúºÎ©¥ Ï°∞Ìöå/ÏÉùÏÑ± Î∂àÍ∞Ä(ÏΩîÎìú Î†àÎ≤®ÏóêÏÑú Í∞ïÏ†ú)
    """

    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="attendances",
        null=False,
        blank=False,
        db_index=True,  # ‚úÖ tenant_id Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
    )

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="attendances",
    )

    date = models.DateField()
    start_time = models.TimeField()
    end_time = models.TimeField()

    work_type = models.CharField(max_length=50)
    memo = models.TextField(blank=True, null=True)

    duration_hours = models.FloatField(default=0)
    amount = models.IntegerField(default=0)

    class Meta:
        app_label = "core"
        ordering = ["-date", "-start_time"]
        indexes = [
            models.Index(fields=["tenant", "date"]),  # ‚úÖ Î≥µÌï© Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
        ]

    def __str__(self):
        return f"{self.user.username} - {self.date}"


class Expense(TimestampModel):
    """
    ‚úÖ Ïö¥ÏòÅÎ†àÎ≤® ÌïµÏã¨:
    - ExpenseÎèÑ tenant Îã®ÏúÑÎ°ú Í≤©Î¶¨ÎêòÏñ¥Ïïº Ìï® (13+ ÌïôÏõê Ï†ÑÏ†ú)
    - tenant ÏóÜÏúºÎ©¥ Ï°∞Ìöå/ÏÉùÏÑ± Î∂àÍ∞Ä(ÏΩîÎìú Î†àÎ≤®ÏóêÏÑú Í∞ïÏ†ú)
    """

    objects = TenantQuerySet.as_manager()

    tenant = models.ForeignKey(
        Tenant,
        on_delete=models.CASCADE,
        related_name="expenses",
        null=False,
        blank=False,
        db_index=True,  # ‚úÖ tenant_id Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
    )

    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name="expenses",
    )

    date = models.DateField()
    title = models.CharField(max_length=255)
    amount = models.IntegerField()
    memo = models.TextField(blank=True, null=True)

    class Meta:
        app_label = "core"
        ordering = ["-date"]
        indexes = [
            models.Index(fields=["tenant", "date"]),  # ‚úÖ Î≥µÌï© Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
        ]

    def __str__(self):
        return f"{self.user.username} - {self.title}"


==========================================================================================
# FILE: services/attendance_policy.py
==========================================================================================
# PATH: apps/core/services/attendance_policy.py
from __future__ import annotations

from datetime import datetime, time
from typing import Optional, Union

from apps.core.models import Program, Tenant


TimeLike = Union[str, time]


def _to_time(v: TimeLike) -> Optional[time]:
    if v is None:
        return None
    if isinstance(v, time):
        return v

    s = str(v or "").strip()
    if not s:
        return None

    # "HH:MM" or "HH:MM:SS"
    for fmt in ("%H:%M", "%H:%M:%S"):
        try:
            return datetime.strptime(s, fmt).time()
        except Exception:
            continue
    return None


def calculate_duration_hours(start: TimeLike, end: TimeLike) -> float:
    """
    - ÎÇ†Ïßú ÏóÜÏù¥ ÏãúÍ∞ÑÎßå Îì§Ïñ¥Ïò§Îäî Í∑ºÌÉú ÏûÖÎ†• Ï†ÑÏ†ú
    - end < start Ïù∏ Í≤ΩÏö∞(ÏïºÍ∞Ñ Í∑ºÎ¨¥)ÍπåÏßÄÎäî Ï†ïÏ±Ö Ï†ïÏùòÍ∞Ä ÌïÑÏöîÌïòÎØÄÎ°ú Í∏∞Î≥∏ÏùÄ 0 Ï≤òÎ¶¨
    """
    st = _to_time(start)
    et = _to_time(end)
    if not st or not et:
        return 0.0

    start_dt = datetime(2000, 1, 1, st.hour, st.minute, st.second)
    end_dt = datetime(2000, 1, 1, et.hour, et.minute, et.second)

    if end_dt < start_dt:
        return 0.0

    seconds = (end_dt - start_dt).total_seconds()
    if seconds <= 0:
        return 0.0

    return float(seconds / 3600.0)


def get_hourly_rate_for_tenant(tenant: Tenant) -> int:
    """
    Enterprise Ï†ïÏ±Ö:
    - ÏãúÍ∏âÏùÄ Program.feature_flags['attendance_hourly_rate'] Î°ú Ï†úÍ≥µ
    - ÏóÜÏúºÎ©¥ 15000 Í∏∞Î≥∏Í∞í
    """
    program = Program.objects.filter(tenant=tenant).only("feature_flags").first()
    flags = getattr(program, "feature_flags", {}) or {}
    try:
        v = int(flags.get("attendance_hourly_rate", 15000))
        return v if v > 0 else 15000
    except Exception:
        return 15000


def calculate_amount(tenant: Tenant, duration_hours: float) -> int:
    hourly = get_hourly_rate_for_tenant(tenant)
    if duration_hours <= 0:
        return 0
    return int(duration_hours * hourly)


==========================================================================================
# FILE: services/expense_policy.py
==========================================================================================
# PATH: apps/core/services/expense_policy.py
from __future__ import annotations


def normalize_expense_amount(amount) -> int:
    """
    Enterprise Ï†ïÏ±Ö:
    - amountÎäî Ìï≠ÏÉÅ int >= 0 ÏúºÎ°ú Ï†ïÍ∑úÌôî
    - ÏûÖÎ†• Ïã§Ïàò(Î¨∏ÏûêÏó¥/Í≥µÎ∞±)Î•º ÏïàÏ†ÑÌïòÍ≤å Ìù°Ïàò
    """
    try:
        v = int(str(amount).strip())
        return v if v >= 0 else 0
    except Exception:
        return 0


==========================================================================================
# FILE: tenant/__init__.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/__init__.py
# ======================================================================
from .context import (
    get_current_tenant,
    set_current_tenant,
    clear_current_tenant,
)
from .resolver import resolve_tenant_from_request
from .exceptions import TenantResolutionError

__all__ = [
    "get_current_tenant",
    "set_current_tenant",
    "clear_current_tenant",
    "resolve_tenant_from_request",
    "TenantResolutionError",
]


==========================================================================================
# FILE: tenant/context.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/context.py
# ======================================================================
from __future__ import annotations

from contextvars import ContextVar
from typing import Optional

from apps.core.models import Tenant

_current_tenant: ContextVar[Optional[Tenant]] = ContextVar("current_tenant", default=None)


def set_current_tenant(tenant: Tenant) -> None:
    _current_tenant.set(tenant)


def get_current_tenant() -> Optional[Tenant]:
    return _current_tenant.get()


def clear_current_tenant() -> None:
    _current_tenant.set(None)


==========================================================================================
# FILE: tenant/exceptions.py
==========================================================================================
# ======================================================================
# PATH: apps/core/tenant/exceptions.py
# ======================================================================
from __future__ import annotations


class TenantResolutionError(Exception):
    """
    Tenant resolution failures are explicit & ops-friendly.

    code:
      - tenant_missing
      - tenant_invalid
      - tenant_inactive
      - tenant_ambiguous
    """

    def __init__(
        self,
        *,
        code: str,
        message: str,
        http_status: int = 400,
    ):
        super().__init__(message)
        self.code = str(code)
        self.message = str(message)
        self.http_status = int(http_status)


==========================================================================================
# FILE: tenant/resolver.py
==========================================================================================
# PATH: apps/core/tenant/resolver.py
from __future__ import annotations

from typing import Optional

from django.conf import settings

from apps.core.models import Tenant, TenantDomain
from apps.core.tenant.exceptions import TenantResolutionError


def _is_bypass_path(path: str) -> bool:
    p = str(path or "/")
    for prefix in getattr(settings, "TENANT_BYPASS_PATH_PREFIXES", []):
        if p.startswith(prefix):
            return True
    return False


def _normalize_host(host: str) -> str:
    """
    - Ìè¨Ìä∏ Ï†úÍ±∞
    - ÏÜåÎ¨∏Ïûê Ï†ïÍ∑úÌôî
    """
    if not host:
        return ""
    return host.split(":")[0].strip().lower()


def _resolve_tenant_from_host(host: str) -> Optional[Tenant]:
    """
    Host -> TenantDomain.host -> Tenant (SSOT)

    ‚úÖ ÏóêÎü¨ Î∂ÑÍ∏∞ (Enterprise):
    - domain row ÏóÜÏùå            -> None
    - domain inactive            -> TenantResolutionError(tenant_inactive)
    - tenant inactive            -> TenantResolutionError(tenant_inactive)
    - (DB Î¨¥Í≤∞ÏÑ± Íπ®Ïßê) Ï§ëÎ≥µ host  -> TenantResolutionError(tenant_ambiguous)
    """
    if not host:
        return None

    qs = TenantDomain.objects.select_related("tenant").filter(host=host)
    # host Îäî unique Í∞Ä Ï†ïÏÉÅÏù¥ÎÇò, Ïö¥ÏòÅ ÏÇ¨Í≥†/ÏàòÎèô SQL Îì± ÏµúÏïÖÏùò ÏÉÅÌô© ÎåÄÎπÑ
    cnt = qs.count()
    if cnt == 0:
        return None
    if cnt > 1:
        raise TenantResolutionError(
            code="tenant_ambiguous",
            message=f"Multiple TenantDomain rows exist for host '{host}'",
            http_status=500,
        )

    td = qs.first()
    if td is None:
        return None

    if not td.is_active:
        raise TenantResolutionError(
            code="tenant_inactive",
            message=f"TenantDomain is inactive for host '{host}'",
            http_status=403,
        )

    if not td.tenant or not td.tenant.is_active:
        raise TenantResolutionError(
            code="tenant_inactive",
            message=f"Tenant is inactive for host '{host}'",
            http_status=403,
        )

    return td.tenant


def resolve_tenant_from_request(request) -> Optional[Tenant]:
    """
    Enterprise Resolver (Domain 1:1 with operational flexibility)

    Rules:
    - tenantÎäî request.get_host() -> TenantDomain.host Î°úÎßå Í≤∞Ï†ï
    - fallback ÏóÜÏùå
    - bypass pathÎßå tenant=None ÌóàÏö©
    """
    path = getattr(request, "path", "") or "/"
    bypass = _is_bypass_path(path)

    host = _normalize_host(request.get_host())

    try:
        tenant = _resolve_tenant_from_host(host)
    except TenantResolutionError:
        # Ïó¨Í∏∞ÏÑú Í∑∏ÎåÄÎ°ú propagate (middlewareÍ∞Ä ops-friendly JSONÏúºÎ°ú Î≥ÄÌôò)
        raise

    if tenant:
        return tenant

    if bypass:
        return None

    raise TenantResolutionError(
        code="tenant_invalid",
        message=f"Tenant not found for host '{host}'",
        http_status=404,
    )
