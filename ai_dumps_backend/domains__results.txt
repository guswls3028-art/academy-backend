====================================================================================================
# BACKEND APP: domains__results
# ROOT PATH: C:\academy\apps\domains\results
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class ResultsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.results"
    label = "results"


==========================================================================================
# FILE: permissions.py
==========================================================================================
# PATH: apps/domains/results/permissions.py
from __future__ import annotations

from rest_framework.permissions import BasePermission


def _role(u) -> str:
    """
    ÌîÑÎ°úÏ†ùÌä∏ÎßàÎã§ user.role / user.user_type / groups Îì± Îã§Î•º Ïàò ÏûàÏñ¥ÏÑú Î∞©Ïñ¥Ï†ÅÏúºÎ°ú.
    - ÏûàÏúºÎ©¥ Ïì∞Í≥†
    - ÏóÜÏúºÎ©¥ is_staff/is_superuserÎ°ú ÌåêÎã®
    """
    v = getattr(u, "role", None) or getattr(u, "user_type", None) or ""
    return str(v).upper()


def is_admin_user(u) -> bool:
    return bool(getattr(u, "is_superuser", False) or getattr(u, "is_staff", False) or _role(u) in ("ADMIN", "STAFF"))


def is_teacher_user(u) -> bool:
    # ÌîÑÎ°úÏ†ùÌä∏Ïóê Îî∞Îùº "TEACHER" Î¨∏ÏûêÏó¥Ïù¥ Îã§Î•º Ïàò ÏûàÏùå ‚Üí ÌïÑÏöîÏãú Ïó¨Í∏∞Îßå ÏàòÏ†ï
    return bool(is_admin_user(u) or _role(u) in ("TEACHER",))


def is_student_user(u) -> bool:
    # Î™ÖÏãúÏ†ÅÏúºÎ°ú teacher/admin ÏïÑÎãàÎ©¥ studentÎ°ú Ï∑®Í∏â(ÏùºÎ∞òÏ†ÅÏù∏ Ï†ïÏ±Ö)
    return bool(not is_teacher_user(u))


class IsStudent(BasePermission):
    def has_permission(self, request, view):
        u = getattr(request, "user", None)
        return bool(u and u.is_authenticated and is_student_user(u))


class IsTeacherOrAdmin(BasePermission):
    def has_permission(self, request, view):
        u = getattr(request, "user", None)
        return bool(u and u.is_authenticated and is_teacher_user(u))


==========================================================================================
# FILE: urls.py
==========================================================================================
# apps/domains/results/urls.py
"""
Results Domain API Routes

Ï†ïÏ±Ö:
- Student / Admin API Î™ÖÌôïÌûà Î∂ÑÎ¶¨
- Legacy APIÎäî DEPRECATED Ï≤òÎ¶¨
"""

from django.urls import path
from rest_framework.routers import DefaultRouter

# ======================
# Student
# ======================
from apps.domains.results.views.student_exam_result_view import MyExamResultView

# ======================
# Admin / Teacher (‚≠ê Í∂åÏû•)
# ======================
from apps.domains.results.views.admin_exam_results_view import AdminExamResultsView
from apps.domains.results.views.admin_exam_summary_view import AdminExamSummaryView
from apps.domains.results.views.admin_exam_question_stats_view import (
    AdminExamQuestionStatsView,
)

# ======================
# Wrong Notes
# ======================
from apps.domains.results.views.wrong_note_view import WrongNoteView

# ‚úÖ PDF ÏÉùÏÑ± API (URL Îì±Î°ù ÎàÑÎùΩ Î≤ÑÍ∑∏ ÏàòÏ†ï)
from apps.domains.results.views.wrong_note_pdf_view import WrongNotePDFCreateView

# ======================
# Legacy
# ======================
from apps.domains.results.views.exam_result_view import (
    ExamStatsView,
    ExamQuestionStatsView,
)

# ======================
# Attempt
# ======================
from apps.domains.results.views.exam_attempt_view import ExamAttemptViewSet


urlpatterns = [
    # -------------------
    # Student
    # -------------------
    path(
        "me/exams/<int:exam_id>/",
        MyExamResultView.as_view(),
        name="my-exam-result",
    ),

    # -------------------
    # Admin / Teacher
    # -------------------
    path(
        "admin/exams/<int:exam_id>/summary/",
        AdminExamSummaryView.as_view(),
        name="admin-exam-summary",
    ),
    path(
        "admin/exams/<int:exam_id>/results/",
        AdminExamResultsView.as_view(),
        name="admin-exam-results",
    ),
    path(
        "admin/exams/<int:exam_id>/questions/",
        AdminExamQuestionStatsView.as_view(),
        name="admin-exam-question-stats",
    ),

    # -------------------
    # Wrong Notes
    # -------------------
    path(
        "wrong-notes",
        WrongNoteView.as_view(),
        name="wrong-note",
    ),

    # ‚úÖ WrongNote PDF ÏÉùÏÑ± (Í∏∞Ï°¥ ÎàÑÎùΩÎêú ÎùºÏö∞Ìä∏)
    path(
        "wrong-notes/pdf/",
        WrongNotePDFCreateView.as_view(),
        name="wrong-note-pdf-create",
    ),

    # -------------------
    # ‚ö†Ô∏è Legacy (DEPRECATED)
    # -------------------
    path(
        "exams/<int:exam_id>/stats",
        ExamStatsView.as_view(),
        name="legacy-exam-stats",
    ),
    path(
        "exams/<int:exam_id>/questions/stats",
        ExamQuestionStatsView.as_view(),
        name="legacy-exam-question-stats",
    ),
]

# ======================
# Attempt Router
# ======================
attempt_router = DefaultRouter()
attempt_router.register("exam-attempts", ExamAttemptViewSet)

urlpatterns += attempt_router.urls


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="ResultFact",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("target_type", models.CharField(max_length=20)),
                ("target_id", models.PositiveIntegerField()),
                ("enrollment_id", models.PositiveIntegerField()),
                ("submission_id", models.PositiveIntegerField()),
                ("question_id", models.PositiveIntegerField()),
                ("answer", models.TextField(blank=True)),
                ("is_correct", models.BooleanField(default=False)),
                ("score", models.FloatField(default=0.0)),
                ("max_score", models.FloatField(default=0.0)),
                ("source", models.CharField(max_length=20)),
                ("meta", models.JSONField(blank=True, null=True)),
            ],
            options={
                "db_table": "results_fact",
                "ordering": ["-id"],
            },
        ),
        migrations.CreateModel(
            name="Result",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("target_type", models.CharField(max_length=20)),
                ("target_id", models.PositiveIntegerField()),
                ("enrollment_id", models.PositiveIntegerField()),
                ("total_score", models.FloatField(default=0.0)),
                ("max_score", models.FloatField(default=0.0)),
                ("submitted_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "db_table": "results_result",
                "unique_together": {("target_type", "target_id", "enrollment_id")},
            },
        ),
        migrations.CreateModel(
            name="ResultItem",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("question_id", models.PositiveIntegerField()),
                ("answer", models.TextField(blank=True)),
                ("is_correct", models.BooleanField(default=False)),
                ("score", models.FloatField(default=0.0)),
                ("max_score", models.FloatField(default=0.0)),
                ("source", models.CharField(max_length=20)),
                (
                    "result",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="items",
                        to="results.result",
                    ),
                ),
            ],
            options={
                "db_table": "results_result_item",
                "unique_together": {("result", "question_id")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_wrongnotepdf_examattempt_submissionanswer.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 07:51

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("results", "0001_initial"),
    ]

    operations = [
        migrations.CreateModel(
            name="WrongNotePDF",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("enrollment_id", models.PositiveIntegerField()),
                ("lecture_id", models.PositiveIntegerField(blank=True, null=True)),
                ("exam_id", models.PositiveIntegerField(blank=True, null=True)),
                ("from_session_order", models.PositiveIntegerField(default=2)),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("PENDING", "Pending"),
                            ("RUNNING", "Running"),
                            ("DONE", "Done"),
                            ("FAILED", "Failed"),
                        ],
                        default="PENDING",
                        max_length=20,
                    ),
                ),
                ("file_path", models.CharField(blank=True, max_length=255)),
                ("error_message", models.TextField(blank=True)),
            ],
            options={
                "db_table": "results_wrong_note_pdf",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="ExamAttempt",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("exam_id", models.PositiveIntegerField()),
                ("enrollment_id", models.PositiveIntegerField()),
                (
                    "submission_id",
                    models.PositiveIntegerField(
                        help_text="Ïù¥ attemptÎ•º Î∞úÏÉùÏãúÌÇ® submission"
                    ),
                ),
                ("attempt_index", models.PositiveIntegerField(help_text="1Î∂ÄÌÑ∞ ÏãúÏûë")),
                ("is_retake", models.BooleanField(default=False)),
                ("is_representative", models.BooleanField(default=True)),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("pending", "Pending"),
                            ("grading", "Grading"),
                            ("done", "Done"),
                            ("failed", "Failed"),
                        ],
                        default="pending",
                        max_length=20,
                    ),
                ),
            ],
            options={
                "db_table": "results_exam_attempt",
                "ordering": ["-created_at"],
                "unique_together": {("exam_id", "enrollment_id", "attempt_index")},
            },
        ),
        migrations.CreateModel(
            name="SubmissionAnswer",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("question_id", models.PositiveIntegerField()),
                ("detected", models.JSONField(default=list)),
                ("marking", models.CharField(max_length=20)),
                ("confidence", models.FloatField(default=0.0)),
                (
                    "status",
                    models.CharField(
                        help_text="ok / ambiguous / low_confidence / blank / error",
                        max_length=20,
                    ),
                ),
                ("is_correct", models.BooleanField(null=True)),
                ("score_awarded", models.FloatField(default=0.0)),
                ("meta", models.JSONField(blank=True, default=dict)),
                (
                    "attempt",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="answers",
                        to="results.examattempt",
                    ),
                ),
            ],
            options={
                "db_table": "results_submission_answer",
                "unique_together": {("attempt", "question_id")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0003_add_attempt_id_to_result_and_fact.py
==========================================================================================
# apps/domains/results/migrations/0003_add_attempt_id_to_result_and_fact.py
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("results", "0002_wrongnotepdf_examattempt_submissionanswer"),
    ]

    operations = [
        migrations.AddField(
            model_name="result",
            name="attempt_id",
            field=models.PositiveIntegerField(
                null=True,
                blank=True,
                db_index=True,
                help_text="Ïù¥ ResultÍ∞Ä Ï∞∏Ï°∞ÌïòÎäî ÎåÄÌëú ExamAttempt.id",
            ),
        ),
        migrations.AddField(
            model_name="resultfact",
            name="attempt_id",
            field=models.PositiveIntegerField(
                null=True,
                blank=True,
                db_index=True,
                help_text="Ïù¥ FactÎ•º ÏÉùÏÑ±Ìïú ExamAttempt.id",
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: models/__init__.py
==========================================================================================
# apps/domains/results/models/__init__.py

from .result import Result
from .result_item import ResultItem
from .result_fact import ResultFact
from .exam_attempt import ExamAttempt
from .submission_answer import SubmissionAnswer
from .wrong_note_pdf import WrongNotePDF

__all__ = [
    "Result",
    "ResultItem",
    "ResultFact",
    "ExamAttempt",
    "SubmissionAnswer",
    "WrongNotePDF",
]


==========================================================================================
# FILE: models/exam_attempt.py
==========================================================================================
from django.db import models
from apps.api.common.models import BaseModel


class ExamAttempt(BaseModel):
    """
    ÌïôÏÉùÏùò 'ÏãúÌóò 1Ìöå ÏùëÏãú'Î•º ÎÇòÌÉÄÎÇ¥Îäî ÏóîÌã∞Ìã∞ (append-only)

    üî• ÌïµÏã¨ Ï±ÖÏûÑ
    - Submission Îã®ÏúÑÍ∞Ä ÏïÑÎãå 'ÏãúÌóò ÏùëÏãú ÏÇ¨Ïã§'Ïùò Í≥†Ï†ï
    - Result / Fact / SnapshotÏùò Í∏∞Ï§ÄÏ†ê
    """

    exam_id = models.PositiveIntegerField()
    enrollment_id = models.PositiveIntegerField()

    # SubmissionÏùÄ ÏãúÎèÑÏùò ÏõêÏù∏(event)
    submission_id = models.PositiveIntegerField(
        help_text="Ïù¥ attemptÎ•º Î∞úÏÉùÏãúÌÇ® submission"
    )

    attempt_index = models.PositiveIntegerField(help_text="1Î∂ÄÌÑ∞ ÏãúÏûë")
    is_retake = models.BooleanField(default=False)

    # ÏÑúÎ≤ÑÍ∞Ä ÌåêÎã®ÌïòÎäî ÎåÄÌëú attempt (ResultÎäî Ìï≠ÏÉÅ Ïù¥Í≤É Í∏∞Ï§Ä)
    is_representative = models.BooleanField(default=True)

    status = models.CharField(
        max_length=20,
        choices=[
            ("pending", "Pending"),     # ÏÉùÏÑ±Îê®
            ("grading", "Grading"),     # Ï±ÑÏ†ê Ï§ë
            ("done", "Done"),           # Ï±ÑÏ†ê ÏôÑÎ£å
            ("failed", "Failed"),       # Ï±ÑÏ†ê Ïã§Ìå®
        ],
        default="pending",
    )

    class Meta:
        db_table = "results_exam_attempt"
        unique_together = ("exam_id", "enrollment_id", "attempt_index")
        ordering = ["-created_at"]

    def __str__(self):
        return (
            f"ExamAttempt exam={self.exam_id} "
            f"enrollment={self.enrollment_id} "
            f"#{self.attempt_index}"
        )


==========================================================================================
# FILE: models/result.py
==========================================================================================
# apps/domains/results/models/result.py
from django.db import models
from apps.api.common.models import BaseModel


class Result(BaseModel):
    """
    ÏãúÌóò/ÏàôÏ†ú Í≤∞Í≥º ÏµúÏã† Ïä§ÎÉÖÏÉ∑ (Ï°∞ÌöåÏö©)
    Í≥ÑÏÇ∞ ÏóÜÏùå

    ‚úÖ attempt Ï§ëÏã¨ ÏÑ§Í≥Ñ Î∞òÏòÅ
    - attempt_id: Ïù¥ ResultÍ∞Ä Ïñ¥Îñ§ ExamAttempt(ÏãúÎèÑ)Î•º ÎåÄÌëúÌïòÎäîÏßÄ Ï∂îÏ†Å Í∞ÄÎä•
    - Ïû¨ÏãúÌóò/ÎåÄÌëú attempt ÍµêÏ≤¥ ÏãúÏóêÎèÑ "Ïñ¥Îñ§ attempt Í≤∞Í≥ºÏù∏ÏßÄ" Î™ÖÌôïÌï¥Ïßê

    ‚ö†Ô∏è Ï£ºÏùò:
    - Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ attempt_idÎäî ÏùºÎã® NULL ÌóàÏö©ÏúºÎ°ú Îì§Ïñ¥Í∞ê (ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖòÏóêÏÑú null=True)
    - Ïö¥ÏòÅÏóêÏÑú Î∞±ÌïÑ ÌõÑ null=FalseÎ°ú tighten ÌïòÎäî 2Îã®Í≥ÑÍ∞Ä Ï†ïÏÑù
    """

    target_type = models.CharField(max_length=20)  # exam / homework
    target_id = models.PositiveIntegerField()

    enrollment_id = models.PositiveIntegerField()

    # ‚úÖ Ïñ¥Îñ§ attemptÏùò Í≤∞Í≥ºÏù∏ÏßÄ Ï∂îÏ†Å (ÎåÄÌëú attempt Í∏∞Ï§Ä)
    attempt_id = models.PositiveIntegerField(
        null=True,
        blank=True,
        db_index=True,
        help_text="Ïù¥ ResultÍ∞Ä Ï∞∏Ï°∞ÌïòÎäî ÎåÄÌëú ExamAttempt.id",
    )

    total_score = models.FloatField(default=0.0)
    max_score = models.FloatField(default=0.0)

    submitted_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        db_table = "results_result"
        unique_together = ("target_type", "target_id", "enrollment_id")


==========================================================================================
# FILE: models/result_fact.py
==========================================================================================
# apps/domains/results/models/result_fact.py
from django.db import models
from apps.api.common.models import BaseModel


class ResultFact(BaseModel):
    """
    Í≤∞Í≥º Fact (append-only, Î∂àÎ≥Ä)
    - ÏßëÍ≥Ñ/ÌÜµÍ≥Ñ/Ïù¥Î≤§Ìä∏ Î°úÍ∑∏Ïóê Í∞ÄÍπåÏõÄ

    ‚úÖ attempt Ï§ëÏã¨ ÏÑ§Í≥Ñ Î∞òÏòÅ
    - attempt_id: Ïù¥ FactÍ∞Ä Ïñ¥Îäê attemptÏóêÏÑú ÎÇòÏò® Ïù¥Î≤§Ìä∏Ïù∏ÏßÄ Ï∂îÏ†Å Í∞ÄÎä•

    ‚ö†Ô∏è Î¶¨Ìå©ÌÜ†ÎßÅ Î©îÎ™® (Ï§ëÏöî)
    ÏßÄÍ∏àÏùÄ ResultFactÍ∞Ä answer/score/meta/sourceÍπåÏßÄ Îì§Í≥† ÏûàÏùå.
    Ïû•Í∏∞Ï†ÅÏúºÎ°úÎäî:
      - ResultFact = "ÏßëÍ≥ÑÏö© Ïù¥Î≤§Ìä∏"
      - ÏÉÅÏÑ∏/Ï±ÑÏ†êÍ≤∞Í≥º = results.SubmissionAnswer Í∞Ä Îì§Í≥† Í∞ÄÎäî Í≤å Ï†ïÏÑù
    Îã§Îßå ÏßÄÍ∏à Îã®Í≥ÑÏóêÏÑúÎäî analytics Ï†úÍ±∞ + Îã®Ïàú Ïö¥ÏòÅÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ.
    """

    target_type = models.CharField(max_length=20)
    target_id = models.PositiveIntegerField()

    enrollment_id = models.PositiveIntegerField()
    submission_id = models.PositiveIntegerField()

    # ‚úÖ Ïñ¥Îñ§ attemptÏóêÏÑú ÏÉùÏÑ±Îêú FactÏù∏ÏßÄ
    attempt_id = models.PositiveIntegerField(
        null=True,
        blank=True,
        db_index=True,
        help_text="Ïù¥ FactÎ•º ÏÉùÏÑ±Ìïú ExamAttempt.id",
    )

    question_id = models.PositiveIntegerField()

    answer = models.TextField(blank=True)
    is_correct = models.BooleanField(default=False)

    score = models.FloatField(default=0.0)
    max_score = models.FloatField(default=0.0)

    source = models.CharField(max_length=20)
    meta = models.JSONField(null=True, blank=True)

    class Meta:
        db_table = "results_fact"
        ordering = ["-id"]


==========================================================================================
# FILE: models/result_item.py
==========================================================================================
from django.db import models
from apps.api.common.models import BaseModel


class ResultItem(BaseModel):
    """
    Î¨∏Ìï≠Î≥Ñ ÏµúÏã† Í≤∞Í≥º ÏÉÅÌÉú (snapshot)
    """

    result = models.ForeignKey(
        "results.Result",
        on_delete=models.CASCADE,
        related_name="items",
    )

    question_id = models.PositiveIntegerField()

    answer = models.TextField(blank=True)
    is_correct = models.BooleanField(default=False)

    score = models.FloatField(default=0.0)
    max_score = models.FloatField(default=0.0)

    source = models.CharField(max_length=20)

    class Meta:
        db_table = "results_result_item"
        unique_together = ("result", "question_id")


==========================================================================================
# FILE: models/submission_answer.py
==========================================================================================
from django.db import models
from apps.api.common.models import BaseModel


class SubmissionAnswer(BaseModel):
    """
    results ÎèÑÎ©îÏù∏Ïùò Î¨∏Ìï≠ Îã®ÏúÑ 'Ï±ÑÏ†ê Í≤∞Í≥º'

    üî• SubmissionAnswer(submissions) = raw input
    üî• SubmissionAnswer(results) = grading output (Î∂àÎ≥Ä)
    """

    attempt = models.ForeignKey(
        "results.ExamAttempt",
        on_delete=models.CASCADE,
        related_name="answers",
    )

    question_id = models.PositiveIntegerField()

    detected = models.JSONField(default=list)      # ["B"]
    marking = models.CharField(max_length=20)      # single / multi / blank
    confidence = models.FloatField(default=0.0)
    status = models.CharField(
        max_length=20,
        help_text="ok / ambiguous / low_confidence / blank / error",
    )

    is_correct = models.BooleanField(null=True)
    score_awarded = models.FloatField(default=0.0)

    meta = models.JSONField(default=dict, blank=True)

    class Meta:
        db_table = "results_submission_answer"
        unique_together = ("attempt", "question_id")

    def __str__(self) -> str:
        return f"Attempt#{self.attempt_id} Q{self.question_id}"


==========================================================================================
# FILE: models/wrong_note_pdf.py
==========================================================================================
# apps/domains/results/models/wrong_note_pdf.py
from django.db import models
from apps.api.common.models import BaseModel


class WrongNotePDF(BaseModel):
    """
    Ïò§ÎãµÎÖ∏Ìä∏ PDF ÏÉùÏÑ± Job
    """

    class Status(models.TextChoices):
        PENDING = "PENDING"
        RUNNING = "RUNNING"
        DONE = "DONE"
        FAILED = "FAILED"

    enrollment_id = models.PositiveIntegerField()
    lecture_id = models.PositiveIntegerField(null=True, blank=True)
    exam_id = models.PositiveIntegerField(null=True, blank=True)

    from_session_order = models.PositiveIntegerField(default=2)

    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
    )

    file_path = models.CharField(max_length=255, blank=True)
    error_message = models.TextField(blank=True)

    class Meta:
        db_table = "results_wrong_note_pdf"
        ordering = ["-created_at"]


==========================================================================================
# FILE: serializers/admin_exam_result_row.py
==========================================================================================
# apps/domains/results/serializers/admin_exam_result_row.py
from rest_framework import serializers


class AdminExamResultRowSerializer(serializers.Serializer):
    enrollment_id = serializers.IntegerField()
    student_name = serializers.CharField()

    total_score = serializers.FloatField()
    max_score = serializers.FloatField()

    passed = serializers.BooleanField()
    clinic_required = serializers.BooleanField()

    submitted_at = serializers.DateTimeField(allow_null=True)

    # ===============================
    # üî• Submission Ïó∞Îèô ÌïÑÎìú (Ïã†Í∑ú)
    # ===============================
    submission_id = serializers.IntegerField(allow_null=True)
    submission_status = serializers.CharField(allow_null=True)


==========================================================================================
# FILE: serializers/admin_exam_summary.py
==========================================================================================
# apps/domains/results/serializers/admin_exam_summary.py
from rest_framework import serializers


class AdminExamSummarySerializer(serializers.Serializer):
    participant_count = serializers.IntegerField()

    avg_score = serializers.FloatField()
    min_score = serializers.FloatField()
    max_score = serializers.FloatField()

    pass_count = serializers.IntegerField()
    fail_count = serializers.IntegerField()
    pass_rate = serializers.FloatField()

    clinic_count = serializers.IntegerField()


==========================================================================================
# FILE: serializers/exam_attempt.py
==========================================================================================
# apps/domains/results/serializers/exam_attempt.py (Ïã†Í∑ú)

from rest_framework import serializers
from apps.domains.results.models import ExamAttempt


class ExamAttemptSerializer(serializers.ModelSerializer):
    class Meta:
        model = ExamAttempt
        fields = "__all__"


==========================================================================================
# FILE: serializers/student_exam_result.py
==========================================================================================
# PATH: apps/domains/results/serializers/student_exam_result.py
from __future__ import annotations

from rest_framework import serializers
from apps.domains.results.models import Result, ResultItem


class ResultItemSerializer(serializers.ModelSerializer):
    """
    ‚úÖ ÌïôÏÉù ÌôîÎ©¥: Î¨∏Ìï≠Î≥Ñ Í≤∞Í≥º
    """
    class Meta:
        model = ResultItem
        fields = [
            "question_id",
            "answer",
            "is_correct",
            "score",
            "max_score",
            "source",
        ]


class StudentExamResultSerializer(serializers.ModelSerializer):
    """
    ‚úÖ ÌïôÏÉù ÌôîÎ©¥: ÏãúÌóò Í≤∞Í≥º(Ï¥ùÏ†ê + Î¨∏Ìï≠Î≥Ñ)
    """
    items = ResultItemSerializer(many=True, read_only=True)

    class Meta:
        model = Result
        fields = [
            "target_type",
            "target_id",
            "enrollment_id",
            "total_score",
            "max_score",
            "submitted_at",
            "items",
        ]


==========================================================================================
# FILE: services/__init__.py
==========================================================================================
from .applier import ResultApplier

__all__ = ["ResultApplier"]


==========================================================================================
# FILE: services/applier.py
==========================================================================================
# apps/domains/results/services/applier.py
from __future__ import annotations

from django.db import transaction
from django.utils import timezone

from apps.domains.results.models import Result, ResultItem, ResultFact


class ResultApplier:
    """
    Í≥ÑÏÇ∞Îêú Í≤∞Í≥ºÎ•º Î∞õÏïÑ resultsÏóê Î∞òÏòÅ
    ‚ùå Í≥ÑÏÇ∞ ÏóÜÏùå (Í≥ÑÏÇ∞ÏùÄ graderÍ∞Ä Ìï®)

    ‚úÖ attempt Ï§ëÏã¨ ÏÑ§Í≥Ñ Î∞òÏòÅ:
    - apply()Í∞Ä attempt_idÎ•º Î∞õÏïÑÏÑú Result / ResultFactÏóê Ï†ÄÏû•
    """

    @staticmethod
    @transaction.atomic
    def apply(
        *,
        target_type: str,
        target_id: int,
        enrollment_id: int,
        submission_id: int,
        attempt_id: int,            # ‚úÖ Ï∂îÍ∞Ä
        items: list[dict],
    ) -> Result:
        """
        items format:
        {
            question_id,
            answer,
            is_correct,
            score,
            max_score,
            source,
            meta
        }
        """

        # ResultÎäî "ÏµúÏã† Ïä§ÎÉÖÏÉ∑"
        result, _ = Result.objects.get_or_create(
            target_type=target_type,
            target_id=target_id,
            enrollment_id=enrollment_id,
        )

        # ‚úÖ Ïù¥ ResultÍ∞Ä Ï∞∏Ï°∞ÌïòÎäî attempt Í∞±Ïã†
        # ÎåÄÌëú attemptÍ∞Ä Î∞îÎÄåÎ©¥ Ïó¨Í∏∞ÏÑú ÏµúÏã†Í∞íÏúºÎ°ú ÎçÆÏñ¥ÏîåÏõåÏßê(Ï†ïÏÉÅ)
        result.attempt_id = int(attempt_id)

        total = 0.0
        max_total = 0.0

        for item in items:
            # 1Ô∏è‚É£ Fact (append-only)
            ResultFact.objects.create(
                target_type=target_type,
                target_id=target_id,
                enrollment_id=enrollment_id,
                submission_id=submission_id,
                attempt_id=int(attempt_id),  # ‚úÖ Ï∂îÍ∞Ä
                **item,
            )

            # 2Ô∏è‚É£ Snapshot (ResultItem)
            ResultItem.objects.update_or_create(
                result=result,
                question_id=item["question_id"],
                defaults={
                    "answer": item["answer"],
                    "is_correct": item["is_correct"],
                    "score": item["score"],
                    "max_score": item["max_score"],
                    "source": item["source"],
                },
            )

            total += float(item["score"] or 0.0)
            max_total += float(item["max_score"] or 0.0)

        result.total_score = float(total)
        result.max_score = float(max_total)
        result.submitted_at = timezone.now()

        # ‚úÖ attempt_idÎèÑ Í∞ôÏù¥ Ï†ÄÏû•
        result.save(
            update_fields=["attempt_id", "total_score", "max_score", "submitted_at"]
        )

        return result


==========================================================================================
# FILE: services/attempt_service.py
==========================================================================================
from django.db import transaction
from django.db.models import Max

from apps.domains.results.models import ExamAttempt


class ExamAttemptService:
    """
    ExamAttempt ÏÉùÏÑ±/Í¥ÄÎ¶¨ Ï†ÑÎã¥

    üî• ÏàòÏ†ï ÏÇ¨Ìï≠
    - ÎèôÏãúÏÑ± ÏïàÏ†Ñ (transaction.atomic)
    - ÎåÄÌëú attempt Îã®ÏùºÏÑ± Î≥¥Ïû•
    """

    @staticmethod
    @transaction.atomic
    def create_for_submission(
        *,
        exam_id: int,
        enrollment_id: int,
        submission_id: int,
    ) -> ExamAttempt:

        # üîí row-level lock
        qs = (
            ExamAttempt.objects
            .select_for_update()
            .filter(exam_id=exam_id, enrollment_id=enrollment_id)
        )

        last = qs.aggregate(Max("attempt_index")).get(
            "attempt_index__max"
        ) or 0

        # Í∏∞Ï°¥ ÎåÄÌëú attempt Ìï¥Ï†ú
        qs.filter(is_representative=True).update(
            is_representative=False
        )

        attempt = ExamAttempt.objects.create(
            exam_id=exam_id,
            enrollment_id=enrollment_id,
            submission_id=submission_id,
            attempt_index=last + 1,
            is_retake=(last > 0),
            is_representative=True,
            status="pending",
        )

        return attempt


==========================================================================================
# FILE: services/grader.py
==========================================================================================
# apps/domains/results/services/grader.py
from __future__ import annotations

from typing import Any, Dict, List, Optional, Tuple

from django.db import transaction

# üîΩ SubmissionÏùÄ submissions ÎèÑÎ©îÏù∏Ïùò Îã®Ïùº ÏßÑÏã§
from apps.domains.submissions.models import Submission, SubmissionAnswer

# üîΩ Results ÎèÑÎ©îÏù∏ Ïã§ Ï†ÄÏû• Answer (Ï±ÑÏ†ê Í≤∞Í≥º)
from apps.domains.results.models import SubmissionAnswer as ResultSubmissionAnswer

from apps.domains.results.services.applier import ResultApplier
from apps.domains.results.services.attempt_service import ExamAttemptService

from apps.domains.exams.models import ExamQuestion, AnswerKey

# ‚úÖ Progress ÌååÏù¥ÌîÑÎùºÏù∏ Celery Task
from apps.domains.progress.tasks.progress_pipeline_task import (
    run_progress_pipeline_task,
)

# ============================================================
# OMR / Ï±ÑÏ†ê Ï†ïÏ±Ö v1 (Results ÎèÑÎ©îÏù∏ Ï±ÖÏûÑ)
# ============================================================

OMR_CONF_THRESHOLD_V1 = 0.70


def _norm(s: Optional[str]) -> str:
    return (s or "").strip().upper()


def _get_omr_meta(meta: Any) -> Dict[str, Any]:
    if not isinstance(meta, dict):
        return {}
    omr = meta.get("omr")
    return omr if isinstance(omr, dict) else {}


def _grade_choice_v1(
    *,
    detected: List[str],
    marking: str,
    confidence: Optional[float],
    status: str,
    correct_answer: str,
    max_score: float,
) -> Tuple[bool, float]:
    if (status or "").lower() != "ok":
        return False, 0.0

    if (marking or "").lower() in ("blank", "multi"):
        return False, 0.0

    conf = float(confidence) if confidence is not None else 0.0
    if conf < OMR_CONF_THRESHOLD_V1:
        return False, 0.0

    if not detected or len(detected) != 1:
        return False, 0.0

    ans = _norm(detected[0])
    cor = _norm(correct_answer)

    is_correct = ans != "" and cor != "" and ans == cor
    return is_correct, (float(max_score) if is_correct else 0.0)


def _grade_short_v1(
    *,
    answer_text: str,
    correct_answer: str,
    max_score: float,
) -> Tuple[bool, float]:
    ans = _norm(answer_text)
    cor = _norm(correct_answer)

    if ans == "":
        return False, 0.0

    is_correct = cor != "" and ans == cor
    return is_correct, (float(max_score) if is_correct else 0.0)


def _infer_answer_type(q: ExamQuestion) -> str:
    v = getattr(q, "answer_type", None)
    if isinstance(v, str) and v.strip():
        return v.strip().lower()
    return "choice"


def _get_correct_answer_map(exam_id: int) -> Dict[str, Any]:
    ak = AnswerKey.objects.filter(exam_id=exam_id).first()
    if not ak or not isinstance(ak.answers, dict):
        return {}
    return ak.answers


@transaction.atomic
def grade_submission_to_results(submission: Submission) -> None:
    """
    Submission ‚Üí ExamAttempt ‚Üí Result / ResultItem / ResultFact

    ‚úÖ attempt Ï§ëÏã¨ ÏÑ§Í≥Ñ:
    - ExamAttempt ÏÉùÏÑ±
    - Result / ResultFactÏóê attempt_id Ï†ÄÏû•
    """

    # ---------------------------
    # 1Ô∏è‚É£ Submission ÏÉÅÌÉú Î≥ÄÍ≤Ω
    # ---------------------------
    submission.status = Submission.Status.GRADING
    submission.save(update_fields=["status"])

    if submission.target_type != Submission.TargetType.EXAM:
        raise ValueError("Only exam grading is supported")

    # ---------------------------
    # 2Ô∏è‚É£ ExamAttempt ÏÉùÏÑ± + ÏÉÅÌÉú Ï†ÑÏù¥
    # ---------------------------
    attempt = ExamAttemptService.create_for_submission(
        exam_id=int(submission.target_id),
        enrollment_id=int(submission.enrollment_id),
        submission_id=int(submission.id),
    )

    attempt.status = "grading"
    attempt.save(update_fields=["status"])

    # ---------------------------
    # 3Ô∏è‚É£ Ï±ÑÏ†ê ÎåÄÏÉÅ Î°úÎî©
    # ---------------------------
    answers = list(
        SubmissionAnswer.objects.filter(submission=submission)
    )

    questions = (
        ExamQuestion.objects
        .filter(sheet__exam_id=submission.target_id)
        .in_bulk(field_name="id")
    )

    correct_map = _get_correct_answer_map(int(submission.target_id))

    items: List[dict] = []

    # ---------------------------
    # 4Ô∏è‚É£ Î¨∏Ìï≠Î≥Ñ Ï±ÑÏ†ê + ResultSubmissionAnswer Ï†ÄÏû•
    # ---------------------------
    for sa in answers:
        q = questions.get(sa.question_id)
        if not q:
            continue

        max_score = float(getattr(q, "score", 0) or 0.0)
        correct_answer = str(
            correct_map.get(str(getattr(q, "number", ""))) or ""
        )

        answer_text = str(sa.answer or "").strip()

        omr = _get_omr_meta(sa.meta)
        detected = omr.get("detected") or []
        marking = str(omr.get("marking") or "")
        confidence = omr.get("confidence", None)
        status = str(omr.get("status") or "")
        omr_version = str(omr.get("version") or "")

        answer_type = _infer_answer_type(q)

        if answer_type in ("choice", "omr", "multiple_choice"):
            if omr_version.lower() == "v1":
                is_correct, score = _grade_choice_v1(
                    detected=[str(x) for x in detected],
                    marking=marking,
                    confidence=(float(confidence) if confidence is not None else None),
                    status=status,
                    correct_answer=correct_answer,
                    max_score=max_score,
                )
                final_answer = "".join([_norm(x) for x in detected]) if detected else ""
            else:
                is_correct, score = _grade_short_v1(
                    answer_text=answer_text,
                    correct_answer=correct_answer,
                    max_score=max_score,
                )
                final_answer = answer_text
        else:
            is_correct, score = _grade_short_v1(
                answer_text=answer_text,
                correct_answer=correct_answer,
                max_score=max_score,
            )
            final_answer = answer_text

        # üî• Results ÎèÑÎ©îÏù∏ Answer Ïã§ Ï†ÄÏû• (Î∂àÎ≥Ä)
        ResultSubmissionAnswer.objects.create(
            attempt=attempt,
            question_id=q.id,
            detected=detected,
            marking=marking,
            confidence=float(confidence or 0),
            status=status,
            is_correct=bool(is_correct),
            score_awarded=float(score),
            meta=sa.meta,
        )

        items.append({
            "question_id": q.id,
            "answer": final_answer,
            "is_correct": bool(is_correct),
            "score": float(score),
            "max_score": float(max_score),
            "source": submission.source,
            "meta": sa.meta,
        })

    # ---------------------------
    # 5Ô∏è‚É£ Result Î∞òÏòÅ (attempt Í∏∞Ï§Ä)
    # ---------------------------
    ResultApplier.apply(
        target_type=submission.target_type,
        target_id=int(submission.target_id),
        enrollment_id=int(submission.enrollment_id),
        submission_id=int(submission.id),
        attempt_id=int(attempt.id),     # ‚úÖ ÌïµÏã¨: attempt_id Ï†ÄÏû•
        items=items,
    )

    # ---------------------------
    # 6Ô∏è‚É£ ÏÉÅÌÉú ÎßàÎ¨¥Î¶¨
    # ---------------------------
    attempt.status = "done"
    attempt.save(update_fields=["status"])

    submission.status = Submission.Status.DONE
    submission.save(update_fields=["status"])

    # ---------------------------
    # 7Ô∏è‚É£ Progress ÌååÏù¥ÌîÑÎùºÏù∏ (commit ÌõÑ)
    # ---------------------------
    transaction.on_commit(
        lambda: run_progress_pipeline_task.delay(submission.id)
    )


==========================================================================================
# FILE: services/progress_pipeline.py
==========================================================================================
# apps/domains/progress/services/progress_pipeline.py
from __future__ import annotations

from typing import Optional

from django.db import transaction

from apps.domains.submissions.models import Submission
from apps.domains.results.models import Result
from apps.domains.lectures.models import Session

from apps.domains.progress.services.session_calculator import SessionProgressCalculator
from apps.domains.progress.services.lecture_calculator import LectureProgressCalculator
from apps.domains.progress.services.risk_evaluator import RiskEvaluator
from apps.domains.progress.services.clinic_trigger_service import ClinicTriggerService


class ProgressPipeline:
    """
    Results Ïù¥ÌõÑ 'ÌïôÏäµ ÏßÑÎèÑ ÌååÏù¥ÌîÑÎùºÏù∏'

    ‚ö†Ô∏è Ï£ºÏùò
    - Results ÎèÑÎ©îÏù∏ÏóêÏÑú ÏßÅÏ†ë import Í∏àÏßÄ
    - Ïã§Ìå®Ìï¥ÎèÑ Ïû¨ÏãúÎèÑ Í∞ÄÎä•Ìï¥Ïïº Ìï®
    - Î©±Îì±ÏÑ± Ïú†ÏßÄ
    """

    @staticmethod
    @transaction.atomic
    def run_by_submission(
        *,
        submission: Submission,
        result: Result,
    ) -> None:
        """
        ÏãúÌóò Ï±ÑÏ†ê ÏôÑÎ£å ÌõÑ Progress Ïû¨Í≥ÑÏÇ∞
        """

        if submission.target_type != Submission.TargetType.EXAM:
            return

        # 1Ô∏è‚É£ Exam ‚Üí Session Îß§Ìïë
        session: Optional[Session] = (
            Session.objects
            .filter(exam__id=submission.target_id)
            .select_related("lecture")
            .first()
        )

        if not session:
            return

        # 2Ô∏è‚É£ SessionProgress Í≥ÑÏÇ∞
        sp = SessionProgressCalculator.calculate(
            enrollment_id=submission.enrollment_id,
            session=session,
            attendance_type="online",
            video_progress_rate=100,
            exam_score=result.total_score,
            homework_submitted=True,
            homework_teacher_approved=True,
        )

        # 3Ô∏è‚É£ ÌÅ¥Î¶¨Îãâ ÏûêÎèô Ìä∏Î¶¨Í±∞
        ClinicTriggerService.auto_create_if_failed(sp)

        # 4Ô∏è‚É£ LectureProgress ÏßëÍ≥Ñ
        lp = LectureProgressCalculator.calculate(
            enrollment_id=submission.enrollment_id,
            lecture=session.lecture,
        )

        # 5Ô∏è‚É£ ÏúÑÌóòÎèÑ ÌèâÍ∞Ä
        RiskEvaluator.evaluate(lp)


==========================================================================================
# FILE: tasks/__init__.py
==========================================================================================



==========================================================================================
# FILE: tasks/grading_tasks.py
==========================================================================================
# apps/domains/results/tasks/grading_tasks.py
from celery import shared_task

from apps.domains.submissions.models import Submission
from apps.domains.results.services.grader import grade_submission_to_results


@shared_task(bind=True, autoretry_for=(Exception,), retry_kwargs={"max_retries": 3})
def grade_submission_task(self, submission_id: int) -> bool:
    submission = Submission.objects.get(id=submission_id)
    grade_submission_to_results(submission)
    return True


==========================================================================================
# FILE: tasks/progress_pipeline_task.py
==========================================================================================
# apps/domains/progress/tasks/progress_pipeline_task.py
from celery import shared_task

from apps.domains.submissions.models import Submission
from apps.domains.results.models import Result
from apps.domains.progress.services.progress_pipeline import ProgressPipeline


@shared_task(bind=True, autoretry_for=(Exception,), retry_kwargs={"max_retries": 3})
def run_progress_pipeline_task(self, submission_id: int) -> bool:
    submission = Submission.objects.get(id=submission_id)

    result = Result.objects.filter(
        target_type=submission.target_type,
        target_id=submission.target_id,
        enrollment_id=submission.enrollment_id,
    ).first()

    if not result:
        return False

    ProgressPipeline.run_by_submission(
        submission=submission,
        result=result,
    )

    return True


==========================================================================================
# FILE: tasks/wrong_note_pdf_tasks.py
==========================================================================================
# apps/domains/results/tasks/wrong_note_pdf_tasks.py
from celery import shared_task

from apps.domains.results.models.wrong_note_pdf import WrongNotePDF
from worker.wrong_notes.generator import generate_wrong_note_pdf


@shared_task(
    bind=True,
    autoretry_for=(Exception,),
    retry_kwargs={"max_retries": 3},
)
def generate_wrong_note_pdf_task(self, job_id: int) -> bool:
    """
    ‚ùó Í≥ÑÏïΩ Ïó≠Ìï†Îßå ÏàòÌñâ
    ‚ùó Ïã§Ï†ú Í≥ÑÏÇ∞/ÏÉùÏÑ±ÏùÄ workerÎ°ú ÏúÑÏûÑ
    """
    job = WrongNotePDF.objects.get(id=job_id)

    job.status = WrongNotePDF.Status.RUNNING
    job.save(update_fields=["status"])

    try:
        file_path = generate_wrong_note_pdf(job_id)
        job.file_path = file_path
        job.status = WrongNotePDF.Status.DONE
        job.save(update_fields=["status", "file_path"])
        return True

    except Exception as e:
        job.status = WrongNotePDF.Status.FAILED
        job.error_message = str(e)
        job.save(update_fields=["status", "error_message"])
        raise


==========================================================================================
# FILE: views/__init__.py
==========================================================================================
# PATH: apps/domains/results/views/__init__.py

from .exam_result_view import ExamStatsView, ExamQuestionStatsView
from .wrong_note_view import WrongNoteView

from .admin_exam_results_view import AdminExamResultsView
from .admin_exam_summary_view import AdminExamSummaryView
from .admin_exam_question_stats_view import AdminExamQuestionStatsView

__all__ = [
    # Legacy
    "ExamStatsView",
    "ExamQuestionStatsView",

    # Admin
    "AdminExamResultsView",
    "AdminExamSummaryView",
    "AdminExamQuestionStatsView",

    # Shared
    "WrongNoteView",
]


==========================================================================================
# FILE: views/admin_exam_question_stats_view.py
==========================================================================================
# PATH: apps/domains/results/views/admin_exam_question_stats_view.py
"""
Admin / Teacher Exam Question Statistics

- ResultFact Í∏∞Î∞ò (append-only)
- support.analytics ÏôÑÏ†Ñ ÎåÄÏ≤¥
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import Count

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import ResultFact


class AdminExamQuestionStatsView(APIView):
    """
    GET /results/admin/exams/<exam_id>/questions/
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        facts = ResultFact.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
        )

        rows = []

        for qid in facts.values_list("question_id", flat=True).distinct():
            qf = facts.filter(question_id=qid)
            total = qf.count()
            correct = qf.filter(is_correct=True).count()

            rows.append({
                "question_id": qid,
                "attempts": total,
                "correct_count": correct,
                "wrong_count": total - correct,
                "correct_rate": (correct / total) if total else 0.0,
            })

        return Response(rows)


==========================================================================================
# FILE: views/admin_exam_results_view.py
==========================================================================================
# PATH: apps/domains/results/views/admin_exam_results_view.py

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import Result, ResultFact
from apps.domains.results.serializers.admin_exam_result_row import (
    AdminExamResultRowSerializer,
)

from apps.domains.progress.models import SessionProgress
from apps.domains.lectures.models import Session
from apps.domains.students.models import Student
from apps.domains.submissions.models import Submission


class AdminExamResultsView(APIView):
    """
    GET /results/admin/exams/<exam_id>/results/

    üî• attempt Ï§ëÏã¨ ÏÑ§Í≥Ñ Î∞òÏòÅ Î≤ÑÏ†Ñ

    Î≥ÄÍ≤Ω Ìè¨Ïù∏Ìä∏ ÏöîÏïΩ:
    - ResultFact Í∏∞Ï§Ä "ÏµúÏã† submission" ÌåêÎã® Ïãú
      submission_id Îã®ÎèÖÏù¥ ÏïÑÎãàÎùº attempt_id Í∏∞Ï§ÄÏúºÎ°ú ÌåêÎã®
    - Ïû¨ÏãúÌóò / Ïû¨Ï±ÑÏ†ê / ÎåÄÌëú attempt Î≥ÄÍ≤ΩÏóêÎèÑ ÏùòÎØ∏Ï†ÅÏúºÎ°ú Ïò¨Î∞îÎ•∏ ÏµúÏã†Í∞í Î≥¥Ïû•
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        exam_id = int(exam_id)

        # -------------------------------------------------
        # 1Ô∏è‚É£ Result (ÏµúÏã† Ïä§ÎÉÖÏÉ∑)
        # -------------------------------------------------
        results = Result.objects.filter(
            target_type="exam",
            target_id=exam_id,
        )

        # -------------------------------------------------
        # 2Ô∏è‚É£ Session ‚Üí Progress (enrollment Í∏∞Ï§Ä)
        # -------------------------------------------------
        session = Session.objects.filter(exam__id=exam_id).first()
        progress_map = {
            sp.enrollment_id: sp
            for sp in SessionProgress.objects.filter(session=session)
        }

        # -------------------------------------------------
        # 3Ô∏è‚É£ Student Ï°∞Ìöå ÏµúÏ†ÅÌôî
        # -------------------------------------------------
        student_ids = [
            sp.student_id
            for sp in progress_map.values()
            if getattr(sp, "student_id", None)
        ]

        student_map = {
            s.id: s
            for s in Student.objects.filter(id__in=student_ids)
        }

        # -------------------------------------------------
        # 4Ô∏è‚É£ üî• enrollment_id ‚Üí ÏµúÏã† attempt/submission Îßµ
        # -------------------------------------------------
        """
        ‚ùó ÌïµÏã¨ Î≥ÄÍ≤Ω Ìè¨Ïù∏Ìä∏

        Í∏∞Ï°¥:
        - ResultFact.id DESC Í∏∞Ï§Ä ‚Üí submission_id ÏµúÏã† ÌåêÎã®
        Î¨∏Ï†ú:
        - Ïû¨ÏãúÌóò/Ïû¨Ï±ÑÏ†ê Ïãú ÏùòÎØ∏ÏÉÅ ÏµúÏã†Ïù¥ ÏïÑÎãê Ïàò ÏûàÏùå

        Î≥ÄÍ≤Ω:
        - ResultFact.attempt_id Í∏∞Ï§ÄÏúºÎ°ú "ÏãúÌóò ÏùëÏãú Îã®ÏúÑ ÏµúÏã†" ÌåêÎã®
        """

        fact_qs = (
            ResultFact.objects
            .filter(
                target_type="exam",
                target_id=exam_id,
            )
            .exclude(attempt_id__isnull=True)
            .order_by("-attempt_id", "-id")
            .values(
                "enrollment_id",
                "attempt_id",
                "submission_id",
            )
        )

        latest_map = {}
        for row in fact_qs:
            eid = row["enrollment_id"]
            if eid not in latest_map:
                latest_map[eid] = {
                    "attempt_id": row["attempt_id"],
                    "submission_id": row["submission_id"],
                }

        # -------------------------------------------------
        # 5Ô∏è‚É£ Submission.status Ï°∞Ìöå
        # -------------------------------------------------
        submission_ids = [
            v["submission_id"]
            for v in latest_map.values()
            if v.get("submission_id")
        ]

        submission_status_map = {
            s.id: s.status
            for s in Submission.objects.filter(id__in=submission_ids)
        }

        # -------------------------------------------------
        # 6Ô∏è‚É£ ÏµúÏ¢Ö rows Íµ¨ÏÑ± (ÏùëÎãµ Ïä§Ìéô Î≥ÄÍ≤Ω ÏóÜÏùå)
        # -------------------------------------------------
        rows = []

        for r in results:
            enrollment_id = r.enrollment_id
            sp = progress_map.get(enrollment_id)
            student = student_map.get(
                getattr(sp, "student_id", None)
            )

            latest = latest_map.get(enrollment_id, {})
            submission_id = latest.get("submission_id")
            submission_status = (
                submission_status_map.get(submission_id)
                if submission_id
                else None
            )

            rows.append({
                "enrollment_id": enrollment_id,
                "student_name": student.name if student else "-",

                "total_score": r.total_score,
                "max_score": r.max_score,

                "passed": bool(sp and not sp.failed),
                "clinic_required": bool(sp and sp.clinic_required),

                "submitted_at": r.submitted_at,

                # üî• Submission Ïó∞Îèô (Í∏∞Ï°¥ ÌîÑÎ°†Ìä∏ Ìò∏Ìôò)
                "submission_id": submission_id,
                "submission_status": submission_status,
            })

        return Response(
            AdminExamResultRowSerializer(rows, many=True).data
        )


==========================================================================================
# FILE: views/admin_exam_summary_view.py
==========================================================================================
# PATH: apps/domains/results/views/admin_exam_summary_view.py
"""
Admin / Teacher Exam Summary
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import Avg, Min, Max, Count

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import Result
from apps.domains.results.serializers.admin_exam_summary import (
    AdminExamSummarySerializer,
)

from apps.domains.progress.models import ProgressPolicy, SessionProgress
from apps.domains.lectures.models import Session


class AdminExamSummaryView(APIView):
    """
    GET /results/admin/exams/<exam_id>/summary/
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        qs = Result.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
        )

        agg = qs.aggregate(
            participant_count=Count("id"),
            avg_score=Avg("total_score"),
            min_score=Min("total_score"),
            max_score=Max("total_score"),
        )

        session = Session.objects.filter(exam__id=exam_id).first()

        policy = (
            ProgressPolicy.objects
            .filter(lecture=session.lecture)
            .first()
            if session else None
        )

        pass_score = policy.exam_pass_score if policy else 0

        pass_count = qs.filter(total_score__gte=pass_score).count()
        fail_count = qs.filter(total_score__lt=pass_score).count()

        participant_count = agg["participant_count"] or 0
        pass_rate = (
            pass_count / participant_count
            if participant_count else 0.0
        )

        clinic_count = (
            SessionProgress.objects
            .filter(session=session, clinic_required=True)
            .count()
            if session else 0
        )

        return Response(
            AdminExamSummarySerializer({
                "participant_count": participant_count,
                "avg_score": float(agg["avg_score"] or 0.0),
                "min_score": float(agg["min_score"] or 0.0),
                "max_score": float(agg["max_score"] or 0.0),
                "pass_count": pass_count,
                "fail_count": fail_count,
                "pass_rate": round(float(pass_rate), 4),
                "clinic_count": clinic_count,
            }).data
        )


==========================================================================================
# FILE: views/exam_attempt_view.py
==========================================================================================
# apps/domains/results/views/exam_attempt_view.py
"""
ExamAttemptViewSet

‚ùó ÏπòÎ™ÖÏ†Å Î≥¥Ïïà Ïù¥Ïäà ÏàòÏ†ï:
- Í∏∞Ï°¥: IsAuthenticated Îßå Í±∏Î†§ÏÑú ÌïôÏÉùÎèÑ Ï†ÑÏ≤¥ Attempt Ïó¥Îûå Í∞ÄÎä•
- Î≥ÄÍ≤Ω: Teacher/AdminÎßå Ï†ëÍ∑º Í∞ÄÎä•

ÌïÑÏöîÌïòÎ©¥ Ï∂îÌõÑ:
- ÌïôÏÉù Î≥∏Ïù∏ attemptÎßå Ï°∞ÌöåÌïòÎäî Î≥ÑÎèÑ ViewÎ•º /me/* Î°ú Îî∞Î°ú ÎßåÎì§ Í≤É
"""

from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.models import ExamAttempt
from apps.domains.results.serializers.exam_attempt import ExamAttemptSerializer
from apps.domains.results.permissions import IsTeacherOrAdmin


class ExamAttemptViewSet(ModelViewSet):
    """
    ÏãúÌóò ÏãúÎèÑ(Attempt) Í¥ÄÎ¶¨ API (Í¥ÄÎ¶¨Ïûê/ÍµêÏÇ¨Ïö©)
    """

    queryset = ExamAttempt.objects.all().order_by("-created_at")
    serializer_class = ExamAttemptSerializer

    # ‚úÖ Î≥¥Ïïà ÏàòÏ†ï
    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]


==========================================================================================
# FILE: views/exam_result_view.py
==========================================================================================
# PATH: apps/domains/results/views/exam_result_view.py
"""
‚ö†Ô∏è LEGACY APIs (DEPRECATED)

- Admin Ï†ÑÏö© APIÎäî /admin/* Í≤ΩÎ°ú ÏÇ¨Ïö©
- Î≥∏ ÌååÏùºÏùÄ Í≥ºÍ±∞ ÌîÑÎ°†Ìä∏ Ìò∏ÌôòÏö©
- Ï∂îÌõÑ ÏÇ≠Ï†ú ÏòàÏ†ï
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import Avg, Min, Max, StdDev, Count

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import Result, ResultFact
from apps.domains.exams.models import Exam
from apps.domains.progress.models import ProgressPolicy


class ExamStatsView(APIView):
    """
    ‚ö†Ô∏è DEPRECATED
    ÏãúÌóò ÏöîÏïΩ ÌÜµÍ≥Ñ (Legacy)
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        exam = Exam.objects.select_related("lecture").get(id=exam_id)
        policy = ProgressPolicy.objects.get(lecture=exam.lecture)

        qs = Result.objects.filter(
            target_type="exam",
            target_id=exam_id,
        )

        agg = qs.aggregate(
            avg=Avg("total_score"),
            std=StdDev("total_score"),
            min=Min("total_score"),
            max=Max("total_score"),
            participants=Count("id"),
        )

        participants = agg["participants"] or 0
        passed = qs.filter(
            total_score__gte=policy.exam_pass_score
        ).count()

        pass_rate = (passed / participants) if participants else 0.0

        return Response({
            "exam_id": exam_id,
            "participants": participants,
            "avg": agg["avg"],
            "std": agg["std"],
            "min": agg["min"],
            "max": agg["max"],
            "pass_rate": pass_rate,
        })


class ExamQuestionStatsView(APIView):
    """
    ‚ö†Ô∏è DEPRECATED
    ÏãúÌóò Î¨∏Ìï≠Î≥Ñ ÌÜµÍ≥Ñ (Legacy)
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        facts = ResultFact.objects.filter(
            target_type="exam",
            target_id=exam_id,
        )

        rows = []

        for qid in facts.values_list("question_id", flat=True).distinct():
            qf = facts.filter(question_id=qid)
            total = qf.count()
            correct = qf.filter(is_correct=True).count()

            rows.append({
                "question_id": qid,
                "correct_rate": (correct / total) if total else 0.0,
            })

        return Response(rows)


==========================================================================================
# FILE: views/homework_result_view.py
==========================================================================================



==========================================================================================
# FILE: views/student_exam_result_view.py
==========================================================================================
# PATH: apps/domains/results/views/student_exam_result_view.py
from __future__ import annotations

from django.shortcuts import get_object_or_404

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.models import Result
from apps.domains.results.serializers.student_exam_result import StudentExamResultSerializer
from apps.domains.results.permissions import IsStudent

# ‚úÖ ÏãúÌóò/ÏàòÍ∞ïÏ†ïÎ≥¥Î•º ÌÜµÌï¥ enrollment_idÎ•º Ï∞æÍ∏∞ ÏúÑÌï¥ import
from apps.domains.exams.models import Exam
from apps.domains.enrollment.models import Enrollment


class MyExamResultView(APIView):
    """
    ‚úÖ ÌïôÏÉù Î≥∏Ïù∏ ÏãúÌóò ÏÑ±Ï†Å Ï°∞Ìöå (1Í∞ú API)

    GET /results/me/exams/<exam_id>/

    - request.user(ÌïôÏÉù) Í∏∞Ï§ÄÏúºÎ°ú enrollment_idÎ•º Ï∞æÏïÑÏÑú
    - results_result + results_result_itemÏùÑ Î∞òÌôò

    Ï£ºÏùò:
    - Enrollment/Exam ÌïÑÎìúÍ∞Ä ÌîÑÎ°úÏ†ùÌä∏ÎßàÎã§ Îã§Î•º Ïàò ÏûàÏñ¥ Î∞©Ïñ¥Ï†ÅÏúºÎ°ú ÏûëÏÑ±Ìï®
    """

    permission_classes = [IsAuthenticated, IsStudent]

    def get(self, request, exam_id: int):
        user = request.user
        exam = get_object_or_404(Exam, id=int(exam_id))

        # ------------------------------------------------------------
        # 1) enrollment Ï∞æÍ∏∞
        # ------------------------------------------------------------
        # ‚úÖ Í∞ÄÏû• Ïù¥ÏÉÅÏ†ÅÏù∏ Îß§Ìïë: Enrollment(user + lecture)
        # - ExamÏóê lecture_id(ÌòπÏùÄ lecture)Í∞Ä ÏûàÎäî ÌîÑÎ°úÏ†ùÌä∏Î•º Ï†ÑÏ†úÎ°ú Ïö∞ÏÑ† ÏãúÎèÑ
        lecture_id = getattr(exam, "lecture_id", None)
        if lecture_id is None and getattr(exam, "lecture", None) is not None:
            lecture_id = getattr(exam.lecture, "id", None)

        enrollment_qs = Enrollment.objects.all()

        # ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ EnrollmentÏùò user FK ÌïÑÎìúÎ™ÖÏù¥ Îã§Î•º Ïàò ÏûàÏùå (Î≥¥ÌÜµ user)
        if hasattr(Enrollment, "user_id"):
            enrollment_qs = enrollment_qs.filter(user_id=user.id)
        elif hasattr(Enrollment, "student_id"):
            enrollment_qs = enrollment_qs.filter(student_id=user.id)
        else:
            # Ï†ïÎßê ÌäπÏù¥ ÏºÄÏù¥Ïä§Î©¥ Ïó¨Í∏∞ ÏàòÏ†ï
            enrollment_qs = enrollment_qs.filter(user=user)

        if lecture_id is not None:
            # EnrollmentÏóê lecture_id ÌïÑÎìúÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ Ïö∞ÏÑ† ÌïÑÌÑ∞
            if hasattr(Enrollment, "lecture_id"):
                enrollment_qs = enrollment_qs.filter(lecture_id=int(lecture_id))

        enrollment = enrollment_qs.first()
        if not enrollment:
            return Response(
                {"detail": "enrollment not found for this user (and lecture)."},
                status=404,
            )

        enrollment_id = int(getattr(enrollment, "id"))

        # ------------------------------------------------------------
        # 2) Result Ï°∞Ìöå (Result = ÏµúÏã† Ïä§ÎÉÖÏÉ∑)
        # ------------------------------------------------------------
        result = Result.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
            enrollment_id=enrollment_id,
        ).prefetch_related("items").first()

        if not result:
            # ‚úÖ ÌïôÏÉù Í¥ÄÏ†ê UX:
            # - ÏïÑÏßÅ Ï†úÏ∂ú/Ï±ÑÏ†ê Ï†ÑÏù¥Î©¥ 404Í∞Ä Îçî ÏûêÏó∞Ïä§ÎüΩÍ±∞ÎÇò,
            # - 200 + null ÌòïÌÉúÎ°ú Ï£ºÍ∏∞ÎèÑ Ìï® (ÌåÄ Ïª®Î≤§ÏÖòÏóê ÎßûÏ∂∞ ÌÉù1)
            return Response(
                {"detail": "result not found (not submitted or not graded yet)."},
                status=404,
            )

        return Response(StudentExamResultSerializer(result).data)


==========================================================================================
# FILE: views/wrong_note_pdf_view.py
==========================================================================================
# apps/domains/results/views/wrong_note_pdf_view.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.models.wrong_note_pdf import WrongNotePDF

# ‚úÖ ÎÑ§ ÌîÑÎ°úÏ†ùÌä∏ Îç§ÌîÑ Í∏∞Ï§Ä Ïã§Ï†ú ÌååÏùºÎ™ÖÏùÄ wrong_note_pdf_tasks.py
# (Ïù¥Í±∞ ÌãÄÎ¶¨Î©¥ Î∞îÎ°ú ImportError/CI ÌÑ∞Ïßê)
from apps.domains.results.tasks.wrong_note_pdf_tasks import generate_wrong_note_pdf_task


class WrongNotePDFCreateView(APIView):
    """
    Ïò§ÎãµÎÖ∏Ìä∏ PDF ÏÉùÏÑ± ÏöîÏ≤≠

    POST /results/wrong-notes/pdf/

    body:
    - enrollment_id (required)
    - lecture_id (optional)
    - exam_id (optional)
    - from_session_order (optional, default=2)
    """

    permission_classes = [IsAuthenticated]

    def post(self, request):
        enrollment_id = request.data.get("enrollment_id")
        lecture_id = request.data.get("lecture_id")
        exam_id = request.data.get("exam_id")
        from_order = request.data.get("from_session_order", 2)

        if not enrollment_id:
            return Response({"detail": "enrollment_id required"}, status=400)

        job = WrongNotePDF.objects.create(
            enrollment_id=enrollment_id,
            lecture_id=lecture_id,
            exam_id=exam_id,
            from_session_order=from_order,
        )

        # ‚úÖ celery task Ïã§Ìñâ
        generate_wrong_note_pdf_task.delay(job.id)

        return Response({
            "job_id": job.id,
            "status": job.status,
        })


==========================================================================================
# FILE: views/wrong_note_view.py
==========================================================================================
# apps/domains/results/views/wrong_note_view.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import F

from apps.domains.results.models import ResultFact
from apps.domains.exams.models import Exam
from apps.domains.lectures.models import Session


class WrongNoteView(APIView):
    """
    Ïò§ÎãµÎÖ∏Ìä∏ Ï°∞Ìöå API (v1)
    - ResultFact Í∏∞Î∞ò
    - append-only
    """

    permission_classes = [IsAuthenticated]

    def get(self, request):
        """
        Query Params
        - enrollment_id (required)
        - lecture_id (optional)
        - exam_id (optional)
        - from_session_order (optional, default=2)
        """

        enrollment_id = request.query_params.get("enrollment_id")
        if not enrollment_id:
            return Response(
                {"detail": "enrollment_id is required"},
                status=400,
            )

        lecture_id = request.query_params.get("lecture_id")
        exam_id = request.query_params.get("exam_id")
        from_order = int(request.query_params.get("from_session_order", 2))

        qs = ResultFact.objects.filter(
            enrollment_id=enrollment_id,
            is_correct=False,
            target_type="exam",
        )

        # -----------------------------
        # ÏãúÌóò Í∏∞Ï§Ä ÌïÑÌÑ∞
        # -----------------------------
        if exam_id:
            qs = qs.filter(target_id=exam_id)

        # -----------------------------
        # Í∞ïÏùò / Ï£ºÏ∞® Í∏∞Ï§Ä ÌïÑÌÑ∞
        # -----------------------------
        if lecture_id:
            exam_ids = (
                Exam.objects
                .filter(
                    lecture_id=lecture_id,
                    session__order__gte=from_order,
                )
                .values_list("id", flat=True)
            )
            qs = qs.filter(target_id__in=exam_ids)

        qs = qs.select_related(None).order_by(
            "target_id",
            "question_id",
        )

        result = []

        for f in qs:
            result.append({
                "exam_id": f.target_id,
                "question_id": f.question_id,
                "answer": f.answer,
                "score": f.score,
                "max_score": f.max_score,
                "source": f.source,
                "meta": f.meta,
                "created_at": f.created_at,
            })

        return Response({
            "enrollment_id": int(enrollment_id),
            "count": len(result),
            "items": result,
        })
