====================================================================================================
# BACKEND APP: domains__results
# ROOT PATH: C:\academy\apps\domains\results
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class ResultsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.results"
    label = "results"


==========================================================================================
# FILE: permissions.py
==========================================================================================
# PATH: apps/domains/results/permissions.py
from __future__ import annotations

from rest_framework.permissions import BasePermission


def _role(u) -> str:
    """
    í”„ë¡œì íŠ¸ë§ˆë‹¤ user.role / user.user_type / groups ë“± ë‹¤ë¥¼ ìˆ˜ ìˆì–´ì„œ ë°©ì–´ì ìœ¼ë¡œ.
    - ìˆìœ¼ë©´ ì“°ê³ 
    - ì—†ìœ¼ë©´ is_staff/is_superuserë¡œ íŒë‹¨
    """
    v = getattr(u, "role", None) or getattr(u, "user_type", None) or ""
    return str(v).upper()


def is_admin_user(u) -> bool:
    return bool(getattr(u, "is_superuser", False) or getattr(u, "is_staff", False) or _role(u) in ("ADMIN", "STAFF"))


def is_teacher_user(u) -> bool:
    # í”„ë¡œì íŠ¸ì— ë”°ë¼ "TEACHER" ë¬¸ìì—´ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ â†’ í•„ìš”ì‹œ ì—¬ê¸°ë§Œ ìˆ˜ì •
    return bool(is_admin_user(u) or _role(u) in ("TEACHER",))


def is_student_user(u) -> bool:
    # ëª…ì‹œì ìœ¼ë¡œ teacher/admin ì•„ë‹ˆë©´ studentë¡œ ì·¨ê¸‰(ì¼ë°˜ì ì¸ ì •ì±…)
    return bool(not is_teacher_user(u))


class IsStudent(BasePermission):
    def has_permission(self, request, view):
        u = getattr(request, "user", None)
        return bool(u and u.is_authenticated and is_student_user(u))


class IsTeacherOrAdmin(BasePermission):
    def has_permission(self, request, view):
        u = getattr(request, "user", None)
        return bool(u and u.is_authenticated and is_teacher_user(u))


==========================================================================================
# FILE: urls.py
==========================================================================================
# PATH: apps/domains/results/urls.py
"""
Results Domain API Routes

ì •ì±…:
- Student / Admin API ëª…í™•íˆ ë¶„ë¦¬
- Legacy APIëŠ” DEPRECATED ì²˜ë¦¬
"""

from django.urls import path

# ======================
# Student
# ======================
from apps.domains.results.views.student_exam_result_view import MyExamResultView

# ======================
# Admin / Teacher (â­ ê¶Œì¥)
# ======================
from apps.domains.results.views.admin_exam_results_view import AdminExamResultsView
from apps.domains.results.views.admin_exam_summary_view import AdminExamSummaryView
from apps.domains.results.views.admin_exam_question_stats_view import (
    AdminExamQuestionStatsView,
)

# ======================
# Legacy
# ======================
from apps.domains.results.views.exam_result_view import (
    ExamStatsView,
    ExamQuestionStatsView,
)
from apps.domains.results.views.wrong_note_view import WrongNoteView


urlpatterns = [
    # -------------------
    # Student
    # -------------------
    path(
        "me/exams/<int:exam_id>/",
        MyExamResultView.as_view(),
        name="my-exam-result",
    ),

    # -------------------
    # Admin / Teacher
    # -------------------
    path(
        "admin/exams/<int:exam_id>/summary/",
        AdminExamSummaryView.as_view(),
        name="admin-exam-summary",
    ),
    path(
        "admin/exams/<int:exam_id>/results/",
        AdminExamResultsView.as_view(),
        name="admin-exam-results",
    ),
    path(
        "admin/exams/<int:exam_id>/questions/",
        AdminExamQuestionStatsView.as_view(),
        name="admin-exam-question-stats",
    ),

    # -------------------
    # Wrong Notes
    # -------------------
    path(
        "wrong-notes",
        WrongNoteView.as_view(),
        name="wrong-note",
    ),

    # -------------------
    # âš ï¸ Legacy (DEPRECATED)
    # -------------------
    path(
        "exams/<int:exam_id>/stats",
        ExamStatsView.as_view(),
        name="legacy-exam-stats",
    ),
    path(
        "exams/<int:exam_id>/questions/stats",
        ExamQuestionStatsView.as_view(),
        name="legacy-exam-question-stats",
    ),
]


==========================================================================================
# FILE: views.py
==========================================================================================
# exam_result_view.py / homework_result_view.py
# ì¡°íšŒ APIë§Œ êµ¬í˜„ (ì§€ê¸ˆì€ ìƒëµ ê°€ëŠ¥)


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2025-12-19 00:33

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="ResultFact",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("target_type", models.CharField(max_length=20)),
                ("target_id", models.PositiveIntegerField()),
                ("enrollment_id", models.PositiveIntegerField()),
                ("submission_id", models.PositiveIntegerField()),
                ("question_id", models.PositiveIntegerField()),
                ("answer", models.TextField(blank=True)),
                ("is_correct", models.BooleanField(default=False)),
                ("score", models.FloatField(default=0.0)),
                ("max_score", models.FloatField(default=0.0)),
                ("source", models.CharField(max_length=20)),
                ("meta", models.JSONField(blank=True, null=True)),
            ],
            options={
                "db_table": "results_fact",
                "ordering": ["-id"],
            },
        ),
        migrations.CreateModel(
            name="Result",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("target_type", models.CharField(max_length=20)),
                ("target_id", models.PositiveIntegerField()),
                ("enrollment_id", models.PositiveIntegerField()),
                ("total_score", models.FloatField(default=0.0)),
                ("max_score", models.FloatField(default=0.0)),
                ("submitted_at", models.DateTimeField(blank=True, null=True)),
            ],
            options={
                "db_table": "results_result",
                "unique_together": {("target_type", "target_id", "enrollment_id")},
            },
        ),
        migrations.CreateModel(
            name="ResultItem",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("question_id", models.PositiveIntegerField()),
                ("answer", models.TextField(blank=True)),
                ("is_correct", models.BooleanField(default=False)),
                ("score", models.FloatField(default=0.0)),
                ("max_score", models.FloatField(default=0.0)),
                ("source", models.CharField(max_length=20)),
                (
                    "result",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="items",
                        to="results.result",
                    ),
                ),
            ],
            options={
                "db_table": "results_result_item",
                "unique_together": {("result", "question_id")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: models/__init__.py
==========================================================================================
from .result import Result
from .result_item import ResultItem
from .result_fact import ResultFact

__all__ = ["Result", "ResultItem", "ResultFact"]


==========================================================================================
# FILE: models/result.py
==========================================================================================
from django.db import models
from apps.api.common.models import BaseModel


class Result(BaseModel):
    """
    ì‹œí—˜/ìˆ™ì œ ê²°ê³¼ ìµœì‹  ìŠ¤ëƒ…ìƒ· (ì¡°íšŒìš©)
    ê³„ì‚° ì—†ìŒ
    """

    target_type = models.CharField(max_length=20)  # exam / homework
    target_id = models.PositiveIntegerField()

    enrollment_id = models.PositiveIntegerField()

    total_score = models.FloatField(default=0.0)
    max_score = models.FloatField(default=0.0)

    submitted_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        db_table = "results_result"
        unique_together = ("target_type", "target_id", "enrollment_id")


==========================================================================================
# FILE: models/result_fact.py
==========================================================================================
from django.db import models
from apps.api.common.models import BaseModel


class ResultFact(BaseModel):
    """
    ê²°ê³¼ Fact (append-only, ë¶ˆë³€)
    """

    target_type = models.CharField(max_length=20)
    target_id = models.PositiveIntegerField()

    enrollment_id = models.PositiveIntegerField()
    submission_id = models.PositiveIntegerField()

    question_id = models.PositiveIntegerField()

    answer = models.TextField(blank=True)
    is_correct = models.BooleanField(default=False)

    score = models.FloatField(default=0.0)
    max_score = models.FloatField(default=0.0)

    source = models.CharField(max_length=20)
    meta = models.JSONField(null=True, blank=True)

    class Meta:
        db_table = "results_fact"
        ordering = ["-id"]


==========================================================================================
# FILE: models/result_item.py
==========================================================================================
from django.db import models
from apps.api.common.models import BaseModel


class ResultItem(BaseModel):
    """
    ë¬¸í•­ë³„ ìµœì‹  ê²°ê³¼ ìƒíƒœ (snapshot)
    """

    result = models.ForeignKey(
        "results.Result",
        on_delete=models.CASCADE,
        related_name="items",
    )

    question_id = models.PositiveIntegerField()

    answer = models.TextField(blank=True)
    is_correct = models.BooleanField(default=False)

    score = models.FloatField(default=0.0)
    max_score = models.FloatField(default=0.0)

    source = models.CharField(max_length=20)

    class Meta:
        db_table = "results_result_item"
        unique_together = ("result", "question_id")


==========================================================================================
# FILE: models/wrong_note_pdf.py
==========================================================================================
# apps/domains/results/models/wrong_note_pdf.py
from django.db import models
from apps.api.common.models import BaseModel


class WrongNotePDF(BaseModel):
    """
    ì˜¤ë‹µë…¸íŠ¸ PDF ìƒì„± Job
    """

    class Status(models.TextChoices):
        PENDING = "PENDING"
        RUNNING = "RUNNING"
        DONE = "DONE"
        FAILED = "FAILED"

    enrollment_id = models.PositiveIntegerField()
    lecture_id = models.PositiveIntegerField(null=True, blank=True)
    exam_id = models.PositiveIntegerField(null=True, blank=True)

    from_session_order = models.PositiveIntegerField(default=2)

    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
    )

    file_path = models.CharField(max_length=255, blank=True)
    error_message = models.TextField(blank=True)

    class Meta:
        db_table = "results_wrong_note_pdf"
        ordering = ["-created_at"]


==========================================================================================
# FILE: serializers/admin_exam_result_row.py
==========================================================================================
# apps/domains/results/serializers/admin_exam_result_row.py
from rest_framework import serializers


class AdminExamResultRowSerializer(serializers.Serializer):
    enrollment_id = serializers.IntegerField()
    student_name = serializers.CharField()

    total_score = serializers.FloatField()
    max_score = serializers.FloatField()

    passed = serializers.BooleanField()
    clinic_required = serializers.BooleanField()

    submitted_at = serializers.DateTimeField(allow_null=True)


==========================================================================================
# FILE: serializers/admin_exam_summary.py
==========================================================================================
# apps/domains/results/serializers/admin_exam_summary.py
from rest_framework import serializers


class AdminExamSummarySerializer(serializers.Serializer):
    participant_count = serializers.IntegerField()

    avg_score = serializers.FloatField()
    min_score = serializers.FloatField()
    max_score = serializers.FloatField()

    pass_count = serializers.IntegerField()
    fail_count = serializers.IntegerField()
    pass_rate = serializers.FloatField()

    clinic_count = serializers.IntegerField()


==========================================================================================
# FILE: serializers/student_exam_result.py
==========================================================================================
# PATH: apps/domains/results/serializers/student_exam_result.py
from __future__ import annotations

from rest_framework import serializers
from apps.domains.results.models import Result, ResultItem


class ResultItemSerializer(serializers.ModelSerializer):
    """
    âœ… í•™ìƒ í™”ë©´: ë¬¸í•­ë³„ ê²°ê³¼
    """
    class Meta:
        model = ResultItem
        fields = [
            "question_id",
            "answer",
            "is_correct",
            "score",
            "max_score",
            "source",
        ]


class StudentExamResultSerializer(serializers.ModelSerializer):
    """
    âœ… í•™ìƒ í™”ë©´: ì‹œí—˜ ê²°ê³¼(ì´ì  + ë¬¸í•­ë³„)
    """
    items = ResultItemSerializer(many=True, read_only=True)

    class Meta:
        model = Result
        fields = [
            "target_type",
            "target_id",
            "enrollment_id",
            "total_score",
            "max_score",
            "submitted_at",
            "items",
        ]


==========================================================================================
# FILE: services/__init__.py
==========================================================================================
from .applier import ResultApplier

__all__ = ["ResultApplier"]


==========================================================================================
# FILE: services/applier.py
==========================================================================================
from django.db import transaction
from django.utils import timezone

from apps.domains.results.models import Result, ResultItem, ResultFact


class ResultApplier:
    """
    ê³„ì‚°ëœ ê²°ê³¼ë¥¼ ë°›ì•„ resultsì— ë°˜ì˜
    âŒ ê³„ì‚° ì—†ìŒ
    """

    @staticmethod
    @transaction.atomic
    def apply(
        *,
        target_type: str,
        target_id: int,
        enrollment_id: int,
        submission_id: int,
        items: list[dict],
    ) -> Result:
        """
        items format:
        {
            question_id,
            answer,
            is_correct,
            score,
            max_score,
            source,
            meta
        }
        """

        result, _ = Result.objects.get_or_create(
            target_type=target_type,
            target_id=target_id,
            enrollment_id=enrollment_id,
        )

        total = 0.0
        max_total = 0.0

        for item in items:
            # 1ï¸âƒ£ Fact
            ResultFact.objects.create(
                target_type=target_type,
                target_id=target_id,
                enrollment_id=enrollment_id,
                submission_id=submission_id,
                **item,
            )

            # 2ï¸âƒ£ Snapshot
            ResultItem.objects.update_or_create(
                result=result,
                question_id=item["question_id"],
                defaults={
                    "answer": item["answer"],
                    "is_correct": item["is_correct"],
                    "score": item["score"],
                    "max_score": item["max_score"],
                    "source": item["source"],
                },
            )

            total += item["score"]
            max_total += item["max_score"]

        result.total_score = total
        result.max_score = max_total
        result.submitted_at = timezone.now()
        result.save(update_fields=["total_score", "max_score", "submitted_at"])

        return result


==========================================================================================
# FILE: services/grader.py
==========================================================================================
# apps/domains/results/services/grader.py
from __future__ import annotations

from typing import Any, Dict, List, Optional, Tuple

from django.db import transaction

from apps.domains.submissions.models import Submission, SubmissionAnswer
from apps.domains.results.services.applier import ResultApplier
from apps.domains.exams.models import ExamQuestion, AnswerKey

# progress ì—°ê²°
from apps.domains.progress.dispatcher import dispatch_progress_pipeline

# ============================================================
# OMR/ì±„ì  ì •ì±… v1 (Results ë„ë©”ì¸ ì±…ì„)
# - WorkerëŠ” "ë‹µì•ˆ ì‚¬ì‹¤"ë§Œ ë³´ë‚´ê³ , ì ìˆ˜ ê³„ì‚°ì€ ì—¬ê¸°ì„œ í•œë‹¤.
# - v1 ê³ ì • ì •ì±…:
#   - multi ë§ˆí‚¹ = 0ì 
#   - confidence < 0.70 = 0ì 
#   - status != ok = 0ì 
#   - ë¶€ë¶„ì ìˆ˜ ì—†ìŒ
# ============================================================

OMR_CONF_THRESHOLD_V1 = 0.70


def _norm(s: Optional[str]) -> str:
    return (s or "").strip().upper()


def _get_omr_meta(meta: Any) -> Dict[str, Any]:
    """
    SubmissionAnswer.metaì—ì„œ OMR v1 payload ì¶”ì¶œ.
    ê¸°ëŒ€ ìœ„ì¹˜: meta["omr"]
    """
    if not isinstance(meta, dict):
        return {}
    omr = meta.get("omr")
    return omr if isinstance(omr, dict) else {}


def _grade_choice_v1(
    *,
    detected: List[str],
    marking: str,
    confidence: Optional[float],
    status: str,
    correct_answer: str,
    max_score: float,
) -> Tuple[bool, float]:
    """
    ê°ê´€ì‹(ì„ íƒí˜•) ì±„ì  v1
    return: (is_correct, score)
    """
    if (status or "").lower() != "ok":
        return (False, 0.0)

    m = (marking or "").lower()
    if m in ("blank", "multi"):
        return (False, 0.0)

    conf = float(confidence) if confidence is not None else 0.0
    if conf < OMR_CONF_THRESHOLD_V1:
        return (False, 0.0)

    if not detected or len(detected) != 1:
        return (False, 0.0)

    ans = _norm(detected[0])
    cor = _norm(correct_answer)

    is_correct = (ans != "") and (cor != "") and (ans == cor)
    score = float(max_score) if is_correct else 0.0
    return (is_correct, score)


def _grade_short_v1(
    *,
    answer_text: str,
    correct_answer: str,
    max_score: float,
) -> Tuple[bool, float]:
    """
    ì£¼ê´€ì‹(í…ìŠ¤íŠ¸) ì±„ì  v1 (exact match only)
    """
    ans = _norm(answer_text)
    cor = _norm(correct_answer)

    if ans == "":
        return (False, 0.0)

    is_correct = (cor != "") and (ans == cor)
    score = float(max_score) if is_correct else 0.0
    return (is_correct, score)


def _infer_answer_type(q: ExamQuestion) -> str:
    """
    answer_typeê°€ ëª¨ë¸ì— ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë°©ì–´ì ìœ¼ë¡œ ì¶”ë¡ .
    """
    v = getattr(q, "answer_type", None)
    if isinstance(v, str) and v.strip():
        return v.strip().lower()
    return "choice"


def _get_correct_answer_map(exam_id: int) -> Dict[str, Any]:
    """
    AnswerKey.answers: { "1": "B", "2": "3", ... } (question number ê¸°ë°˜)
    """
    ak = AnswerKey.objects.filter(exam_id=exam_id).first()
    if not ak or not isinstance(ak.answers, dict):
        return {}
    return ak.answers


@transaction.atomic
def grade_submission_to_results(submission: Submission) -> None:
    """
    Submission + SubmissionAnswer(+meta) -> Result/ResultItem/ResultFact ë°˜ì˜
    - ì •ì±…/ì ìˆ˜ ê³„ì‚°ì€ Results ë„ë©”ì¸ ì±…ì„
    """
    submission.status = Submission.Status.GRADING
    submission.save(update_fields=["status"])

    answers = list(SubmissionAnswer.objects.filter(submission=submission))

    if submission.target_type != Submission.TargetType.EXAM:
        raise ValueError("Only exam grading is supported")

    # âœ… ExamQuestionì€ sheet->exam êµ¬ì¡°
    questions = (
        ExamQuestion.objects
        .filter(sheet__exam_id=submission.target_id)
        .in_bulk(field_name="id")
    )

    # âœ… ì •ë‹µì€ AnswerKey.answersì—ì„œ (question.number ê¸°ì¤€)
    correct_map = _get_correct_answer_map(int(submission.target_id))

    items: List[dict] = []

    for sa in answers:
        q = questions.get(sa.question_id)
        if not q:
            continue

        max_score = float(getattr(q, "score", 0) or 0.0)

        # question.number ê¸°ë°˜ ì •ë‹µ
        correct_answer = str(correct_map.get(str(getattr(q, "number", ""))) or "")

        answer_text = str(sa.answer or "").strip()

        omr = _get_omr_meta(sa.meta)
        omr_version = str(omr.get("version") or "")
        detected = omr.get("detected") or []
        marking = str(omr.get("marking") or "")
        confidence = omr.get("confidence", None)
        status = str(omr.get("status") or "")

        answer_type = _infer_answer_type(q)

        if answer_type in ("choice", "omr", "multiple_choice"):
            if omr_version.lower() == "v1" and isinstance(detected, list):
                is_correct, score = _grade_choice_v1(
                    detected=[str(x) for x in detected],
                    marking=marking,
                    confidence=(float(confidence) if confidence is not None else None),
                    status=status,
                    correct_answer=correct_answer,
                    max_score=max_score,
                )
                final_answer = "".join([_norm(x) for x in detected]) if detected else ""
            else:
                is_correct, score = _grade_short_v1(
                    answer_text=answer_text,
                    correct_answer=correct_answer,
                    max_score=max_score,
                )
                final_answer = answer_text
        else:
            is_correct, score = _grade_short_v1(
                answer_text=answer_text,
                correct_answer=correct_answer,
                max_score=max_score,
            )
            final_answer = answer_text

        items.append(
            {
                "question_id": q.id,
                "answer": final_answer,
                "is_correct": bool(is_correct),
                "score": float(score),
                "max_score": float(max_score),
                "source": submission.source,
                "meta": sa.meta,
            }
        )

    ResultApplier.apply(
        target_type=submission.target_type,
        target_id=int(submission.target_id),
        enrollment_id=int(submission.enrollment_id or 0),
        submission_id=int(submission.id),
        items=items,
    )

    submission.status = Submission.Status.DONE
    submission.save(update_fields=["status"])
    
    # ğŸ”” Progress í›„ì† íŒŒì´í”„ë¼ì¸ (íŠ¸ëœì­ì…˜ ì»¤ë°‹ í›„)
    transaction.on_commit(
        lambda: dispatch_progress_pipeline(submission.id)
    )


==========================================================================================
# FILE: services/progress_pipeline.py
==========================================================================================
# apps/domains/progress/services/progress_pipeline.py
from __future__ import annotations

from typing import Optional

from django.db import transaction

from apps.domains.submissions.models import Submission
from apps.domains.results.models import Result
from apps.domains.lectures.models import Session

from apps.domains.progress.services.session_calculator import SessionProgressCalculator
from apps.domains.progress.services.lecture_calculator import LectureProgressCalculator
from apps.domains.progress.services.risk_evaluator import RiskEvaluator
from apps.domains.progress.services.clinic_trigger_service import ClinicTriggerService


class ProgressPipeline:
    """
    Results ì´í›„ 'í•™ìŠµ ì§„ë„ íŒŒì´í”„ë¼ì¸'

    âš ï¸ ì£¼ì˜
    - Results ë„ë©”ì¸ì—ì„œ ì§ì ‘ import ê¸ˆì§€
    - ì‹¤íŒ¨í•´ë„ ì¬ì‹œë„ ê°€ëŠ¥í•´ì•¼ í•¨
    - ë©±ë“±ì„± ìœ ì§€
    """

    @staticmethod
    @transaction.atomic
    def run_by_submission(
        *,
        submission: Submission,
        result: Result,
    ) -> None:
        """
        ì‹œí—˜ ì±„ì  ì™„ë£Œ í›„ Progress ì¬ê³„ì‚°
        """

        if submission.target_type != Submission.TargetType.EXAM:
            return

        # 1ï¸âƒ£ Exam â†’ Session ë§¤í•‘
        session: Optional[Session] = (
            Session.objects
            .filter(exam__id=submission.target_id)
            .select_related("lecture")
            .first()
        )

        if not session:
            return

        # 2ï¸âƒ£ SessionProgress ê³„ì‚°
        sp = SessionProgressCalculator.calculate(
            enrollment_id=submission.enrollment_id,
            session=session,
            attendance_type="online",
            video_progress_rate=100,
            exam_score=result.total_score,
            homework_submitted=True,
            homework_teacher_approved=True,
        )

        # 3ï¸âƒ£ í´ë¦¬ë‹‰ ìë™ íŠ¸ë¦¬ê±°
        ClinicTriggerService.auto_create_if_failed(sp)

        # 4ï¸âƒ£ LectureProgress ì§‘ê³„
        lp = LectureProgressCalculator.calculate(
            enrollment_id=submission.enrollment_id,
            lecture=session.lecture,
        )

        # 5ï¸âƒ£ ìœ„í—˜ë„ í‰ê°€
        RiskEvaluator.evaluate(lp)


==========================================================================================
# FILE: tasks/__init__.py
==========================================================================================



==========================================================================================
# FILE: tasks/grading_tasks.py
==========================================================================================
# apps/domains/results/tasks/grading_tasks.py
from celery import shared_task

from apps.domains.submissions.models import Submission
from apps.domains.results.services.grader import grade_submission_to_results


@shared_task(bind=True, autoretry_for=(Exception,), retry_kwargs={"max_retries": 3})
def grade_submission_task(self, submission_id: int) -> bool:
    submission = Submission.objects.get(id=submission_id)
    grade_submission_to_results(submission)
    return True


==========================================================================================
# FILE: tasks/progress_pipeline_task.py
==========================================================================================
# apps/domains/progress/tasks/progress_pipeline_task.py
from celery import shared_task

from apps.domains.submissions.models import Submission
from apps.domains.results.models import Result
from apps.domains.progress.services.progress_pipeline import ProgressPipeline


@shared_task(bind=True, autoretry_for=(Exception,), retry_kwargs={"max_retries": 3})
def run_progress_pipeline_task(self, submission_id: int) -> bool:
    submission = Submission.objects.get(id=submission_id)

    result = Result.objects.filter(
        target_type=submission.target_type,
        target_id=submission.target_id,
        enrollment_id=submission.enrollment_id,
    ).first()

    if not result:
        return False

    ProgressPipeline.run_by_submission(
        submission=submission,
        result=result,
    )

    return True


==========================================================================================
# FILE: tasks/wrong_note_pdf_tasks.py
==========================================================================================
# apps/domains/results/tasks/wrong_note_pdf_tasks.py
from celery import shared_task

from apps.domains.results.models.wrong_note_pdf import WrongNotePDF
from worker.wrong_notes.generator import generate_wrong_note_pdf


@shared_task(
    bind=True,
    autoretry_for=(Exception,),
    retry_kwargs={"max_retries": 3},
)
def generate_wrong_note_pdf_task(self, job_id: int) -> bool:
    """
    â— ê³„ì•½ ì—­í• ë§Œ ìˆ˜í–‰
    â— ì‹¤ì œ ê³„ì‚°/ìƒì„±ì€ workerë¡œ ìœ„ì„
    """
    job = WrongNotePDF.objects.get(id=job_id)

    job.status = WrongNotePDF.Status.RUNNING
    job.save(update_fields=["status"])

    try:
        file_path = generate_wrong_note_pdf(job_id)
        job.file_path = file_path
        job.status = WrongNotePDF.Status.DONE
        job.save(update_fields=["status", "file_path"])
        return True

    except Exception as e:
        job.status = WrongNotePDF.Status.FAILED
        job.error_message = str(e)
        job.save(update_fields=["status", "error_message"])
        raise


==========================================================================================
# FILE: views/__init__.py
==========================================================================================
# PATH: apps/domains/results/views/__init__.py

from .exam_result_view import ExamStatsView, ExamQuestionStatsView
from .wrong_note_view import WrongNoteView

from .admin_exam_results_view import AdminExamResultsView
from .admin_exam_summary_view import AdminExamSummaryView
from .admin_exam_question_stats_view import AdminExamQuestionStatsView

__all__ = [
    # Legacy
    "ExamStatsView",
    "ExamQuestionStatsView",

    # Admin
    "AdminExamResultsView",
    "AdminExamSummaryView",
    "AdminExamQuestionStatsView",

    # Shared
    "WrongNoteView",
]


==========================================================================================
# FILE: views/admin_exam_question_stats_view.py
==========================================================================================
# PATH: apps/domains/results/views/admin_exam_question_stats_view.py
"""
Admin / Teacher Exam Question Statistics

- ResultFact ê¸°ë°˜ (append-only)
- support.analytics ì™„ì „ ëŒ€ì²´
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import Count

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import ResultFact


class AdminExamQuestionStatsView(APIView):
    """
    GET /results/admin/exams/<exam_id>/questions/
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        facts = ResultFact.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
        )

        rows = []

        for qid in facts.values_list("question_id", flat=True).distinct():
            qf = facts.filter(question_id=qid)
            total = qf.count()
            correct = qf.filter(is_correct=True).count()

            rows.append({
                "question_id": qid,
                "attempts": total,
                "correct_count": correct,
                "wrong_count": total - correct,
                "correct_rate": (correct / total) if total else 0.0,
            })

        return Response(rows)


==========================================================================================
# FILE: views/admin_exam_results_view.py
==========================================================================================
# PATH: apps/domains/results/views/admin_exam_results_view.py
"""
Admin / Teacher Exam Results List

- Results + SessionProgress ê¸°ì¤€
- Submissions âŒ
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import Result
from apps.domains.results.serializers.admin_exam_result_row import (
    AdminExamResultRowSerializer,
)

from apps.domains.progress.models import SessionProgress
from apps.domains.lectures.models import Session
from apps.domains.students.models import Student


class AdminExamResultsView(APIView):
    """
    GET /results/admin/exams/<exam_id>/results/
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        # 1ï¸âƒ£ Results (snapshot)
        results = Result.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
        )

        # 2ï¸âƒ£ Session â†’ Progress
        session = Session.objects.filter(exam__id=exam_id).first()
        progress_map = {
            sp.enrollment_id: sp
            for sp in SessionProgress.objects.filter(session=session)
        }

        # 3ï¸âƒ£ í•„ìš”í•œ í•™ìƒë§Œ ì¡°íšŒ (ì„±ëŠ¥ ìµœì í™”)
        student_ids = [
            sp.student_id
            for sp in progress_map.values()
            if getattr(sp, "student_id", None)
        ]

        student_map = {
            s.id: s
            for s in Student.objects.filter(id__in=student_ids)
        }

        rows = []

        for r in results:
            sp = progress_map.get(r.enrollment_id)
            student = student_map.get(
                getattr(sp, "student_id", None)
            )

            rows.append({
                "enrollment_id": r.enrollment_id,
                "student_name": student.name if student else "-",
                "total_score": r.total_score,
                "max_score": r.max_score,
                "passed": bool(sp and not sp.failed),
                "clinic_required": bool(sp and sp.clinic_required),
                "submitted_at": r.submitted_at,
            })

        return Response(
            AdminExamResultRowSerializer(rows, many=True).data
        )


==========================================================================================
# FILE: views/admin_exam_summary_view.py
==========================================================================================
# PATH: apps/domains/results/views/admin_exam_summary_view.py
"""
Admin / Teacher Exam Summary
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import Avg, Min, Max, Count

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import Result
from apps.domains.results.serializers.admin_exam_summary import (
    AdminExamSummarySerializer,
)

from apps.domains.progress.models import ProgressPolicy, SessionProgress
from apps.domains.lectures.models import Session


class AdminExamSummaryView(APIView):
    """
    GET /results/admin/exams/<exam_id>/summary/
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        qs = Result.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
        )

        agg = qs.aggregate(
            participant_count=Count("id"),
            avg_score=Avg("total_score"),
            min_score=Min("total_score"),
            max_score=Max("total_score"),
        )

        session = Session.objects.filter(exam__id=exam_id).first()

        policy = (
            ProgressPolicy.objects
            .filter(lecture=session.lecture)
            .first()
            if session else None
        )

        pass_score = policy.exam_pass_score if policy else 0

        pass_count = qs.filter(total_score__gte=pass_score).count()
        fail_count = qs.filter(total_score__lt=pass_score).count()

        participant_count = agg["participant_count"] or 0
        pass_rate = (
            pass_count / participant_count
            if participant_count else 0.0
        )

        clinic_count = (
            SessionProgress.objects
            .filter(session=session, clinic_required=True)
            .count()
            if session else 0
        )

        return Response(
            AdminExamSummarySerializer({
                "participant_count": participant_count,
                "avg_score": float(agg["avg_score"] or 0.0),
                "min_score": float(agg["min_score"] or 0.0),
                "max_score": float(agg["max_score"] or 0.0),
                "pass_count": pass_count,
                "fail_count": fail_count,
                "pass_rate": round(float(pass_rate), 4),
                "clinic_count": clinic_count,
            }).data
        )


==========================================================================================
# FILE: views/exam_result_view.py
==========================================================================================
# PATH: apps/domains/results/views/exam_result_view.py
"""
âš ï¸ LEGACY APIs (DEPRECATED)

- Admin ì „ìš© APIëŠ” /admin/* ê²½ë¡œ ì‚¬ìš©
- ë³¸ íŒŒì¼ì€ ê³¼ê±° í”„ë¡ íŠ¸ í˜¸í™˜ìš©
- ì¶”í›„ ì‚­ì œ ì˜ˆì •
"""

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import Avg, Min, Max, StdDev, Count

from apps.domains.results.permissions import IsTeacherOrAdmin
from apps.domains.results.models import Result, ResultFact
from apps.domains.exams.models import Exam
from apps.domains.progress.models import ProgressPolicy


class ExamStatsView(APIView):
    """
    âš ï¸ DEPRECATED
    ì‹œí—˜ ìš”ì•½ í†µê³„ (Legacy)
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        exam = Exam.objects.select_related("lecture").get(id=exam_id)
        policy = ProgressPolicy.objects.get(lecture=exam.lecture)

        qs = Result.objects.filter(
            target_type="exam",
            target_id=exam_id,
        )

        agg = qs.aggregate(
            avg=Avg("total_score"),
            std=StdDev("total_score"),
            min=Min("total_score"),
            max=Max("total_score"),
            participants=Count("id"),
        )

        participants = agg["participants"] or 0
        passed = qs.filter(
            total_score__gte=policy.exam_pass_score
        ).count()

        pass_rate = (passed / participants) if participants else 0.0

        return Response({
            "exam_id": exam_id,
            "participants": participants,
            "avg": agg["avg"],
            "std": agg["std"],
            "min": agg["min"],
            "max": agg["max"],
            "pass_rate": pass_rate,
        })


class ExamQuestionStatsView(APIView):
    """
    âš ï¸ DEPRECATED
    ì‹œí—˜ ë¬¸í•­ë³„ í†µê³„ (Legacy)
    """

    permission_classes = [IsAuthenticated, IsTeacherOrAdmin]

    def get(self, request, exam_id: int):
        facts = ResultFact.objects.filter(
            target_type="exam",
            target_id=exam_id,
        )

        rows = []

        for qid in facts.values_list("question_id", flat=True).distinct():
            qf = facts.filter(question_id=qid)
            total = qf.count()
            correct = qf.filter(is_correct=True).count()

            rows.append({
                "question_id": qid,
                "correct_rate": (correct / total) if total else 0.0,
            })

        return Response(rows)


==========================================================================================
# FILE: views/homework_result_view.py
==========================================================================================



==========================================================================================
# FILE: views/student_exam_result_view.py
==========================================================================================
# PATH: apps/domains/results/views/student_exam_result_view.py
from __future__ import annotations

from django.shortcuts import get_object_or_404

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.models import Result
from apps.domains.results.serializers.student_exam_result import StudentExamResultSerializer
from apps.domains.results.permissions import IsStudent

# âœ… ì‹œí—˜/ìˆ˜ê°•ì •ë³´ë¥¼ í†µí•´ enrollment_idë¥¼ ì°¾ê¸° ìœ„í•´ import
from apps.domains.exams.models import Exam
from apps.domains.enrollment.models import Enrollment


class MyExamResultView(APIView):
    """
    âœ… í•™ìƒ ë³¸ì¸ ì‹œí—˜ ì„±ì  ì¡°íšŒ (1ê°œ API)

    GET /results/me/exams/<exam_id>/

    - request.user(í•™ìƒ) ê¸°ì¤€ìœ¼ë¡œ enrollment_idë¥¼ ì°¾ì•„ì„œ
    - results_result + results_result_itemì„ ë°˜í™˜

    ì£¼ì˜:
    - Enrollment/Exam í•„ë“œê°€ í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ ë°©ì–´ì ìœ¼ë¡œ ì‘ì„±í•¨
    """

    permission_classes = [IsAuthenticated, IsStudent]

    def get(self, request, exam_id: int):
        user = request.user
        exam = get_object_or_404(Exam, id=int(exam_id))

        # ------------------------------------------------------------
        # 1) enrollment ì°¾ê¸°
        # ------------------------------------------------------------
        # âœ… ê°€ì¥ ì´ìƒì ì¸ ë§¤í•‘: Enrollment(user + lecture)
        # - Examì— lecture_id(í˜¹ì€ lecture)ê°€ ìˆëŠ” í”„ë¡œì íŠ¸ë¥¼ ì „ì œë¡œ ìš°ì„  ì‹œë„
        lecture_id = getattr(exam, "lecture_id", None)
        if lecture_id is None and getattr(exam, "lecture", None) is not None:
            lecture_id = getattr(exam.lecture, "id", None)

        enrollment_qs = Enrollment.objects.all()

        # í”„ë¡œì íŠ¸ë³„ Enrollmentì˜ user FK í•„ë“œëª…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ (ë³´í†µ user)
        if hasattr(Enrollment, "user_id"):
            enrollment_qs = enrollment_qs.filter(user_id=user.id)
        elif hasattr(Enrollment, "student_id"):
            enrollment_qs = enrollment_qs.filter(student_id=user.id)
        else:
            # ì •ë§ íŠ¹ì´ ì¼€ì´ìŠ¤ë©´ ì—¬ê¸° ìˆ˜ì •
            enrollment_qs = enrollment_qs.filter(user=user)

        if lecture_id is not None:
            # Enrollmentì— lecture_id í•„ë“œê°€ ìˆëŠ” ê²½ìš° ìš°ì„  í•„í„°
            if hasattr(Enrollment, "lecture_id"):
                enrollment_qs = enrollment_qs.filter(lecture_id=int(lecture_id))

        enrollment = enrollment_qs.first()
        if not enrollment:
            return Response(
                {"detail": "enrollment not found for this user (and lecture)."},
                status=404,
            )

        enrollment_id = int(getattr(enrollment, "id"))

        # ------------------------------------------------------------
        # 2) Result ì¡°íšŒ (Result = ìµœì‹  ìŠ¤ëƒ…ìƒ·)
        # ------------------------------------------------------------
        result = Result.objects.filter(
            target_type="exam",
            target_id=int(exam_id),
            enrollment_id=enrollment_id,
        ).prefetch_related("items").first()

        if not result:
            # âœ… í•™ìƒ ê´€ì  UX:
            # - ì•„ì§ ì œì¶œ/ì±„ì  ì „ì´ë©´ 404ê°€ ë” ìì—°ìŠ¤ëŸ½ê±°ë‚˜,
            # - 200 + null í˜•íƒœë¡œ ì£¼ê¸°ë„ í•¨ (íŒ€ ì»¨ë²¤ì…˜ì— ë§ì¶° íƒ1)
            return Response(
                {"detail": "result not found (not submitted or not graded yet)."},
                status=404,
            )

        return Response(StudentExamResultSerializer(result).data)


==========================================================================================
# FILE: views/wrong_note_pdf_view.py
==========================================================================================
# apps/domains/results/views/wrong_note_pdf_view.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.results.models.wrong_note_pdf import WrongNotePDF
from apps.domains.results.tasks.wrong_note_pdf_task import generate_wrong_note_pdf_task


class WrongNotePDFCreateView(APIView):
    """
    ì˜¤ë‹µë…¸íŠ¸ PDF ìƒì„± ìš”ì²­
    """

    permission_classes = [IsAuthenticated]

    def post(self, request):
        enrollment_id = request.data.get("enrollment_id")
        lecture_id = request.data.get("lecture_id")
        exam_id = request.data.get("exam_id")
        from_order = request.data.get("from_session_order", 2)

        if not enrollment_id:
            return Response({"detail": "enrollment_id required"}, status=400)

        job = WrongNotePDF.objects.create(
            enrollment_id=enrollment_id,
            lecture_id=lecture_id,
            exam_id=exam_id,
            from_session_order=from_order,
        )

        generate_wrong_note_pdf_task.delay(job.id)

        return Response({
            "job_id": job.id,
            "status": job.status,
        })


==========================================================================================
# FILE: views/wrong_note_view.py
==========================================================================================
# apps/domains/results/views/wrong_note_view.py
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django.db.models import F

from apps.domains.results.models import ResultFact
from apps.domains.exams.models import Exam
from apps.domains.lectures.models import Session


class WrongNoteView(APIView):
    """
    ì˜¤ë‹µë…¸íŠ¸ ì¡°íšŒ API (v1)
    - ResultFact ê¸°ë°˜
    - append-only
    """

    permission_classes = [IsAuthenticated]

    def get(self, request):
        """
        Query Params
        - enrollment_id (required)
        - lecture_id (optional)
        - exam_id (optional)
        - from_session_order (optional, default=2)
        """

        enrollment_id = request.query_params.get("enrollment_id")
        if not enrollment_id:
            return Response(
                {"detail": "enrollment_id is required"},
                status=400,
            )

        lecture_id = request.query_params.get("lecture_id")
        exam_id = request.query_params.get("exam_id")
        from_order = int(request.query_params.get("from_session_order", 2))

        qs = ResultFact.objects.filter(
            enrollment_id=enrollment_id,
            is_correct=False,
            target_type="exam",
        )

        # -----------------------------
        # ì‹œí—˜ ê¸°ì¤€ í•„í„°
        # -----------------------------
        if exam_id:
            qs = qs.filter(target_id=exam_id)

        # -----------------------------
        # ê°•ì˜ / ì£¼ì°¨ ê¸°ì¤€ í•„í„°
        # -----------------------------
        if lecture_id:
            exam_ids = (
                Exam.objects
                .filter(
                    lecture_id=lecture_id,
                    session__order__gte=from_order,
                )
                .values_list("id", flat=True)
            )
            qs = qs.filter(target_id__in=exam_ids)

        qs = qs.select_related(None).order_by(
            "target_id",
            "question_id",
        )

        result = []

        for f in qs:
            result.append({
                "exam_id": f.target_id,
                "question_id": f.question_id,
                "answer": f.answer,
                "score": f.score,
                "max_score": f.max_score,
                "source": f.source,
                "meta": f.meta,
                "created_at": f.created_at,
            })

        return Response({
            "enrollment_id": int(enrollment_id),
            "count": len(result),
            "items": result,
        })
