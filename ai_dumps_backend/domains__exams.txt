====================================================================================================
# BACKEND APP: domains__exams
# ROOT PATH: C:\academy\apps\domains\exams
====================================================================================================


==========================================================================================
# FILE: __init__.py
==========================================================================================



==========================================================================================
# FILE: apps.py
==========================================================================================
from django.apps import AppConfig


class ExamsConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "apps.domains.exams"
    label = "exams"


==========================================================================================
# FILE: urls.py
==========================================================================================
# apps/domains/exams/urls.py

from django.urls import path, include
from rest_framework.routers import DefaultRouter

from .views.exam_view import ExamViewSet
from .views.sheet_view import SheetViewSet
from .views.question_view import QuestionViewSet
from .views.answer_key_view import AnswerKeyViewSet
from .views.question_auto_view import SheetAutoQuestionsView
from .views.exam_asset_view import ExamAssetView

# âœ… STEP 8-A ì¶”ê°€
from .views.exam_questions_by_exam_view import ExamQuestionsByExamView

router = DefaultRouter()

router.register(r"", ExamViewSet, basename="exam")
router.register(r"sheets", SheetViewSet)
router.register(r"questions", QuestionViewSet)
router.register(r"answer-keys", AnswerKeyViewSet)

urlpatterns = [
    path("", include(router.urls)),

    path(
        "sheets/<int:sheet_id>/auto-questions/",
        SheetAutoQuestionsView.as_view(),
        name="sheet-auto-questions",
    ),

    path(
        "<int:exam_id>/assets/",
        ExamAssetView.as_view(),
        name="exam-assets",
    ),

    # ==============================
    # âœ… STEP 8-A: exam ê¸°ì¤€ ë¬¸í•­ ì¡°íšŒ
    # ==============================
    path(
        "<int:exam_id>/questions/",
        ExamQuestionsByExamView.as_view(),
        name="exam-questions-by-exam",
    ),
]


==========================================================================================
# FILE: migrations/0001_initial.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 02:52

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = []

    operations = [
        migrations.CreateModel(
            name="Exam",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("title", models.CharField(max_length=255)),
                ("description", models.TextField(blank=True)),
                ("subject", models.CharField(max_length=100)),
                ("exam_type", models.CharField(default="regular", max_length=50)),
                ("is_active", models.BooleanField(default=True)),
            ],
            options={
                "db_table": "exams_exam",
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="AnswerKey",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("answers", models.JSONField()),
                (
                    "exam",
                    models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="answer_key",
                        to="exams.exam",
                    ),
                ),
            ],
            options={
                "db_table": "exams_answer_key",
            },
        ),
        migrations.CreateModel(
            name="Sheet",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("name", models.CharField(max_length=50)),
                ("total_questions", models.PositiveIntegerField(default=0)),
                (
                    "file",
                    models.FileField(blank=True, null=True, upload_to="exams/sheets/"),
                ),
                (
                    "exam",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="sheets",
                        to="exams.exam",
                    ),
                ),
            ],
            options={
                "db_table": "exams_sheet",
                "unique_together": {("exam", "name")},
            },
        ),
        migrations.CreateModel(
            name="ExamQuestion",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("number", models.PositiveIntegerField()),
                ("score", models.FloatField(default=1.0)),
                (
                    "image",
                    models.ImageField(
                        blank=True, null=True, upload_to="exams/questions/"
                    ),
                ),
                (
                    "sheet",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="questions",
                        to="exams.sheet",
                    ),
                ),
            ],
            options={
                "db_table": "exams_question",
                "ordering": ["number"],
                "unique_together": {("sheet", "number")},
            },
        ),
    ]


==========================================================================================
# FILE: migrations/0002_exam_policy_and_assets.py
==========================================================================================
# apps/domains/exams/migrations/0002_exam_policy_and_assets.py
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ("exams", "0001_initial"),
    ]

    operations = [
        # ==============================
        # âœ… Exam ì •ì±… í•„ë“œ ì¶”ê°€
        # ==============================
        migrations.AddField(
            model_name="exam",
            name="allow_retake",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="exam",
            name="max_attempts",
            field=models.PositiveIntegerField(default=1),
        ),
        migrations.AddField(
            model_name="exam",
            name="pass_score",
            field=models.FloatField(default=0.0),
        ),
        migrations.AddField(
            model_name="exam",
            name="open_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="exam",
            name="close_at",
            field=models.DateTimeField(blank=True, null=True),
        ),

        # ==============================
        # âœ… ExamAsset ì‹ ê·œ í…Œì´ë¸”
        # ==============================
        migrations.CreateModel(
            name="ExamAsset",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),

                ("asset_type", models.CharField(max_length=30)),
                ("file_key", models.CharField(max_length=512)),
                ("file_type", models.CharField(blank=True, max_length=50, null=True)),
                ("file_size", models.PositiveIntegerField(blank=True, null=True)),
                (
                    "exam",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="assets",
                        to="exams.exam",
                    ),
                ),
            ],
            options={
                "db_table": "exams_exam_asset",
            },
        ),
        migrations.AddIndex(
            model_name="examasset",
            index=models.Index(fields=["exam", "asset_type"], name="exams_examasset_exam_asset_type_idx"),
        ),
        migrations.AlterUniqueTogether(
            name="examasset",
            unique_together={("exam", "asset_type")},
        ),
    ]


==========================================================================================
# FILE: migrations/0003_rename_exams_examasset_exam_asset_type_idx_exams_exam__exam_id_1b856d_idx_and_more.py
==========================================================================================
# Generated by Django 5.2.9 on 2026-01-06 11:53

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ("exams", "0002_exam_policy_and_assets"),
    ]

    operations = [
        migrations.RenameIndex(
            model_name="examasset",
            new_name="exams_exam__exam_id_1b856d_idx",
            old_name="exams_examasset_exam_asset_type_idx",
        ),
        migrations.AddField(
            model_name="examquestion",
            name="region_meta",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="examasset",
            name="asset_type",
            field=models.CharField(
                choices=[("problem_pdf", "Problem PDF"), ("omr_sheet", "OMR Sheet")],
                max_length=30,
            ),
        ),
    ]


==========================================================================================
# FILE: migrations/__init__.py
==========================================================================================



==========================================================================================
# FILE: models/__init__.py
==========================================================================================
# apps/domains/exams/models/__init__.py
from .exam import Exam
from .sheet import Sheet
from .question import ExamQuestion
from .answer_key import AnswerKey
from .exam_asset import ExamAsset

__all__ = [
    "Exam",
    "Sheet",
    "ExamQuestion",
    "AnswerKey",
    "ExamAsset",
]


==========================================================================================
# FILE: models/answer_key.py
==========================================================================================
#apps/domains/exams/models/answer_key.py

from django.db import models
from apps.api.common.models import BaseModel
from .exam import Exam


class AnswerKey(BaseModel):
    """
    AnswerKey v2

    answers:
      {
        "123": "B",
        "124": "D"
      }
    key == ExamQuestion.id (string)
    """

    exam = models.OneToOneField(
        Exam,
        on_delete=models.CASCADE,
        related_name="answer_key",
    )

    answers = models.JSONField(
        help_text="key=ExamQuestion.id (string), value=correct answer"
    )

    class Meta:
        db_table = "exams_answer_key"

    def __str__(self):
        return f"AnswerKey v2 for {self.exam_id}"


==========================================================================================
# FILE: models/exam.py
==========================================================================================
# apps/domains/exams/models/exam.py
from django.db import models
from apps.api.common.models import BaseModel


class Exam(BaseModel):
    """
    ì‹œí—˜ ì •ì˜ (ë©”íƒ€ ì •ë³´ + ìš´ì˜ ì •ì±…)

    âœ… ë„ë©”ì¸ ì±…ì„(ë‹¨ì¼ ì§„ì‹¤):
    - exams: ì‹œí—˜ ë©”íƒ€ + ë°°í¬ìš© ìì‚°(ë¬¸ì œPDF/OMR) + ì¬ì‹œí—˜ ì •ì±…(allow/max/pass/open/close)
    - submissions: ì œì¶œ ì´ë²¤íŠ¸ ë‹¨ì¼ ì§„ì‹¤
    - results: attempt/ì±„ì /ëŒ€í‘œ attempt/ì¡°íšŒ API

    âš ï¸ ì£¼ì˜:
    - allow_retake=Falseë©´ max_attemptsëŠ” ì‚¬ì‹¤ìƒ 1ë¡œ ì·¨ê¸‰ë¨
      (ì •ì±… ê°•ì œëŠ” results.ExamAttemptServiceê°€ ìˆ˜í–‰)
    """

    title = models.CharField(max_length=255)
    description = models.TextField(blank=True)
    subject = models.CharField(max_length=100)

    # ì˜ˆ: ì¤‘ê°„ê³ ì‚¬, ëª¨ì˜ê³ ì‚¬, í´ë¦¬ë‹‰ í…ŒìŠ¤íŠ¸ ë“±
    exam_type = models.CharField(
        max_length=50,
        default="regular",
    )

    is_active = models.BooleanField(default=True)

    # =====================================================
    # âœ… STEP 1/3: ì¬ì‹œí—˜ ì •ì±…
    # =====================================================
    allow_retake = models.BooleanField(default=False)
    max_attempts = models.PositiveIntegerField(default=1)  # allow_retake=Falseë©´ 1ë¡œ ì·¨ê¸‰
    pass_score = models.FloatField(default=0.0)

    # =====================================================
    # âœ… ì‹œí—˜ ê³µê°œ/ë§ˆê°
    # =====================================================
    open_at = models.DateTimeField(null=True, blank=True)
    close_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        db_table = "exams_exam"
        ordering = ["-created_at"]

    def __str__(self):
        return self.title


==========================================================================================
# FILE: models/exam_asset.py
==========================================================================================
# apps/domains/exams/models/exam_asset.py
from __future__ import annotations

from django.db import models
from apps.api.common.models import BaseModel


class ExamAsset(BaseModel):
    """
    ì‹œí—˜ ë°°í¬ìš© íŒŒì¼ ìì‚° (R2 ê¸°ë°˜)

    âœ… ì±…ì„:
    - ë¬¸ì œ PDF / OMR ë‹µì•ˆì§€ ë“± "ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ íŒŒì¼"ë§Œ ê´€ë¦¬
    - ì—…ë¡œë“œ/ë‹¤ìš´ë¡œë“œ URLì€ serializerì—ì„œ presigned GETìœ¼ë¡œ ì œê³µ

    âš ï¸ ìš´ì˜ ê·œì¹™:
    - exam + asset_typeëŠ” 1ê°œë§Œ ìœ ì§€(update_or_create)
      â†’ teacherê°€ ìµœì‹  íŒŒì¼ë¡œ êµì²´í•´ë„ ì‹ë³„ì€ ë™ì¼
    """

    class AssetType(models.TextChoices):
        PROBLEM_PDF = "problem_pdf", "Problem PDF"
        OMR_SHEET = "omr_sheet", "OMR Sheet"

    exam = models.ForeignKey(
        "exams.Exam",
        on_delete=models.CASCADE,
        related_name="assets",
    )

    asset_type = models.CharField(
        max_length=30,
        choices=AssetType.choices,
    )

    # âœ… R2
    file_key = models.CharField(max_length=512)
    file_type = models.CharField(max_length=50, null=True, blank=True)
    file_size = models.PositiveIntegerField(null=True, blank=True)

    class Meta:
        db_table = "exams_exam_asset"
        unique_together = ("exam", "asset_type")
        indexes = [
            models.Index(fields=["exam", "asset_type"]),
        ]

    def __str__(self):
        return f"{self.exam_id}:{self.asset_type}"


==========================================================================================
# FILE: models/question.py
==========================================================================================
# apps/domains/exams/models/question.py
from django.db import models
from apps.api.common.models import BaseModel
from .sheet import Sheet


class ExamQuestion(BaseModel):
    """
    ì‹œí—˜ ë¬¸í•­ ì •ì˜

    ì„¤ê³„ ì›ì¹™:
    - ë¬¸í•­ì˜ 'ì˜ë¯¸'ëŠ” numberë¡œë§Œ ì‹ë³„
    - ì±„ì /ì •ë‹µ ì—¬ë¶€/ì ìˆ˜ ê³„ì‚° âŒ (results ë„ë©”ì¸ ì±…ì„)
    - ì´ ëª¨ë¸ì€ "ì‹œí—˜ì§€ ìœ„ì˜ ë¬¸í•­ ìœ„ì¹˜ + ì ìˆ˜ ë‹¨ìœ„"ë§Œ ê´€ë¦¬

    region_meta:
    - OMR / Vision Workerê°€ ì œê³µí•œ ë¬¸í•­ ì˜ì—­ ì •ë³´
    - ì˜ˆ: {"x": 12, "y": 34, "w": 120, "h": 45}
    - ì¬ì±„ì  / ì˜¤ë‹µë…¸íŠ¸ / ë¬¸í•­ í•˜ì´ë¼ì´íŠ¸ì— í•„ìˆ˜
    """

    sheet = models.ForeignKey(
        Sheet,
        on_delete=models.CASCADE,
        related_name="questions",
    )

    number = models.PositiveIntegerField()  # 1ë²ˆ, 2ë²ˆ ...
    score = models.FloatField(default=1.0)

    # ë¬¸í•­ ì´ë¯¸ì§€ (AIë¡œ ì˜ë¼ë‚¸ ê²°ê³¼ í¬í•¨ ê°€ëŠ¥)
    image = models.ImageField(
        upload_to="exams/questions/",
        null=True,
        blank=True,
    )

    # ğŸ”¥ STEP 2 í•„ìˆ˜: ë¬¸í•­ ì˜ì—­ ë©”íƒ€ (bbox)
    # worker segmentation ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ì €ì¥
    # í˜•ì‹ ì˜ˆ: {"x": 10, "y": 20, "w": 100, "h": 40}
    region_meta = models.JSONField(
        null=True,
        blank=True,
    )

    class Meta:
        db_table = "exams_question"
        unique_together = ("sheet", "number")
        ordering = ["number"]

    def __str__(self):
        return f"{self.sheet} Q{self.number}"


==========================================================================================
# FILE: models/sheet.py
==========================================================================================
# apps/domains/exams/models/sheet.py
from django.db import models
from apps.api.common.models import BaseModel
from .exam import Exam


class Sheet(BaseModel):
    """
    ì‹œí—˜ì§€ (Aí˜•, Bí˜• ë“±)
    """

    exam = models.ForeignKey(
        Exam,
        on_delete=models.CASCADE,
        related_name="sheets",
    )

    name = models.CharField(max_length=50)  # Aí˜•, Bí˜•

    # âœ… ìë™ ìƒì„± ì„œë¹„ìŠ¤ê°€ ë™ê¸°í™”í•˜ë¯€ë¡œ default=0ì´ ë§ìŒ
    total_questions = models.PositiveIntegerField(default=0)

    # ì‹œí—˜ì§€ ì›ë³¸ ì´ë¯¸ì§€ / PDF
    file = models.FileField(
        upload_to="exams/sheets/",
        null=True,
        blank=True,
    )

    class Meta:
        db_table = "exams_sheet"
        unique_together = ("exam", "name")

    def __str__(self):
        return f"{self.exam.title} - {self.name}"


==========================================================================================
# FILE: serializers/__init__.py
==========================================================================================



==========================================================================================
# FILE: serializers/answer_key.py
==========================================================================================
from rest_framework import serializers
from apps.domains.exams.models import AnswerKey

class AnswerKeySerializer(serializers.ModelSerializer):
    def validate_answers(self, value):
        if not isinstance(value, dict):
            raise serializers.ValidationError("answers must be an object")

        normalized = {}
        for k, v in value.items():
            normalized[str(k)] = str(v).strip()

        return normalized

    class Meta:
        model = AnswerKey
        fields = [
            "id",
            "exam",
            "answers",
            "created_at",
            "updated_at",
        ]


==========================================================================================
# FILE: serializers/exam.py
==========================================================================================
# apps/domains/exams/serializers/exam.py
from rest_framework import serializers
from apps.domains.exams.models import Exam


class ExamSerializer(serializers.ModelSerializer):
    """
    âœ… Exam ì¡°íšŒ/ìˆ˜ì • serializer

    í”„ë¡ íŠ¸ì—ì„œ:
    - allow_retake / max_attempts / pass_scoreë¡œ ì¬ì‹œí—˜ ì •ì±… í‘œì‹œ/í† ê¸€
    - open_at / close_atë¡œ ì‹œí—˜ ê³µê°œ/ë§ˆê° UX êµ¬í˜„
    """

    class Meta:
        model = Exam
        fields = [
            "id",
            "title",
            "description",
            "subject",
            "exam_type",
            "is_active",
            # âœ… STEP 1/3
            "allow_retake",
            "max_attempts",
            "pass_score",
            "open_at",
            "close_at",
            "created_at",
            "updated_at",
        ]


==========================================================================================
# FILE: serializers/exam_asset.py
==========================================================================================
# apps/domains/exams/serializers/exam_asset.py
from __future__ import annotations

from rest_framework import serializers

from apps.domains.exams.models import ExamAsset
from apps.infrastructure.storage.r2 import generate_presigned_get_url


class ExamAssetSerializer(serializers.ModelSerializer):
    """
    âœ… ExamAsset ì‘ë‹µ serializer

    download_url:
    - R2 presigned GET URL
    - expires_inì€ ì§§ê²Œ (ë³´í†µ 1ì‹œê°„) ê¶Œì¥
    """

    download_url = serializers.SerializerMethodField()

    class Meta:
        model = ExamAsset
        fields = [
            "id",
            "exam",
            "asset_type",
            "file_key",
            "file_type",
            "file_size",
            "download_url",
            "created_at",
            "updated_at",
        ]
        # ì—…ë¡œë“œëŠ” Viewì—ì„œ ì²˜ë¦¬í•˜ê³  DB í•„ë“œëŠ” ì„œë²„ê°€ í™•ì •í•˜ëŠ” ë°©ì‹(ì •ì„)
        read_only_fields = ["file_key", "file_type", "file_size", "download_url"]

    def get_download_url(self, obj: ExamAsset) -> str:
        return generate_presigned_get_url(key=obj.file_key, expires_in=60 * 60)


==========================================================================================
# FILE: serializers/question.py
==========================================================================================
from rest_framework import serializers
from apps.domains.exams.models import ExamQuestion


class QuestionSerializer(serializers.ModelSerializer):
    """
    ğŸ”§ PATCH:
    - ExamQuestion.region_meta(bbox)ê°€ ì´ë¯¸ ëª¨ë¸/ì„œë¹„ìŠ¤ì—ì„œ ì €ì¥ë˜ëŠ”ë°
      serializerì—ì„œ ëˆ„ë½ë˜ë©´ í”„ë¡ íŠ¸ì—ì„œ í•˜ì´ë¼ì´íŠ¸/ì˜¤ë‹µë…¸íŠ¸ ì˜ì—­í‘œì‹œ ë¶ˆê°€.
    """

    class Meta:
        model = ExamQuestion
        fields = [
            "id",
            "sheet",
            "number",
            "score",
            "image",
            "region_meta",  # âœ… ì¶”ê°€
            "created_at",
            "updated_at",
        ]


==========================================================================================
# FILE: serializers/question_auto.py
==========================================================================================
# apps/domains/exams/serializers/question_auto.py
from __future__ import annotations

from rest_framework import serializers


class QuestionAutoCreateSerializer(serializers.Serializer):
    """
    worker segmentation ê²°ê³¼ boxesë¥¼ ê·¸ëŒ€ë¡œ ë°›ëŠ”ë‹¤.
    boxes: [[x,y,w,h], ...]
    """
    boxes = serializers.ListField(
        child=serializers.ListField(
            child=serializers.IntegerField(),
            min_length=4,
            max_length=4,
        ),
        allow_empty=False,
    )

    def validate_boxes(self, v):
        # x,y,w,h ëª¨ë‘ 0 ì´ìƒ, w/hëŠ” 1 ì´ìƒ
        out = []
        for row in v:
            x, y, w, h = row
            if x < 0 or y < 0 or w <= 0 or h <= 0:
                raise serializers.ValidationError("Each box must be [x>=0, y>=0, w>0, h>0].")
            out.append([int(x), int(y), int(w), int(h)])
        return out


==========================================================================================
# FILE: serializers/sheet.py
==========================================================================================
from rest_framework import serializers
from apps.domains.exams.models import Sheet

class SheetSerializer(serializers.ModelSerializer):
    class Meta:
        model = Sheet
        fields = [
            "id",
            "exam",
            "name",
            "total_questions",
            "file",
            "created_at",
            "updated_at",
        ]


==========================================================================================
# FILE: services/__init__.py
==========================================================================================



==========================================================================================
# FILE: services/question_factory.py
==========================================================================================
# apps/domains/exams/services/question_factory.py
from __future__ import annotations

from typing import List, Tuple

from django.db import transaction

from apps.domains.exams.models import Sheet, ExamQuestion

BBox = Tuple[int, int, int, int]  # (x, y, w, h)


@transaction.atomic
def create_questions_from_boxes(*, sheet_id: int, boxes: List[BBox]) -> List[ExamQuestion]:
    """
    Segmentation ê²°ê³¼(boxes)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ExamQuestion ìë™ ìƒì„±.

    ì„¤ê³„ ì›ì¹™ (ì¤‘ìš”):
    - idempotent: (sheet, number) ê¸°ì¤€ update_or_create
    - boxes ê°œìˆ˜ ë³€í™” ì‹œ ê¸°ì¡´ ë¬¸ì œ ì‚­ì œ/ì¶”ê°€ ë™ê¸°í™”
    - number = ì‹œê°ì  ìˆœì„œ (1-based)
    - scoreëŠ” ì´ ë‹¨ê³„ì—ì„œ ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ (grading ì±…ì„)
    - bbox(region_meta)ëŠ” ë°˜ë“œì‹œ ì €ì¥ (STEP 2 í•„ìˆ˜)

    âš ï¸ ì£¼ì˜:
    - ì´ í•¨ìˆ˜ëŠ” 'ì‹œí—˜ì§€ êµ¬ì¡° ì •ì˜'ê¹Œì§€ë§Œ ì±…ì„ì§„ë‹¤.
    - ì±„ì  / ì •ë‹µ ë¹„êµ / ê²°ê³¼ ìƒì„±ì€ results ë„ë©”ì¸ ì±…ì„.
    """

    sheet = Sheet.objects.select_for_update().get(id=int(sheet_id))

    # -------------------------------------------------
    # 1ï¸âƒ£ total_questions ë™ê¸°í™”
    # -------------------------------------------------
    total = int(len(boxes or []))
    if sheet.total_questions != total:
        sheet.total_questions = total
        sheet.save(update_fields=["total_questions", "updated_at"])

    # -------------------------------------------------
    # 2ï¸âƒ£ ê¸°ì¡´ ë¬¸í•­ ì •ë¦¬ (boxes ê¸°ì¤€ ë™ê¸°í™”)
    # -------------------------------------------------
    existing_numbers = set(
        ExamQuestion.objects
        .filter(sheet=sheet)
        .values_list("number", flat=True)
    )
    new_numbers = set(range(1, total + 1))

    to_delete = existing_numbers - new_numbers
    if to_delete:
        ExamQuestion.objects.filter(
            sheet=sheet,
            number__in=to_delete,
        ).delete()

    # -------------------------------------------------
    # 3ï¸âƒ£ ìƒì„± / ê°±ì‹  (bbox í¬í•¨)
    # -------------------------------------------------
    created: List[ExamQuestion] = []

    for idx in range(1, total + 1):
        x, y, w, h = boxes[idx - 1]

        obj, _ = ExamQuestion.objects.update_or_create(
            sheet=sheet,
            number=idx,
            defaults={
                # ğŸ”¥ STEP 2 í•µì‹¬
                "region_meta": {
                    "x": int(x),
                    "y": int(y),
                    "w": int(w),
                    "h": int(h),
                },
            },
        )
        created.append(obj)

    return created


==========================================================================================
# FILE: views/__init__.py
==========================================================================================



==========================================================================================
# FILE: views/answer_key_view.py
==========================================================================================

from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import AnswerKey
from apps.domains.exams.serializers.answer_key import AnswerKeySerializer

class AnswerKeyViewSet(ModelViewSet):
    queryset = AnswerKey.objects.select_related("exam")
    serializer_class = AnswerKeySerializer
    permission_classes = [IsAuthenticated]


==========================================================================================
# FILE: views/exam_asset_view.py
==========================================================================================
# apps/domains/exams/views/exam_asset_view.py
from __future__ import annotations

import mimetypes
import uuid

from django.shortcuts import get_object_or_404

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import Exam, ExamAsset
from apps.domains.exams.serializers.exam_asset import ExamAssetSerializer
from apps.infrastructure.storage.r2 import upload_fileobj_to_r2

# - Teacher/Adminë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•˜ë„ë¡ ìœ ì§€
from apps.domains.results.permissions import IsTeacherOrAdmin


class ExamAssetView(APIView):
    """
    ì‹œí—˜ ë°°í¬ìš© íŒŒì¼ ì—…ë¡œë“œ/ëª©ë¡

    GET  /exams/<exam_id>/assets/
    POST /exams/<exam_id>/assets/   (multipart: file, asset_type)

    âœ… ì •ì±…:
    - asset_typeë³„ë¡œ 1ê°œë§Œ ìœ ì§€ (update_or_create)
    - ì—…ë¡œë“œëŠ” R2ë¡œ ë°”ë¡œ ì˜¬ë¦¬ê³  file_keyë¥¼ ì €ì¥
    - download_urlì€ serializerì—ì„œ presigned GETìœ¼ë¡œ ì œê³µ

    ğŸ‘ ê¶Œì¥ ê°œì„  (A)
    - ìš´ì˜ì—ì„œ í•™ìƒì´ ë¬¸ì œPDF/OMRì„ ë‹¤ìš´ë¡œë“œí•´ì•¼ í•˜ëŠ” ì¼€ì´ìŠ¤ê°€ ë§ë‹¤.
    - ë”°ë¼ì„œ ê¶Œí•œì„ ë©”ì„œë“œë³„ë¡œ ë¶„ë¦¬:
      - GET: ë¡œê·¸ì¸ ìœ ì €ë©´ í—ˆìš© (í•™ìƒ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥)
      - POST: Teacher/Adminë§Œ í—ˆìš©
    """

    def get_permissions(self):
        """
        âœ… ë©”ì„œë“œë³„ ê¶Œí•œ ë¶„ë¦¬ (ì •ì„)
        - GET: IsAuthenticated
        - POST: IsAuthenticated + IsTeacherOrAdmin
        """
        if self.request.method == "GET":
            return [IsAuthenticated()]
        return [IsAuthenticated(), IsTeacherOrAdmin()]

    def get(self, request, exam_id: int):
        exam = get_object_or_404(Exam, id=int(exam_id))
        qs = ExamAsset.objects.filter(exam=exam).order_by("asset_type")
        return Response(ExamAssetSerializer(qs, many=True).data)

    def post(self, request, exam_id: int):
        exam = get_object_or_404(Exam, id=int(exam_id))

        asset_type = request.data.get("asset_type")
        upload_file = request.FILES.get("file")

        if not asset_type or not upload_file:
            return Response({"detail": "asset_type and file are required"}, status=400)

        valid = {t for t, _ in ExamAsset.AssetType.choices}
        if asset_type not in valid:
            return Response(
                {"detail": f"asset_type must be one of {sorted(valid)}"},
                status=400,
            )

        name = upload_file.name or ""
        ext = name.split(".")[-1] if "." in name else "bin"

        key = f"exams/{exam.id}/assets/{asset_type}/{uuid.uuid4().hex}.{ext}"

        upload_fileobj_to_r2(
            fileobj=upload_file,
            key=key,
            content_type=upload_file.content_type,
        )

        obj, _ = ExamAsset.objects.update_or_create(
            exam=exam,
            asset_type=asset_type,
            defaults={
                "file_key": key,
                "file_type": upload_file.content_type
                or mimetypes.guess_type(upload_file.name)[0],
                "file_size": upload_file.size,
            },
        )

        return Response(ExamAssetSerializer(obj).data, status=201)


==========================================================================================
# FILE: views/exam_questions_by_exam_view.py
==========================================================================================
# apps/domains/exams/views/exam_questions_by_exam_view.py
from __future__ import annotations

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import ExamQuestion
from apps.domains.exams.serializers.question import QuestionSerializer


class ExamQuestionsByExamView(APIView):
    """
    GET /exams/<exam_id>/questions/

    âœ… ëª©ì 
    - exam ê¸°ì¤€ìœ¼ë¡œ ëª¨ë“  ExamQuestionì„ í•œ ë²ˆì— ì¡°íšŒ
    - ResultItem.question_id â†’ ExamQuestion ë§¤í•‘ìš©
    - ì˜¤ë‹µë…¸íŠ¸ / ë¬¸í•­í†µê³„ / bbox í•˜ì´ë¼ì´íŠ¸ì— í•„ìˆ˜

    ì„¤ê³„ í¬ì¸íŠ¸
    - QuestionViewSet(/exams/questions/)ëŠ” "ì „ì²´"ë¼ ë¹„íš¨ìœ¨
    - exam_id ê¸°ì¤€ í•„í„°ë§ëœ ì „ìš© APIê°€ ìš´ì˜/í”„ë¡ íŠ¸ ëª¨ë‘ì— ì•ˆì „
    """

    permission_classes = [IsAuthenticated]

    def get(self, request, exam_id: int):
        qs = (
            ExamQuestion.objects
            .filter(sheet__exam_id=int(exam_id))
            .select_related("sheet")
            .order_by("sheet_id", "number")
        )

        return Response(QuestionSerializer(qs, many=True).data)


==========================================================================================
# FILE: views/exam_view.py
==========================================================================================
# PATH: apps/domains/exams/views/exam_view.py

from __future__ import annotations

from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import Exam
from apps.domains.exams.serializers.exam import ExamSerializer


class ExamViewSet(ModelViewSet):
    """
    âœ… SaaS í‘œì¤€ Exam ì¡°íšŒ API

    ì§€ì›:
    - GET /exams/?session_id=123
    - GET /exams/?lecture_id=10

    ğŸ”§ ìš´ì˜ ì•ˆì •ì„± íŒ¨ì¹˜ (Critical)
    - ê¸°ì¡´ try/except ë°©ì‹ì€ Django ORMì˜ filter()ê°€ "í•„ë“œ ì—†ìŒ"ì„
      try/exceptë¡œ ì•ˆì •ì ìœ¼ë¡œ ì¡ì•„ì£¼ì§€ ì•ŠëŠ” ì¼€ì´ìŠ¤ê°€ ìˆì–´ ì‹¤ì œë¡œ ì•ˆì „í•˜ì§€ ì•Šë‹¤.
    - ë”°ë¼ì„œ Exam ëª¨ë¸ì˜ _meta.get_fields()ë¡œ ê´€ê³„ í•„ë“œëª…ì„ ë¨¼ì € ê²€ì‚¬ í›„,
      ì¡´ì¬í•˜ëŠ” relationìœ¼ë¡œë§Œ filterë¥¼ ê±´ë‹¤.
    - ë‘˜ ë‹¤ ì—†ìœ¼ë©´ qs.none()ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë¹ˆ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
    """

    queryset = Exam.objects.all()
    serializer_class = ExamSerializer
    permission_classes = [IsAuthenticated]

    @staticmethod
    def _has_relation(model, name: str) -> bool:
        """
        model._meta.get_fields() ê¸°ë°˜ìœ¼ë¡œ relation/field ì¡´ì¬ ì—¬ë¶€ ê²€ì‚¬.

        âœ… ì´ìœ :
        - ì˜ëª»ëœ related_nameì„ filterì— ë„£ìœ¼ë©´
          "ì˜ˆì™¸ê°€ ì•ˆ ë‚˜ê³  ì¡°ìš©íˆ ë¬´ì‹œ" ê°™ì€ ìƒí™©ì´ ì•„ë‹ˆë¼
          ëŸ°íƒ€ì„ì—ì„œ ë‹¤ë¥¸ í˜•íƒœë¡œ ê¹¨ì§ˆ ìˆ˜ ìˆì–´ ìš´ì˜ì— ìœ„í—˜.
        - í•„ë“œê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì •í•˜ê³  filter ì ìš©í•˜ëŠ” ê²Œ ì •ì„.
        """
        try:
            return any(getattr(f, "name", None) == name for f in model._meta.get_fields())
        except Exception:
            # _meta ì ‘ê·¼ ìì²´ê°€ ë¬¸ì œì¸ ê²½ìš°ëŠ” ê±°ì˜ ì—†ì§€ë§Œ,
            # ìš´ì˜ ì•ˆì „ì„±ì„ ìœ„í•´ False ì²˜ë¦¬
            return False

    def get_queryset(self):
        qs = super().get_queryset()

        session_id = self.request.query_params.get("session_id")
        if session_id:
            # session_idëŠ” ìˆ«ìì—¬ì•¼ í•¨
            sid = int(session_id)

            # âœ… ê´€ê³„ëª… ìš°ì„ ìˆœìœ„: projectsë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‚˜ ë³´í†µ sessionsê°€ ë” í”í•¨
            if self._has_relation(Exam, "sessions"):
                qs = qs.filter(sessions__id=sid)
            elif self._has_relation(Exam, "session"):
                qs = qs.filter(session__id=sid)
            else:
                # ê´€ê³„ê°€ ë¶ˆëª…í™•í•˜ë©´ ì•ˆì „í•˜ê²Œ ë¹ˆ ê²°ê³¼
                return qs.none()

        lecture_id = self.request.query_params.get("lecture_id")
        if lecture_id:
            lid = int(lecture_id)

            if self._has_relation(Exam, "sessions"):
                qs = qs.filter(sessions__lecture_id=lid)
            elif self._has_relation(Exam, "session"):
                qs = qs.filter(session__lecture_id=lid)
            else:
                return qs.none()

        return qs.distinct().order_by("-created_at")


==========================================================================================
# FILE: views/question_auto_view.py
==========================================================================================
# apps/domains/exams/views/question_auto_view.py
from __future__ import annotations

from django.shortcuts import get_object_or_404

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import Sheet
from apps.domains.exams.serializers.question import QuestionSerializer
from apps.domains.exams.serializers.question_auto import QuestionAutoCreateSerializer
from apps.domains.exams.services.question_factory import create_questions_from_boxes


class SheetAutoQuestionsView(APIView):
    """
    POST /exams/sheets/<sheet_id>/auto-questions/
    {
      "boxes": [[x,y,w,h], ...]
    }

    ë°˜í™˜: ìƒì„±/ì—…ë°ì´íŠ¸ëœ ExamQuestion ëª©ë¡
    """
    permission_classes = [IsAuthenticated]

    def post(self, request, sheet_id: int):
        # âœ… ì—†ìœ¼ë©´ 404 (ì •ìƒ)
        get_object_or_404(Sheet, id=int(sheet_id))

        s = QuestionAutoCreateSerializer(data=request.data)
        s.is_valid(raise_exception=True)

        boxes = [tuple(b) for b in s.validated_data["boxes"]]
        questions = create_questions_from_boxes(sheet_id=int(sheet_id), boxes=boxes)

        return Response(QuestionSerializer(questions, many=True).data)


==========================================================================================
# FILE: views/question_view.py
==========================================================================================
from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import ExamQuestion
from apps.domains.exams.serializers.question import QuestionSerializer

class QuestionViewSet(ModelViewSet):
    queryset = ExamQuestion.objects.select_related("sheet", "sheet__exam")
    serializer_class = QuestionSerializer
    permission_classes = [IsAuthenticated]


==========================================================================================
# FILE: views/sheet_view.py
==========================================================================================
from rest_framework.viewsets import ModelViewSet
from rest_framework.permissions import IsAuthenticated

from apps.domains.exams.models import Sheet
from apps.domains.exams.serializers.sheet import SheetSerializer

class SheetViewSet(ModelViewSet):
    queryset = Sheet.objects.select_related("exam")
    serializer_class = SheetSerializer
    permission_classes = [IsAuthenticated]
