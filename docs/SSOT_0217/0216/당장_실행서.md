# 당장 실행서 (500 배포 잔여 작업)

**전제**: API EC2 배포 완료, `/health` 200 확인됨.  
**목표**: Messaging·Video·AI 워커 이미지 빌드·푸시 → 각 워커 실행까지.

---

## 0. 합의된 정책 (500 — ASG 사용)

**결론 (워커 평소 대기)**

- **평소 대기**: AI 0, Video 0, **Messaging 항시 1** (그 이상으로 복제 가능).
- **일 들어오면**: ASG가 Video/AI 인스턴스 **자동 생성** → 워커가 일 처리. Messaging도 필요 시 **복제(스케일 아웃)**.
- **일 끝나면**: 큐 비면 ASG **scale-in**으로 인스턴스 **삭제(terminate)**. Messaging은 **최소 1대** 유지(Min=1).
- **평소**: Video 0, AI 0, Messaging 1.

| 항목 | 500 단계 | 실행서 |
|------|----------|--------|
| **Video Worker** | ASG Min=0. 큐 쌓이면 ASG가 EC2 생성 → 워커 실행. 큐 비면 scale-in으로 삭제. | ASG 배포 후 Launch Template User Data에서 워커 실행. [ASG_설계_확정.md](ASG_설계_확정.md) 참고. |
| **AI Worker CPU** | 동일. ASG로 생성 → 처리 → scale-in 삭제. | 동일. |
| **ASG** | **500에서 사용.** Video/AI 평소 0, 일 들어오면 생성 → 일하고 → 삭제. | `deploy_worker_asg.ps1` 또는 콘솔. SQS 메트릭 → Target Tracking. |
| **Messaging** | **복제 가능.** 다만 **항시 대기 1** (Min=1). 필요 시 스케일 아웃. | 500에서는 API EC2에 1대 띄우거나, Messaging ASG Min=1로 배포. |

- **Messaging**: Video/AI와 같이 복제(스케일) 구조. 항시 1대만 대기하는 것일 뿐.

---

## 1. 로컬 — 워커 이미지 3종 빌드 (PowerShell, C:\academy)

베이스가 이미 있으면 첫 줄 생략 가능.

```powershell
cd C:\academy
docker context use default
```

```powershell
docker build --platform linux/arm64 -f docker/Dockerfile.base -t academy-base:latest .
docker build --platform linux/arm64 -f docker/messaging-worker/Dockerfile -t academy-messaging-worker:latest .
docker build --platform linux/arm64 -f docker/video-worker/Dockerfile -t academy-video-worker:latest .
docker build --platform linux/arm64 -f docker/ai-worker-cpu/Dockerfile -t academy-ai-worker-cpu:latest .
```

---

## 2. 로컬 — ECR 로그인 + 레포 생성 + 푸시

```powershell
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
```

```powershell
aws ecr create-repository --repository-name academy-messaging-worker --region ap-northeast-2 2>$null
aws ecr create-repository --repository-name academy-video-worker --region ap-northeast-2 2>$null
aws ecr create-repository --repository-name academy-ai-worker-cpu --region ap-northeast-2 2>$null
```

```powershell
docker tag academy-messaging-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker tag academy-video-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker tag academy-ai-worker-cpu:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
```

---

## 3. API EC2 — Messaging Worker 실행 (같은 서버에 띄우기)

SSH 접속 후:

```bash
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker run -d --name academy-messaging-worker --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker update --restart unless-stopped academy-messaging-worker
docker ps
```

---

## 4. Video Worker — ASG 배포

Video 워커는 **ASG**로 기동. 평소 0, 큐 쌓이면 인스턴스 생성 → 처리 → scale-in 삭제.

- **ASG 설계·배포**: [ASG_설계_확정.md](ASG_설계_확정.md), `scripts/deploy_worker_asg.ps1` 참고.
- **Launch Template**: User Data에 **ECR 로그인**, **docker run 재시도**, **docker ps·로그 CloudWatch 전송** 반드시 포함. 상세는 ASG_설계_확정 §4.1.
- **SIGTERM·cooldown**: 워커 SIGTERM 처리 확인, scale-in cooldown·health check grace period는 ASG_설계_확정 §4.2·§5 참고.
- **아래는 수동 1회 테스트용** (ASG 없이 EC2 하나에서 확인할 때):

```bash
df -h   # /mnt/transcode 약 100G 확인
# .env 준비 후
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker run -d --name academy-video-worker --restart unless-stopped --memory 4g --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker -v /mnt/transcode:/tmp 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
```

---

## 5. AI Worker CPU — ASG 배포

AI 워커도 **ASG**로 기동. [ASG_설계_확정.md](ASG_설계_확정.md), `deploy_worker_asg.ps1` 참고.  
**수동 1회 테스트용**:

```bash
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker run -d --name academy-ai-worker-cpu --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker update --restart unless-stopped academy-ai-worker-cpu
```

---

## 6. API_BASE_URL 반영 (워커 → API 호출용)

API EC2 퍼블릭 IP 확정되면 로컬 `.env.admin97`에:

```
API_BASE_URL=http://<API-EC2-퍼블릭IP>:8000
```

저장 후:

```powershell
cd C:\academy
python scripts/prepare_deploy_env.py -o .env.deploy
```

`.env.deploy`를 Messaging/Video/AI 워커 쓰는 EC2에 다시 복사한 뒤, 해당 컨테이너만 재시작(선택).

---

## 7. 완료 체크

| 항목 | 확인 |
|------|:----:|
| API EC2 `/health` 200 | ☐ |
| Messaging Worker 컨테이너 실행 중 (API EC2) | ☐ |
| Video Worker ASG 배포·동작 (평소 0, 큐 시 생성→삭제) | ☐ |
| AI Worker ASG 배포·동작 (평소 0, 큐 시 생성→삭제) | ☐ |
| Launch Template User Data에 워커 실행 포함 | ☐ |

---

## 8. ASG 동작 확인 (필수 1회)

500에서는 ASG 사용. **한 번만** 확인:

1. Video 또는 AI 큐에 메시지 넣기 → ASG가 인스턴스 생성되는지 확인.
2. 메시지 처리 후 큐 비우기 → **scale-in으로 인스턴스가 terminate 되는지** AWS 콘솔에서 확인.

→ 평소 0, 일 들어오면 생성 → 일하고 → 삭제 되는지 검증.

---

## 9. (참고) ASG 설계

- **500**: ASG 사용. 평소 0, 일 들어오면 인스턴스 생성 → 처리 → scale-in 삭제. 이 실행서 + [ASG_설계_확정.md](ASG_설계_확정.md) 기준.
- **설계 상세**: Min=0, Max=20, SQS 메트릭 → Target Tracking. 설계.md §3, 30K_기준.md 참고.

---

문서 위치: `docs/0216/당장_실행서.md`
