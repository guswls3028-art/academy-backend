# 운영

배포는 [배포.md](배포.md), 아키텍처는 [설계.md](설계.md) 참고.

---

## 1. 배포 전 체크

- **Docker 순서**: academy-base → api → video-worker → ai-worker → messaging-worker. base 없으면 실패.
- **한 번에**: `.\docker\build.ps1` (Windows) / `./docker/build.sh` (Linux)
- **API 기동 전**: migrate, 필수 env(DB_*, R2_*, SQS, INTERNAL_WORKER_TOKEN), GET /health 200
- **워커**: `DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker`, API_BASE_URL·INTERNAL_WORKER_TOKEN
- **검증**: `python scripts/deployment_readiness_check.py --docker`

---

## 2. 엑셀 수강등록 흐름

- API: 파일 → R2 업로드 → SQS 등록 → 202 + job_id
- 프론트: `/api/v1/enrollments/excel_job_status/<job_id>/` 폴링 → DONE 시 결과
- 워커: SQS → R2 다운로드 → ExcelParsingService → lecture_enroll_from_excel_rows → R2 삭제

---

## 3. 학생 복구

- **삭제된 학생 중복**: `python manage.py check_deleted_student_duplicates --dry-run` / `--fix`
- **30일 지난 삭제 학생**: `python manage.py purge_deleted_students --dry-run` / 실행

---

## 4. R2 요약

| 항목 | 구현 |
|------|------|
| 엑셀 업로드 | 처리 후 워커에서 R2 객체 즉시 삭제 |
| 엑셀 내보내기 | 24h Lifecycle 또는 cron 정리 권장 |
| 영상 원본 | 30일 후 삭제/이관 권장 |
| HLS | 무한 유지 |

버킷: academy-ai, academy-video, academy-excel, academy-storage.

---

## 5. 비용 (월, USD)

| 규모 | 예상 |
|------|------|
| 500 DAU | ~$108–130 |
| 10k DAU | ~$420–670 |

---

## 6. 배포 후 할 일

- **오픈 전**: ALB, Target Group /health, ACM 443, 80→443. 8000은 테스트용만.
- **배포 전 필수**: Video/AI 워커 ASG 구동·테스트. [설계.md](설계.md) 참고.
- **운영**: CloudWatch 대시보드, DLQ·scale-in 1회 확인.
