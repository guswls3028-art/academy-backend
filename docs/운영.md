# 운영

배포는 [배포.md](배포.md), 아키텍처는 [설계.md](설계.md) 참고.

---

## 1. 배포 전 체크

- **Docker 순서**: academy-base → api → video-worker → ai-worker → messaging-worker. base 없으면 실패.
- **한 번에**: `.\docker\build.ps1` (Windows) / `./docker/build.sh` (Linux)
- **API 기동 전**: migrate, 필수 env(DB_*, R2_*, SQS, INTERNAL_WORKER_TOKEN), GET /health 200
- **워커**: `DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker`, API_BASE_URL·INTERNAL_WORKER_TOKEN
- **검증**: `python scripts/deployment_readiness_check.py --docker`

---

## 2. 엑셀 수강등록 흐름

- API: 파일 → R2 업로드 → SQS 등록 → 202 + job_id
- 프론트: `/api/v1/enrollments/excel_job_status/<job_id>/` 폴링 → DONE 시 결과
- 워커: SQS → R2 다운로드 → ExcelParsingService → lecture_enroll_from_excel_rows → R2 삭제

---

## 3. 학생 복구

- **삭제된 학생 중복**: `python manage.py check_deleted_student_duplicates --dry-run` / `--fix`
- **30일 지난 삭제 학생**: `python manage.py purge_deleted_students --dry-run` / 실행

---

## 4. R2 요약

| 항목 | 구현 |
|------|------|
| 엑셀 업로드 | 처리 후 워커에서 R2 객체 즉시 삭제 |
| 엑셀 내보내기 | 24h Lifecycle 또는 cron 정리 권장 |
| 영상 원본 | 30일 후 삭제/이관 권장 |
| HLS | 무한 유지 |

버킷: academy-ai, academy-video, academy-excel, academy-storage.

---

## 5. 비용 (월, USD)

| 규모 | 예상 |
|------|------|
| 500 DAU | ~$108–130 |
| 10k DAU | ~$420–670 |

---

## 6. 배포 후 할 일

- **오픈 전**: ALB, Target Group /health, ACM 443, 80→443. 8000은 테스트용만.
- **배포 전 필수**: Video/AI 워커 ASG 구동·테스트. [설계.md](설계.md) 참고.
- **운영**: CloudWatch 대시보드, DLQ·scale-in 1회 확인.

---

## 7. 비디오 인코딩이 진행되지 않을 때

워커 인스턴스는 떠 있는데 인코딩이 안 되거나, 워커가 더 안 늘어나는 경우 아래 순서로 확인.

### 7.1 SQS에 작업이 들어갔는지

```powershell
aws sqs get-queue-url --queue-name academy-video-jobs --region ap-northeast-2 --query "QueueUrl" --output text
# 위에서 나온 URL로:
aws sqs get-queue-attributes --queue-url "<QueueUrl>" --attribute-names ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible --region ap-northeast-2
```

- **Visible > 0**: 메시지는 있는데 워커가 안 가져가는 것 → 7.3(워커 로그/연결) 확인.
- **Visible=0, NotVisible=0**: 큐가 비어 있음 → **작업이 API에서 SQS로 안 들어간 상태** 가능성 큼.

### 7.2 작업이 API에서 SQS로 들어가야 하는 시점

- **업로드 완료 시**: `upload_complete` API가 `VideoSQSQueue().create_job_and_enqueue(video)` 호출. 실패 시 503 + "비디오 작업 큐 등록 실패(SQS)".
- **재처리 요청**: 관리자 화면에서 "재처리 요청" 시 `retry` API → `create_job_and_enqueue(video)` 호출.

**과거에 업로드만 하고 enqueue가 실패했거나, Job 도입 전에 올린 영상**은 DB에는 `업로드 완료(UPLOADED)`인데 SQS에는 없을 수 있음.  
→ 해당 영상에 대해 **"재처리 요청"** 한 번씩 하면 Job 생성 + SQS enqueue 됨.

### 7.3 Lambda BacklogCount(스케일 아웃) 확인

Video ASG는 **BacklogCount** 메트릭으로 스케일 아웃함. Lambda가 1분마다 **Django API** `/api/v1/internal/video/backlog-count/` 를 호출해 값을 퍼블리시해야 함.

- **Lambda 환경변수**: `VIDEO_BACKLOG_API_URL` 이 **설정되어 있어야** DB 기반 BacklogCount 사용. 비어 있으면 메트릭을 안 넣어서 스케일이 안 됨.
- Lambda 콘솔에서 `academy-worker-queue-depth-metric` 환경변수에 `VIDEO_BACKLOG_API_URL=https://api.hakwonplus.com` (실서비스 API 주소) 있는지 확인.
- CloudWatch → Logs → 해당 Lambda 로그에서 `BacklogCount metric published | backlog=N` 또는 `VIDEO_BACKLOG_API fetch failed` 여부 확인.

### 7.4 워커가 메시지를 받는지

- EC2(워커)에서 **SSM Session Manager** 또는 직접 접속 후, video-worker 컨테이너 로그: `docker logs $(docker ps -q -f name=video)` 등으로 `VIDEO-WORKER-SQS` 로그 확인.
- SQS 수신 실패·연결 오류가 있으면 로그에 남음. 워커의 **IAM 역할**에 `sqs:ReceiveMessage`, `sqs:DeleteMessage`, `sqs:GetQueueAttributes` 권한이 있어야 함.
- 워커의 **환경변수**: `VIDEO_SQS_QUEUE_NAME=academy-video-jobs`, API/DB/R2 등 필수 env가 SSM `/academy/workers/env` 와 일치하는지 확인.

### 7.5 한 번에 확인하는 요약 명령

```powershell
# 큐 깊이
$url = (aws sqs get-queue-url --queue-name academy-video-jobs --region ap-northeast-2 --query "QueueUrl" --output text)
aws sqs get-queue-attributes --queue-url $url --attribute-names ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible --region ap-northeast-2 --output table

# Video ASG 인스턴스 수
aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names academy-video-worker-asg --region ap-northeast-2 --query "AutoScalingGroups[0].{Desired:DesiredCapacity,Min:MinSize,Max:MaxCapacity}" --output table

# 최근 BacklogCount 메트릭 (Lambda가 퍼블리시한 값)
aws cloudwatch get-metric-statistics --namespace Academy/VideoProcessing --metric-name BacklogCount --dimensions Name=AutoScalingGroupName,Value=academy-video-worker-asg --start-time (Get-Date).AddMinutes(-30).ToString("yyyy-MM-ddTHH:mm:ssZ") --end-time (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ") --period 60 --statistics Average --region ap-northeast-2 --query "Datapoints | sort_by(@, &Timestamp) | [-5:]" --output table
```
