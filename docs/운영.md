# 운영

배포는 [배포.md](배포.md), 아키텍처는 [설계.md](설계.md) 참고.

---

## 1. 배포 전 체크

- **Docker 순서**: academy-base → api → video-worker → ai-worker → messaging-worker. base 없으면 실패.
- **한 번에**: `.\docker\build.ps1` (Windows) / `./docker/build.sh` (Linux)
- **API 기동 전**: migrate, 필수 env(DB_*, R2_*, SQS, INTERNAL_WORKER_TOKEN), GET /health 200
- **워커**: `DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker`, API_BASE_URL·INTERNAL_WORKER_TOKEN
- **검증**: `python scripts/deployment_readiness_check.py --docker`

---

## 2. 엑셀 수강등록 흐름

- API: 파일 → R2 업로드 → SQS 등록 → 202 + job_id
- 프론트: `/api/v1/enrollments/excel_job_status/<job_id>/` 폴링 → DONE 시 결과
- 워커: SQS → R2 다운로드 → ExcelParsingService → lecture_enroll_from_excel_rows → R2 삭제

---

## 3. 학생 복구

- **삭제된 학생 중복**: `python manage.py check_deleted_student_duplicates --dry-run` / `--fix`
- **30일 지난 삭제 학생**: `python manage.py purge_deleted_students --dry-run` / 실행

---

## 4. R2 요약

| 항목 | 구현 |
|------|------|
| 엑셀 업로드 | 처리 후 워커에서 R2 객체 즉시 삭제 |
| 엑셀 내보내기 | 24h Lifecycle 또는 cron 정리 권장 |
| 영상 원본 | 30일 후 삭제/이관 권장 |
| HLS | 무한 유지 |

버킷: academy-ai, academy-video, academy-excel, academy-storage.

---

## 5. 비용 (월, USD)

| 규모 | 예상 |
|------|------|
| 500 DAU | ~$108–130 |
| 10k DAU | ~$420–670 |

---

## 6. 배포 후 할 일

- **오픈 전**: ALB, Target Group /health, ACM 443, 80→443. 8000은 테스트용만.
- **배포 전 필수**: Video/AI 워커 ASG 구동·테스트. [설계.md](설계.md) 참고.
- **운영**: CloudWatch 대시보드, DLQ·scale-in 1회 확인.

---

## 7. 비디오 인코딩이 진행되지 않을 때

워커 인스턴스는 떠 있는데 인코딩이 안 되거나, 워커가 더 안 늘어나는 경우 아래 순서로 확인.

### 7.1 SQS에 작업이 들어갔는지

```powershell
aws sqs get-queue-url --queue-name academy-video-jobs --region ap-northeast-2 --query "QueueUrl" --output text
# 위에서 나온 URL로:
aws sqs get-queue-attributes --queue-url "<QueueUrl>" --attribute-names ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible --region ap-northeast-2
```

- **Visible > 0**: 메시지는 있는데 워커가 안 가져가는 것 → 7.3(워커 로그/연결) 확인.
- **Visible=0, NotVisible=0**: 큐가 비어 있음 → **작업이 API에서 SQS로 안 들어간 상태** 가능성 큼.

### 7.2 작업이 API에서 SQS로 들어가야 하는 시점

- **업로드 완료 시**: `upload_complete` API가 `VideoSQSQueue().create_job_and_enqueue(video)` 호출. 실패 시 503 + "비디오 작업 큐 등록 실패(SQS)".
- **재처리 요청**: 관리자 화면에서 "재처리 요청" 시 `retry` API → `create_job_and_enqueue(video)` 호출.

**과거에 업로드만 하고 enqueue가 실패했거나, Job 도입 전에 올린 영상**은 DB에는 `업로드 완료(UPLOADED)`인데 SQS에는 없을 수 있음.  
→ 해당 영상에 대해 **"재처리 요청"** 한 번씩 하면 Job 생성 + SQS enqueue 됨.

### 7.3 Lambda BacklogCount(스케일 아웃) 확인

Video ASG는 **BacklogCount** 메트릭으로 스케일 아웃함. Lambda가 1분마다 **Django API** `/api/v1/internal/video/backlog-count/` 를 호출해 값을 퍼블리시해야 함.

- **Lambda 환경변수**: `VIDEO_BACKLOG_API_URL` 이 **설정되어 있어야** DB 기반 BacklogCount 사용. 비어 있으면 메트릭을 안 넣어서 스케일이 안 됨.
- Lambda 콘솔에서 `academy-worker-queue-depth-metric` 환경변수에 `VIDEO_BACKLOG_API_URL=https://api.hakwonplus.com` (실서비스 API 주소) 있는지 확인.
- CloudWatch → Logs → 해당 Lambda 로그에서 `BacklogCount metric published | backlog=N` 또는 `VIDEO_BACKLOG_API fetch failed` 여부 확인.

### 7.4 워커가 메시지를 받는지

- EC2(워커)에서 **SSM Session Manager** 또는 직접 접속 후, video-worker 컨테이너 로그: `docker logs $(docker ps -q -f name=video)` 등으로 `VIDEO-WORKER-SQS` 로그 확인.
- SQS 수신 실패·연결 오류가 있으면 로그에 남음. 워커의 **IAM 역할**에 `sqs:ReceiveMessage`, `sqs:DeleteMessage`, `sqs:GetQueueAttributes` 권한이 있어야 함.
- 워커의 **환경변수**: `VIDEO_SQS_QUEUE_NAME=academy-video-jobs`, API/DB/R2 등 필수 env가 SSM `/academy/workers/env` 와 일치하는지 확인.

### 7.5 한 번에 확인하는 요약 명령

```powershell
# 큐 깊이
$url = (aws sqs get-queue-url --queue-name academy-video-jobs --region ap-northeast-2 --query "QueueUrl" --output text)
aws sqs get-queue-attributes --queue-url $url --attribute-names ApproximateNumberOfMessages ApproximateNumberOfMessagesNotVisible --region ap-northeast-2 --output table

# Video ASG 인스턴스 수
aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names academy-video-worker-asg --region ap-northeast-2 --query "AutoScalingGroups[0].{Desired:DesiredCapacity,Min:MinSize,Max:MaxCapacity}" --output table

# 최근 BacklogCount 메트릭 (Lambda가 퍼블리시한 값)
aws cloudwatch get-metric-statistics --namespace Academy/VideoProcessing --metric-name BacklogCount --dimensions Name=AutoScalingGroupName,Value=academy-video-worker-asg --start-time (Get-Date).AddMinutes(-30).ToString("yyyy-MM-ddTHH:mm:ssZ") --end-time (Get-Date).ToString("yyyy-MM-ddTHH:mm:ssZ") --period 60 --statistics Average --region ap-northeast-2 --query "Datapoints | sort_by(@, &Timestamp) | [-5:]" --output table
```

---

## 8. 업로드 완료 503 / "업로드 완료 처리 중 오류가 발생했습니다"

**원인 요약**: `upload/complete` 가 SQS에 메시지를 넣는 데 실패하면 503으로 응답함.  
Worker용 SSM(`/academy/workers/env`)만 갱신하고 **API 서버의 .env는 자동 갱신되지 않음**.

### 8.1 왜 발생하는가

- `.\scripts\redeploy_worker_asg.ps1` 또는 `deploy_worker_asg.ps1` 실행 시 **SSM `/academy/workers/env` 만 업데이트**됨.
- **API 서버(academy-api 컨테이너)** 는 SSM을 주기적으로 다시 읽지 않음.  
  → API는 **마지막 기동 시점의 .env** (또는 마지막으로 `sync_api_env` 실행 시 받은 값)만 사용.
- API도 `create_job_and_enqueue` → `sqs.send_message(...)` 를 호출하므로, **API 컨테이너 안에 AWS 자격 증명·리전·큐 이름**이 있어야 함.
- 이 중 하나라도 비어 있거나 이전 값이면 `send_message` 에서 boto3 예외 → `_upload_complete_impl` except → `VIDEO_UPLOAD_COMPLETE_ERROR` 로그 → 503 + "업로드 완료 처리 중 오류…".

필요한 env 예시:

- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` (또는 EC2 인스턴스 프로필)
- `AWS_DEFAULT_REGION` 또는 `AWS_REGION` (예: `ap-northeast-2`)
- `VIDEO_SQS_QUEUE_NAME` (없으면 기본값 `academy-video-jobs` 사용)

### 8.2 해결: API 쪽 .env 동기화

SSM을 올린 뒤 **API 서버에 반영**하려면 (로컬 PowerShell에서):

```powershell
.\scripts\sync_api_env_lambda_internal.ps1
```

- 로컬 .env → SSM `/academy/workers/env` 업로드  
- API EC2에서 **병합**: `scripts/merge_ssm_into_env.sh` 로 SSM 내용과 기존 .env 병합 → **기존 .env에만 있던 변수(R2, VIDEO_BUCKET 등) 유지**  
- 그 다음 `refresh_api_container_env.sh` 로 컨테이너 재생성  

**주의**: 예전에는 `get-parameter ... > .env` 로 통째로 덮어써서, SSM에 없는 R2 등이 날아드는 문제가 있었다. 지금은 병합 스크립트를 쓰므로 덮어쓰지 않는다.

#### 8.2.1 .env 수정 후 컨테이너 재생성 (필수)

`docker restart` 는 컨테이너를 그대로 둔 채 재시작만 하므로, **생성 시점에 읽은 .env만** 사용한다. .env를 수정·추가한 뒤에는 **컨테이너를 지우고 다시 만들어야** 새 env가 반영된다.

**API 서버(ec2-user)에서 한 번에 실행 (복붙):**

```bash
IMG=$(docker inspect academy-api --format '{{.Config.Image}}' 2>/dev/null); [ -z "$IMG" ] && IMG=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep academy-api | head -1); docker stop academy-api 2>/dev/null; docker rm academy-api 2>/dev/null; docker run -d --name academy-api --restart unless-stopped --env-file /home/ec2-user/.env -p 8000:8000 "$IMG"
```

또는 repo 있으면: `bash /home/ec2-user/academy/scripts/refresh_api_container_env.sh`

즉, **Worker만 재배포했다면 이 스크립트 한 번 더 실행**해서 API env를 SSM 기준으로 맞추고 재시작해야 함.

### 8.3 1분 컷: API 컨테이너 안에서 SQS 확인

API 서버(EC2)에 SSH 후:

```bash
sudo docker exec -it academy-api bash
```

컨테이너 안에서:

```bash
python - << 'PY'
import os
import boto3
region = os.getenv("AWS_DEFAULT_REGION") or os.getenv("AWS_REGION", "ap-northeast-2")
queue_name = os.getenv("VIDEO_SQS_QUEUE_NAME", "academy-video-jobs")
print("REGION:", region)
print("QUEUE_NAME:", queue_name)
sqs = boto3.client("sqs", region_name=region)
url = sqs.get_queue_url(QueueName=queue_name)["QueueUrl"]
print("QueueUrl:", url)
print(sqs.get_queue_attributes(QueueUrl=url, AttributeNames=["QueueArn"]))
PY
```

**해석**

- 여기서 예외 나면 → upload_complete 503 원인으로 **SQS/자격증명 문제 확정** 가능.
- `InvalidClientTokenId` / `SignatureDoesNotMatch` → 자격 증명(키/시크릿) 확인.
- `NonExistentQueue` → 큐 이름/리전 확인.
- `Could not connect to the endpoint URL` → 네트워크/리전/엔드포인트 확인.
- `QueueUrl is None` / `KeyError` → env에서 `VIDEO_SQS_QUEUE_NAME` 또는 리전이 비어 있을 수 있음.

### 8.4 Lambda timeout과의 관계

- Backlog는 Redis 기반으로 바뀌었지만, **enqueue가 실패하면** Redis INCR이 안 되고, API도 503을 반환.
- Lambda는 backlog API를 호출해 메트릭을 퍼블리시하는데, API가 503/타임아웃이면 메트릭이 안 들어갈 수 있음.
- 따라서 **업로드 503 원인(SQS/env)** 을 해결하면, Lambda timeout/스케일 문제도 같이 해소될 가능성이 큼.
