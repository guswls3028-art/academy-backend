# 500 배포 진행도우미 (복붙용)

**용도**: 한 단계씩 복붙해서 실행. 가이드 상세는 `AWS_500_START_DEPLOY_GUIDE.md` 참고.

---

## Step 0. 터미널 준비

```powershell
cd C:\academy
```

---

## Step 1. .env.admin97 로드 (환경변수 쓸 때마다 세션에서 1회)

```powershell
Get-Content .env.admin97 | ForEach-Object { if ($_ -match '^([^#=]+)=(.*)$') { [Environment]::SetEnvironmentVariable($matches[1].Trim(), $matches[2].Trim(), 'Process') } }
```

---

## Step 2. Docker 이미지 빌드 (순서대로)

```powershell
docker buildx build --platform linux/arm64 -f docker/Dockerfile.base -t academy-base:latest --load .
```

```powershell
docker buildx build --platform linux/arm64 -f docker/api/Dockerfile -t academy-api:latest --load .
```

```powershell
docker buildx build --platform linux/arm64 -f docker/messaging-worker/Dockerfile -t academy-messaging-worker:latest --load .
```

```powershell
docker buildx build --platform linux/arm64 -f docker/video-worker/Dockerfile -t academy-video-worker:latest --load .
```

```powershell
docker buildx build --platform linux/arm64 -f docker/ai-worker-cpu/Dockerfile -t academy-ai-worker-cpu:latest --load .
```

---

## Step 3. ECR 로그인 + 이미지 태그 + 푸시

```powershell
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
```

```powershell
docker tag academy-api:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker tag academy-messaging-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker tag academy-video-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker tag academy-ai-worker-cpu:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
```

```powershell
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
```

---

## Step 4. 배포용 .env 생성 (EC2에 넣을 파일)

```powershell
python scripts/prepare_deploy_env.py -o .env.deploy
```

→ `.env.deploy` 생성됨. EC2에 scp/copy 후 `mv .env.deploy .env` 로 사용.

---

## Step 5. AWS 콘솔 작업 (복붙 아님)

| 순서 | 할 일 | 위치 |
|:----:|-------|------|
| 5.1 | 리전 ap-northeast-2 선택 | 우상단 |
| 5.2 | RDS 생성: academy-db, db.t4g.micro, 20GB, 퍼블릭 아니오 | RDS |
| 5.3 | IAM 역할: EC2용 SQS·ECR·Self-stop | IAM |
| 5.4 | 보안 그룹: API(8000,22), Worker(22), RDS(5432 from API·Worker) | EC2 |

---

## Step 6. EC2 API 서버 (SSH 접속 후)

```bash
# Docker 설치 (없으면)
sudo yum install -y docker && sudo systemctl start docker && sudo systemctl enable docker
sudo usermod -aG docker ec2-user
# 로그아웃 후 재접속
```

```bash
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
```

```bash
# .env.deploy를 scp로 가져온 뒤
docker run -d --name academy-api --restart unless-stopped --env-file .env -p 8000:8000 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker exec academy-api python manage.py migrate
curl http://localhost:8000/health
```

---

## Step 7. EC2 Messaging Worker (SSH 접속 후)

```bash
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker run -d --name academy-messaging-worker --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
```

---

## Step 8. EC2 Video Worker (SSH 접속 후, 100GB EBS 마운트 확인)

```bash
df -h
# /mnt/transcode 약 100G 확인 후 진행
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker run -d --name academy-video-worker --restart unless-stopped --memory 4g --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker -e EC2_IDLE_STOP_THRESHOLD=5 -v /mnt/transcode:/tmp 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
```

---

## Step 9. (선택) EC2 AI Worker CPU

```bash
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker run -d --name academy-ai-worker-cpu --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker -e EC2_IDLE_STOP_THRESHOLD=5 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
```

---

## API_BASE_URL 업데이트

API EC2 퍼블릭 IP 확정 후 `.env.admin97` 에서 수정:

```
API_BASE_URL=http://<API-EC2-퍼블릭IP>:8000
```

그 다음 `.env.deploy` 다시 생성 후 EC2에 복사:

```powershell
python scripts/prepare_deploy_env.py -o .env.deploy
```
