# 설계 (인프라·워커)

---

## 1. 구성도

```
Internet → Cloudflare CDN
              ├── Frontend (Static)
              └── API (Django/Gunicorn)
                    ├── RDS PostgreSQL
                    ├── R2 (academy-ai, academy-video, academy-excel, academy-storage)
                    └── SQS
                          ├── academy-video-jobs      → Video Worker
                          ├── academy-ai-jobs-*       → AI Worker CPU
                          └── academy-messaging-jobs  → Messaging Worker
```

---

## 2. 설정·코드

| 용도 | 경로 |
|------|------|
| API | `apps/api/config/settings/base.py`, `prod.py` |
| Worker | `apps/api/config/settings/worker.py` |
| SQS 생성 | `scripts/create_sqs_resources.py`, `create_ai_sqs_resources.py` (리전 ap-northeast-2) |

---

## 3. 워커 ASG (권장)

- **구조**: SQS → CloudWatch 메트릭 → **ASG Target Tracking** → EC2. Min=**0**, Max=**20**. scale-in 시 ASG가 terminate.
- **메트릭**: `ApproximateNumberOfMessagesVisible`, 타깃 인스턴스당 15~25 메시지.
- **원칙**: 평시 0대, 일 들어오면 증설, 끝나면 사라짐.
- **구현**: `scripts/deploy_worker_asg.ps1` (SubnetIds, SecurityGroupId, IamInstanceProfileName). SSM `/academy/workers/env`에 .env.

---

## 4. 비용 (3~4 TB 가정, 월)

| 구분 | 낮음 | 높음 |
|------|------|------|
| EC2 Video 워커 | $5 | $20 |
| EBS | $3 | $8 |
| R2 저장 3~4 TB | 약 $45 | 약 $60 |
| **합계** | **약 $53** | **약 $93** |

R2 + Cloudflare CDN → egress GB 과금 없음. 시청 증가 = R2 Class B 요청만.

---

## 5. R2·SQS 요약

- **R2 버킷**: R2_AI_BUCKET, R2_VIDEO_BUCKET, R2_EXCEL_BUCKET, R2_STORAGE_BUCKET (base.py)
- **SQS**: academy-video-jobs, academy-ai-jobs-lite/basic/premium, academy-messaging-jobs + 각 DLQ
- **워커 진입**: video_worker/sqs_main.py, messaging_worker/sqs_main.py, ai_worker/sqs_main_cpu.py
