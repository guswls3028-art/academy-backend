# 배포 한 방 참고 (재배포 · 확인)

**주의**: 액세스 키는 이 문서나 저장소에 **실제 값을 넣지 말 것**. 로컬 터미널에서만 설정하거나, `.env.local` 등 gitignore 된 파일에 두고 사용.

---

## 1. AWS 액세스 키 설정 (로컬에서만)

### 루트 (배포/인프라 작업 시)

```powershell
$env:AWS_ACCESS_KEY_ID = "루트_액세스_키_ID"
$env:AWS_SECRET_ACCESS_KEY = "루트_시크릿_키"
$env:AWS_DEFAULT_REGION = "ap-northeast-2"
```

### admin97 (평소 작업 시, 루트 키 해제 후)

```powershell
Remove-Item Env:AWS_ACCESS_KEY_ID, Env:AWS_SECRET_ACCESS_KEY -ErrorAction SilentlyContinue
$env:AWS_ACCESS_KEY_ID = "admin97_액세스_키_ID"
$env:AWS_SECRET_ACCESS_KEY = "admin97_시크릿_키"
$env:AWS_DEFAULT_REGION = "ap-northeast-2"
```

---

## 2. 재배포 명령어

**빌드 미포함** (이미 ECR에 이미지 있을 때):

```powershell
cd C:\academy
.\scripts\full_redeploy.ps1 -SkipBuild
```

**빌드 포함** (빌드 인스턴스 띄워서 빌드 → 푸시 → 종료 후 API/워커 배포):

```powershell
cd C:\academy
.\scripts\full_redeploy.ps1 -GitRepoUrl "https://github.com/guswls3028-art/academy.git"
```

---

## 3. 배포 확인 명령어

```powershell
$region = "ap-northeast-2"
Write-Host "`n=== Worker deploy final check ===`n" -ForegroundColor Cyan
Write-Host "[1] Lambda" -ForegroundColor White
$lambda = aws lambda get-function --function-name academy-worker-queue-depth-metric --region $region --query "Configuration.FunctionName" --output text 2>$null
if ($lambda) { Write-Host "  OK" -ForegroundColor Green } else { Write-Host "  Missing" -ForegroundColor Red }
Write-Host "`n[2] Launch Template" -ForegroundColor White
$lt = aws ec2 describe-launch-templates --launch-template-names academy-ai-worker-asg academy-video-worker-asg academy-messaging-worker-asg --region $region 2>$null
if ($lt -match "LaunchTemplateName") { Write-Host "  OK" -ForegroundColor Green } else { Write-Host "  Missing" -ForegroundColor Red }
Write-Host "`n[3] ASG" -ForegroundColor White
$asg = aws autoscaling describe-auto-scaling-groups --region $region --output json 2>$null | ConvertFrom-Json
if ($asg.AutoScalingGroups.Count -gt 0) { $asg.AutoScalingGroups | ForEach-Object { Write-Host "  $($_.AutoScalingGroupName) Desired=$($_.DesiredCapacity) Min=$($_.MinSize) Max=$($_.MaxSize)" -ForegroundColor Green } } else { Write-Host "  (0 - check console)" -ForegroundColor Yellow }
Write-Host "`n[4] ECR" -ForegroundColor White
@("academy-messaging-worker","academy-video-worker","academy-ai-worker-cpu") | ForEach-Object { $t = aws ecr list-images --repository-name $_ --region $region --query "imageIds[*].imageTag" --output text 2>$null; if ($t -match "latest") { Write-Host "  $_`:latest OK" -ForegroundColor Green } else { Write-Host "  $_ -" -ForegroundColor Yellow } }
Write-Host "`n[5] SSM" -ForegroundColor White
$ssm = aws ssm get-parameter --name /academy/workers/env --region $region --query "Parameter.Name" --output text 2>$null
if ($ssm) { Write-Host "  OK" -ForegroundColor Green } else { Write-Host "  Missing" -ForegroundColor Red }
Write-Host "`n[6] API SG <- Worker" -ForegroundColor White
$ing = aws ec2 describe-security-groups --group-ids sg-0051cc8f79c04b058 --region $region --query "SecurityGroups[0].IpPermissions" --output json 2>$null
if ($ing -match "sg-02692600fbf8e26f7") { Write-Host "  OK" -ForegroundColor Green } else { Write-Host "  Check" -ForegroundColor Yellow }
Write-Host "`n=== Done ===`n" -ForegroundColor Cyan
```

---

## 4. 워커 ASG만 재배포 (인프라 갱신)

API/고정 EC2 배포 없이, Lambda·Launch Template·ASG·SSM 설정만 갱신할 때:

```powershell
cd C:\academy
.\scripts\redeploy_worker_asg.ps1
```

---

## 5. API 서버 고정 IP (Elastic IP)

인스턴스 껐다 켜도 퍼블릭 IP가 바뀌지 않게 하려면 Elastic IP 한 번 붙여 두기. (Tunnel은 사용 안 함.)

**최초 1회** (academy-api 인스턴스 ID 확인 후):

```powershell
$region = "ap-northeast-2"
$instanceId = "i-0c8ae616abf345fd1"   # 필요 시 describe-instances로 확인

$alloc = aws ec2 allocate-address --domain vpc --region $region --output json | ConvertFrom-Json
Write-Host "Elastic IP: $($alloc.PublicIp)  AllocationId: $($alloc.AllocationId)"
aws ec2 associate-address --instance-id $instanceId --allocation-id $alloc.AllocationId --region $region
Write-Host "`nCloudflare DNS: api.hakwonplus.com A 레코드 -> $($alloc.PublicIp)"
```

- Cloudflare에서 **api** A 레코드를 위에 나온 `PublicIp` 로 설정/수정.
- 나중에 **인스턴스를 새로 만들면** 같은 EIP를 새 인스턴스에 `associate-address` 로 붙이거나, 새 EIP 쓰고 DNS만 그 IP로 갱신하면 됨.
