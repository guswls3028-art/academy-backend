# 500 배포

**리전**: ap-northeast-2 (서울)  
**원칙**: Video Worker **4GB RAM + 100GB EBS** 필수. 8000 포트는 테스트용만 → 오픈 전 ALB+HTTPS.  
**워커**: ASG Target Tracking — 평소 0대, 큐 쌓이면 증설(Min=0, Max=20). [설계.md](설계.md) 참고.

---

## 1. 순서

| # | 할 일 |
|---|--------|
| 1 | 리전 서울 |
| 2 | RDS academy-db (db.t4g.micro, 20GB, 퍼블릭 아니오) → .env `DB_HOST` |
| 3 | SQS `create_sqs_resources.py` → `create_ai_sqs_resources.py` |
| 4 | IAM EC2용 (SQS·ECR·Self-stop) |
| 5 | 보안 그룹 API(8000,22), Worker(22), RDS(5432 from API·Worker) |
| 6 | EC2 API t4g.small 30GB → Docker, ECR pull, .env, migrate, `/health` |
| 7 | EC2 Messaging t4g.micro 상시 |
| 8 | EC2 Video t4g.medium 4GB+100GB → `df -h`로 `/mnt/transcode` 확인 후 컨테이너 |
| 9 | Video·AI 워커 ASG(Min=0) 또는 수동 EC2 |

---

## 2. 로컬 (복붙)

```powershell
cd C:\academy
docker buildx build --platform linux/arm64 -f docker/Dockerfile.base -t academy-base:latest --load .
docker buildx build --platform linux/arm64 -f docker/api/Dockerfile -t academy-api:latest --load .
docker buildx build --platform linux/arm64 -f docker/messaging-worker/Dockerfile -t academy-messaging-worker:latest --load .
docker buildx build --platform linux/arm64 -f docker/video-worker/Dockerfile -t academy-video-worker:latest --load .
docker buildx build --platform linux/arm64 -f docker/ai-worker-cpu/Dockerfile -t academy-ai-worker-cpu:latest --load .
```

```powershell
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
docker tag academy-api:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker tag academy-messaging-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker tag academy-video-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker tag academy-ai-worker-cpu:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
```

```powershell
python scripts/prepare_deploy_env.py -o .env.deploy
# .env.deploy → EC2에 scp 후 .env
```

---

## 3. EC2 API (SSH 후)

```bash
sudo yum install -y docker && sudo systemctl start docker && sudo systemctl enable docker
sudo usermod -aG docker ec2-user
# 로그아웃 후 재접속
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker run -d --name academy-api --restart unless-stopped --env-file .env -p 8000:8000 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-api:latest
docker exec academy-api python manage.py migrate --no-input
curl http://localhost:8000/health
docker update --restart unless-stopped academy-api
```

---

## 4. EC2 Messaging

```bash
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker run -d --name academy-messaging-worker --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker update --restart unless-stopped academy-messaging-worker
```

---

## 5. EC2 Video (100GB 확인 후)

```bash
df -h   # /mnt/transcode 약 100G 확인
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker run -d --name academy-video-worker --restart unless-stopped --memory 4g --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker -e EC2_IDLE_STOP_THRESHOLD=5 -v /mnt/transcode:/tmp 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker update --restart unless-stopped academy-video-worker
```

---

## 6. EC2 AI (선택)

```bash
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker run -d --name academy-ai-worker-cpu --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker -e EC2_IDLE_STOP_THRESHOLD=5 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker update --restart unless-stopped academy-ai-worker-cpu
```

---

## 7. 배포 전 필수 6개

1. 워커 ASG 구동·테스트 (`scripts/deploy_worker_asg.ps1`, [설계.md](설계.md))
2. RDS 퍼블릭 아니오
3. Video EC2 `df -h` → /mnt/transcode 약 100G
4. CloudWatch 로그 7~14일
5. ASG scale-in 1회 확인
6. 8000 포트 테스트용만, 오픈 전 ALB+HTTPS

---

## 8. 오픈 전 4개

- ALB + Target Group `/health` + ACM 443 + 80→443
- RDS max_connections 모니터링
- ASG scale-in 1회 확인
- Video EC2 `free -h` Swap 확인

---

## 9. 스펙·비용

| 역할 | 인스턴스 |
|------|----------|
| API | t4g.small 30GB |
| RDS | db.t4g.micro 20GB |
| Messaging | t4g.micro 상시 |
| Video·AI | ASG Min=0 Max=20 |

**예상 월**: 9~15만 원.
