# 10K 기준 (목표·실행 계획)

**목표**: 1만 명 규모까지 확장 시 준수할 설계·SLO·실행 기준.

---

## 1. 전제

- **500 배포**: [배포.md](배포.md) 완료 상태. DB 커넥션·Video 100GB·CloudWatch 7~14일 등 점검 완료.
- **DB 커넥션**: steady state 7일 관측 후 `max_connections × 0.8` 이내. 500명 기준 "20~40 동시 접속" 가정.
- **AI 큐**: Academy Worker 기준 Visibility **3600초**, Lease **3540초** 고정.

---

## 2. Big Bang 진입 조건 (사용자 0·배포 직전 기준)

아래 **5가지 점검** 후 Big Bang 진행.

| # | 조건 | 점검 방법 |
|---|------|-----------|
| 1 | Tier Enforcer Pre-Phase | payload 검증·enforcer optional 반영. TypeError 0. |
| 2 | AI 60분 상한 준수 | inference 60분 초과 시 fail_ai_job + SQS delete + extender stop. |
| 3 | Lease 고정 1차 정리 | 코드·문서 정리. Lease 3540초. |
| 4 | Legacy 경로 최종 정리 | `USE_LEGACY_AI_WORKER` 최종 제거 또는 배포 스위치만 유지. |
| 5 | Video visibility 정리 | 10K 목표 시 extender 도입. 500 배포만 쓰면 extend 1회 등 최소. |

---

## 3. Big Bang 검증 7단계 (순서·배포)

| # | 단계 | 점검 방법 |
|---|------|-----------|
| 1 | DB Drop | (필요 시 키 보관) 초기화·재실행 |
| 2 | migrate | `python manage.py migrate` 성공 |
| 3 | AI 1건 | AI Job 1건 생성 → SQS → Worker 처리 → DONE 확인 |
| 4 | Video 1건 | Video Job 1건 → Worker 처리 → 완료 확인 |
| 5 | Messaging 1건 | Messaging 1건 발송/처리 확인 |
| 6 | Worker kill 시나리오 1회 | 처리 중 Worker 강제 종료 → 재시도·멱등 동작 확인 |
| 7 | DLQ 시나리오 1회 | (선택) 의도 실패 1건 → DLQ 전달 확인 |

**위 7단계 통과 시 배포.**

---

## 4. Big Bang 최종 점검 10개 (YES면 GO)

| # | 항목 | 점검 방식 |
|---|------|-----------|
| 1 | Tier Enforcer | 호출 후 확인, Worker 1건 처리. payload 검증. TypeError 0. |
| 2 | AI 60분 상한 | 코드·로직. INFERENCE_MAX_SECONDS=3600. 초과 시 fail + delete + extender.stop(). |
| 3 | Lease 고정 | 코드·env. LEASE_SECONDS=3540, visibility=3600. |
| 4 | Legacy 현재 제거 | `grep -r "USE_LEGACY_AI_WORKER"` → 0건 |
| 5 | Worker 기준 시간 제한 호출 없음 | mark_processing/complete_job/fail_job 제한 호출 0건. |
| 6 | domain/application에서 django import 없음 | grep → 0건 |
| 7 | adapters 이외 ORM 직접 없음 | .objects. 직접 → adapters 이외 0건 |
| 8 | DB unique 설정 | AIJobModel.job_id unique. AIResultModel OneToOne. |
| 9 | Visibility 고정 일치 | AI queue visibility 3600. 기존 300초에서 3600으로 정리. |
| 10 | 7단계 시나리오 통과 | AI 1건, Video 1건, Messaging 1건, Worker kill 1회, DLQ 1회. |

---

## 5. SLO/SLI 요약

| 영역 | 목표 | 비고 |
|------|------|------|
| 가용성 | API 가용 99.5% | ALB 5xx·/health 실패 최소화 |
| 응답 | Read P95 < 2초, Write P95 < 3초, /health < 300ms | DB 접속·inference/비동기 job 제외 |
| AI Job 처리 완료 | 요청+처리 < 1시간 (Basic/Lite). 상한: inference 최대 60분 초과 시 fail | Worker kill 시 재시도·멱등 1시간 내 완료 |
| Video 인코딩 완료 | 3시간 내 완료 권장 < 4시간 | VIDEO_SQS_VISIBILITY_EXTEND=10800 |
| 멱등 | 동일 job_id 재처리 시 기준 상태 변경 없음 (DONE 제외). DB 원칙: job↔result 1:1 설정 | prepare_ai_job·mark_done 등 |
| DLQ 비율 | AI/Video/Messaging DLQ 메시지 < 1% | SQS 메트릭 |
| DB 커넥션 | < max_connections. Worst case: steady_state + burst_margin + admin_margin | SHOW max_connections; |
| Video Worker 디스크 | 사용률 < 80% (100GB 마운트) | EC2 df -h, CloudWatch |

---

## 6. 10K 단계 7개 점검 (요약)

| # | 항목 | 10K 대비 |
| 1 | DB 커넥션 수 | SHOW max_connections; 확인. 필요 시 PgBouncer 또는 CONN_MAX_AGE=0. |
| 2 | Row lock (AI Job) | select_for_update(). lease 기준 완료 검증. |
| 3 | SQS Visibility | AI 3600초, Visibility extender 도입. Legacy 제거 시 3600으로 통일. |
| 4 | Idempotency | prepare_ai_job·mark_running 등. Domain/Application에서 멱등·상태 검증. |
| 5 | 디스크 (Video) | 100GB EBS /mnt/transcode. df -h. CloudWatch 사용률 80% 미만. |
| 6 | 관측 | 로그 보관 7~14일. /health 응답·DB 커넥션. Worker 로그 request_id, job_id, duration. |
| 7 | 테스트 | 코드/설정 변경 시 배포. DB 스키마·마이그레이션 Phase 3에서 정리. |

---

## 7. AI Queue Visibility 고정 (배포 기준)

- AI SQS VisibilityTimeout = **3600초**
- lease_expires_at = **3540초** (visibility − safety_margin 60초)
- Academy Worker 기준 적용. **USE_LEGACY_AI_WORKER** 제거 또는 배포 스위치만 유지.

이 고정은 Big Bang 전제 조건이다. 기존 300초 Visibility는 큐·IaC에서 **3600초로 정리**한다.
