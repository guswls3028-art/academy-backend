# 500 배포 진행도우미

**전제**: API EC2 배포 완료, `/health` 200 확인.  
**목표**: Messaging **항시 1대 대기**(복제 가능, Min=1) + Video/AI는 ASG로 자동 생성·삭제(Min=0).

체크박스 채우면서 순서대로 진행하면 됨. 복붙용 명령 위주.

---

## A. 로컬 — 이미지 빌드·푸시

### A1. 워커 이미지 3종 빌드 (PowerShell, `C:\academy`)

- [ ] **A1-1** 터미널 열고:
```powershell
cd C:\academy
docker context use default
```

- [ ] **A1-2** 베이스·워커 빌드 (이미 있으면 base 생략 가능):
```powershell
docker build --platform linux/arm64 -f docker/Dockerfile.base -t academy-base:latest .
docker build --platform linux/arm64 -f docker/messaging-worker/Dockerfile -t academy-messaging-worker:latest .
docker build --platform linux/arm64 -f docker/video-worker/Dockerfile -t academy-video-worker:latest .
docker build --platform linux/arm64 -f docker/ai-worker-cpu/Dockerfile -t academy-ai-worker-cpu:latest .
```

### A2. ECR 로그인·레포 생성·푸시

- [ ] **A2-1** ECR 로그인:
```powershell
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
```

- [ ] **A2-2** 레포 없으면 생성:
```powershell
aws ecr create-repository --repository-name academy-messaging-worker --region ap-northeast-2 2>$null
aws ecr create-repository --repository-name academy-video-worker --region ap-northeast-2 2>$null
aws ecr create-repository --repository-name academy-ai-worker-cpu --region ap-northeast-2 2>$null
```

- [ ] **A2-3** 태그·푸시:
```powershell
docker tag academy-messaging-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker tag academy-video-worker:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker tag academy-ai-worker-cpu:latest 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-video-worker:latest
docker push 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-ai-worker-cpu:latest
```

---

## B. API EC2 — Messaging Worker (상시 1대)

- [ ] **B1** API EC2에 SSH 접속.

- [ ] **B2** Messaging 워커 실행 (같은 서버):
```bash
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com
docker pull 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker run -d --name academy-messaging-worker --restart unless-stopped --env-file .env -e DJANGO_SETTINGS_MODULE=apps.api.config.settings.worker 809466760795.dkr.ecr.ap-northeast-2.amazonaws.com/academy-messaging-worker:latest
docker update --restart unless-stopped academy-messaging-worker
docker ps
```

- [ ] **B3** `.env` 없으면 로컬에서 `prepare_deploy_env.py`로 `.env.deploy` 만든 뒤 scp로 복사.

---

## C. SSM·IAM — ASG 워커용

- [ ] **C1** 배포용 .env를 SSM에 저장 (로컬 PowerShell):
```powershell
cd C:\academy
# .env.deploy 또는 .env 준비 후
aws ssm put-parameter --name /academy/workers/env --type SecureString --value file://.env.deploy --overwrite --region ap-northeast-2
```

- [ ] **C2** EC2 역할에 권한 확인: `ssm:GetParameter` (/academy/workers/env), ECR pull, (필요 시) CloudWatch Logs.
- [ ] **C3** Lambda 역할 `academy-lambda`에 CloudWatch PutMetricData (Namespace `Academy/Workers`) 권한 확인.  
  - `infra/worker_asg/iam_policy_queue_depth_lambda.json` 참고.

---

## D. ASG 배포 (Video·AI 워커)

- [ ] **D1** 서브넷 ID 2개, 보안 그룹 ID, EC2 인스턴스 프로필 이름 확인.

- [ ] **D2** 배포 실행 (PowerShell, `C:\academy`):
```powershell
.\scripts\deploy_worker_asg.ps1 `
  -SubnetIds "subnet-xxx,subnet-yyy" `
  -SecurityGroupId "sg-xxx" `
  -IamInstanceProfileName "academy-ec2-role"
```

  선택: `-MaxCapacity 10`, `-TargetMessagesPerInstance 20`, `-KeyName "my-key"`.  
  **참고**: 이미지가 **arm64**로 빌드됐으면 EC2도 **ARM(Graviton)** 이어야 함. 스크립트 기본 AMI가 x86일 수 있으니 ARM 쓰려면 `-AmiId ami-xxx` 로 ARM AMI 지정.

- [ ] **D3** Launch Template에 User Data 반영됨 확인 (스크립트가 `infra/worker_asg/user_data/*.sh` 사용).  
  - ECR 로그인, docker run 재시도, `docker ps` 로그 포함됨.

---

## E. 완료 체크

- [ ] **E1** API EC2 `/health` 200
- [ ] **E2** Messaging Worker 컨테이너 실행 중 (API EC2에서 `docker ps`)
- [ ] **E3** Video Worker ASG 배포됨 (`academy-video-worker-asg`)
- [ ] **E4** AI Worker ASG 배포됨 (`academy-ai-worker-asg`)

---

## F. ASG 동작 1회 검증

- [ ] **F1** Video 또는 AI 큐에 메시지 넣기 → ASG가 인스턴스 생성하는지 콘솔에서 확인.
- [ ] **F2** 메시지 처리 후 큐 비우기 → scale-in으로 인스턴스가 terminate 되는지 확인.

---

## 참고

- **실행서 상세**: [당장_실행서.md](당장_실행서.md)
- **ASG 설계·User Data·SIGTERM·cooldown**: [ASG_설계_확정.md](ASG_설계_확정.md)
- **인프라 상세**: `infra/worker_asg/README.md`, `scripts/deploy_worker_asg.ps1`

문서 위치: `docs/0216/500_배포_진행도우미.md`
