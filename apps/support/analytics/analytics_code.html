
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>analytics Code Browser</title>
<style>
body {
    background:#0f1115;
    color:#eaeaea;
    font-family:Consolas, monospace;
    padding:24px;
}
h1 { margin-bottom:24px; }
h2 { color:#7dd3fc; font-size:15px; }
pre {
    background:#111418;
    padding:16px;
    border-radius:8px;
    overflow-x:auto;
    font-size:13px;
    line-height:1.5;
}
section { margin-bottom:32px; }
</style>
</head>
<body>
<h1>üì¶ apps\support\analytics</h1>

        <section>
            <h2>serializers.py</h2>
            <pre><code># apps/support/analytics/serializers.py
from __future__ import annotations

from rest_framework import serializers


class ExamSummarySerializer(serializers.Serializer):
    target_type = serializers.CharField()
    target_id = serializers.IntegerField()

    participant_count = serializers.IntegerField()
    average_score = serializers.FloatField()
    max_score = serializers.FloatField()


class QuestionStatSerializer(serializers.Serializer):
    question_id = serializers.IntegerField()
    attempts = serializers.IntegerField()
    correct_count = serializers.IntegerField()
    wrong_count = serializers.IntegerField()
    answer_rate = serializers.FloatField()
    avg_score = serializers.FloatField()
    max_score = serializers.FloatField()


class WrongAnswerDistributionSerializer(serializers.Serializer):
    question_id = serializers.IntegerField()
    total = serializers.IntegerField()
    top = serializers.ListField(child=serializers.DictField())
</code></pre>
        </section>
        
        <section>
            <h2>services\__init__.py</h2>
            <pre><code></code></pre>
        </section>
        
        <section>
            <h2>services\exam_analytics.py</h2>
            <pre><code># apps/support/analytics/services/exam_analytics.py
from __future__ import annotations

from typing import Any, Dict, List
from collections import Counter

from django.db.models import Avg, Max, Count, Sum, Case, When, IntegerField

from apps.domains.results.models import Result, ResultItem, ResultFact


def get_exam_summary(*, exam_id: int) -&gt; Dict[str, Any]:
    &quot;&quot;&quot;
    results Í∏∞Î∞ò ÏãúÌóò ÏöîÏïΩ (ÏùΩÍ∏∞ Ï†ÑÏö©)

    - Result Í∏∞Ï§Ä ÏßëÍ≥Ñ
    - Ï±ÑÏ†ê/Ï†ïÎãµÎπÑÍµê ÏóÜÏùå
    &quot;&quot;&quot;
    qs = Result.objects.filter(target_type=&quot;exam&quot;, target_id=exam_id)

    agg = qs.aggregate(
        participant_count=Count(&quot;id&quot;),
        average_score=Avg(&quot;total_score&quot;),
        max_score=Max(&quot;max_score&quot;),
    )

    return {
        &quot;target_type&quot;: &quot;exam&quot;,
        &quot;target_id&quot;: int(exam_id),
        &quot;participant_count&quot;: int(agg[&quot;participant_count&quot;] or 0),
        &quot;average_score&quot;: float(agg[&quot;average_score&quot;] or 0.0),
        &quot;max_score&quot;: float(agg[&quot;max_score&quot;] or 0.0),
    }


def get_question_stats(*, exam_id: int) -&gt; List[Dict[str, Any]]:
    &quot;&quot;&quot;
    results Í∏∞Î∞ò Î¨∏Ìï≠Î≥Ñ ÌÜµÍ≥Ñ (ÏùΩÍ∏∞ Ï†ÑÏö©)

    Í∏∞Ï§Ä:
    - ResultItemÏùÄ (result, question_id) Í∏∞Ï§Ä snapshot 1Í∞úÎßå Ï°¥Ïû¨
    - Îî∞ÎùºÏÑú attempts = Ìï¥Îãπ Î¨∏Ìï≠ÏùÑ Ìëº ÌïôÏÉù Ïàò
    &quot;&quot;&quot;
    items = (
        ResultItem.objects
        .filter(result__target_type=&quot;exam&quot;, result__target_id=exam_id)
        .values(&quot;question_id&quot;)
        .annotate(
            attempts=Count(&quot;id&quot;),
            correct_count=Sum(
                Case(
                    When(is_correct=True, then=1),
                    default=0,
                    output_field=IntegerField(),
                )
            ),
            wrong_count=Sum(
                Case(
                    When(is_correct=False, then=1),
                    default=0,
                    output_field=IntegerField(),
                )
            ),
            avg_score=Avg(&quot;score&quot;),
            max_score=Max(&quot;max_score&quot;),
        )
        .order_by(&quot;question_id&quot;)
    )

    rows: List[Dict[str, Any]] = []
    for r in items:
        attempts = int(r[&quot;attempts&quot;] or 0)
        correct = int(r[&quot;correct_count&quot;] or 0)
        wrong = int(r[&quot;wrong_count&quot;] or 0)

        answer_rate = (correct / attempts) if attempts &gt; 0 else 0.0

        rows.append(
            {
                &quot;question_id&quot;: int(r[&quot;question_id&quot;]),
                &quot;attempts&quot;: attempts,
                &quot;correct_count&quot;: correct,
                &quot;wrong_count&quot;: wrong,
                &quot;answer_rate&quot;: round(float(answer_rate), 4),
                &quot;avg_score&quot;: float(r[&quot;avg_score&quot;] or 0.0),
                &quot;max_score&quot;: float(r[&quot;max_score&quot;] or 0.0),
            }
        )
    return rows


def get_top_wrong_questions(*, exam_id: int, limit: int = 5) -&gt; List[Dict[str, Any]]:
    &quot;&quot;&quot;
    Ïò§ÎãµÏù¥ ÎßéÏùÄ Î¨∏Ìï≠ TOP N (snapshot Í∏∞Î∞ò)
    &quot;&quot;&quot;
    stats = get_question_stats(exam_id=exam_id)
    stats.sort(key=lambda x: x[&quot;wrong_count&quot;], reverse=True)
    return stats[: max(1, int(limit))]


def get_wrong_answer_distribution(
    *, exam_id: int, question_id: int, limit: int = 5
) -&gt; Dict[str, Any]:
    &quot;&quot;&quot;
    Ïò§Îãµ Î∂ÑÌè¨ (Fact Í∏∞Î∞ò: ÎàÑÏ†Å Ï†úÏ∂ú ÌûàÏä§ÌÜ†Î¶¨)

    - is_correct=False Ïù∏ Ïò§ÎãµÎßå ÏßëÍ≥Ñ
    - Ï±ÑÏ†ê/Ï†ïÎãµÎπÑÍµê ÏóÜÏùå (Îã®Ïàú ÌÜµÍ≥Ñ)
    &quot;&quot;&quot;
    qs = ResultFact.objects.filter(
        target_type=&quot;exam&quot;,
        target_id=exam_id,
        question_id=question_id,
        is_correct=False,
    ).exclude(answer=&quot;&quot;)

    counter = Counter(qs.values_list(&quot;answer&quot;, flat=True))
    total = sum(counter.values())

    top = []
    for ans, cnt in counter.most_common(limit):
        top.append(
            {
                &quot;answer&quot;: ans,
                &quot;count&quot;: int(cnt),
                &quot;rate&quot;: round((cnt / total) * 100.0, 2) if total &gt; 0 else 0.0,
            }
        )

    return {
        &quot;question_id&quot;: int(question_id),
        &quot;total&quot;: int(total),
        &quot;top&quot;: top,
    }
</code></pre>
        </section>
        
        <section>
            <h2>urls.py</h2>
            <pre><code># apps/support/analytics/urls.py
from django.urls import path

from apps.support.analytics.views import (
    ExamAnalyticsSummaryView,
    ExamAnalyticsQuestionStatsView,
    ExamAnalyticsTopWrongView,
    ExamAnalyticsWrongDistributionView,
)

urlpatterns = [
    path(&quot;analytics/exams/&lt;int:exam_id&gt;/summary/&quot;, ExamAnalyticsSummaryView.as_view()),
    path(&quot;analytics/exams/&lt;int:exam_id&gt;/questions/&quot;, ExamAnalyticsQuestionStatsView.as_view()),
    path(&quot;analytics/exams/&lt;int:exam_id&gt;/top-wrong/&quot;, ExamAnalyticsTopWrongView.as_view()),
    path(
        &quot;analytics/exams/&lt;int:exam_id&gt;/questions/&lt;int:question_id&gt;/wrong-distribution/&quot;,
        ExamAnalyticsWrongDistributionView.as_view(),
    ),
]
</code></pre>
        </section>
        
        <section>
            <h2>views.py</h2>
            <pre><code># apps/support/analytics/views.py
from __future__ import annotations

from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from apps.support.analytics.serializers import (
    ExamSummarySerializer,
    QuestionStatSerializer,
    WrongAnswerDistributionSerializer,
)
from apps.support.analytics.services.exam_analytics import (
    get_exam_summary,
    get_question_stats,
    get_top_wrong_questions,
    get_wrong_answer_distribution,
)


class ExamAnalyticsSummaryView(APIView):
    permission_classes = [IsAuthenticated]

    def get(self, request, exam_id: int):
        data = get_exam_summary(exam_id=int(exam_id))
        return Response(ExamSummarySerializer(data).data)


class ExamAnalyticsQuestionStatsView(APIView):
    permission_classes = [IsAuthenticated]

    def get(self, request, exam_id: int):
        rows = get_question_stats(exam_id=int(exam_id))
        return Response(QuestionStatSerializer(rows, many=True).data)


class ExamAnalyticsTopWrongView(APIView):
    permission_classes = [IsAuthenticated]

    def get(self, request, exam_id: int):
        limit = int(request.query_params.get(&quot;limit&quot;) or 5)
        rows = get_top_wrong_questions(exam_id=int(exam_id), limit=limit)
        return Response(QuestionStatSerializer(rows, many=True).data)


class ExamAnalyticsWrongDistributionView(APIView):
    permission_classes = [IsAuthenticated]

    def get(self, request, exam_id: int, question_id: int):
        limit = int(request.query_params.get(&quot;limit&quot;) or 5)
        data = get_wrong_answer_distribution(
            exam_id=int(exam_id),
            question_id=int(question_id),
            limit=limit,
        )
        return Response(WrongAnswerDistributionSerializer(data).data)
</code></pre>
        </section>
        
</body>
</html>
