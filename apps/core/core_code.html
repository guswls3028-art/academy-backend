
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>core Code Browser</title>
<style>
body {
    background:#0f1115;
    color:#eaeaea;
    font-family:Consolas, monospace;
    padding:24px;
}
h1 { margin-bottom:24px; }
h2 { color:#7dd3fc; font-size:15px; }
pre {
    background:#111418;
    padding:16px;
    border-radius:8px;
    overflow-x:auto;
    font-size:13px;
    line-height:1.5;
}
section { margin-bottom:32px; }
</style>
</head>
<body>
<h1>üì¶ apps\core</h1>

        <section>
            <h2>__init__.py</h2>
            <pre><code></code></pre>
        </section>
        
        <section>
            <h2>apps.py</h2>
            <pre><code>from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = &quot;django.db.models.BigAutoField&quot;
    name = &quot;apps.core&quot;
    label = &quot;core&quot;
</code></pre>
        </section>
        
        <section>
            <h2>middleware\__init__.py</h2>
            <pre><code></code></pre>
        </section>
        
        <section>
            <h2>middleware\tenant.py</h2>
            <pre><code># apps/core/middleware/tenant.py

class TenantMiddleware:
    &quot;&quot;&quot;
    Tenant middleware (placeholder)
    ÌòÑÏû¨Îäî Î©ÄÌã∞ÌÖåÎÑåÏãú Î°úÏßÅ ÏóÜÏù¥ ÌÜµÍ≥ºÎßå ÏãúÌÇ®Îã§.
    &quot;&quot;&quot;

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)
        return response
</code></pre>
        </section>
        
        <section>
            <h2>models\__init__.py</h2>
            <pre><code>from .tenant import Tenant
from .user import User, Attendance, Expense

__all__ = [
    &quot;Tenant&quot;,
    &quot;User&quot;,
    &quot;Attendance&quot;,
    &quot;Expense&quot;,
]
</code></pre>
        </section>
        
        <section>
            <h2>models\tenant.py</h2>
            <pre><code>from django.db import models


class Tenant(models.Model):
    &quot;&quot;&quot;
    Tenant == Academy
    SaaS Îã®ÏúÑÏùò ÌïôÏõê
    &quot;&quot;&quot;

    name = models.CharField(max_length=255)
    code = models.CharField(max_length=50, unique=True)

    owner_name = models.CharField(max_length=100, blank=True)
    phone = models.CharField(max_length=50, blank=True)
    address = models.CharField(max_length=255, blank=True)

    logo = models.ImageField(
        upload_to=&quot;academy/logo/&quot;,
        null=True,
        blank=True,
    )

    is_active = models.BooleanField(default=True)

    class Meta:
        app_label = &quot;core&quot;
        verbose_name = &quot;Tenant&quot;
        verbose_name_plural = &quot;Tenants&quot;

    def __str__(self):
        return self.name
</code></pre>
        </section>
        
        <section>
            <h2>models\user.py</h2>
            <pre><code>from django.db import models
from django.conf import settings
from django.contrib.auth.models import AbstractUser, Group, Permission

from apps.api.common.models import TimestampModel


# --------------------------------------------------
# Custom User (AUTH_USER_MODEL)
# --------------------------------------------------

class User(AbstractUser):
    &quot;&quot;&quot;
    Custom User Î™®Îç∏
    - AUTH_USER_MODEL = core.User
    - auth.User ÏôÄÏùò groups / permissions reverse accessor Ï∂©Îèå Î∞©ÏßÄ
    &quot;&quot;&quot;

    name = models.CharField(max_length=50, blank=True, null=True)
    phone = models.CharField(max_length=20, blank=True, null=True)

    # üî• ÌïµÏã¨: auth.User ÏôÄ reverse accessor Ï∂©Îèå Î∞©ÏßÄ
    groups = models.ManyToManyField(
        Group,
        related_name=&quot;core_users&quot;,
        blank=True,
    )
    user_permissions = models.ManyToManyField(
        Permission,
        related_name=&quot;core_users&quot;,
        blank=True,
    )

    class Meta:
        app_label = &quot;core&quot;
        db_table = &quot;accounts_user&quot;
        ordering = [&quot;-id&quot;]

    def __str__(self):
        return self.username


# --------------------------------------------------
# Attendance
# --------------------------------------------------

class Attendance(TimestampModel):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name=&quot;attendances&quot;,
    )

    date = models.DateField()
    start_time = models.TimeField()
    end_time = models.TimeField()

    work_type = models.CharField(max_length=50)
    memo = models.TextField(blank=True, null=True)

    duration_hours = models.FloatField(default=0)
    amount = models.IntegerField(default=0)

    class Meta:
        app_label = &quot;core&quot;
        ordering = [&quot;-date&quot;, &quot;-start_time&quot;]

    def __str__(self):
        return f&quot;{self.user.username} - {self.date}&quot;


# --------------------------------------------------
# Expense
# --------------------------------------------------

class Expense(TimestampModel):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name=&quot;expenses&quot;,
    )

    date = models.DateField()
    title = models.CharField(max_length=255)
    amount = models.IntegerField()
    memo = models.TextField(blank=True, null=True)

    class Meta:
        app_label = &quot;core&quot;
        ordering = [&quot;-date&quot;]

    def __str__(self):
        return f&quot;{self.user.username} - {self.title}&quot;
</code></pre>
        </section>
        
        <section>
            <h2>permissions.py</h2>
            <pre><code>from rest_framework.permissions import BasePermission


class IsAdminOrStaff(BasePermission):
    &quot;&quot;&quot;
    Í¥ÄÎ¶¨Ïûê / Ïö¥ÏòÅÏûê Ï†ÑÏö© Permission
    &quot;&quot;&quot;
    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and (user.is_superuser or user.is_staff)
        )


class IsStudent(BasePermission):
    &quot;&quot;&quot;
    ÌïôÏÉù Ï†ÑÏö© Permission
    - Î°úÍ∑∏Ïù∏ ÌïÑÏàò
    - User ‚Üî Student OneToOne Ïó∞Í≤∞ ÌïÑÏàò
    &quot;&quot;&quot;
    message = &quot;Student account required.&quot;

    def has_permission(self, request, view):
        user = request.user
        return bool(
            user
            and user.is_authenticated
            and hasattr(user, &quot;student_profile&quot;)
        )
</code></pre>
        </section>
        
        <section>
            <h2>serializers.py</h2>
            <pre><code>from rest_framework import serializers
from django.contrib.auth import get_user_model

from apps.core.models import Attendance, Expense

User = get_user_model()


# ------------------------------------
# User Base
# ------------------------------------

class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = [&quot;id&quot;, &quot;username&quot;, &quot;email&quot;, &quot;name&quot;, &quot;phone&quot;]


# ------------------------------------
# Profile
# ------------------------------------

class ProfileSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = [&quot;id&quot;, &quot;name&quot;, &quot;phone&quot;]


# ------------------------------------
# Attendance
# ------------------------------------

class AttendanceSerializer(serializers.ModelSerializer):
    class Meta:
        model = Attendance
        fields = &quot;__all__&quot;
        read_only_fields = [&quot;user&quot;, &quot;duration_hours&quot;, &quot;amount&quot;]


# ------------------------------------
# Expense
# ------------------------------------

class ExpenseSerializer(serializers.ModelSerializer):
    class Meta:
        model = Expense
        fields = &quot;__all__&quot;
        read_only_fields = [&quot;user&quot;]
</code></pre>
        </section>
        
        <section>
            <h2>urls.py</h2>
            <pre><code>from django.urls import path, include
from rest_framework.routers import DefaultRouter

from apps.core.views import (
    MeView,
    ProfileViewSet,
    MyAttendanceViewSet,
    MyExpenseViewSet,
)

router = DefaultRouter()
router.register(&quot;profile&quot;, ProfileViewSet, basename=&quot;profile&quot;)
router.register(&quot;profile/attendance&quot;, MyAttendanceViewSet, basename=&quot;my-attendance&quot;)
router.register(&quot;profile/expenses&quot;, MyExpenseViewSet, basename=&quot;my-expense&quot;)

urlpatterns = [
    path(&quot;me/&quot;, MeView.as_view(), name=&quot;core-me&quot;),
    path(&quot;&quot;, include(router.urls)),
]
</code></pre>
        </section>
        
        <section>
            <h2>views.py</h2>
            <pre><code>from datetime import datetime
from django.db.models import Sum

from rest_framework.views import APIView
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response

from drf_yasg.utils import swagger_auto_schema

from apps.core.models import Attendance, Expense
from apps.core.serializers import (
    UserSerializer,
    ProfileSerializer,
    AttendanceSerializer,
    ExpenseSerializer,
)


# --------------------------------------------------
# Auth: /core/me/
# --------------------------------------------------

class MeView(APIView):
    permission_classes = [IsAuthenticated]

    @swagger_auto_schema(auto_schema=None)
    def get(self, request):
        serializer = UserSerializer(request.user)
        return Response(serializer.data)


# --------------------------------------------------
# Profile
# --------------------------------------------------

class ProfileViewSet(viewsets.ViewSet):
    permission_classes = [IsAuthenticated]

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=[&quot;get&quot;])
    def me(self, request):
        serializer = ProfileSerializer(request.user)
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=[&quot;patch&quot;])
    def update_me(self, request):
        serializer = ProfileSerializer(
            request.user,
            data=request.data,
            partial=True,
        )
        serializer.is_valid(raise_exception=True)
        serializer.save()
        return Response(serializer.data)

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=[&quot;post&quot;], url_path=&quot;change-password&quot;)
    def change_password(self, request):
        old_pw = request.data.get(&quot;old_password&quot;)
        new_pw = request.data.get(&quot;new_password&quot;)

        if not old_pw or not new_pw:
            return Response({&quot;error&quot;: &quot;old_password, new_password ÌïÑÏöî&quot;}, status=400)

        if not request.user.check_password(old_pw):
            return Response({&quot;error&quot;: &quot;ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.&quot;}, status=400)

        request.user.set_password(new_pw)
        request.user.save()

        return Response({&quot;message&quot;: &quot;ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω ÏôÑÎ£å&quot;})


# --------------------------------------------------
# Attendance
# --------------------------------------------------

class MyAttendanceViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]
    serializer_class = AttendanceSerializer

    def get_queryset(self):
        user = self.request.user
        month = self.request.query_params.get(&quot;month&quot;)

        qs = Attendance.objects.filter(user=user)

        if month:
            qs = qs.filter(date__startswith=month)

        return qs

    def perform_create(self, serializer):
        user = self.request.user

        start = self.request.data.get(&quot;start_time&quot;)
        end = self.request.data.get(&quot;end_time&quot;)

        try:
            start_dt = datetime.strptime(start, &quot;%H:%M&quot;)
            end_dt = datetime.strptime(end, &quot;%H:%M&quot;)
            duration = (end_dt - start_dt).seconds / 3600
        except Exception:
            duration = 0

        hourly = 15000
        amount = int(duration * hourly)

        serializer.save(
            user=user,
            duration_hours=duration,
            amount=amount,
        )

    @swagger_auto_schema(auto_schema=None)
    @action(detail=False, methods=[&quot;get&quot;], url_path=&quot;summary&quot;)
    def summary(self, request):
        user = request.user
        month = self.request.query_params.get(&quot;month&quot;)

        qs = Attendance.objects.filter(user=user)

        if month:
            qs = qs.filter(date__startswith=month)

        total_hours = qs.aggregate(Sum(&quot;duration_hours&quot;))[&quot;duration_hours__sum&quot;] or 0
        total_amount = qs.aggregate(Sum(&quot;amount&quot;))[&quot;amount__sum&quot;] or 0
        after_tax = int(total_amount * 0.967)

        return Response({
            &quot;total_hours&quot;: total_hours,
            &quot;total_amount&quot;: total_amount,
            &quot;total_after_tax&quot;: after_tax,
        })


# --------------------------------------------------
# Expense
# --------------------------------------------------

class MyExpenseViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]
    serializer_class = ExpenseSerializer

    def get_queryset(self):
        user = self.request.user
        month = self.request.query_params.get(&quot;month&quot;)

        qs = Expense.objects.filter(user=user)

        if month:
            qs = qs.filter(date__startswith=month)

        return qs

    def perform_create(self, serializer):
        serializer.save(user=self.request.user)
</code></pre>
        </section>
        
</body>
</html>
