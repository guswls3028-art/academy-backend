최종 마스터 프롬프트 (실상품 완성용)

⚠️ 이 프롬프트는 V1 스펙을 수정하지 않는다
⚠️ assets / worker 책임 분리를 절대 깨지 않는다
⚠️ “예제·가이드·설명”을 금지하고 실제 코드/패치만 요구한다

역할:
너는 대기업 실무급 Django/DRF + Computer Vision 백엔드 엔지니어다.
교육/OMR/문서인식 시스템을 실제 학원/학교에 상용 배포한 경험이 있다.

현재 상태 (단일진실, 이미 구현됨):
- assets 도메인
  - OMR 객관식 답안지 PDF 생성 (10/20/30 문항)
  - reportlab 벡터 PDF
  - constants.py 기반 좌표 단일진실
  - meta API (mm 단위, PDF와 1:1 대응)
- worker 도메인
  - OMR v1 grading 엔진 (ROI 기반)
  - scan / photo / video 대응 구조
  - warp → meta ROI 적용 → fallback segmentation 구조
- 두 도메인은 이미 코드로 연결 가능

목표:
아래 작업을 통해 **“실제 상품으로 바로 출시 가능한 상태”**로 완성하라.
PoC, 예제, 가이드는 금지한다.
반드시 실제 운영 가능한 코드/패치/설계를 제공하라.

==================================================
[절대 규칙]
==================================================
- V1 단일진실 문서를 1바이트도 위반하지 말 것
- assets 도메인의 책임을 절대 확장하지 말 것
- worker는 “판단/추출”까지만 담당
- 채점/점수/정답 비교는 API(results) 책임
- 외부 SaaS 호출 금지
- 비동기 큐 신규 도입 금지
- 기존 코드 삭제 금지 (추가/보강만 허용)

==================================================
[반드시 완성해야 할 작업]
==================================================

A. Worker – OMR 실사용 완성 (필수)

1) Identifier(식별자) OMR 인식 v1 구현
- assets meta의 identifier.bubbles를 그대로 사용
- 휴대폰번호 뒤 8자리 (digit 1~8)
- 각 digit별 0~9 중 1개 선택
- 결과 예시:
  {
    "identifier": "12345678",
    "confidence": 0.91,
    "status": "ok|ambiguous|blank"
  }

- detect_omr_answers_v1과 동일한 철학
- ROI 기반, fill_score 방식
- meta(mm) → px 변환 재사용

2) OMR threshold 운영 튜닝 가이드 + 기본값 보정
- blank / multi / ambiguous 과다 발생 방지
- v1 default를 “실데이터 기준 안정값”으로 조정
- 코드 + 이유 명시

3) scan / photo / auto 모드 정책 최종 고정
- 프론트 기본값: mode=auto
- photo 모드는 실패 시 error 반환
- auto 모드는 warp 실패 시 fallback 허용

--------------------------------------------------

B. Worker ↔ Assets 연계 최종 정리

4) assets meta API 호출 안정화
- 인증 방식 정리 (cookie/header)
- timeout / error 처리
- meta 실패 시 graceful fallback 규칙 명시

5) meta → questions payload 변환 책임 고정
- meta(mm)는 assets의 단일진실
- px 변환은 worker의 책임
- 이 경계를 코드와 주석으로 명확히 고정

--------------------------------------------------

C. 결과 도메인(results) 연계 명세 (구현 또는 정확한 명세)

6) worker OMR 결과 → results API 계약 정의
- input payload
- expected response
- retry / error 정책
- identifier + answers 결합 방식

※ results 도메인에 코드를 넣지는 말고
※ “이대로 구현하면 된다” 수준의 명세 제공

==================================================
[산출물 형식 – 필수]
==================================================

- 수정/추가된 모든 파일:
  - 경로 + 전체 코드
- 기존 파일 변경 시:
  - patch 또는 before/after
- 마지막에 반드시 포함:
  1) 전체 처리 플로우 다이어그램 (텍스트)
  2) scan vs photo 처리 차이 요약
  3) 실운영 기준 수동 QA 체크리스트
  4) “이 상태가 왜 상품 완성인지”에 대한 기술적 근거

==================================================
[완료 기준 선언]
==================================================

이 작업이 끝나면 시스템은 다음을 만족해야 한다.

- 학원/학교에서 바로 인쇄·배포 가능한 OMR 답안지
- 스캔/촬영/영상 모두 안정적으로 인식
- assets ↔ worker ↔ results 책임 분리 명확
- 좌표/레이아웃 단일진실 유지
- v1 스펙을 수정하지 않고 v2 확장 가능
- 대기업 실무 리뷰 및 보안/운영 검토 통과 가능

이 기준을 만족하는 **완성 산출물**을 제시하라.
