
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>students Code Browser</title>
<style>
body {
    background:#0f1115;
    color:#eaeaea;
    font-family:Consolas, monospace;
    padding:24px;
}
h1 { margin-bottom:24px; }
h2 { color:#7dd3fc; font-size:15px; }
pre {
    background:#111418;
    padding:16px;
    border-radius:8px;
    overflow-x:auto;
    font-size:13px;
    line-height:1.5;
}
section { margin-bottom:32px; }
</style>
</head>
<body>
<h1>ğŸ“¦ apps\domains\students</h1>

        <section>
            <h2>__init__.py</h2>
            <pre><code></code></pre>
        </section>
        
        <section>
            <h2>admin.py</h2>
            <pre><code>from django.contrib import admin
from .models import Student, Tag, StudentTag


@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = (
        &quot;id&quot;,
        &quot;name&quot;,
        &quot;gender&quot;,
        &quot;grade&quot;,
        &quot;phone&quot;,
        &quot;parent&quot;,
        &quot;high_school&quot;,
        &quot;is_managed&quot;,
        &quot;created_at&quot;,
    )
    list_filter = (
        &quot;gender&quot;,
        &quot;grade&quot;,
        &quot;high_school&quot;,
        &quot;is_managed&quot;,
    )
    search_fields = (&quot;name&quot;, &quot;phone&quot;)


@admin.register(Tag)
class TagAdmin(admin.ModelAdmin):
    list_display = (&quot;id&quot;, &quot;name&quot;, &quot;color&quot;)
    search_fields = (&quot;name&quot;,)


@admin.register(StudentTag)
class StudentTagAdmin(admin.ModelAdmin):
    list_display = (&quot;student&quot;, &quot;tag&quot;)
    list_filter = (&quot;tag&quot;,)
</code></pre>
        </section>
        
        <section>
            <h2>apps.py</h2>
            <pre><code>from django.apps import AppConfig


class StudentsConfig(AppConfig):
    default_auto_field = &quot;django.db.models.BigAutoField&quot;
    name = &quot;apps.domains.students&quot;
    label = &quot;students&quot;
</code></pre>
        </section>
        
        <section>
            <h2>filters.py</h2>
            <pre><code>import django_filters
from .models import Student


class StudentFilter(django_filters.FilterSet):
    name = django_filters.CharFilter(field_name=&quot;name&quot;, lookup_expr=&quot;icontains&quot;)
    gender = django_filters.CharFilter()
    grade = django_filters.NumberFilter()
    high_school = django_filters.CharFilter(lookup_expr=&quot;icontains&quot;)
    major = django_filters.CharFilter(lookup_expr=&quot;icontains&quot;)
    is_managed = django_filters.BooleanFilter()

    class Meta:
        model = Student
        fields = [
            &quot;name&quot;,
            &quot;gender&quot;,
            &quot;grade&quot;,
            &quot;high_school&quot;,
            &quot;major&quot;,
            &quot;is_managed&quot;,
        ]
</code></pre>
        </section>
        
        <section>
            <h2>models.py</h2>
            <pre><code>from django.db import models
from django.conf import settings

from apps.api.common.models import TimestampModel


class Student(TimestampModel):
    # =========================
    # ğŸ” ë¡œê·¸ì¸ ì‚¬ìš©ì ì—°ê²° (ì‹ ê·œ)
    # =========================
    # - ìƒìš© SaaSì—ì„œ ì¬ìƒ ê¶Œí•œ/ë¡œê·¸ì¸ì„ ì¦ëª…í•˜ë ¤ë©´ User â†” Student ë§¤í•‘ì´ í•„ìˆ˜
    # - ê¸°ì¡´ ë°ì´í„°/ìš´ì˜ ê³ ë ¤: null í—ˆìš©
    user = models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name=&quot;student_profile&quot;,
        help_text=&quot;í•™ìƒì´ ë¡œê·¸ì¸ ê³„ì •ì„ ê°€ì§€ëŠ” ê²½ìš° ì—°ê²°&quot;,
    )

    # =========================
    # ê¸°ë³¸ ì •ë³´
    # =========================
    name = models.CharField(max_length=50)

    gender = models.CharField(
        max_length=1,
        choices=[(&quot;M&quot;, &quot;ë‚¨&quot;), (&quot;F&quot;, &quot;ì—¬&quot;)],
        null=True,
        blank=True,
    )

    # ì¤‘/ê³  ê³µí†µ í•™ë…„ (1~3)
    grade = models.PositiveSmallIntegerField(
        choices=[(1, &quot;1&quot;), (2, &quot;2&quot;), (3, &quot;3&quot;)],
        null=True,
        blank=True,
    )

    # ğŸ”´ ì¤‘í•™ìƒ / ê³ ë“±í•™ìƒ êµ¬ë¶„
    SCHOOL_TYPE_CHOICES = (
        (&quot;MIDDLE&quot;, &quot;ì¤‘ë“±&quot;),
        (&quot;HIGH&quot;, &quot;ê³ ë“±&quot;),
    )

    school_type = models.CharField(
        max_length=10,
        choices=SCHOOL_TYPE_CHOICES,
        default=&quot;HIGH&quot;,
    )

    phone = models.CharField(max_length=20, null=True, blank=True)

    # legacy ìœ ì§€ (í•™ìƒ ê¸°ì¤€ ë¹ ë¥¸ ì¡°íšŒìš©)
    parent_phone = models.CharField(max_length=20, null=True, blank=True)

    # =========================
    # ë³´í˜¸ì (1:N êµ¬ì¡°)
    # =========================
    parent = models.ForeignKey(
        &quot;parents.Parent&quot;,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name=&quot;students&quot;,
    )

    # =========================
    # í•™êµ ì •ë³´
    # =========================
    # ê³ ë“±í•™ìƒìš©
    high_school = models.CharField(max_length=100, null=True, blank=True)
    high_school_class = models.CharField(max_length=100, null=True, blank=True)
    major = models.CharField(max_length=50, null=True, blank=True)

    # ì¤‘í•™ìƒìš©
    middle_school = models.CharField(max_length=100, null=True, blank=True)

    # =========================
    # ê¸°íƒ€
    # =========================
    memo = models.TextField(null=True, blank=True)
    is_managed = models.BooleanField(default=True)

    # =========================
    # íƒœê·¸ (ì£¼ì˜í•™ìƒ ë“±)
    # =========================
    tags = models.ManyToManyField(
        &quot;Tag&quot;,
        through=&quot;StudentTag&quot;,
        related_name=&quot;students&quot;,
        blank=True,
    )

    class Meta:
        ordering = [&quot;-id&quot;]
        constraints = [
            models.UniqueConstraint(
                fields=[&quot;user&quot;],
                name=&quot;uniq_student_user&quot;,
                condition=models.Q(user__isnull=False),
            )
        ]

    def __str__(self):
        return self.name


# =========================
# Tag
# =========================
class Tag(models.Model):
    name = models.CharField(max_length=50)
    color = models.CharField(max_length=20, default=&quot;#000000&quot;)

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=[&quot;name&quot;],
                name=&quot;uniq_tag_name&quot;,
            )
        ]

    def __str__(self):
        return self.name


# =========================
# Student - Tag ì—°ê²°
# =========================
class StudentTag(models.Model):
    student = models.ForeignKey(
        Student,
        on_delete=models.CASCADE,
        related_name=&quot;student_tags&quot;,
    )
    tag = models.ForeignKey(Tag, on_delete=models.CASCADE)

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=[&quot;student&quot;, &quot;tag&quot;],
                name=&quot;uniq_student_tag&quot;,
            )
        ]

    def __str__(self):
        return f&quot;{self.student.name} - {self.tag.name}&quot;
</code></pre>
        </section>
        
        <section>
            <h2>serializers.py</h2>
            <pre><code>
from rest_framework import serializers


from apps.domains.students.models import Student, Tag
from apps.domains.enrollment.models import Enrollment
from apps.domains.interactions.counseling.models import Counseling
from apps.domains.interactions.questions.models import Question


# -------------------------------
# Tag
# -------------------------------

class TagSerializer(serializers.ModelSerializer):
    class Meta:
        model = Tag
        fields = &quot;__all__&quot;
        ref_name = &quot;StudentTagSerializer&quot;


# -------------------------------
# Nested
# -------------------------------

class CounselingSerializer(serializers.ModelSerializer):
    class Meta:
        model = Counseling
        fields = &quot;__all__&quot;
        ref_name = &quot;StudentCounseling&quot;


class QuestionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Question
        fields = &quot;__all__&quot;
        ref_name = &quot;StudentQuestion&quot;


class EnrollmentSerializer(serializers.ModelSerializer):
    lecture_name = serializers.CharField(source=&quot;lecture.title&quot;, read_only=True)

    class Meta:
        model = Enrollment
        fields = &quot;__all__&quot;
        ref_name = &quot;StudentEnrollment&quot;


# -------------------------------
# Student
# -------------------------------

class StudentListSerializer(serializers.ModelSerializer):
    tags = TagSerializer(many=True, read_only=True)
    is_enrolled = serializers.SerializerMethodField()

    class Meta:
        model = Student
        fields = &quot;__all__&quot;
        ref_name = &quot;StudentList&quot;

    def get_is_enrolled(self, obj):
        request = self.context.get(&quot;request&quot;)
        if not request:
            return False

        lecture_id = request.query_params.get(&quot;lecture&quot;)
        if lecture_id:
            return obj.enrollments.filter(lecture_id=lecture_id).exists()

        return False


class StudentDetailSerializer(serializers.ModelSerializer):
    tags = TagSerializer(many=True, read_only=True)
    enrollments = EnrollmentSerializer(many=True, read_only=True)
    counselings = CounselingSerializer(many=True, read_only=True)
    questions = QuestionSerializer(many=True, read_only=True)

    class Meta:
        model = Student
        fields = &quot;__all__&quot;
        ref_name = &quot;StudentDetail&quot;


class AddTagSerializer(serializers.Serializer):
    tag_id = serializers.IntegerField()


# -------------------------------
# Student Create (with User)
# -------------------------------

class StudentCreateSerializer(serializers.ModelSerializer):
    &quot;&quot;&quot;
    í•™ìƒ ìƒì„± ì „ìš© Serializer
    - êµì‚¬ê°€ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
    - phone â†’ User.username ìœ¼ë¡œ ì‚¬ìš©
    &quot;&quot;&quot;

    initial_password = serializers.CharField(
        write_only=True,
        required=True,
        min_length=4,
        help_text=&quot;í•™ìƒ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ (êµì‚¬ ì„¤ì •)&quot;,
    )

    class Meta:
        model = Student
        fields = &quot;__all__&quot;

    def validate_phone(self, value):
        if not value:
            raise serializers.ValidationError(&quot;ì „í™”ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.&quot;)

        from django.contrib.auth import get_user_model
        User = get_user_model()

        if User.objects.filter(username=value).exists():
            raise serializers.ValidationError(&quot;ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì „í™”ë²ˆí˜¸ì…ë‹ˆë‹¤.&quot;)

        return value
</code></pre>
        </section>
        
        <section>
            <h2>urls.py</h2>
            <pre><code>from rest_framework.routers import DefaultRouter
from .views import StudentViewSet, TagViewSet

router = DefaultRouter()
router.register(r&quot;&quot;, StudentViewSet)
router.register(r&quot;tags&quot;, TagViewSet)

urlpatterns = router.urls
</code></pre>
        </section>
        
        <section>
            <h2>views.py</h2>
            <pre><code>from django.db import transaction
from django.contrib.auth import get_user_model

from rest_framework.viewsets import ModelViewSet
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated

from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

from apps.core.permissions import IsAdminOrStaff, IsStudent

from .models import Student, Tag, StudentTag
from .filters import StudentFilter
from .serializers import (
    StudentListSerializer,
    StudentDetailSerializer,
    TagSerializer,
    AddTagSerializer,
)


# ======================================================
# Tag
# ======================================================

class TagViewSet(ModelViewSet):
    &quot;&quot;&quot;
    í•™ìƒ íƒœê·¸ ê´€ë¦¬
    - ê´€ë¦¬ì / ìŠ¤íƒœí”„ ì „ìš©
    &quot;&quot;&quot;
    queryset = Tag.objects.all()
    serializer_class = TagSerializer
    permission_classes = [IsAdminOrStaff]


# ======================================================
# Student
# ======================================================

class StudentViewSet(ModelViewSet):
    &quot;&quot;&quot;
    í•™ìƒ ê´€ë¦¬ ViewSet

    âœ” í•™ìƒ ìƒì„± ì‹œ User ê³„ì • ìë™ ìƒì„±
    âœ” phone = username
    âœ” ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ëŠ” êµì‚¬ê°€ ì„¤ì •
    âœ” í•™ìƒ CRUDëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥
    &quot;&quot;&quot;
    queryset = Student.objects.all()
    permission_classes = [IsAdminOrStaff]

    # ------------------------------
    # Serializer ì„ íƒ
    # ------------------------------
    def get_serializer_class(self):
        if self.action == &quot;create&quot;:
            # ìƒì„± ì „ìš© (initial_password í¬í•¨)
            from .serializers import StudentCreateSerializer
            return StudentCreateSerializer

        if self.action == &quot;list&quot;:
            return StudentListSerializer

        return StudentDetailSerializer

    # ------------------------------
    # Student + User ìƒì„±
    # ------------------------------
    @transaction.atomic
    def create(self, request, *args, **kwargs):
        &quot;&quot;&quot;
        í•™ìƒ ìƒì„± ì‹œ ì²˜ë¦¬ íë¦„

        1. ì…ë ¥ê°’ ê²€ì¦ (StudentCreateSerializer)
        2. User ìƒì„± (username = phone)
        3. Student ìƒì„± + user ì—°ê²°
        &quot;&quot;&quot;
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        User = get_user_model()

        phone = serializer.validated_data[&quot;phone&quot;]
        password = serializer.validated_data.pop(&quot;initial_password&quot;)

        # 1ï¸âƒ£ User ìƒì„±
        user = User.objects.create(
            username=phone,
            phone=phone,
            name=serializer.validated_data.get(&quot;name&quot;, &quot;&quot;),
        )
        user.set_password(password)
        user.save()

        # 2ï¸âƒ£ Student ìƒì„± + User ì—°ê²°
        student = Student.objects.create(
            user=user,
            **serializer.validated_data,
        )

        output = StudentDetailSerializer(
            student,
            context={&quot;request&quot;: request},
        )
        return Response(output.data, status=201)

    # ------------------------------
    # Filtering / Searching / Ordering
    # ------------------------------
    filter_backends = [
        DjangoFilterBackend,
        SearchFilter,
        OrderingFilter,
    ]
    filterset_class = StudentFilter
    search_fields = [&quot;name&quot;, &quot;high_school&quot;, &quot;major&quot;]
    ordering_fields = [&quot;id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;]
    ordering = [&quot;-id&quot;]

    # ------------------------------
    # Tag ê´€ë¦¬
    # ------------------------------
    @action(detail=True, methods=[&quot;post&quot;])
    def add_tag(self, request, pk=None):
        student = self.get_object()
        serializer = AddTagSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        tag = Tag.objects.get(id=serializer.validated_data[&quot;tag_id&quot;])
        StudentTag.objects.get_or_create(student=student, tag=tag)

        return Response({&quot;status&quot;: &quot;ok&quot;}, status=201)

    @action(detail=True, methods=[&quot;post&quot;])
    def remove_tag(self, request, pk=None):
        student = self.get_object()
        serializer = AddTagSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        StudentTag.objects.filter(
            student=student,
            tag_id=serializer.validated_data[&quot;tag_id&quot;],
        ).delete()

        return Response({&quot;status&quot;: &quot;ok&quot;}, status=200)

    # --------------------------------------------------
    # Anchor API: /students/me/
    # --------------------------------------------------
    @action(
        detail=False,
        methods=[&quot;get&quot;],
        url_path=&quot;me&quot;,
        permission_classes=[IsAuthenticated, IsStudent],
    )
    def me(self, request):
        &quot;&quot;&quot;
        í•™ìƒ ë³¸ì¸ ì •ë³´ ì¡°íšŒ (Anchor API)

        ğŸ”’ ë³´ì•ˆ í¬ì¸íŠ¸
        - request.user ê¸°ì¤€ ê°•ì œ
        - ë‹¤ë¥¸ í•™ìƒ ID ì ‘ê·¼ ë¶ˆê°€
        - staffê°€ í˜¸ì¶œí•˜ë©´ 403
        &quot;&quot;&quot;
        student = (
            Student.objects
            .select_related(&quot;user&quot;)
            .prefetch_related(&quot;tags&quot;, &quot;enrollments&quot;)
            .get(user=request.user)
        )

        serializer = StudentDetailSerializer(
            student,
            context={&quot;request&quot;: request},
        )
        return Response(serializer.data)
</code></pre>
        </section>
        
</body>
</html>
