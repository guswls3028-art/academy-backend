# 엑셀 파싱 개선 보고서 (한 장)

**일자**: 2026-02-17  
**대상**: `src/application/services/excel_parsing_service.py`

---

## 1. 개요

학원마다 학생 일괄 등록 엑셀 양식이 다르므로, 다양한 헤더·형식을 자동 인식하도록 파싱 로직을 개선했다.

---

## 2. 필수/선택 필드

| 구분 | 필드 | 설명 |
|------|------|------|
| **필수** | 이름 | 학생명 (없으면 건너뜀) |
| **필수** | 학부모 전화 | 010 10~11자리, **대체 불가** (없으면 업로드 전체 실패) |
| 선택 | 학생 전화 | 공란 가능 |
| 선택 | 학교(학년), 성별, 메모 등 | 있으면 매칭 |

### Fail-Fast 정책

- `parent_phone` 누락 또는 형식 오류가 **하나라도** 있으면 전체 업로드 실패 (부분 성공 금지)

---

## 3. 개선 내용

### 3.1 헤더 별칭 확장

- **이름**: 이름, 성명, 학생명, 성함, 학생성명
- **학부모 전화**: 학부모전화번호, 부모핸드폰, 부모 전화, 학부모 전화, 보호자 전화, 휴대폰, 핸드폰, 연락처, 전화번호, 전화, 폰, 폰번호, 부모핸드, 학부모, 보호자
- **학생 전화**: 학생전화번호, 학생핸드폰, 학생 전화, 학생폰, 학생 연락처, 학생핸드, 학생전화
- **성별**: 성별, 남자, 여자, 남성, 여성, 남, 여, 녀
- **학교**: 학교, 학교(학년), 학교명, 출신학교
- **비고/메모**: 메모, 비고, 특이사항, 구분, 체크, 출석, 현장
- **계열**: 계열, 이과, 문과

### 3.2 매칭 방식 개선

- **전각 문자 정규화**: ０１２３ → 0123, 전각 공백 제거
- **부분 매칭**: 별칭 3글자 이상이 헤더에 포함되면 매칭
- **시작 매칭**: 헤더가 짧은 별칭으로 시작하면 매칭 (예: `학부모` → `학부모 전화`)

### 3.3 컬럼 추론 (헤더 미인식 시)

- **전화번호 컬럼**: 010 11자리 패턴이 2행 이상 나오는 컬럼 → `phone_candidate` 후보 지정 (부모/학생 구분은 Rule/AI로 판정)
- **이름 컬럼**: 2~4글자 한글(+숫자/`*`)이 2행 이상 나오는 컬럼 → 이름으로 추정

### 3.4 강의 제목 추출

- 헤더 행 위 최대 5행에서 4~120자 텍스트를 강의 제목으로 추출
- 결과에 `lecture_title` 포함 (프론트 표시용)

### 3.5 행 단위 학생 여부 판별 (ChatGPT 피드백 반영)

- **비학생 행 필터링**: 소제목·날짜·빈 행 등 비학생 행 제외
- **제외 패턴**: `01월`, `2/7~` 같은 날짜/안내 패턴, 순수 숫자만 있는 이름, 20자 초과 문자열
- **포함 조건**: 유효 이름(2~5자 한글+알파벳) 또는 유효 전화번호(010 11자리) 중 1개 이상
- 컬럼 매핑만으로는 70~80% 수준이던 정확도를 행 판별 추가로 95% 이상으로 상승

---

## 4. 지원 양식 예시

```
체크 | 이름 | 부모핸드폰 | 학생핸드폰 | 학교(학년) | 31(토) ...
  1  | 강다윤 | 010-2980-0958 | | 숙명여고(０) | 출
  2  | 강예준 | 010-4650-0825 | 010-4972-0829 | 중동고(0) | 출
```

- 학교(학년): `숙명여고(０)`, `휘문중(3)` 등 전각/반각 숫자 모두 인식
- 학생 전화 공란 가능

---

## 5. 배포

- AI 워커 이미지 재빌드 후 배포 시 반영
- `full_redeploy.ps1` 또는 `build_and_push_ecr` → ASG refresh

### 배포 전 확인 (실무 포인트)

- **Git push**: 로컬 수정이 repo에 push됐는지 확인 (full_redeploy는 Git clone 후 빌드)
- **ECR tag/digest**: 새 이미지가 푸시됐는지 확인
- **ASG Instance Refresh**: 실제로 새 인스턴스에 반영됐는지 확인

---

## 6. AI 하이브리드 (구현 예정)

| 항목 | 상태 | 비고 |
|------|------|------|
| 행 단위 학생 여부 판별 | ✅ 반영 | `_row_looks_like_student()` |
| 규칙 1차 + AI 워커 2차 컬럼 분류 | 🔶 적용 예정 | Rule 기반 1차 점수화(phone_ratio + parent/student 키워드), conf < 0.9 시 AI 워커로 parent_phone 판정, AI conf < 0.8이면 업로드 실패 |
| 학원별 매핑 학습 | 🔲 Optional | 구조(확장 포인트)만 준비, 실제 저장은 TODO |
